'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { MainLayout } from '@/components/layout/MainLayout';
import {
  Save, Plus, Trash2, Edit2, X, Upload, Download, Phone,
  Calendar, FileText, MessageSquare, Activity, Users, Settings,
  PlayCircle, ClipboardList, FileCheck, Database, Rocket, HeadphonesIcon,
  Building2, Mail, Globe, MapPin, Clock, RefreshCw, Bold, Italic, Underline, CheckCircle
} from 'lucide-react';
import api from '@/lib/api';

// Tab configuration with icons
const mainTabs = [
  { id: 'customer-details', label: 'Customer Details', icon: Building2 },
  { id: 'introduction', label: 'Introduction', icon: Mail },
  { id: 'requirement', label: 'Requirement', icon: ClipboardList },
  { id: 'presentation', label: 'Presentation', icon: PlayCircle },
  { id: 'demo', label: 'Demo', icon: PlayCircle },
  { id: 'proposal', label: 'Proposal', icon: FileText },
  { id: 'agreement', label: 'Agreement', icon: FileCheck },
  { id: 'initiation', label: 'Initiation', icon: Rocket },
  { id: 'planning', label: 'Planning', icon: Calendar },
  { id: 'configuration', label: 'Configuration', icon: Settings },
  { id: 'training', label: 'Training', icon: Users },
  { id: 'uat', label: 'UAT', icon: ClipboardList },
  { id: 'data-migration', label: 'Data Migration', icon: Database },
  { id: 'go-live', label: 'Go Live', icon: Rocket },
  { id: 'support', label: 'Support', icon: HeadphonesIcon },
  { id: 'call-logs', label: 'Call Logs', icon: Phone },
  { id: 'upload-file', label: 'Upload File', icon: Upload },
];

// Sub-tabs for each main tab

interface CustomerRequirement {
  id: number;
  lead_id: number;
  company_name?: string;
  address_line1?: string;
  address_line2?: string;
  country_id?: number;
  state_id?: number;
  city_id?: number;
  zip_code?: string;
  phone_no?: string;
  phone_ext?: string;
  fax?: string;
  website?: string;
  contact_name?: string;
  contact_title?: string;
  contact_phone?: string;
  contact_ext?: string;
  contact_email?: string;
  best_time_call?: string;
  mode?: string;
  branch_office?: string;
  no_of_employees?: number;
  instance_required?: string;
  ecommerce?: boolean;
  group_id?: number;
  industry_id?: number;
  region_id?: number;
  timezone_id?: number;
  sales_rep_id?: number;
  lead_source_id?: number;
  lead_from_id?: number;
  need_type?: string;
  budget?: string;
  time_frame?: string;
  current_it_infrastructure?: string;
  current_tab?: string;
  status?: string;
}

export default function CustomerRequirementPage() {
  const params = useParams();
  const router = useRouter();
  const leadId = Number(params.id);

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [activeTab, setActiveTab] = useState('customer-details');

  // Data states
  const [cr, setCr] = useState<CustomerRequirement | null>(null);
  const [introduction, setIntroduction] = useState<any>(null);
  const [requirement, setRequirement] = useState<any>(null);
  const [presentations, setPresentations] = useState<any[]>([]);
  const [demos, setDemos] = useState<any[]>([]);
  const [proposals, setProposals] = useState<any[]>([]);
  const [agreements, setAgreements] = useState<any[]>([]);
  const [callLogs, setCallLogs] = useState<any[]>([]);
  const [documents, setDocuments] = useState<any[]>([]);
  const [documentsRefreshTrigger, setDocumentsRefreshTrigger] = useState(0);

  // Modal states
  const [showDemoModal, setShowDemoModal] = useState(false);
  const [showProposalModal, setShowProposalModal] = useState(false);
  const [showAgreementModal, setShowAgreementModal] = useState(false);
  const [showCallLogModal, setShowCallLogModal] = useState(false);
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [emailModalData, setEmailModalData] = useState<any>({ tab: '', contactEmail: '', templateId: null });
  const [editingItem, setEditingItem] = useState<any>(null);

  // Form states
  const [formData, setFormData] = useState<any>({});

  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      const crData = await api.getCustomerRequirementByLead(leadId);
      setCr(crData);
      setFormData(crData);

      // Load tab-specific data
      if (crData.id) {
        const [introData, reqData, presData, demoData, propData, agrData, logsData] = await Promise.all([
          api.getCRIntroduction(crData.id).catch(() => null),
          api.getCRRequirement(crData.id).catch(() => null),
          api.getCRPresentations(crData.id).catch(() => []),
          api.getCRDemos(crData.id).catch(() => []),
          api.getCRProposals(crData.id).catch(() => []),
          api.getCRAgreements(crData.id).catch(() => []),
          api.getCRCallLogs(crData.id).catch(() => []),
        ]);
        setIntroduction(introData);
        setRequirement(reqData);
        setPresentations(presData);
        setDemos(demoData);
        setProposals(propData);
        setAgreements(agrData);
        setCallLogs(logsData);
      }
    } catch (err) {
      console.error('Failed to fetch data:', err);
    } finally {
      setLoading(false);
    }
  }, [leadId]);

  useEffect(() => {
    if (leadId) {
      fetchData();
    }
  }, [leadId, fetchData]);

  // Load documents when Upload File tab is active
  useEffect(() => {
    if (cr?.id && activeTab === 'upload-file') {
      api.getCRDocuments(cr.id, 'upload-file').then(setDocuments).catch(() => setDocuments([]));
    }
  }, [cr?.id, activeTab, documentsRefreshTrigger]);

  // Function to reload documents
  const reloadDocuments = useCallback(() => {
    setDocumentsRefreshTrigger(prev => prev + 1);
  }, []);

  const handleTabChange = (tabId: string) => {
    setActiveTab(tabId);
  };

  const handleSaveCustomerDetails = async () => {
    if (!cr?.id) return;
    setSaving(true);
    try {
      const updated = await api.updateCustomerRequirement(cr.id, formData);
      setCr(updated);
      alert('Saved successfully');
    } catch (err) {
      console.error('Failed to save:', err);
      alert('Failed to save');
    } finally {
      setSaving(false);
    }
  };

  const handleSaveIntroduction = async () => {
    if (!cr?.id) return;
    setSaving(true);
    try {
      const updated = await api.updateCRIntroduction(cr.id, introduction);
      setIntroduction(updated);
      alert('Saved successfully');
    } catch (err) {
      console.error('Failed to save:', err);
      alert('Failed to save');
    } finally {
      setSaving(false);
    }
  };

  const handleSaveRequirement = async () => {
    if (!cr?.id) return;
    setSaving(true);
    try {
      const updated = await api.updateCRRequirement(cr.id, requirement);
      setRequirement(updated);
      alert('Saved successfully');
    } catch (err) {
      console.error('Failed to save:', err);
      alert('Failed to save');
    } finally {
      setSaving(false);
    }
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files?.length) {
      return;
    }
    if (!cr?.id) {
      alert('Please save the customer requirement first before uploading documents.');
      return;
    }
    const file = e.target.files[0];
    try {
      await api.uploadCRDocument(cr.id, file, activeTab, 'Details');
      const data = await api.getCRDocuments(cr.id, activeTab);
      setDocuments(data);
      alert('File uploaded successfully');
    } catch (err: any) {
      console.error('Failed to upload:', err);
      alert(err?.response?.data?.detail || 'Failed to upload file');
    }
    e.target.value = '';
  };

  const handleDeleteDocument = async (docId: number) => {
    if (!cr?.id || !confirm('Are you sure you want to delete this document?')) return;
    try {
      await api.deleteCRDocument(cr.id, docId);
      setDocuments(documents.filter(d => d.id !== docId));
    } catch (err) {
      console.error('Failed to delete:', err);
      alert('Failed to delete document');
    }
  };

  // Open email modal handler
  const handleOpenEmailModal = (tab: string, contactEmail: string = '', templateId: number | null = null) => {
    setEmailModalData({ tab, contactEmail, templateId });
    setShowEmailModal(true);
  };

  // Styles
  const inputClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500";
  const labelClass = "text-xs font-medium text-gray-700 mb-1";
  const mainTabClass = (tabId: string) => `
    px-3 py-2 text-xs font-medium rounded-t border-b-2 transition-colors whitespace-nowrap
    ${activeTab === tabId
      ? 'bg-blue-600 text-white border-blue-600'
      : 'bg-gray-100 text-gray-600 border-transparent hover:bg-gray-200'}
  `;
  if (loading) {
    return (
      <MainLayout>
        <div className="flex items-center justify-center h-64">
          <div className="text-gray-500">Loading...</div>
        </div>
      </MainLayout>
    );
  }

  return (
    <MainLayout>
      <div className="space-y-4">
        {/* Header */}
        <div className="flex items-center justify-between">
          <h1 className="text-lg font-bold text-blue-600">
            CUSTOMER REQUIREMENT - {cr?.company_name || 'New'}
          </h1>
          <button
            onClick={() => router.back()}
            className="px-3 py-1.5 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200"
          >
            Back to Leads
          </button>
        </div>

        {/* Main Tabs */}
        <div className="flex flex-wrap gap-1 pb-2 border-b border-gray-200 overflow-x-auto">
          {mainTabs.map((tab) => {
            const IconComponent = tab.icon;
            return (
              <button
                key={tab.id}
                onClick={() => handleTabChange(tab.id)}
                className={mainTabClass(tab.id)}
              >
                <span className="flex items-center gap-1">
                  <IconComponent className="w-3.5 h-3.5" />
                  {tab.label}
                </span>
              </button>
            );
          })}
        </div>

        {/* Content Area */}
        <div className="bg-white rounded-lg shadow p-4">
          {/* Customer Details Tab */}
          {activeTab === 'customer-details' && (
            <CustomerDetailsForm
              formData={formData}
              setFormData={setFormData}
              onSave={handleSaveCustomerDetails}
              saving={saving}
              inputClass={inputClass}
              labelClass={labelClass}
            />
          )}

          {/* Introduction Tab */}
          {activeTab === 'introduction' && (
            <IntroductionForm
              data={introduction}
              setData={setIntroduction}
              onSave={handleSaveIntroduction}
              saving={saving}
              inputClass={inputClass}
              labelClass={labelClass}
              crId={cr?.id}
              leadId={leadId}
              customerData={formData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Requirement Tab */}
          {activeTab === 'requirement' && (
            <RequirementForm
              data={requirement}
              setData={setRequirement}
              onSave={handleSaveRequirement}
              saving={saving}
              inputClass={inputClass}
              labelClass={labelClass}
              crId={cr?.id}
              leadId={leadId}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Presentation Tab */}
          {activeTab === 'presentation' && (
            <PresentationForm
              data={formData}
              setData={setFormData}
              crId={cr?.id}
              leadId={leadId}
              presentations={presentations}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Demo Tab */}
          {activeTab === 'demo' && (
            <DemoForm
              data={formData}
              setData={setFormData}
              crId={cr?.id}
              leadId={leadId}
              demos={demos}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Proposal Tab */}
          {activeTab === 'proposal' && (
            <ProposalForm
              data={cr}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Agreement Tab */}
          {activeTab === 'agreement' && (
            <AgreementForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Call Logs Tab */}
          {activeTab === 'call-logs' && (
            <CallLogsList
              callLogs={callLogs}
              onAdd={() => { setEditingItem(null); setShowCallLogModal(true); }}
              onEdit={(item: any) => { setEditingItem(item); setShowCallLogModal(true); }}
              crId={cr?.id}
              refreshData={fetchData}
              leadData={formData}
            />
          )}

          {/* Initiation Tab */}
          {activeTab === 'initiation' && (
            <InitiationForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Planning Tab */}
          {activeTab === 'planning' && (
            <PlanningForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Configuration Tab */}
          {activeTab === 'configuration' && (
            <ConfigurationForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Training Tab */}
          {activeTab === 'training' && (
            <TrainingForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* UAT Tab */}
          {activeTab === 'uat' && (
            <UATForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Data Migration Tab */}
          {activeTab === 'data-migration' && (
            <DataMigrationForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Go Live Tab */}
          {activeTab === 'go-live' && (
            <GoLiveForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Support Tab */}
          {activeTab === 'support' && (
            <SupportForm
              data={formData}
              crId={cr?.id}
              leadId={leadId}
              refreshData={fetchData}
              onOpenEmailModal={handleOpenEmailModal}
            />
          )}

          {/* Upload File Tab */}
          {activeTab === 'upload-file' && (
            <DocumentsSection
              documents={documents}
              onUpload={handleFileUpload}
              onDelete={handleDeleteDocument}
              crId={cr?.id}
              refreshData={reloadDocuments}
            />
          )}
        </div>
      </div>

      {/* Demo Modal */}
      {showDemoModal && cr?.id && (
        <DemoModal
          isOpen={showDemoModal}
          onClose={() => { setShowDemoModal(false); setEditingItem(null); }}
          crId={cr.id}
          editingItem={editingItem}
          refreshData={fetchData}
        />
      )}

      {/* Proposal Modal */}
      {showProposalModal && cr?.id && (
        <ProposalModal
          isOpen={showProposalModal}
          onClose={() => { setShowProposalModal(false); setEditingItem(null); }}
          crId={cr.id}
          editingItem={editingItem}
          refreshData={fetchData}
        />
      )}

      {/* Agreement Modal */}
      {showAgreementModal && cr?.id && (
        <AgreementModal
          isOpen={showAgreementModal}
          onClose={() => { setShowAgreementModal(false); setEditingItem(null); }}
          crId={cr.id}
          editingItem={editingItem}
          refreshData={fetchData}
        />
      )}

      {/* Call Log Modal */}
      {showCallLogModal && cr?.id && (
        <CallLogModal
          isOpen={showCallLogModal}
          onClose={() => { setShowCallLogModal(false); setEditingItem(null); }}
          crId={cr.id}
          editingItem={editingItem}
          refreshData={fetchData}
        />
      )}

      {/* Email Modal */}
      {showEmailModal && cr?.id && (
        <EmailModal
          isOpen={showEmailModal}
          onClose={() => setShowEmailModal(false)}
          crId={cr.id}
          leadId={leadId}
          tab={emailModalData.tab}
          contactEmail={emailModalData.contactEmail}
          templateId={emailModalData.templateId}
          companyName={formData?.company_name || cr?.company_name || ''}
        />
      )}
    </MainLayout>
  );
}

// ============== Customer Details Form ==============
function CustomerDetailsForm({ formData, setFormData, onSave, saving, inputClass, labelClass }: any) {
  const [profileSubTab, setProfileSubTab] = useState('company-profile');

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-36 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50";
  const fieldSelectClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white";
  const rowClass = "flex items-center gap-2 mb-3";

  return (
    <div className="space-y-6">
      {/* Two Column Layout */}
      <div className="grid grid-cols-2 gap-8">
        {/* Left Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Company Name</label>
            <input type="text" value={formData.company_name || ''} onChange={(e) => setFormData({ ...formData, company_name: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Company Address</label>
            <input type="text" value={formData.address_line1 || ''} onChange={(e) => setFormData({ ...formData, address_line1: e.target.value })} className={fieldInputClass} placeholder="Street road" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}></label>
            <input type="text" value={formData.address_line2 || ''} onChange={(e) => setFormData({ ...formData, address_line2: e.target.value })} className={fieldInputClass} placeholder="Street road" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Country</label>
            <select value={formData.country_id || ''} onChange={(e) => setFormData({ ...formData, country_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Country</option>
              <option value="1">United Arab Emirates</option>
              <option value="2">India</option>
              <option value="3">United States</option>
              <option value="4">United Kingdom</option>
              <option value="5">Pakistan</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>State/Province</label>
            <select value={formData.state_id || ''} onChange={(e) => setFormData({ ...formData, state_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select State</option>
              <option value="1">Dubai</option>
              <option value="2">Abu Dhabi</option>
              <option value="3">Maharashtra</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>City</label>
            <div className="flex-1 flex gap-1">
              <select value={formData.city_id || ''} onChange={(e) => setFormData({ ...formData, city_id: parseInt(e.target.value) || null })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white">
                <option value="">Select City</option>
                <option value="1">Hub</option>
                <option value="2">Dubai</option>
                <option value="3">Mumbai</option>
              </select>
              <button className="w-8 h-8 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100">
                <Plus className="w-4 h-4" />
              </button>
            </div>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Postal/Zip Code</label>
            <input type="text" value={formData.zip_code || ''} onChange={(e) => setFormData({ ...formData, zip_code: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Phone</label>
            <input type="text" value={formData.phone_no || ''} onChange={(e) => setFormData({ ...formData, phone_no: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" />
            <span className="text-xs text-gray-500">Ext.</span>
            <input type="text" value={formData.phone_ext || ''} onChange={(e) => setFormData({ ...formData, phone_ext: e.target.value })} className="w-16 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Fax</label>
            <input type="text" value={formData.fax || ''} onChange={(e) => setFormData({ ...formData, fax: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Website</label>
            <input type="text" value={formData.website || ''} onChange={(e) => setFormData({ ...formData, website: e.target.value })} className={fieldInputClass} placeholder="Website" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Name</label>
            <input type="text" value={formData.contact_name || ''} onChange={(e) => setFormData({ ...formData, contact_name: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Job Title</label>
            <input type="text" value={formData.contact_title || ''} onChange={(e) => setFormData({ ...formData, contact_title: e.target.value })} className={fieldInputClass} placeholder="Contact Job Title" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Phone</label>
            <input type="text" value={formData.contact_phone || ''} onChange={(e) => setFormData({ ...formData, contact_phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" />
            <span className="text-xs text-gray-500">Ext.</span>
            <input type="text" value={formData.contact_ext || ''} onChange={(e) => setFormData({ ...formData, contact_ext: e.target.value })} className="w-16 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Email</label>
            <input type="email" value={formData.contact_email || ''} onChange={(e) => setFormData({ ...formData, contact_email: e.target.value })} className={fieldInputClass} placeholder="Email" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Best Time(Call)</label>
            <input type="time" value={formData.best_time_call || ''} onChange={(e) => setFormData({ ...formData, best_time_call: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Mode</label>
            <input type="text" value={formData.mode || ''} onChange={(e) => setFormData({ ...formData, mode: e.target.value })} className={fieldInputClass} placeholder="Mode" />
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Branch Office</label>
            <input type="text" value={formData.branch_office || ''} onChange={(e) => setFormData({ ...formData, branch_office: e.target.value })} className={fieldInputClass} placeholder="Branch Office" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Number Of Employees</label>
            <select value={formData.no_of_employees || ''} onChange={(e) => setFormData({ ...formData, no_of_employees: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select the Employee</option>
              <option value="10">1-10</option>
              <option value="50">11-50</option>
              <option value="100">51-100</option>
              <option value="500">101-500</option>
              <option value="1000">500+</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Instance Required</label>
            <select value={formData.instance_required || ''} onChange={(e) => setFormData({ ...formData, instance_required: e.target.value })} className={fieldSelectClass}>
              <option value="">Select Instance</option>
              <option value="Impex">Impex</option>
              <option value="Single">Single</option>
              <option value="Multi">Multi</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>E-Commerce</label>
            <select value={formData.ecommerce ? 'yes' : 'no'} onChange={(e) => setFormData({ ...formData, ecommerce: e.target.value === 'yes' })} className={fieldSelectClass}>
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Group</label>
            <select value={formData.group_id || ''} onChange={(e) => setFormData({ ...formData, group_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Group</option>
              <option value="1">Group A</option>
              <option value="2">Group B</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Industry</label>
            <select value={formData.industry_id || ''} onChange={(e) => setFormData({ ...formData, industry_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Industry</option>
              <option value="1">Technology</option>
              <option value="2">Manufacturing</option>
              <option value="3">Retail</option>
              <option value="4">Healthcare</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Company Region</label>
            <select value={formData.region_id || ''} onChange={(e) => setFormData({ ...formData, region_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Region</option>
              <option value="1">Middle East</option>
              <option value="2">Asia</option>
              <option value="3">Europe</option>
              <option value="4">North America</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Office Timing</label>
            <input type="time" value={formData.office_timing_from || ''} onChange={(e) => setFormData({ ...formData, office_timing_from: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" />
            <input type="time" value={formData.office_timing_to || ''} onChange={(e) => setFormData({ ...formData, office_timing_to: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>TimeZone</label>
            <select value={formData.timezone_id || ''} onChange={(e) => setFormData({ ...formData, timezone_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Timezone</option>
              <option value="1">Asia/Dubai (+04:00)</option>
              <option value="2">Asia/Kolkata (+05:30)</option>
              <option value="3">America/New_York (-05:00)</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Sales Rep</label>
            <select value={formData.sales_rep_id || ''} onChange={(e) => setFormData({ ...formData, sales_rep_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Rep.</option>
              <option value="1">Junaid Ali</option>
              <option value="2">Admin User</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Lead Source</label>
            <select value={formData.lead_source_id || ''} onChange={(e) => setFormData({ ...formData, lead_source_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Lead Source</option>
              <option value="1">Website</option>
              <option value="2">Referral</option>
              <option value="3">Social Media</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Lead From</label>
            <select value={formData.lead_from_id || ''} onChange={(e) => setFormData({ ...formData, lead_from_id: parseInt(e.target.value) || null })} className={fieldSelectClass}>
              <option value="">Select Lead From</option>
              <option value="1">Direct</option>
              <option value="2">Partner</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Lead From (Name)</label>
            <input type="text" value={formData.lead_from_name || ''} onChange={(e) => setFormData({ ...formData, lead_from_name: e.target.value })} className={fieldInputClass} placeholder="Lead From" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Lead Status</label>
            <input type="text" value={formData.lead_status || 'Validated Lead'} onChange={(e) => setFormData({ ...formData, lead_status: e.target.value })} className={fieldInputClass} readOnly />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Lead Score</label>
            <select value={formData.lead_score || ''} onChange={(e) => setFormData({ ...formData, lead_score: e.target.value })} className={fieldSelectClass}>
              <option value="">Select Lead Score</option>
              <option value="hot">Hot</option>
              <option value="warm">Warm</option>
              <option value="cold">Cold</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Remarks</label>
            <textarea value={formData.remarks || ''} onChange={(e) => setFormData({ ...formData, remarks: e.target.value })} className="flex-1 h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" />
          </div>
        </div>
      </div>

      {/* Additional Information Section */}
      <div className="border-t pt-4">
        <h3 className="text-sm font-bold text-blue-600 mb-4">ADDITIONAL INFORMATION</h3>
        <div className="grid grid-cols-2 gap-8">
          {/* Left Column */}
          <div className="space-y-1">
            <div className={rowClass}>
              <label className={fieldLabelClass}>Need Type</label>
              <select value={formData.need_type || ''} onChange={(e) => setFormData({ ...formData, need_type: e.target.value })} className={fieldSelectClass}>
                <option value="">Select Need Type</option>
                <option value="new">New Implementation</option>
                <option value="upgrade">Upgrade</option>
                <option value="migration">Migration</option>
                <option value="support">Support</option>
              </select>
            </div>
            <div className={rowClass}>
              <label className={fieldLabelClass}>Current Software</label>
              <input type="text" value={formData.current_software || ''} onChange={(e) => setFormData({ ...formData, current_software: e.target.value })} className={fieldInputClass} placeholder="Current Software" />
            </div>
            <div className={rowClass}>
              <label className={fieldLabelClass}>Need Summary</label>
              <textarea value={formData.need_summary || ''} onChange={(e) => setFormData({ ...formData, need_summary: e.target.value })} className="flex-1 h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" placeholder="Summary" />
            </div>
          </div>
          {/* Right Column */}
          <div className="space-y-1">
            <div className={rowClass}>
              <label className={fieldLabelClass}>Budget</label>
              <select value={formData.budget || ''} onChange={(e) => setFormData({ ...formData, budget: e.target.value })} className={fieldSelectClass}>
                <option value="">Select Budget</option>
                <option value="<10k">Less than $10,000</option>
                <option value="10k-50k">$10,000 - $50,000</option>
                <option value="50k-100k">$50,000 - $100,000</option>
                <option value=">100k">More than $100,000</option>
              </select>
            </div>
            <div className={rowClass}>
              <label className={fieldLabelClass}>Decision Maker</label>
              <select value={formData.decision_maker || ''} onChange={(e) => setFormData({ ...formData, decision_maker: e.target.value })} className={fieldSelectClass}>
                <option value="">Select Decision Maker</option>
                <option value="1">Arbaz Alam</option>
                <option value="2">Contact Person</option>
              </select>
            </div>
            <div className={rowClass}>
              <label className={fieldLabelClass}>Time Frame</label>
              <select value={formData.time_frame || ''} onChange={(e) => setFormData({ ...formData, time_frame: e.target.value })} className={fieldSelectClass}>
                <option value="">Select Time Frame</option>
                <option value="immediate">Immediate</option>
                <option value="1-3months">1-3 Months</option>
                <option value="3-6months">3-6 Months</option>
                <option value="6-12months">6-12 Months</option>
              </select>
            </div>
            <div className={rowClass}>
              <label className={fieldLabelClass}>Qualified By</label>
              <select value={formData.qualified_by || ''} onChange={(e) => setFormData({ ...formData, qualified_by: e.target.value })} className={fieldSelectClass}>
                <option value="">Select Qualified By</option>
                <option value="1">Junaid Ali</option>
                <option value="2">Admin User</option>
              </select>
            </div>
          </div>
        </div>
        <div className="flex justify-center mt-4">
          <button onClick={onSave} disabled={saving} className="px-6 py-1.5 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 disabled:opacity-50">
            {saving ? 'Saving...' : 'Save'}
          </button>
        </div>
      </div>

      {/* Company Profile Section with Sub-tabs */}
      <div className="border-t pt-4">
        <div className="flex gap-1 mb-4">
          <button onClick={() => setProfileSubTab('company-profile')} className={`px-4 py-1.5 text-xs font-medium rounded ${profileSubTab === 'company-profile' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>
            Company Profile
          </button>
          <button onClick={() => setProfileSubTab('summary')} className={`px-4 py-1.5 text-xs font-medium rounded ${profileSubTab === 'summary' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>
            Summary
          </button>
          <button onClick={() => setProfileSubTab('conclusion')} className={`px-4 py-1.5 text-xs font-medium rounded ${profileSubTab === 'conclusion' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>
            Conclusion
          </button>
        </div>

        {profileSubTab === 'company-profile' && (
          <div>
            <h4 className="text-sm font-bold text-blue-600 mb-3">COMPANY PROFILE</h4>
            <textarea
              value={formData.company_profile || ''}
              onChange={(e) => setFormData({ ...formData, company_profile: e.target.value })}
              className="w-full h-48 px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="Enter company profile..."
            />
          </div>
        )}

        {profileSubTab === 'summary' && (
          <div>
            <h4 className="text-sm font-bold text-blue-600 mb-3">SUMMARY</h4>
            <textarea
              value={formData.summary || ''}
              onChange={(e) => setFormData({ ...formData, summary: e.target.value })}
              className="w-full h-48 px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="Enter summary..."
            />
          </div>
        )}

        {profileSubTab === 'conclusion' && (
          <div>
            <h4 className="text-sm font-bold text-blue-600 mb-3">CONCLUSION</h4>
            <textarea
              value={formData.conclusion || ''}
              onChange={(e) => setFormData({ ...formData, conclusion: e.target.value })}
              className="w-full h-48 px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="Enter conclusion..."
            />
          </div>
        )}

        <div className="flex justify-center mt-4">
          <button onClick={onSave} disabled={saving} className="px-6 py-1.5 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 disabled:opacity-50">
            {saving ? 'Saving...' : 'Save'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ============== Introduction Form ==============
function IntroductionForm({ data, setData, onSave, saving, inputClass, labelClass, crId, leadId, customerData, onOpenEmailModal }: any) {
  const [introSubTab, setIntroSubTab] = useState('activity');
  const [activitySubTab, setActivitySubTab] = useState('all');
  const [emailsSent, setEmailsSent] = useState<any[]>([]);
  const [documents, setDocuments] = useState<any[]>([]);
  const [introContacts, setIntroContacts] = useState<any[]>([]);
  const [introEmailTemplates, setIntroEmailTemplates] = useState<any[]>([]);
  const [introFormData, setIntroFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [activities, setActivities] = useState<any[]>([]);
  const [followUpActivities, setFollowUpActivities] = useState<any[]>([]);
  const [showFollowUpModal, setShowFollowUpModal] = useState(false);
  const [editingFollowUp, setEditingFollowUp] = useState<any>(null);
  const [followUpFormData, setFollowUpFormData] = useState({
    activity_type: '',
    subject: '',
    start_date: new Date().toISOString().split('T')[0],
    start_time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }),
    end_date: new Date().toISOString().split('T')[0],
    end_time: '',
    description: '',
    status: 'Open',
    contact_id: '',
    assigned_to: '',
    priority: '',
  });
  const [introMemos, setIntroMemos] = useState<any[]>([]);
  const [showIntroMemoModal, setShowIntroMemoModal] = useState(false);
  const [editingMemo, setEditingMemo] = useState<any>(null);
  const [memoFormData, setMemoFormData] = useState({ content: '' });
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const fileInputRef = React.useRef<HTMLInputElement>(null);
  const [subTabDocs, setSubTabDocs] = useState<any[]>([]);
  const [subTabFile, setSubTabFile] = useState<File | null>(null);
  const [subTabNotes, setSubTabNotes] = useState('');
  const [subTabUploading, setSubTabUploading] = useState(false);
  const subTabFileRef = React.useRef<HTMLInputElement>(null);

  // Load documents when crId is available
  useEffect(() => {
    if (crId) {
      api.getCRDocuments(crId, 'introduction').then(setDocuments).catch(() => setDocuments([]));
    }
  }, [crId]);

  // Load contacts from lead
  useEffect(() => {
    if (leadId) {
      api.getLeadContactsForEdit(leadId).then(setIntroContacts).catch(() => setIntroContacts([]));
    }
  }, [leadId]);

  // Load email templates for Introduction tab
  useEffect(() => {
    api.getCRIEmailTemplates('Introduction').then(setIntroEmailTemplates).catch(() => setIntroEmailTemplates([]));
  }, []);

  // Initialize form data from customerData (lead data)
  useEffect(() => {
    if (customerData) {
      setIntroFormData(prev => ({
        ...prev,
        company_name: customerData.company_name || '',
        branch_office: customerData.branch_office || ''
      }));
    }
  }, [customerData]);

  // Load follow-up activities when sub-tab changes
  useEffect(() => {
    if (crId && introSubTab === 'follow-up') {
      api.getCRActivities(crId, 'introduction-followup').then(setFollowUpActivities).catch(() => setFollowUpActivities([]));
    }
  }, [crId, introSubTab]);

  // Load memos when sub-tab changes
  useEffect(() => {
    if (crId && introSubTab === 'memo') {
      api.getCRMemos(crId, 'introduction').then(setIntroMemos).catch(() => setIntroMemos([]));
    }
  }, [crId, introSubTab]);

  // Load upload-file sub-tab documents
  useEffect(() => {
    if (crId && introSubTab === 'upload-file') {
      api.getCRDocuments(crId, 'introduction-upload').then(setSubTabDocs).catch(() => setSubTabDocs([]));
    }
  }, [crId, introSubTab]);

  const handleSubTabChooseFile = () => {
    subTabFileRef.current?.click();
  };

  const handleSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files?.length) {
      setSubTabFile(e.target.files[0]);
    }
  };

  const handleSubTabUpload = async () => {
    if (!subTabFile) {
      alert('Please choose a file first');
      return;
    }
    if (!crId) {
      alert('Please save the customer requirement first');
      return;
    }
    setSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, subTabFile, 'introduction-upload', 'Upload File');
      const docs = await api.getCRDocuments(crId, 'introduction-upload');
      setSubTabDocs(docs);
      setSubTabFile(null);
      setSubTabNotes('');
      if (subTabFileRef.current) subTabFileRef.current.value = '';
    } catch (err: any) {
      console.error('Upload failed:', err);
      alert(err?.response?.data?.detail || 'Failed to upload file');
    } finally {
      setSubTabUploading(false);
    }
  };

  const handleSubTabDeleteDoc = async (docId: number) => {
    if (!crId) return;
    if (!confirm('Are you sure you want to delete this document?')) return;
    try {
      await api.deleteCRDocument(crId, docId);
      setSubTabDocs(subTabDocs.filter((d: any) => d.id !== docId));
    } catch (err: any) {
      console.error('Delete failed:', err);
      alert(err?.response?.data?.detail || 'Failed to delete document');
    }
  };

  const handleChooseFile = () => {
    fileInputRef.current?.click();
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files?.length) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleUploadFile = async () => {
    if (!selectedFile) {
      alert('Please choose a file first');
      return;
    }
    if (!crId) {
      alert('Please save the customer requirement first');
      return;
    }
    setUploading(true);
    try {
      await api.uploadCRDocument(crId, selectedFile, 'introduction', 'Details');
      const docs = await api.getCRDocuments(crId, 'introduction');
      setDocuments(docs);
      setSelectedFile(null);
      if (fileInputRef.current) fileInputRef.current.value = '';
      alert('File uploaded successfully');
    } catch (err: any) {
      console.error('Upload failed:', err);
      alert(err?.response?.data?.detail || 'Failed to upload file');
    } finally {
      setUploading(false);
    }
  };
  const [showActivityModal, setShowActivityModal] = useState(false);
  const [activityFormData, setActivityFormData] = useState({
    created_by: '',
    action_to_be_taken: '',
    start_date: '',
    start_time: '',
    description: '',
    source: '',
    type: '',
    contact: ''
  });

  const handleSaveActivity = () => {
    const newActivity = {
      ...activityFormData,
      by: activityFormData.created_by || 'Current User',
      date: activityFormData.start_date,
      time: activityFormData.start_time,
    };
    setActivities([...activities, newActivity]);
    setShowActivityModal(false);
    setActivityFormData({
      created_by: '',
      action_to_be_taken: '',
      start_date: '',
      start_time: '',
      description: '',
      source: '',
      type: '',
      contact: ''
    });
  };

  const handleDeleteDocument = async (docId: number) => {
    if (!crId) return;
    if (!confirm('Are you sure you want to delete this document?')) return;
    try {
      await api.deleteCRDocument(crId, docId);
      setDocuments(documents.filter((d: any) => d.id !== docId));
    } catch (err: any) {
      console.error('Delete failed:', err);
      alert(err?.response?.data?.detail || 'Failed to delete document');
    }
  };

  const handleOpenFollowUpModal = (item?: any) => {
    if (item) {
      setEditingFollowUp(item);
      setFollowUpFormData({
        activity_type: item.activity_type || '',
        subject: item.subject || '',
        start_date: item.start_date || '',
        start_time: item.start_time || '',
        end_date: item.end_date || '',
        end_time: item.end_time || '',
        description: item.description || '',
        status: item.status || 'Open',
        contact_id: item.contact_id?.toString() || '',
        assigned_to: item.assigned_to?.toString() || '',
        priority: item.priority || '',
      });
    } else {
      setEditingFollowUp(null);
      const now = new Date();
      setFollowUpFormData({
        activity_type: '',
        subject: '',
        start_date: now.toISOString().split('T')[0],
        start_time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }),
        end_date: now.toISOString().split('T')[0],
        end_time: '',
        description: '',
        status: 'Open',
        contact_id: '',
        assigned_to: '',
        priority: '',
      });
    }
    setShowFollowUpModal(true);
  };

  const handleSaveFollowUp = async () => {
    if (!crId) return;
    try {
      if (editingFollowUp) {
        const updated = await api.updateCRActivity(crId, editingFollowUp.id, followUpFormData);
        setFollowUpActivities(followUpActivities.map((a: any) => a.id === editingFollowUp.id ? updated : a));
      } else {
        const created = await api.createCRActivity(crId, {
          ...followUpFormData,
          tab_name: 'introduction-followup',
        });
        setFollowUpActivities([...followUpActivities, created]);
      }
      setShowFollowUpModal(false);
      setEditingFollowUp(null);
    } catch (err: any) {
      console.error('Save follow-up failed:', err);
      alert(err?.response?.data?.detail || 'Failed to save follow-up');
    }
  };

  const handleDeleteFollowUp = async (id: number) => {
    if (!crId) return;
    if (!confirm('Are you sure you want to delete this follow-up?')) return;
    try {
      await api.deleteCRActivity(crId, id);
      setFollowUpActivities(followUpActivities.filter((a: any) => a.id !== id));
    } catch (err: any) {
      console.error('Delete follow-up failed:', err);
      alert(err?.response?.data?.detail || 'Failed to delete follow-up');
    }
  };

  const handleOpenMemoModal = (item?: any) => {
    if (item) {
      setEditingMemo(item);
      setMemoFormData({ content: item.content || '' });
    } else {
      setEditingMemo(null);
      setMemoFormData({ content: '' });
    }
    setShowIntroMemoModal(true);
  };

  const handleSaveMemo = async () => {
    if (!crId) return;
    try {
      if (editingMemo) {
        const updated = await api.updateCRMemo(crId, editingMemo.id, memoFormData);
        setIntroMemos(introMemos.map((m: any) => m.id === editingMemo.id ? updated : m));
      } else {
        const created = await api.createCRMemo(crId, {
          ...memoFormData,
          tab_name: 'introduction',
        });
        setIntroMemos([...introMemos, created]);
      }
      setShowIntroMemoModal(false);
      setEditingMemo(null);
    } catch (err: any) {
      console.error('Save memo failed:', err);
      alert(err?.response?.data?.detail || 'Failed to save memo');
    }
  };

  const handleDeleteMemo = async (id: number) => {
    if (!crId) return;
    if (!confirm('Are you sure you want to delete this memo?')) return;
    try {
      await api.deleteCRMemo(crId, id);
      setIntroMemos(introMemos.filter((m: any) => m.id !== id));
    } catch (err: any) {
      console.error('Delete memo failed:', err);
      alert(err?.response?.data?.detail || 'Failed to delete memo');
    }
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-32 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-blue-50";
  const fieldSelectClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-blue-50";
  const rowClass = "flex items-center gap-2 mb-2";
  const thClass = "px-3 py-2 text-left text-xs font-medium text-white bg-blue-600 border-r border-blue-500 last:border-r-0";
  const tdClass = "px-3 py-2 text-xs border-b border-gray-200";

  return (
    <div className="space-y-4">
      {/* Top Form Section */}
      <div className="grid grid-cols-2 gap-6">
        {/* Left Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Company Name</label>
            <input type="text" value={introFormData.company_name} onChange={(e) => setIntroFormData({ ...introFormData, company_name: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Name</label>
            <select value={introFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = introContacts.find((c: any) => c.id?.toString() === cid); setIntroFormData({ ...introFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className={fieldSelectClass}>
              <option value="">Select Contact Name</option>
              {introContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={introFormData.email_format_type} onChange={(e) => setIntroFormData({ ...introFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {introEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Introduction', introFormData.contact_email, introEmailTemplates.find((t: any) => t.email_format === introFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>

          {/* Email Sent To Table */}
          <div className="mt-3 border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className={thClass}>Email Sent To</th>
                  <th className={thClass}>Attachments</th>
                  <th className={thClass}>Sent On</th>
                  <th className={thClass}>Action</th>
                </tr>
              </thead>
              <tbody>
                {emailsSent.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-gray-400 text-xs">No emails sent</td></tr>
                ) : (
                  emailsSent.map((email: any, index: number) => (
                    <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className={tdClass}>{email.to}</td>
                      <td className={tdClass}>{email.attachments || '-'}</td>
                      <td className={tdClass}>{email.sent_on}</td>
                      <td className={tdClass}>
                        <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Edit2 className="w-3 h-3" /></button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Branch Office</label>
            <input type="text" value={introFormData.branch_office} onChange={(e) => setIntroFormData({ ...introFormData, branch_office: e.target.value })} className={fieldInputClass} placeholder="Branch Office" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Email</label>
            <input type="email" value={introFormData.contact_email} readOnly className={`${fieldInputClass} bg-gray-100`} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Document</label>
            <input type="text" className={fieldInputClass} readOnly value={selectedFile?.name || ''} placeholder="No file chosen" />
            <input
              ref={fileInputRef}
              type="file"
              onChange={handleFileChange}
              className="hidden"
              style={{ display: 'none' }}
            />
            <button
              type="button"
              onClick={handleChooseFile}
              className="h-8 px-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"
            >
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button
              type="button"
              onClick={handleUploadFile}
              disabled={!selectedFile || uploading}
              className="h-8 px-3 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {uploading ? 'Uploading...' : 'Upload'}
            </button>
          </div>

          {/* Documents Table */}
          <div className="mt-3 border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className={thClass}>File Name</th>
                  <th className={thClass}>Link</th>
                  <th className={thClass}>Size</th>
                  <th className={thClass}>Upload On</th>
                  <th className={thClass}>Action</th>
                </tr>
              </thead>
              <tbody>
                {documents.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs">No documents uploaded</td></tr>
                ) : (
                  documents.map((doc: any, index: number) => (
                    <tr key={doc.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className={`${tdClass} text-blue-600`}>{doc.file_name}</td>
                      <td className={`${tdClass} text-blue-600`}>
                        {doc.file_path ? (
                          <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">
                            View
                          </a>
                        ) : '-'}
                      </td>
                      <td className={tdClass}>{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className={tdClass}>{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className={tdClass}>
                        <div className="flex gap-1 justify-center">
                          <button
                            type="button"
                            onClick={() => handleDeleteDocument(doc.id)}
                            className="p-1 text-red-600 hover:bg-red-50 rounded"
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Section */}
      <div className="border-t pt-4">
        <div className="flex gap-4 mb-4">
          {['Activity', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'].map((tab) => {
            const tabKey = tab.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-');
            const isActive = introSubTab === tabKey;
            return (
              <button
                key={tab}
                onClick={() => setIntroSubTab(tabKey)}
                className={`px-2 py-1 text-xs font-medium border-b-2 ${
                  isActive
                    ? 'border-blue-600 text-blue-600 bg-blue-50 rounded-t'
                    : 'border-transparent text-orange-500 hover:text-orange-600'
                }`}
              >
                {tab}
              </button>
            );
          })}
        </div>

        {/* Activity Section */}
        {introSubTab === 'activity' && (
          <div className="space-y-3">
            {/* Activity Sub-tabs */}
            <div className="flex items-center justify-between">
              <div className="flex gap-2">
                <button
                  onClick={() => setActivitySubTab('all')}
                  className={`px-3 py-1 text-xs font-medium rounded ${
                    activitySubTab === 'all' ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-600'
                  }`}
                >
                  All Activity
                </button>
                <button
                  onClick={() => setActivitySubTab('followup')}
                  className={`px-3 py-1 text-xs font-medium rounded ${
                    activitySubTab === 'followup' ? 'bg-blue-600 text-white' : 'text-orange-500'
                  }`}
                >
                  Activity Follow-Up
                </button>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowActivityModal(true)} className="px-3 py-1 text-xs border rounded hover:bg-gray-50">Add New Activity</button>
                <button className="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">CSV</button>
                <button className="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">EXCEL</button>
                <button className="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">PDF</button>
              </div>
            </div>

            {/* Activity Table */}
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className={thClass}>By</th>
                    <th className={thClass}>Date</th>
                    <th className={thClass}>Time</th>
                    <th className={thClass}>Source</th>
                    <th className={thClass}>Type</th>
                    <th className={thClass}>Description</th>
                    <th className={thClass}>Action to be Taken</th>
                    <th className={thClass}>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {activities.length === 0 ? (
                    <tr><td colSpan={8} className="px-3 py-8 text-center text-gray-400 text-xs">No activities found</td></tr>
                  ) : (
                    activities.map((activity: any, index: number) => (
                      <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className={tdClass}>{activity.by}</td>
                        <td className={`${tdClass} text-blue-600`}>{activity.date}</td>
                        <td className={`${tdClass} text-blue-600`}>{activity.time}</td>
                        <td className={`${tdClass} text-blue-600`}>{activity.source}</td>
                        <td className={tdClass}>{activity.type}</td>
                        <td className={`${tdClass} text-blue-600`}>{activity.description}</td>
                        <td className={tdClass}>{activity.action_to_be_taken || '-'}</td>
                        <td className={tdClass}>
                          <button className="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">Follow-Up</button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Follow-Up Section */}
        {introSubTab === 'follow-up' && (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <button
                onClick={() => handleOpenFollowUpModal()}
                className="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50"
              >
                Add New Activity
              </button>
            </div>

            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className={thClass}>Activity Type</th>
                    <th className={thClass}>Activity Subject</th>
                    <th className={thClass}>Date & Time</th>
                    <th className={thClass}>Next Follow-up Date</th>
                    <th className={thClass}>Channel Type</th>
                    <th className={thClass}>Assigned To</th>
                    <th className={thClass}>Sent To</th>
                    <th className={thClass}>Status</th>
                    <th className={thClass}>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {followUpActivities.length === 0 ? (
                    <tr><td colSpan={9} className="px-3 py-8 text-center text-gray-400 text-xs">No follow-up activities found</td></tr>
                  ) : (
                    followUpActivities.map((item: any, index: number) => (
                      <tr key={item.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className={`${tdClass} text-red-500`}>{item.activity_type || '-'}</td>
                        <td className={tdClass}>{item.subject || '-'}</td>
                        <td className={tdClass}>
                          {item.start_date ? `${new Date(item.start_date).toLocaleDateString()}, ${item.start_time || ''}` : '-'}
                        </td>
                        <td className={tdClass}>
                          {item.end_date ? `${new Date(item.end_date).toLocaleDateString()} ; ${item.end_time || ''}` : '-'}
                        </td>
                        <td className={tdClass}>{item.description || '-'}</td>
                        <td className={tdClass}>{item.assigned_to || '-'}</td>
                        <td className={tdClass}>{item.contact_id || '-'}</td>
                        <td className={tdClass}>
                          <span className={item.status === 'Closed' ? 'text-red-600' : 'text-green-600'}>
                            {item.status || 'Open'}
                          </span>
                        </td>
                        <td className={tdClass}>
                          <button
                            type="button"
                            onClick={() => handleOpenFollowUpModal(item)}
                            className="p-1 text-blue-600 hover:bg-blue-50 rounded border border-gray-300"
                          >
                            <Edit2 className="w-3 h-3" />
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Memo Section */}
        {introSubTab === 'memo' && (
          <div className="space-y-3">
            <div>
              <button
                onClick={() => handleOpenMemoModal()}
                className="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50"
              >
                Add Memo
              </button>
            </div>

            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className={thClass}>Date</th>
                    <th className={thClass}>Added By</th>
                    <th className={thClass}>Details</th>
                    <th className={thClass}>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {introMemos.length === 0 ? (
                    <tr><td colSpan={4} className="px-3 py-8 text-center text-gray-400 text-xs">No memos found</td></tr>
                  ) : (
                    introMemos.map((memo: any, index: number) => (
                      <tr key={memo.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className={tdClass}>
                          {memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}
                        </td>
                        <td className={tdClass}>{memo.title || '-'}</td>
                        <td className={`${tdClass} text-blue-600`}>{memo.content || '-'}</td>
                        <td className={tdClass}>
                          <div className="flex gap-1 justify-center">
                            <button
                              type="button"
                              onClick={() => handleOpenMemoModal(memo)}
                              className="p-1 text-blue-600 hover:bg-blue-50 rounded border border-gray-300"
                            >
                              <Edit2 className="w-3 h-3" />
                            </button>
                            <button
                              type="button"
                              onClick={() => handleDeleteMemo(memo.id)}
                              className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"
                            >
                              <Trash2 className="w-3 h-3" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Upload File Section */}
        {introSubTab === 'upload-file' && (
          <div className="space-y-4">
            {/* Document & Notes Fields */}
            <div className="space-y-2">
              <div className="flex items-center gap-2 justify-center">
                <label className="text-xs font-semibold text-orange-500 w-20 text-right">Document</label>
                <input
                  type="text"
                  className="h-8 w-64 px-2 text-sm border border-gray-300 rounded bg-gray-50"
                  readOnly
                  value={subTabFile?.name || ''}
                  placeholder=""
                />
                <input
                  ref={subTabFileRef}
                  type="file"
                  onChange={handleSubTabFileChange}
                  className="hidden"
                  style={{ display: 'none' }}
                />
                <button
                  type="button"
                  onClick={handleSubTabChooseFile}
                  className="h-8 px-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"
                >
                  <Upload className="w-3 h-3" /> Choose File
                </button>
                <button
                  type="button"
                  onClick={handleSubTabUpload}
                  disabled={!subTabFile || subTabUploading}
                  className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {subTabUploading ? 'Uploading...' : 'Upload'}
                </button>
              </div>
              <div className="flex items-center gap-2 justify-center">
                <label className="text-xs font-semibold text-orange-500 w-20 text-right">Notes</label>
                <input
                  type="text"
                  value={subTabNotes}
                  onChange={(e) => setSubTabNotes(e.target.value)}
                  className="h-8 w-64 px-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
                <div className="w-[186px]"></div>
              </div>
            </div>

            {/* Documents Table */}
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className={thClass}>File Name</th>
                    <th className={thClass}>Uploaded On</th>
                    <th className={thClass}>Size</th>
                    <th className={thClass}>Notes</th>
                    <th className={thClass}>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {subTabDocs.length === 0 ? (
                    <tr><td colSpan={5} className="px-3 py-8 text-center text-gray-400 text-xs">No files uploaded</td></tr>
                  ) : (
                    subTabDocs.map((doc: any, index: number) => (
                      <tr key={doc.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className={`${tdClass} text-blue-600`}>{doc.file_name || '-'}</td>
                        <td className={tdClass}>{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                        <td className={tdClass}>{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                        <td className={tdClass}>{doc.description || '-'}</td>
                        <td className={tdClass}>
                          <div className="flex gap-1 justify-center">
                            <button
                              type="button"
                              onClick={() => handleSubTabDeleteDoc(doc.id)}
                              className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"
                            >
                              <Trash2 className="w-3 h-3" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Workflow & Audit Trail Section */}
        {introSubTab === 'workflow-audit-trail' && (
          <div className="text-center py-8 text-gray-500 text-sm">Workflow & Audit Trail content</div>
        )}
      </div>

      {/* Add Activity Modal */}
      {showActivityModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-white rounded shadow-xl w-[650px] max-h-[90vh] overflow-hidden">
            {/* Modal Header */}
            <div className="flex items-center justify-between px-4 py-2.5 bg-blue-600 text-white">
              <h3 className="font-semibold text-sm uppercase tracking-wide">ADD ACTIVITY</h3>
              <button onClick={() => setShowActivityModal(false)} className="hover:bg-blue-700 rounded p-1">
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Modal Body */}
            <div className="p-4 bg-gray-50">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                {/* Row 1 */}
                <div>
                  <label className="text-xs font-medium text-blue-600 mb-1 block">Created By</label>
                  <select
                    value={activityFormData.created_by}
                    onChange={(e) => setActivityFormData({ ...activityFormData, created_by: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  >
                    <option value="">Select User</option>
                    <option value="Junaid Ali">Junaid Ali</option>
                    <option value="Hamza Manzoor">Hamza Manzoor</option>
                    <option value="Admin User">Admin User</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 mb-1 block">Source</label>
                  <select
                    value={activityFormData.source}
                    onChange={(e) => setActivityFormData({ ...activityFormData, source: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  >
                    <option value="">Select Source Type</option>
                    <option value="Email">Email</option>
                    <option value="Phone">Phone</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Website">Website</option>
                  </select>
                </div>

                {/* Row 2 */}
                <div>
                  <label className="text-xs font-medium text-blue-600 mb-1 block">Action to be Taken</label>
                  <input
                    type="text"
                    value={activityFormData.action_to_be_taken}
                    onChange={(e) => setActivityFormData({ ...activityFormData, action_to_be_taken: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 mb-1 block">Type</label>
                  <select
                    value={activityFormData.type}
                    onChange={(e) => setActivityFormData({ ...activityFormData, type: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  >
                    <option value="">Select Type</option>
                    <option value="Send">Send</option>
                    <option value="Receive">Receive</option>
                    <option value="Call">Call</option>
                    <option value="Visit">Visit</option>
                  </select>
                </div>

                {/* Row 3 */}
                <div>
                  <label className="text-xs font-medium text-blue-600 mb-1 block">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input
                      type="date"
                      value={activityFormData.start_date}
                      onChange={(e) => setActivityFormData({ ...activityFormData, start_date: e.target.value })}
                      className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                    />
                    <input
                      type="time"
                      value={activityFormData.start_time}
                      onChange={(e) => setActivityFormData({ ...activityFormData, start_time: e.target.value })}
                      className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                    />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 mb-1 block">Contact</label>
                  <select
                    value={activityFormData.contact}
                    onChange={(e) => setActivityFormData({ ...activityFormData, contact: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  >
                    <option value="">Select Contact</option>
                    <option value="Contact 1">Contact 1</option>
                    <option value="Contact 2">Contact 2</option>
                    <option value="Contact 3">Contact 3</option>
                  </select>
                </div>

                {/* Description - Full Width */}
                <div className="col-span-2 mt-2">
                  <label className="text-xs font-medium text-blue-600 mb-1 block">Description</label>
                  {/* Rich Text Editor Toolbar */}
                  <div className="border border-gray-300 rounded-t flex items-center gap-1 px-2 py-1.5 bg-white">
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded font-bold text-sm">B</button>
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded italic text-sm font-serif">I</button>
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded underline text-sm">U</button>
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">
                      <span className="text-yellow-500"></span>
                    </button>
                    <div className="h-5 w-px bg-gray-300 mx-1"></div>
                    <select className="h-7 px-2 text-xs border border-gray-300 rounded bg-white">
                      <option>jost</option>
                      <option>Arial</option>
                      <option>Times New Roman</option>
                    </select>
                    <select className="h-7 w-14 px-1 text-xs border border-gray-300 rounded bg-white">
                      <option>14</option>
                      <option>12</option>
                      <option>16</option>
                      <option>18</option>
                    </select>
                    <div className="h-5 w-px bg-gray-300 mx-1"></div>
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">
                      <span className="bg-yellow-300 px-1 font-bold">A</span>
                    </button>
                    <div className="h-5 w-px bg-gray-300 mx-1"></div>
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm"></button>
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm"></button>
                    <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm"></button>
                  </div>
                  <textarea
                    value={activityFormData.description}
                    onChange={(e) => setActivityFormData({ ...activityFormData, description: e.target.value })}
                    className="w-full h-48 px-3 py-2 text-sm border border-gray-300 border-t-0 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none bg-white"
                    placeholder=""
                  />
                </div>
              </div>

              {/* Save Button */}
              <div className="flex justify-center mt-5">
                <button
                  onClick={handleSaveActivity}
                  className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600"
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Follow-Up Modal */}
      {showFollowUpModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-white rounded shadow-xl w-[680px] max-h-[90vh] overflow-auto">
            {/* Modal Header */}
            <div className="flex items-center justify-between px-4 py-2.5 bg-blue-600 text-white">
              <div className="flex items-center gap-3">
                <h3 className="font-semibold text-sm uppercase tracking-wide">NEW ACTIVITY</h3>
                <button
                  type="button"
                  onClick={() => setIntroSubTab('activity')}
                  className="px-3 py-1 text-xs font-medium border border-white rounded hover:bg-blue-700"
                >
                  View Previous Activities
                </button>
              </div>
              <button onClick={() => setShowFollowUpModal(false)} className="hover:bg-blue-700 rounded p-1">
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Modal Body */}
            <div className="p-5 bg-gray-50">
              <div className="grid grid-cols-2 gap-x-8 gap-y-4">
                {/* Row 1: Contact / Activity Subject */}
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Contact</label>
                  <select
                    value={followUpFormData.contact_id}
                    onChange={(e) => setFollowUpFormData({ ...followUpFormData, contact_id: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  >
                    <option value="">Select Contact</option>
                    <option value="1">Contact 1</option>
                    <option value="2">Contact 2</option>
                    <option value="3">Contact 3</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Activity Subject</label>
                  <input
                    type="text"
                    value={followUpFormData.subject}
                    onChange={(e) => setFollowUpFormData({ ...followUpFormData, subject: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  />
                </div>

                {/* Row 2: Email / Activity Type */}
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Email</label>
                  <input
                    type="text"
                    value={followUpFormData.priority}
                    onChange={(e) => setFollowUpFormData({ ...followUpFormData, priority: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-100"
                  />
                </div>
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Activity Type</label>
                  <input
                    type="text"
                    value={followUpFormData.activity_type}
                    onChange={(e) => setFollowUpFormData({ ...followUpFormData, activity_type: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  />
                </div>

                {/* Row 3: Start Date / Time / Assigned To */}
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input
                      type="date"
                      value={followUpFormData.start_date}
                      onChange={(e) => setFollowUpFormData({ ...followUpFormData, start_date: e.target.value })}
                      className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                    />
                    <input
                      type="time"
                      value={followUpFormData.start_time}
                      onChange={(e) => setFollowUpFormData({ ...followUpFormData, start_time: e.target.value })}
                      className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                    />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Assigned To</label>
                  <select
                    value={followUpFormData.assigned_to}
                    onChange={(e) => setFollowUpFormData({ ...followUpFormData, assigned_to: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  >
                    <option value="">Select User</option>
                    <option value="1">Junaid Ali</option>
                    <option value="2">Hamza Manzoor</option>
                    <option value="3">Admin User</option>
                  </select>
                </div>

                {/* Row 4: Next Follow Up Date / Status */}
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Next Follow Up Date</label>
                  <input
                    type="date"
                    value={followUpFormData.end_date}
                    onChange={(e) => setFollowUpFormData({ ...followUpFormData, end_date: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  />
                </div>
                <div>
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Status</label>
                  <select
                    value={followUpFormData.status}
                    onChange={(e) => setFollowUpFormData({ ...followUpFormData, status: e.target.value })}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
                  >
                    <option value="Open">Open</option>
                    <option value="Closed">Closed</option>
                  </select>
                </div>

                {/* Description - Full Width */}
                <div className="col-span-2 mt-1">
                  <label className="text-xs font-semibold text-blue-600 mb-1 block">Description</label>
                  <div className="border border-gray-300 rounded overflow-hidden">
                    {/* Rich Text Editor Toolbar */}
                    <div className="flex items-center gap-1 px-2 py-1.5 bg-white border-b border-gray-300">
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded font-bold text-sm">B</button>
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded italic text-sm font-serif">I</button>
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded underline text-sm">U</button>
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">
                        <span className="text-yellow-500">&#9998;</span>
                      </button>
                      <div className="h-5 w-px bg-gray-300 mx-1"></div>
                      <select className="h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                        <option>jost</option>
                        <option>Arial</option>
                        <option>Times New Roman</option>
                      </select>
                      <select className="h-7 w-14 px-1 text-xs border border-gray-300 rounded bg-white">
                        <option>14</option>
                        <option>12</option>
                        <option>16</option>
                        <option>18</option>
                      </select>
                      <div className="h-5 w-px bg-gray-300 mx-1"></div>
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm font-bold">
                        <span className="bg-yellow-300 px-1 rounded">A</span>
                      </button>
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">&#9776;</button>
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">&#9776;</button>
                      <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">&#9776;</button>
                    </div>
                    {/* Text Area */}
                    <textarea
                      value={followUpFormData.description}
                      onChange={(e) => setFollowUpFormData({ ...followUpFormData, description: e.target.value })}
                      className="w-full px-3 py-2 text-sm focus:outline-none bg-white resize-y"
                      rows={8}
                      placeholder=""
                    />
                  </div>
                </div>
              </div>

              {/* Save Button */}
              <div className="flex justify-center mt-5">
                <button
                  onClick={handleSaveFollowUp}
                  className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600"
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showIntroMemoModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-white rounded shadow-xl w-[500px] max-h-[90vh] overflow-auto">
            <div className="flex items-center justify-between px-4 py-2.5 bg-blue-600 text-white">
              <h3 className="font-semibold text-sm uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => setShowIntroMemoModal(false)} className="text-yellow-300 hover:text-yellow-100 rounded p-1">
                <X className="w-5 h-5" />
              </button>
            </div>
            <div className="p-5 bg-gray-50">
              <div className="border border-gray-300 rounded overflow-hidden">
                <div className="flex items-center gap-1 px-2 py-1.5 bg-white border-b border-gray-300">
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded font-bold text-sm">B</button>
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded italic text-sm font-serif">I</button>
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded underline text-sm">U</button>
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">
                    <span className="text-yellow-500">&#9998;</span>
                  </button>
                  <div className="h-5 w-px bg-gray-300 mx-1"></div>
                  <select className="h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option>jost</option>
                    <option>Arial</option>
                    <option>Times New Roman</option>
                  </select>
                  <select className="h-7 w-14 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option>14</option>
                    <option>12</option>
                    <option>16</option>
                    <option>18</option>
                  </select>
                  <div className="h-5 w-px bg-gray-300 mx-1"></div>
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm font-bold">
                    <span className="bg-yellow-300 px-1 rounded">A</span>
                  </button>
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">&#9776;</button>
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">&#9776;</button>
                  <button type="button" className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded text-sm">&#9776;</button>
                </div>
                <textarea
                  value={memoFormData.content}
                  onChange={(e) => setMemoFormData({ ...memoFormData, content: e.target.value })}
                  className="w-full px-3 py-2 text-sm focus:outline-none bg-white resize-y"
                  rows={10}
                />
              </div>
              <div className="flex justify-center mt-5">
                <button
                  onClick={handleSaveMemo}
                  className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600"
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Requirement Form ==============
function RequirementForm({ data, setData, onSave, saving, inputClass, labelClass, crId, leadId, onOpenEmailModal }: any) {
  const [reqSubTab, setReqSubTab] = useState('pre-demo-business-questionnaire');
  const [emailsSent, setEmailsSent] = useState<any[]>([]);
  const [reqDocs, setReqDocs] = useState<any[]>([]);
  const [reqEmailTemplates, setReqEmailTemplates] = useState<any[]>([]);
  const [reqSelectedFile, setReqSelectedFile] = useState<File | null>(null);
  const [reqUploading, setReqUploading] = useState(false);
  const reqFileInputRef = React.useRef<HTMLInputElement>(null);

  // Sub-tab states
  const [reqSubTabDocs, setReqSubTabDocs] = useState<any[]>([]);
  const [reqSubTabFile, setReqSubTabFile] = useState<File | null>(null);
  const [reqSubTabNotes, setReqSubTabNotes] = useState('');
  const [reqSubTabUploading, setReqSubTabUploading] = useState(false);
  const reqSubTabFileRef = React.useRef<HTMLInputElement>(null);
  const [reqFollowUps, setReqFollowUps] = useState<any[]>([]);
  const [showReqFollowUpModal, setShowReqFollowUpModal] = useState(false);
  const [editingReqFollowUp, setEditingReqFollowUp] = useState<any>(null);
  const [reqFollowUpForm, setReqFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', end_date: '', end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: '', next_followup_time: '', channel_type: '', sent_to: '',
  });
  const [reqMemos, setReqMemos] = useState<any[]>([]);
  const [showReqMemoModal, setShowReqMemoModal] = useState(false);
  const [editingReqMemo, setEditingReqMemo] = useState<any>(null);
  const [reqMemoForm, setReqMemoForm] = useState({ content: '' });
  const reqMemoEditorRef = React.useRef<HTMLDivElement>(null);
  const reqFollowUpEditorRef = React.useRef<HTMLDivElement>(null);
  const [reqActivities, setReqActivities] = useState<any[]>([]);
  const [reqContacts, setReqContacts] = useState<any[]>([]);
  const [showReqPreviousActivities, setShowReqPreviousActivities] = useState(false);

  // Questionnaire state
  const [questionnaire, setQuestionnaire] = useState<any>(data?.questionnaire || {});

  useEffect(() => {
    if (data?.questionnaire) setQuestionnaire(data.questionnaire);
  }, [data?.questionnaire]);

  const updateQ = (field: string, value: any) => {
    const updated = { ...questionnaire, [field]: value };
    setQuestionnaire(updated);
    setData({ ...data, questionnaire: updated });
  };

  const toggleCheckbox = (field: string, value: string) => {
    const arr = questionnaire[field] || [];
    const updated = arr.includes(value) ? arr.filter((v: string) => v !== value) : [...arr, value];
    updateQ(field, updated);
  };

  // Load contacts
  useEffect(() => {
    if (leadId) {
      api.getLeadContactsForEdit(leadId).then(setReqContacts).catch(() => setReqContacts([]));
    }
  }, [leadId]);

  // Load documents
  useEffect(() => {
    if (crId) {
      api.getCRDocuments(crId, 'requirement').then(setReqDocs).catch(() => setReqDocs([]));
    }
  }, [crId]);

  // Load email templates for Requirement tab
  useEffect(() => {
    api.getCRIEmailTemplates('Requirement').then(setReqEmailTemplates).catch(() => setReqEmailTemplates([]));
  }, []);

  // Load sub-tab data
  useEffect(() => {
    if (crId && reqSubTab === 'follow-up') {
      api.getCRActivities(crId, 'requirement-followup').then(setReqFollowUps).catch(() => setReqFollowUps([]));
    }
  }, [crId, reqSubTab]);

  useEffect(() => {
    if (crId && reqSubTab === 'memo') {
      api.getCRMemos(crId, 'requirement').then(setReqMemos).catch(() => setReqMemos([]));
    }
  }, [crId, reqSubTab]);

  useEffect(() => {
    if (crId && reqSubTab === 'upload-file') {
      api.getCRDocuments(crId, 'requirement-upload').then(setReqSubTabDocs).catch(() => setReqSubTabDocs([]));
    }
  }, [crId, reqSubTab]);

  // Document handlers
  const handleReqChooseFile = () => reqFileInputRef.current?.click();
  const handleReqFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setReqSelectedFile(e.target.files[0]); };
  const handleReqUploadFile = async () => {
    if (!reqSelectedFile || !crId) { alert(!reqSelectedFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setReqUploading(true);
    try {
      await api.uploadCRDocument(crId, reqSelectedFile, 'requirement', 'Details');
      const docs = await api.getCRDocuments(crId, 'requirement');
      setReqDocs(docs);
      setReqSelectedFile(null);
      if (reqFileInputRef.current) reqFileInputRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setReqUploading(false); }
  };
  const handleReqDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setReqDocs(reqDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  // Sub-tab upload handlers
  const handleReqSubTabChooseFile = () => reqSubTabFileRef.current?.click();
  const handleReqSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setReqSubTabFile(e.target.files[0]); };
  const handleReqSubTabUpload = async () => {
    if (!reqSubTabFile || !crId) { alert(!reqSubTabFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setReqSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, reqSubTabFile, 'requirement-upload', 'Upload File');
      const docs = await api.getCRDocuments(crId, 'requirement-upload');
      setReqSubTabDocs(docs);
      setReqSubTabFile(null); setReqSubTabNotes('');
      if (reqSubTabFileRef.current) reqSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setReqSubTabUploading(false); }
  };
  const handleReqSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setReqSubTabDocs(reqSubTabDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  // Follow-up handlers
  const handleOpenReqFollowUp = (item?: any) => {
    if (item) { setEditingReqFollowUp(item); setReqFollowUpForm({ activity_type: item.activity_type || '', subject: item.subject || '', start_date: item.start_date || '', start_time: item.start_time || '', end_date: item.end_date || '', end_time: item.end_time || '', description: item.description || '', status: item.status || 'Open', contact_id: item.contact_id?.toString() || '', assigned_to: item.assigned_to?.toString() || '', priority: item.priority || '', next_followup_date: item.next_followup_date || '', next_followup_time: item.next_followup_time || '', channel_type: item.channel_type || '', sent_to: item.sent_to || '' }); }
    else { setEditingReqFollowUp(null); const now = new Date(); setReqFollowUpForm({ activity_type: '', subject: '', start_date: now.toISOString().split('T')[0], start_time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), end_date: now.toISOString().split('T')[0], end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: now.toISOString().split('T')[0], next_followup_time: '', channel_type: '', sent_to: '' }); }
    setShowReqFollowUpModal(true);
    setTimeout(() => {
      if (reqFollowUpEditorRef.current) {
        reqFollowUpEditorRef.current.innerHTML = item?.description || '';
      }
    }, 50);
  };
  const handleReqFollowUpExec = (command: string, value?: string) => {
    document.execCommand(command, false, value || '');
    reqFollowUpEditorRef.current?.focus();
  };
  const handleSaveReqFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = reqFollowUpEditorRef.current?.innerHTML || reqFollowUpForm.description;
    const formToSave = { ...reqFollowUpForm, description: descriptionContent };
    try {
      if (editingReqFollowUp) { const updated = await api.updateCRActivity(crId, editingReqFollowUp.id, formToSave); setReqFollowUps(reqFollowUps.map((a: any) => a.id === editingReqFollowUp.id ? updated : a)); }
      else { const created = await api.createCRActivity(crId, { ...formToSave, tab_name: 'requirement-followup' }); setReqFollowUps([...reqFollowUps, created]); }
      setShowReqFollowUpModal(false); setEditingReqFollowUp(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteReqFollowUp = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRActivity(crId, id); setReqFollowUps(reqFollowUps.filter((a: any) => a.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleOpenReqMemo = (item?: any) => {
    if (item) { setEditingReqMemo(item); setReqMemoForm({ content: item.content || '' }); }
    else { setEditingReqMemo(null); setReqMemoForm({ content: '' }); }
    setShowReqMemoModal(true);
    setTimeout(() => {
      if (reqMemoEditorRef.current) {
        reqMemoEditorRef.current.innerHTML = item?.content || '';
      }
    }, 50);
  };
  const handleReqMemoExec = (command: string, value?: string) => {
    document.execCommand(command, false, value || '');
    reqMemoEditorRef.current?.focus();
  };
  const handleSaveReqMemo = async () => {
    if (!crId) return;
    const content = reqMemoEditorRef.current?.innerHTML || reqMemoForm.content;
    const payload = { content };
    try {
      if (editingReqMemo) { const updated = await api.updateCRMemo(crId, editingReqMemo.id, payload); setReqMemos(reqMemos.map((m: any) => m.id === editingReqMemo.id ? updated : m)); }
      else { const created = await api.createCRMemo(crId, { ...payload, tab_name: 'requirement' }); setReqMemos([...reqMemos, created]); }
      setShowReqMemoModal(false); setEditingReqMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteReqMemo = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRMemo(crId, id); setReqMemos(reqMemos.filter((m: any) => m.id !== id)); } catch { alert('Failed to delete'); }
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-32 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-blue-50";
  const fieldSelectClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-blue-50";
  const rowClass = "flex items-center gap-2 mb-2";
  const thClass = "px-3 py-2 text-left text-xs font-medium text-white bg-blue-600 border-r border-blue-500 last:border-r-0";
  const tdClass = "px-3 py-2 text-xs border-b border-gray-200";
  const sectionTitle = "text-sm font-bold text-gray-800 mb-3 uppercase";
  const checkLabel = "text-xs text-blue-600 ml-2 cursor-pointer";
  const subSectionTitle = "text-xs font-semibold text-blue-600 mb-2";

  const reqSubTabs = ['Pre-Demo Business Questionnaire', 'Meeting Date & Time', 'Process Flow', 'Analysis', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  return (
    <div className="space-y-4">
      {/* Top Form Section */}
      <div className="grid grid-cols-2 gap-6">
        {/* Left Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Company Name</label>
            <input type="text" value={data?.company_name || ''} onChange={(e) => setData({ ...data, company_name: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Name</label>
            <select value={data?.contact_id || ''} onChange={(e) => setData({ ...data, contact_id: e.target.value })} className={fieldSelectClass}>
              <option value="">Select Contact Name</option>
              <option value="1">Contact 1</option>
              <option value="2">Contact 2</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={data?.email_format || ''} onChange={(e) => setData({ ...data, email_format: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {reqEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Requirement', '', reqEmailTemplates.find((t: any) => t.email_format === data?.email_format)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>

          {/* Email Sent To Table */}
          <div className="mt-3 border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className={thClass}>Email Sent To</th>
                  <th className={thClass}>Attachments</th>
                  <th className={thClass}>Sent On</th>
                  <th className={thClass}>Action</th>
                </tr>
              </thead>
              <tbody>
                {emailsSent.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-gray-400 text-xs">No emails sent</td></tr>
                ) : (
                  emailsSent.map((email: any, index: number) => (
                    <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className={tdClass}>{email.to}</td>
                      <td className={tdClass}>{email.attachments || '-'}</td>
                      <td className={tdClass}>{email.sent_on}</td>
                      <td className={tdClass}><button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Edit2 className="w-3 h-3" /></button></td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Branch Office</label>
            <input type="text" value={data?.branch_office || ''} onChange={(e) => setData({ ...data, branch_office: e.target.value })} className={fieldInputClass} placeholder="Branch Office" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Email</label>
            <input type="email" value={data?.contact_email || ''} onChange={(e) => setData({ ...data, contact_email: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Document</label>
            <input type="text" className={fieldInputClass} readOnly value={reqSelectedFile?.name || ''} placeholder="" />
            <input ref={reqFileInputRef} type="file" onChange={handleReqFileChange} className="hidden" style={{ display: 'none' }} />
            <button type="button" onClick={handleReqChooseFile} className="h-8 px-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button type="button" onClick={handleReqUploadFile} disabled={!reqSelectedFile || reqUploading} className="h-8 px-3 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed">
              {reqUploading ? 'Uploading...' : 'Upload'}
            </button>
          </div>

          {/* Documents Table */}
          <div className="mt-3 border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className={thClass}>File Name</th>
                  <th className={thClass}>Link</th>
                  <th className={thClass}>Size</th>
                  <th className={thClass}>Upload On</th>
                  <th className={thClass}>Action</th>
                </tr>
              </thead>
              <tbody>
                {reqDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs">No documents uploaded</td></tr>
                ) : (
                  reqDocs.map((doc: any, index: number) => (
                    <tr key={doc.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className={`${tdClass} text-blue-600`}>{doc.file_name}</td>
                      <td className={`${tdClass} text-blue-600`}>
                        {doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline truncate block max-w-[120px]">service.delta.axieve...</a> : '-'}
                      </td>
                      <td className={tdClass}>{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className={tdClass}>{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : '-'}</td>
                      <td className={tdClass}>
                        <div className="flex gap-1 justify-center items-center">
                          <input type="checkbox" className="w-3 h-3" />
                          <button type="button" onClick={() => handleReqDeleteDoc(doc.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Section */}
      <div className="border-t pt-4">
        <div className="flex gap-4 mb-4">
          {reqSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-');
            const isActive = reqSubTab === tabKey;
            return (
              <button
                key={tab}
                onClick={() => setReqSubTab(tabKey)}
                className={`px-2 py-1 text-xs font-medium border-b-2 ${
                  isActive
                    ? 'border-blue-600 text-blue-600 bg-blue-50 rounded-t'
                    : 'border-transparent text-orange-500 hover:text-orange-600'
                }`}
              >
                {tab}
              </button>
            );
          })}
        </div>

        {/* Pre-Demo Business Questionnaire */}
        {reqSubTab === 'pre-demo-business-questionnaire' && (
          <div className="space-y-6">
            <h3 className={sectionTitle}>PRE-DEMO BUSINESS QUESTIONNAIRE</h3>

            {/* 1. GENERAL INFORMATION */}
            <div>
              <h4 className={sectionTitle}>1. GENERAL INFORMATION</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Company Name:</label>
                  <input type="text" value={questionnaire.gen_company_name || ''} onChange={(e) => updateQ('gen_company_name', e.target.value)} className={fieldInputClass} placeholder="Name" />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-48 flex-shrink-0 mb-0`}>Key Person (Name):</label>
                  <input type="text" value={questionnaire.gen_key_person || ''} onChange={(e) => updateQ('gen_key_person', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Designation:</label>
                  <input type="text" value={questionnaire.gen_designation || ''} onChange={(e) => updateQ('gen_designation', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-48 flex-shrink-0 mb-0`}>Email:</label>
                  <input type="email" value={questionnaire.gen_email || ''} onChange={(e) => updateQ('gen_email', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Phone:</label>
                  <input type="text" value={questionnaire.gen_phone || ''} onChange={(e) => updateQ('gen_phone', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-48 flex-shrink-0 mb-0`}>Website:</label>
                  <input type="text" value={questionnaire.gen_website || ''} onChange={(e) => updateQ('gen_website', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Address:</label>
                  <input type="text" value={questionnaire.gen_address || ''} onChange={(e) => updateQ('gen_address', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-48 flex-shrink-0 mb-0`}>Postal Code:</label>
                  <input type="text" value={questionnaire.gen_postal_code || ''} onChange={(e) => updateQ('gen_postal_code', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Country:</label>
                  <input type="text" value={questionnaire.gen_country || ''} onChange={(e) => updateQ('gen_country', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-48 flex-shrink-0 mb-0`}>Years in Operation:</label>
                  <input type="text" value={questionnaire.gen_years_operation || ''} onChange={(e) => updateQ('gen_years_operation', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>State/Province:</label>
                  <input type="text" value={questionnaire.gen_state || ''} onChange={(e) => updateQ('gen_state', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-48 flex-shrink-0 mb-0`}>Branch Offices / Address(es):</label>
                  <input type="text" value={questionnaire.gen_branch_offices || ''} onChange={(e) => updateQ('gen_branch_offices', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>City:</label>
                  <input type="text" value={questionnaire.gen_city || ''} onChange={(e) => updateQ('gen_city', e.target.value)} className={fieldInputClass} />
                </div>
              </div>
            </div>

            {/* 2. ABOUT YOUR BUSINESS */}
            <div>
              <h4 className={sectionTitle}>2. ABOUT YOUR BUSINESS</h4>
              <div className="grid grid-cols-2 gap-x-8">
                {/* Left: Years in Operation, Company Size, Annual Revenue */}
                <div className="space-y-4">
                  <div>
                    <p className={subSectionTitle}>Years in Operation:</p>
                    {['1-5', '6-10', '11-20', '20+'].map((opt) => (
                      <label key={opt} className="flex items-center mb-1 cursor-pointer">
                        <input type="checkbox" checked={(questionnaire.biz_years_operation || []).includes(opt)} onChange={() => toggleCheckbox('biz_years_operation', opt)} className="w-3.5 h-3.5" />
                        <span className={checkLabel}>{opt}</span>
                      </label>
                    ))}
                  </div>
                  <div>
                    <p className={subSectionTitle}>Company Size:</p>
                    {['1-10', '11-50', '51-100', '100+'].map((opt) => (
                      <label key={opt} className="flex items-center mb-1 cursor-pointer">
                        <input type="checkbox" checked={(questionnaire.biz_company_size || []).includes(opt)} onChange={() => toggleCheckbox('biz_company_size', opt)} className="w-3.5 h-3.5" />
                        <span className={checkLabel}>{opt}</span>
                      </label>
                    ))}
                  </div>
                  <div>
                    <p className={subSectionTitle}>Annual Revenue (Approx.):</p>
                    {['Upto US$ 100,000', 'US$ 100,000  250,000', 'US$ 250,000  1,000,000', 'US$ 1,000,000  5,000,000', 'US$ 5,000,000  10,000,000', 'Above US$ 10,000,000'].map((opt) => (
                      <label key={opt} className="flex items-center mb-1 cursor-pointer">
                        <input type="checkbox" checked={(questionnaire.biz_annual_revenue || []).includes(opt)} onChange={() => toggleCheckbox('biz_annual_revenue', opt)} className="w-3.5 h-3.5" />
                        <span className={checkLabel}>{opt}</span>
                      </label>
                    ))}
                  </div>
                </div>
                {/* Right: Industry Type, Markets Served, Company Legal Structure */}
                <div className="space-y-4">
                  <div>
                    <p className={subSectionTitle}>Industry Type:</p>
                    {['Trading (Buy & Sell Products)', 'Manufacturing (Produce Goods)', 'Services (Provide Services to Clients)', 'Distribution / Wholesale', 'Retail / POS', 'Projects / EPC', 'Consulting / Advisory'].map((opt) => (
                      <label key={opt} className="flex items-center mb-1 cursor-pointer">
                        <input type="checkbox" checked={(questionnaire.biz_industry_type || []).includes(opt)} onChange={() => toggleCheckbox('biz_industry_type', opt)} className="w-3.5 h-3.5" />
                        <span className={checkLabel}>{opt}</span>
                      </label>
                    ))}
                    <label className="flex items-center mb-1 cursor-pointer">
                      <input type="checkbox" checked={(questionnaire.biz_industry_type || []).includes('Other')} onChange={() => toggleCheckbox('biz_industry_type', 'Other')} className="w-3.5 h-3.5" />
                      <span className={checkLabel}>Other:</span>
                      <input type="text" value={questionnaire.biz_industry_other || ''} onChange={(e) => updateQ('biz_industry_other', e.target.value)} className="ml-2 h-7 w-40 px-2 text-xs border border-gray-300 rounded" placeholder="Please specify" />
                    </label>
                  </div>
                  <div>
                    <p className={subSectionTitle}>Markets Served (Select all that apply):</p>
                    {['Local', 'National', 'International'].map((opt) => (
                      <label key={opt} className="flex items-center mb-1 cursor-pointer">
                        <input type="checkbox" checked={(questionnaire.biz_markets_served || []).includes(opt)} onChange={() => toggleCheckbox('biz_markets_served', opt)} className="w-3.5 h-3.5" />
                        <span className={checkLabel}>{opt}</span>
                      </label>
                    ))}
                  </div>
                  <div>
                    <p className={subSectionTitle}>Company Legal Structure:</p>
                    {['Sole Proprietorship', 'Partnership', 'LLC (Limited Liability Company)'].map((opt) => (
                      <label key={opt} className="flex items-center mb-1 cursor-pointer">
                        <input type="checkbox" checked={(questionnaire.biz_legal_structure || []).includes(opt)} onChange={() => toggleCheckbox('biz_legal_structure', opt)} className="w-3.5 h-3.5" />
                        <span className={checkLabel}>{opt}</span>
                      </label>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* 3 & 4 side by side */}
            <div className="grid grid-cols-2 gap-x-8">
              {/* 3. CURRENT SYSTEMS USED */}
              <div>
                <h4 className={sectionTitle}>3. CURRENT SYSTEMS USED</h4>
                {['Paper / Excel Sheets', 'Accounting Software (Tally, QuickBooks, Zoho, etc.)', 'CRM Software', 'HRM Software', 'Inventory / Stock System', 'ERP System'].map((opt) => (
                  <label key={opt} className="flex items-center mb-1 cursor-pointer">
                    <input type="checkbox" checked={(questionnaire.current_systems || []).includes(opt)} onChange={() => toggleCheckbox('current_systems', opt)} className="w-3.5 h-3.5" />
                    <span className={checkLabel}>{opt}</span>
                  </label>
                ))}
                <label className="flex items-center mb-1 cursor-pointer">
                  <input type="checkbox" checked={(questionnaire.current_systems || []).includes('Other')} onChange={() => toggleCheckbox('current_systems', 'Other')} className="w-3.5 h-3.5" />
                  <span className={checkLabel}>Other:</span>
                  <input type="text" value={questionnaire.current_systems_other || ''} onChange={(e) => updateQ('current_systems_other', e.target.value)} className="ml-2 h-7 w-40 px-2 text-xs border border-gray-300 rounded" placeholder="Please specify" />
                </label>
              </div>

              {/* 4. KEY BUSINESS PRIORITIES */}
              <div>
                <h4 className={sectionTitle}>4. KEY BUSINESS PRIORITIES</h4>
                {['Getting More Customers (Sales & CRM)', 'Managing Suppliers & Vendors Better', 'Faster Proposal / Quotation Process', 'Tracking Inventory & Stock Easily', 'Better Financial Control (Invoices, Payments, Reports)', 'Tracking Projects, Tasks, Timesheets', 'Managing Employees (HR & Payroll)', 'Easy Access to Documents (DMS)', 'Quick & Accurate Business Reports (Better Visibility of Data)', 'Smooth Integration Across Departments (Improved Workflow & Communication)', 'Multi-Currency Support', 'Reduce Manual Errors', 'Reduce Operational Costs'].map((opt) => (
                  <label key={opt} className="flex items-center mb-1 cursor-pointer">
                    <input type="checkbox" checked={(questionnaire.key_priorities || []).includes(opt)} onChange={() => toggleCheckbox('key_priorities', opt)} className="w-3.5 h-3.5" />
                    <span className={checkLabel}>{opt}</span>
                  </label>
                ))}
                <label className="flex items-center mb-1 cursor-pointer">
                  <input type="checkbox" checked={(questionnaire.key_priorities || []).includes('Other')} onChange={() => toggleCheckbox('key_priorities', 'Other')} className="w-3.5 h-3.5" />
                  <span className={checkLabel}>Other:</span>
                  <input type="text" value={questionnaire.key_priorities_other || ''} onChange={(e) => updateQ('key_priorities_other', e.target.value)} className="ml-2 h-7 w-40 px-2 text-xs border border-gray-300 rounded" placeholder="Please specify" />
                </label>
              </div>
            </div>

            {/* 5. MAIN BUSINESS CHALLENGES */}
            <div>
              <h4 className={sectionTitle}>5. MAIN BUSINESS CHALLENGES</h4>
              <div className="grid grid-cols-2 gap-x-8">
                <div>
                  {['Too much manual work in Excel / Paper', 'Hard to track orders, stock, or shipments', 'Delays in sending Quotations / Invoices', 'No clear view of payments & collections', 'Inventory or supply chain management issues', 'Difficulty in managing suppliers/vendors', 'Employee leave, payroll, or performance issues', 'Lack of reports for decision making', 'Difficult to manage multiple currencies', 'Difficult to manage multiple branches/locations'].map((opt) => (
                    <label key={opt} className="flex items-center mb-1 cursor-pointer">
                      <input type="checkbox" checked={(questionnaire.main_challenges || []).includes(opt)} onChange={() => toggleCheckbox('main_challenges', opt)} className="w-3.5 h-3.5" />
                      <span className={checkLabel}>{opt}</span>
                    </label>
                  ))}
                  <label className="flex items-center mb-1 cursor-pointer">
                    <input type="checkbox" checked={(questionnaire.main_challenges || []).includes('Other')} onChange={() => toggleCheckbox('main_challenges', 'Other')} className="w-3.5 h-3.5" />
                    <span className={checkLabel}>Other:</span>
                    <input type="text" value={questionnaire.main_challenges_other || ''} onChange={(e) => updateQ('main_challenges_other', e.target.value)} className="ml-2 h-7 w-40 px-2 text-xs border border-gray-300 rounded" placeholder="Please specify" />
                  </label>
                </div>
              </div>
            </div>

            {/* 6. OTHER REQUIREMENTS / NOTES */}
            <div>
              <h4 className={sectionTitle}>6. OTHER REQUIREMENTS / NOTES</h4>
              <p className="text-xs text-blue-500 mb-2 italic">Please mention any special features, compliance needs, or integrations you require</p>
              <textarea
                value={questionnaire.other_requirements || ''}
                onChange={(e) => updateQ('other_requirements', e.target.value)}
                className="w-full h-28 px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50"
                placeholder=""
              />
            </div>

            <div className="flex justify-center mt-4">
              <button onClick={onSave} disabled={saving} className="px-6 py-1.5 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 disabled:opacity-50">
                {saving ? 'Saving...' : 'Save'}
              </button>
            </div>
          </div>
        )}

        {/* Meeting Date & Time */}
        {reqSubTab === 'meeting-date-time' && (
          <div className="space-y-6">
            <h3 className={sectionTitle}>MEETING DATE & TIME</h3>

            {/* GENERAL INFORMATION */}
            <div>
              <h4 className={sectionTitle}>GENERAL INFORMATION</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Key Person&apos;s Name:</label>
                  <input type="text" value={questionnaire.meet_key_person || ''} onChange={(e) => updateQ('meet_key_person', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Company Phone:</label>
                  <input type="text" value={questionnaire.meet_company_phone || ''} onChange={(e) => updateQ('meet_company_phone', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Company Name:</label>
                  <input type="text" value={questionnaire.meet_company_name || ''} onChange={(e) => updateQ('meet_company_name', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>EXT:</label>
                  <input type="text" value={questionnaire.meet_ext || ''} onChange={(e) => updateQ('meet_ext', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Address:</label>
                  <input type="text" value={questionnaire.meet_address || ''} onChange={(e) => updateQ('meet_address', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Fax:</label>
                  <input type="text" value={questionnaire.meet_fax || ''} onChange={(e) => updateQ('meet_fax', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Country</label>
                  <select value={questionnaire.meet_country || ''} onChange={(e) => updateQ('meet_country', e.target.value)} className={fieldSelectClass}>
                    <option value="">Country</option>
                    <option value="UAE">UAE</option>
                    <option value="Saudi Arabia">Saudi Arabia</option>
                    <option value="Qatar">Qatar</option>
                    <option value="Bahrain">Bahrain</option>
                    <option value="Kuwait">Kuwait</option>
                    <option value="Oman">Oman</option>
                    <option value="India">India</option>
                    <option value="Pakistan">Pakistan</option>
                    <option value="USA">USA</option>
                    <option value="UK">UK</option>
                  </select>
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Email:</label>
                  <input type="email" value={questionnaire.meet_email || ''} onChange={(e) => updateQ('meet_email', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Province</label>
                  <select value={questionnaire.meet_province || ''} onChange={(e) => updateQ('meet_province', e.target.value)} className={fieldSelectClass}>
                    <option value="">Select State</option>
                  </select>
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Website:</label>
                  <input type="text" value={questionnaire.meet_website || ''} onChange={(e) => updateQ('meet_website', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>City</label>
                  <select value={questionnaire.meet_city || ''} onChange={(e) => updateQ('meet_city', e.target.value)} className={fieldSelectClass}>
                    <option value="">Select City</option>
                  </select>
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Any Branch Office:</label>
                  <input type="text" value={questionnaire.meet_branch_office || ''} onChange={(e) => updateQ('meet_branch_office', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Postal Code:</label>
                  <input type="text" value={questionnaire.meet_postal_code || ''} onChange={(e) => updateQ('meet_postal_code', e.target.value)} className={fieldInputClass} />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Branch Address:</label>
                  <input type="text" value={questionnaire.meet_branch_address || ''} onChange={(e) => updateQ('meet_branch_address', e.target.value)} className={fieldInputClass} />
                </div>
              </div>
            </div>

            {/* ARRANGE MEETING SESSION */}
            <div>
              <h4 className={sectionTitle}>ARRANGE MEETING SESSION</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Preferred Date:</label>
                  <input type="date" value={questionnaire.meet_preferred_date || ''} onChange={(e) => updateQ('meet_preferred_date', e.target.value)} className={fieldInputClass} />
                </div>
                <div className="flex items-center gap-4 mb-2">
                  <div className="flex items-center gap-2 flex-1">
                    <label className={`${subSectionTitle} w-20 flex-shrink-0 mb-0`}>Remark:</label>
                    <input type="text" value={questionnaire.meet_remark || ''} onChange={(e) => updateQ('meet_remark', e.target.value)} className={fieldInputClass} />
                  </div>
                  <div className="flex items-center gap-2 flex-1">
                    <label className={`${subSectionTitle} w-20 flex-shrink-0 mb-0`}>Discuss</label>
                  </div>
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-36 flex-shrink-0 mb-0`}>Preferred Time:</label>
                  <input type="time" value={questionnaire.meet_preferred_time || ''} onChange={(e) => updateQ('meet_preferred_time', e.target.value)} className={fieldInputClass} step="1" />
                </div>
                <div className={rowClass}>
                  <label className={`${subSectionTitle} w-20 flex-shrink-0 mb-0`}>TimeZone:</label>
                  <select value={questionnaire.meet_timezone || ''} onChange={(e) => updateQ('meet_timezone', e.target.value)} className={fieldSelectClass}>
                    <option value="">Select Timezone</option>
                    <option value="Asia/Aden (+03:00)">Asia/Aden (+03:00)</option>
                    <option value="Asia/Dubai (+04:00)">Asia/Dubai (+04:00)</option>
                    <option value="Asia/Karachi (+05:00)">Asia/Karachi (+05:00)</option>
                    <option value="Asia/Kolkata (+05:30)">Asia/Kolkata (+05:30)</option>
                    <option value="Asia/Riyadh (+03:00)">Asia/Riyadh (+03:00)</option>
                    <option value="Asia/Qatar (+03:00)">Asia/Qatar (+03:00)</option>
                    <option value="Europe/London (+00:00)">Europe/London (+00:00)</option>
                    <option value="America/New_York (-05:00)">America/New_York (-05:00)</option>
                    <option value="America/Los_Angeles (-08:00)">America/Los_Angeles (-08:00)</option>
                  </select>
                </div>
              </div>
            </div>

            <div className="flex justify-center mt-4">
              <button onClick={onSave} disabled={saving} className="px-6 py-1.5 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 disabled:opacity-50">
                {saving ? 'Saving...' : 'Save'}
              </button>
            </div>
          </div>
        )}

        {/* Process Flow */}
        {reqSubTab === 'process-flow' && (() => {
          const boxStyle = "px-4 py-2 border-2 border-blue-400 rounded text-xs text-blue-600 font-medium text-center bg-white min-w-[160px] whitespace-nowrap";
          const arrowDown = <div className="flex justify-center my-1"><svg width="12" height="20" viewBox="0 0 12 20"><line x1="6" y1="0" x2="6" y2="14" stroke="#6366f1" strokeWidth="2"/><polygon points="1,14 6,20 11,14" fill="#6366f1"/></svg></div>;
          const arrowRight = <div className="flex items-center mx-1"><svg width="24" height="12" viewBox="0 0 24 12"><line x1="0" y1="6" x2="18" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="18,1 24,6 18,11" fill="#6366f1"/></svg></div>;
          const arrowLeft = <div className="flex items-center mx-1"><svg width="24" height="12" viewBox="0 0 24 12"><line x1="6" y1="6" x2="24" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="6,1 0,6 6,11" fill="#6366f1"/></svg></div>;
          const arrowBoth = <div className="flex items-center mx-1"><svg width="28" height="12" viewBox="0 0 28 12"><line x1="6" y1="6" x2="22" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="6,1 0,6 6,11" fill="#6366f1"/><polygon points="22,1 28,6 22,11" fill="#6366f1"/></svg></div>;
          const colTitle = "text-sm font-bold text-blue-600 mb-3 text-center uppercase tracking-wide";
          return (
          <div className="space-y-8 overflow-x-auto pb-4">
            {/* Row 1: CUSTOMER, ORDERS, SUPPLIER, PROJECT */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* CUSTOMER */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>CUSTOMER</h4>
                <div className={boxStyle}>Pre - Lead</div>
                {arrowDown}
                <div className={boxStyle}>Lead</div>
                {arrowDown}
                <div className={boxStyle}>Quality Lead</div>
                {arrowDown}
                <div className={boxStyle}>Customer</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Customer Master</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Campaign</div>
                {arrowDown}
                <div className={boxStyle}>Customer Survey</div>
              </div>

              {/* ORDERS */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>ORDERS</h4>
                <div className={boxStyle}>Customer Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Order</div>
              </div>

              {/* SUPPLIER */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>SUPPLIER</h4>
                <div className={boxStyle}>Supplier Master</div>
                {arrowDown}
                <div className={boxStyle}>Vendor Master</div>
                {arrowDown}
                <div className={boxStyle}>Manufacturer Master</div>
                {arrowDown}
                <div className={boxStyle}>Price List</div>
              </div>

              {/* PROJECT */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>PROJECT</h4>
                <div className={boxStyle}>Task Management</div>
                {arrowDown}
                <div className={boxStyle}>Project Management</div>
                {arrowDown}
                <div className={boxStyle}>Timesheet</div>
              </div>
            </div>

            {/* Row 2: INVENTORY, ORDERS continued, FINANCIAL, E-COMMERCE + HRM */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* INVENTORY */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>INVENTORY</h4>
                <div className={boxStyle}>Item Master</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Shipping Instruction</div>
                  {arrowBoth}
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Receiving</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Inventory</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Return Receive</div>
                {arrowDown}
                <div className={boxStyle}>Return Authorization</div>
              </div>

              {/* ORDERS continued */}
              <div className="flex flex-col items-center mt-[36px]">
                <div className="flex items-center">
                  <div className={boxStyle}>Supplier Purchase Order</div>
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Priority</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Order Pick - Pack</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Shipping</div>
                {arrowDown}
                <div className={boxStyle}>Order Tracking</div>
              </div>

              {/* FINANCIAL */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>FINANCIAL</h4>
                <div className={boxStyle}>Supplier Invoice</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Payment</div>
                {arrowDown}
                <div className={boxStyle}>Sales Invoice</div>
                {arrowDown}
                <div className={boxStyle}>Customer Payment</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Employee Payroll</div>
                  {arrowBoth}
                </div>
                {arrowDown}
                <div className={boxStyle}>Salary Payment</div>
                {arrowDown}
                <div className={boxStyle}>Tax Payment</div>
                {arrowDown}
                <div className={boxStyle}>Bank Reconciliation</div>
              </div>

              {/* E-COMMERCE + HRM */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>E-COMMERCE</h4>
                <div className={boxStyle}>E-Commerce</div>
                {arrowDown}
                <div className={boxStyle}>Credit Card Payment</div>
                <div className="mt-6">
                  <h4 className={colTitle}>HRM</h4>
                  <div className="flex flex-col items-center">
                    <div className={boxStyle}>Recruitment</div>
                    {arrowDown}
                    <div className={boxStyle}>Employee Master</div>
                    {arrowDown}
                    <div className={boxStyle}>Leave Management</div>
                    {arrowDown}
                    <div className={boxStyle}>Employee Assessment</div>
                    {arrowDown}
                    <div className={boxStyle}>Bonus - Increment</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Row 3: DOCUMENT MANAGEMENT, FINANCIAL continued, HRM continued */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* DOCUMENT MANAGEMENT */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>DOCUMENT MANAGEMENT</h4>
                <div className={boxStyle}>Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Order</div>
                {arrowDown}
                <div className={boxStyle}>Customer</div>
                {arrowDown}
                <div className={boxStyle}>Supplier</div>
                {arrowDown}
                <div className={boxStyle}>Accounts</div>
                {arrowDown}
                <div className={boxStyle}>Order Fulfillment</div>
                {arrowDown}
                <div className={boxStyle}>Return</div>
              </div>

              {/* Spacer */}
              <div className="min-w-[160px]"></div>

              {/* FINANCIAL continued */}
              <div className="flex flex-col items-center">
                <div className={boxStyle}>Journal Ledger</div>
                {arrowDown}
                <div className={boxStyle}>Ledger</div>
                {arrowDown}
                <div className={boxStyle}>Fixed Asset</div>
                {arrowDown}
                <div className={boxStyle}>Account Statements</div>
                {arrowDown}
                <div className={boxStyle}>Tax Return</div>
                {arrowDown}
                <div className={boxStyle}>Tax Payment</div>
                {arrowDown}
                <div className={boxStyle}>Budget</div>
              </div>

              {/* HRM continued */}
              <div className="flex flex-col items-center">
                <div className={boxStyle}>Holiday Master</div>
              </div>
            </div>

            {/* Generate PDF Button */}
            <div className="flex justify-center mt-6">
              <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                Generate PDF
              </button>
            </div>
          </div>
          );
        })()}

        {/* Analysis */}
        {reqSubTab === 'analysis' && (() => {
          const analysisData = questionnaire.analysis || {};
          const updateAnalysis = (field: string, value: any) => {
            const updated = { ...analysisData, [field]: value };
            updateQ('analysis', updated);
          };
          const toggleFeature = (category: string, item: string, col: 'software' | 'word_excel' | 'manual') => {
            const catData = analysisData[category] || {};
            const itemData = catData[item] || {};
            const updatedItem = { ...itemData, [col]: !itemData[col] };
            const updatedCat = { ...catData, [item]: updatedItem };
            updateAnalysis(category, updatedCat);
          };
          const getFeatureVal = (category: string, item: string, col: 'software' | 'word_excel' | 'manual') => {
            return !!(analysisData[category]?.[item]?.[col]);
          };
          const featureRow = (category: string, item: string, label: string) => (
            <div key={item} className="flex items-center py-1.5">
              <span className="text-xs text-blue-600 w-[300px] flex-shrink-0 pl-8">{label}</span>
              <div className="flex-1 flex">
                <div className="w-[160px] flex justify-center"><input type="checkbox" checked={getFeatureVal(category, item, 'software')} onChange={() => toggleFeature(category, item, 'software')} className="w-3.5 h-3.5 accent-blue-600" /></div>
                <div className="w-[160px] flex justify-center"><input type="checkbox" checked={getFeatureVal(category, item, 'word_excel')} onChange={() => toggleFeature(category, item, 'word_excel')} className="w-3.5 h-3.5 accent-blue-600" /></div>
                <div className="w-[160px] flex justify-center"><input type="checkbox" checked={getFeatureVal(category, item, 'manual')} onChange={() => toggleFeature(category, item, 'manual')} className="w-3.5 h-3.5 accent-blue-600" /></div>
              </div>
            </div>
          );
          const otherRow = (category: string) => (
            <div className="flex items-center py-1.5">
              <div className="w-[300px] flex-shrink-0 pl-8 flex items-center gap-1">
                <span className="text-xs text-red-400">Other</span>
                <input type="text" value={analysisData[`${category}_other`] || ''} onChange={(e) => updateAnalysis(`${category}_other`, e.target.value)} className="h-7 flex-1 px-2 text-xs border-b border-gray-300 bg-transparent focus:outline-none focus:border-blue-500" />
              </div>
              <div className="flex-1 flex">
                <div className="w-[160px] flex justify-center"><input type="checkbox" checked={getFeatureVal(category, '_other', 'software')} onChange={() => toggleFeature(category, '_other', 'software')} className="w-3.5 h-3.5 accent-blue-600" /></div>
                <div className="w-[160px] flex justify-center"><input type="checkbox" checked={getFeatureVal(category, '_other', 'word_excel')} onChange={() => toggleFeature(category, '_other', 'word_excel')} className="w-3.5 h-3.5 accent-blue-600" /></div>
                <div className="w-[160px] flex justify-center"><input type="checkbox" checked={getFeatureVal(category, '_other', 'manual')} onChange={() => toggleFeature(category, '_other', 'manual')} className="w-3.5 h-3.5 accent-blue-600" /></div>
              </div>
            </div>
          );
          const catTitle = "text-base font-semibold text-blue-600 mt-8 mb-1 ml-2";
          return (
          <div className="space-y-6">
            {/* Pain Points */}
            <div>
              <h4 className={sectionTitle}>PAIN POINTS OR INEFFICIENCIES IN THE EXISTING BUSINESS PROCESSES/SOFTWARE.</h4>
              <textarea value={analysisData.pain_points || ''} onChange={(e) => updateAnalysis('pain_points', e.target.value)} className="w-full h-16 px-3 py-2 text-sm border-b border-gray-200 focus:outline-none focus:border-blue-400 bg-transparent resize-none" />
            </div>

            {/* Benefits Expected */}
            <div>
              <h4 className={sectionTitle}>BENEFITS EXPECTED FROM THE NEW ERP/SOFTWARE.</h4>
              <div className="space-y-5 mt-3">
                <div>
                  <p className="text-sm font-medium text-blue-500 mb-2">Critical</p>
                  <div className="flex items-center gap-3 ml-16">
                    <label className="text-xs text-blue-600 flex-shrink-0">Other Requirements</label>
                    <input type="text" value={analysisData.benefits_critical || ''} onChange={(e) => updateAnalysis('benefits_critical', e.target.value)} className="flex-1 h-8 px-2 text-sm border-b border-gray-300 bg-transparent focus:outline-none focus:border-blue-500" />
                  </div>
                </div>
                <div>
                  <p className="text-sm font-medium text-blue-500 mb-2">Important</p>
                  <div className="flex items-center gap-3 ml-16">
                    <label className="text-xs text-blue-600 flex-shrink-0">Other Requirements</label>
                    <input type="text" value={analysisData.benefits_important || ''} onChange={(e) => updateAnalysis('benefits_important', e.target.value)} className="flex-1 h-8 px-2 text-sm border-b border-gray-300 bg-transparent focus:outline-none focus:border-blue-500" />
                  </div>
                </div>
                <div>
                  <p className="text-sm font-medium text-blue-500 mb-2">Minor Importance</p>
                  <div className="flex items-center gap-3 ml-16">
                    <label className="text-xs text-blue-600 flex-shrink-0">Other Requirements</label>
                    <input type="text" value={analysisData.benefits_minor || ''} onChange={(e) => updateAnalysis('benefits_minor', e.target.value)} className="flex-1 h-8 px-2 text-sm border-b border-gray-300 bg-transparent focus:outline-none focus:border-blue-500" />
                  </div>
                </div>
              </div>
            </div>

            {/* KEY FEATURES IN THE SOFTWARE/PROCESS */}
            <div>
              <h4 className="text-sm font-bold text-blue-600 mb-2 uppercase">KEY FEATURES IN THE SOFTWARE/PROCESS</h4>

              {/* Customer Relationship Management */}
              <h5 className={catTitle}>Customer Relationship Management</h5>
              {/* Column headers - shown once */}
              <div className="flex items-center py-2">
                <span className="w-[300px] flex-shrink-0"></span>
                <div className="flex-1 flex">
                  <div className="w-[160px] text-center text-xs font-semibold text-gray-700">Software</div>
                  <div className="w-[160px] text-center text-xs font-semibold text-gray-700">Word/Excel</div>
                  <div className="w-[160px] text-center text-xs font-semibold text-gray-700">Manual</div>
                </div>
              </div>
              {featureRow('crm', 'customer_details', 'Customer Details')}
              {featureRow('crm', 'customer_interactions', 'Customer Interactions')}
              {featureRow('crm', 'lead_details', 'Lead Details')}
              {featureRow('crm', 'lead_tracking', 'Lead Tracking/Interactions')}
              {featureRow('crm', 'marketing_campaigns', 'Marketing Campaigns')}
              {featureRow('crm', 'survey_satisfaction', 'Survey and Customer Satisfaction')}
              {otherRow('crm')}

              {/* Vendor/Supplier Management */}
              <h5 className={catTitle}>Vendor/Supplier Management</h5>
              {featureRow('vendor', 'vendor_supplier_master', 'Vendor/Supplier Master')}
              {featureRow('vendor', 'manufacturer_brand', 'Manufacturer and Brand Management')}
              {featureRow('vendor', 'price_list', 'Price List')}
              {otherRow('vendor')}

              {/* Supply Chain Management (Order Management) */}
              <h5 className={catTitle}>Supply Chain Management (Order Management)</h5>
              {featureRow('scm', 'customer_inquiry', 'Customer Inquiry')}
              {featureRow('scm', 'supplier_inquiry', 'Supplier Inquiry')}
              {featureRow('scm', 'supplier_quotations', 'Supplier Quotations')}
              {featureRow('scm', 'customer_quotations', 'Customer Quotations')}
              {featureRow('scm', 'customer_sales_order', 'Customer Sales Order')}
              {featureRow('scm', 'supplier_purchase_order', 'Supplier Purchase Order')}
              {featureRow('scm', 'order_receiving', 'Order Receiving')}
              {featureRow('scm', 'order_fulfillment', 'Order Fulfillment')}
              {featureRow('scm', 'shipping', 'Shipping')}
              {featureRow('scm', 'sales_tracking', 'Sales Tracking')}
              {otherRow('scm')}

              {/* Inventory Management */}
              <h5 className={catTitle}>Inventory Management</h5>
              {featureRow('inventory', 'inventory_control', 'Inventory Control')}
              {featureRow('inventory', 'item_master', 'Item Master')}
              {featureRow('inventory', 'logistics', 'Logistics')}
              {featureRow('inventory', 'rma', 'RMA (Return Material Authorization)')}
              {featureRow('inventory', 'return_receiving', 'Return Receiving')}
              {otherRow('inventory')}

              {/* Financial Management */}
              <h5 className={catTitle}>Financial Management</h5>
              {featureRow('financial', 'proforma_invoice', 'Proforma Invoice')}
              {featureRow('financial', 'sales_invoice', 'Sales Invoice')}
              {featureRow('financial', 'customer_payment', 'Customer Payment')}
              {featureRow('financial', 'credit_note', 'Credit Note')}
              {featureRow('financial', 'supplier_invoice', 'Supplier Invoice')}
              {featureRow('financial', 'supplier_payment', 'Supplier Payment')}
              {featureRow('financial', 'debit_note', 'Debit Note')}
              {featureRow('financial', 'voucher_payment', 'Voucher Payment')}
              {featureRow('financial', 'general_ledger', 'General Ledger')}
              {featureRow('financial', 'payroll_management', 'Payroll Management')}
              {featureRow('financial', 'fixed_asset_management', 'Fixed Asset Management')}
              {featureRow('financial', 'bank_credit_card', 'Bank/Credit Card Accounts')}
              {featureRow('financial', 'bank_reconciliation', 'Bank Reconciliation')}
              {featureRow('financial', 'account_statements', 'Account Statements')}
              {featureRow('financial', 'sales_commissions', 'Sales Commissions')}
              {featureRow('financial', 'credit_card_payments', 'Credit Card Payments')}
              {featureRow('financial', 'budgeting_forecasting', 'Budgeting and Forecasting')}
              {featureRow('financial', 'regulatory_compliance', 'Regulatory Compliance')}
              {otherRow('financial')}

              {/* Human Resource Management */}
              <h5 className={catTitle}>Human Resource Management</h5>
              {featureRow('hrm', 'employee_details', 'Employee Details')}
              {featureRow('hrm', 'roles_responsibilities', 'Roles and Responsibilities')}
              {featureRow('hrm', 'time_attendance', 'Time and Attendance')}
              {featureRow('hrm', 'tracking', 'Tracking')}
              {featureRow('hrm', 'leave_management', 'Leave Management')}
              {featureRow('hrm', 'performance_appraisal', 'Performance and Appraisal')}
              {featureRow('hrm', 'bonus_increments', 'Bonus and Increments')}
              {featureRow('hrm', 'hiring', 'Hiring')}
              {otherRow('hrm')}

              {/* Project Management */}
              <h5 className={catTitle}>Project Management</h5>
              {featureRow('project', 'project_planning', 'Project planning')}
              {featureRow('project', 'resource_allocation', 'Resource Allocation')}
              {featureRow('project', 'task_management', 'Task Management')}
              {featureRow('project', 'budgeting', 'Budgeting')}
              {featureRow('project', 'scheduling', 'Scheduling')}
              {featureRow('project', 'collaboration', 'Collaboration')}
              {otherRow('project')}

              {/* Other Features */}
              <h5 className={catTitle}>Other Features</h5>
              {featureRow('other_features', 'bi_kpis', 'Business Intelligence and KPIs')}
              {featureRow('other_features', 'dashboard', 'Dashboard')}
              {featureRow('other_features', 'multi_currency', 'Multi-currency Support')}
              {featureRow('other_features', 'multiple_office', 'Multiple Office')}
              {featureRow('other_features', 'dms', 'Document Management System')}
              {featureRow('other_features', 'ecommerce_integration', 'E-commerce Integration')}
              {featureRow('other_features', 'integrated_email', 'Integrated Email')}
              {featureRow('other_features', 'integrated_phone', 'Integrated Phone System')}
              {featureRow('other_features', 'integrated_calendar', 'Integrated Calendar')}
              {featureRow('other_features', 'message_board', 'Message Board')}
              {featureRow('other_features', 'mobile_access', 'Mobile Access')}
              {featureRow('other_features', 'workflow_integration', 'Work Flow Integration')}
              {featureRow('other_features', 'customer_portal', 'Customer Portal')}
              {featureRow('other_features', 'vendor_supplier_portal', 'Vendor/Supplier Portal')}
              {otherRow('other_features')}
            </div>

            <div className="flex justify-center mt-6">
              <button onClick={onSave} disabled={saving} className="px-6 py-1.5 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 disabled:opacity-50">
                {saving ? 'Saving...' : 'Save'}
              </button>
            </div>
          </div>
          );
        })()}

        {/* Follow-Up */}
        {reqSubTab === 'follow-up' && (
          <div className="space-y-3">
            <div className="flex items-center">
              <button onClick={() => handleOpenReqFollowUp()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className={thClass}>Activity Type</th>
                    <th className={thClass}>Activity Subject</th>
                    <th className={thClass}>Date & Time</th>
                    <th className={thClass}>Next Follow-up Date</th>
                    <th className={thClass}>Channel Type</th>
                    <th className={thClass}>Assigned To</th>
                    <th className={thClass}>Sent To</th>
                    <th className={thClass}>Status</th>
                    <th className={thClass}>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {reqFollowUps.length === 0 ? (
                    <tr><td colSpan={9} className="px-3 py-8 text-center text-gray-400 text-xs">No follow-up activities</td></tr>
                  ) : (
                    reqFollowUps.map((item: any, index: number) => (
                      <tr key={item.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className={tdClass}>{item.activity_type || '-'}</td>
                        <td className={tdClass}>{item.subject || '-'}</td>
                        <td className={tdClass}>{item.start_date ? `${item.start_date}${item.start_time ? ';  ' + item.start_time : ''}` : '-'}</td>
                        <td className={tdClass}>{item.next_followup_date ? `${item.next_followup_date}${item.next_followup_time ? ' ; ' + item.next_followup_time : ''}` : '-'}</td>
                        <td className={tdClass}>{item.channel_type || '-'}</td>
                        <td className={tdClass}>{item.assigned_to || '-'}</td>
                        <td className={tdClass}>{item.sent_to || '-'}</td>
                        <td className={`${tdClass} text-green-600`}>{item.status || '-'}</td>
                        <td className={tdClass}>
                          <button onClick={() => handleOpenReqFollowUp(item)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Memo */}
        {reqSubTab === 'memo' && (
          <div className="space-y-3">
            <div className="flex items-center">
              <button onClick={() => handleOpenReqMemo()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className={thClass}>Date</th>
                    <th className={thClass}>Added By</th>
                    <th className={thClass}>Details</th>
                    <th className={thClass}>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {reqMemos.length === 0 ? (
                    <tr><td colSpan={4} className="px-3 py-8 text-center text-gray-400 text-xs">No memos</td></tr>
                  ) : (
                    reqMemos.map((memo: any, index: number) => (
                      <tr key={memo.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className={tdClass}>{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                        <td className={`${tdClass} text-blue-600`}>{memo.added_by || memo.created_by_name || '-'}</td>
                        <td className={tdClass}>{memo.content || '-'}</td>
                        <td className={tdClass}>
                          <div className="flex gap-1 justify-center">
                            <button onClick={() => handleOpenReqMemo(memo)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                            <button onClick={() => handleDeleteReqMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Upload File */}
        {reqSubTab === 'upload-file' && (
          <div className="space-y-4">
            <div className="space-y-2">
              <div className="flex items-center gap-2 justify-center">
                <label className="text-xs font-semibold text-orange-500 w-20 text-right">Document</label>
                <input type="text" className="h-8 w-64 px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={reqSubTabFile?.name || ''} />
                <input ref={reqSubTabFileRef} type="file" onChange={handleReqSubTabFileChange} className="hidden" style={{ display: 'none' }} />
                <button type="button" onClick={handleReqSubTabChooseFile} className="h-8 px-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
                <button type="button" onClick={handleReqSubTabUpload} disabled={!reqSubTabFile || reqSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed">{reqSubTabUploading ? 'Uploading...' : 'Upload'}</button>
              </div>
              <div className="flex items-center gap-2 justify-center">
                <label className="text-xs font-semibold text-orange-500 w-20 text-right">Notes</label>
                <input type="text" value={reqSubTabNotes} onChange={(e) => setReqSubTabNotes(e.target.value)} className="h-8 w-64 px-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                <div className="w-[186px]"></div>
              </div>
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className={thClass}>File Name</th>
                    <th className={thClass}>Uploaded On</th>
                    <th className={thClass}>Size</th>
                    <th className={thClass}>Notes</th>
                    <th className={thClass}>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {reqSubTabDocs.length === 0 ? (
                    <tr><td colSpan={5} className="px-3 py-8 text-center text-gray-400 text-xs">No files uploaded</td></tr>
                  ) : (
                    reqSubTabDocs.map((doc: any, index: number) => (
                      <tr key={doc.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className={`${tdClass} text-blue-600`}>{doc.file_name || '-'}</td>
                        <td className={tdClass}>{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                        <td className={tdClass}>{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                        <td className={tdClass}>{doc.description || '-'}</td>
                        <td className={tdClass}>
                          <div className="flex gap-1 justify-center">
                            <button type="button" onClick={() => handleReqSubTabDeleteDoc(doc.id)} className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Workflow & Audit Trail */}
        {reqSubTab === 'workflow-audit-trail' && (
          <div className="text-center py-8 text-gray-500 text-sm">Workflow & Audit Trail content</div>
        )}
      </div>

      {/* Follow-Up Modal */}
      {showReqFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button onClick={() => setShowReqPreviousActivities(!showReqPreviousActivities)} className="px-3 py-1 text-xs font-medium text-blue-900 bg-blue-500 rounded hover:bg-blue-400">View Previous Activities</button>
              </div>
              <button onClick={() => setShowReqFollowUpModal(false)} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            {/* Body */}
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                {/* Contact */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select
                    value={reqFollowUpForm.contact_id}
                    onChange={(e) => {
                      const contactId = e.target.value;
                      const selectedContact = reqContacts.find((c: any) => c.id?.toString() === contactId);
                      setReqFollowUpForm({
                        ...reqFollowUpForm,
                        contact_id: contactId,
                        sent_to: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || ''
                      });
                    }}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  >
                    <option value="">Select Contact</option>
                    {reqContacts.map((contact: any) => (
                      <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                    ))}
                  </select>
                </div>
                {/* Activity Subject */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={reqFollowUpForm.subject} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                {/* Email */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={reqFollowUpForm.sent_to} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readOnly />
                </div>
                {/* Activity Type */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={reqFollowUpForm.activity_type} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                {/* Start Date / Time */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={reqFollowUpForm.start_date} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <input type="time" value={reqFollowUpForm.start_time} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                {/* Assigned To */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={reqFollowUpForm.assigned_to} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select User</option>
                    <option value="1">Admin User</option>
                    <option value="Junaid Ali">Junaid Ali</option>
                  </select>
                </div>
                {/* Next Follow Up Date */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={reqFollowUpForm.next_followup_date} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                {/* Status */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={reqFollowUpForm.status} onChange={(e) => setReqFollowUpForm({ ...reqFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              {/* Description */}
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                {/* Rich Text Toolbar */}
                <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqFollowUpExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded" title="Bold">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqFollowUpExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded" title="Italic">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqFollowUpExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded" title="Underline">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqFollowUpExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Highlight"><Edit2 className="w-3.5 h-3.5" /></button>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <select onChange={(e) => { handleReqFollowUpExec('fontName', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                  </select>
                  <select onChange={(e) => { handleReqFollowUpExec('fontSize', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                    <option value="1">8</option>
                    <option value="2">10</option>
                    <option value="3">12</option>
                    <option value="4">14</option>
                    <option value="5">18</option>
                    <option value="6">24</option>
                    <option value="7">36</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300" title="Text Color">A</button>
                    <input type="color" onChange={(e) => handleReqFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Text Color" />
                  </div>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqFollowUpExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Bullet List">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqFollowUpExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Numbered List">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                  <select onChange={(e) => { handleReqFollowUpExec(e.target.value === 'left' ? 'justifyLeft' : e.target.value === 'center' ? 'justifyCenter' : e.target.value === 'right' ? 'justifyRight' : 'justifyFull'); e.target.value = ''; }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer">
                    <option value="">Align</option>
                    <option value="left">Left</option>
                    <option value="center">Center</option>
                    <option value="right">Right</option>
                    <option value="justify">Justify</option>
                  </select>
                </div>
                {/* Rich Text Editor */}
                <div ref={reqFollowUpEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y" style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }} suppressContentEditableWarning />
              </div>
              {/* Save Button */}
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveReqFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showReqMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => setShowReqMemoModal(false)} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            {/* Body */}
            <div className="p-5">
              {/* Toolbar */}
              <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqMemoExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded" title="Bold">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqMemoExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded" title="Italic">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqMemoExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded" title="Underline">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqMemoExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Highlight">
                  <Edit2 className="w-3.5 h-3.5" />
                </button>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <select onChange={(e) => { handleReqMemoExec('fontName', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Courier New">Courier New</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                </select>
                <select onChange={(e) => { handleReqMemoExec('fontSize', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                  <option value="1">8</option>
                  <option value="2">10</option>
                  <option value="3">12</option>
                  <option value="4">14</option>
                  <option value="5">18</option>
                  <option value="6">24</option>
                  <option value="7">36</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300" title="Text Color">A</button>
                  <input type="color" onChange={(e) => handleReqMemoExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Text Color" />
                </div>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqMemoExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Bullet List">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleReqMemoExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Numbered List">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
                <select onChange={(e) => { handleReqMemoExec(e.target.value === 'left' ? 'justifyLeft' : e.target.value === 'center' ? 'justifyCenter' : e.target.value === 'right' ? 'justifyRight' : 'justifyFull'); e.target.value = ''; }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer">
                  <option value="">Align</option>
                  <option value="left">Left</option>
                  <option value="center">Center</option>
                  <option value="right">Right</option>
                  <option value="justify">Justify</option>
                </select>
              </div>
              {/* Editor Area */}
              <div
                ref={reqMemoEditorRef}
                contentEditable
                className="w-full min-h-[220px] max-h-[400px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y"
                style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }}
                suppressContentEditableWarning
              />
              {/* Save Button */}
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveReqMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Presentation Module Categories ==============
const PRESENTATION_MODULES: Record<string, string[]> = {
  'Customer': ['Customer Master', 'CRM', 'Campaign', 'Customer Survey'],
  'Supplier': ['Supplier Master', 'Vendor Master', 'Manufacturer Master', 'Price List'],
  'Inventory': ['Item Master', 'E-Commerce', 'Requisition', 'Shipping Instruction', 'Receiving', 'Discount', 'Return', 'Inventory'],
  'Orders': ['Inquiry', 'Quotation', 'Order', 'Fulfillment Priority', 'Order Fulfillment', 'Wave Pick', 'Order Tracking'],
  'Financials': ['Account Receivable', 'Account Payable', 'Journal Entry', 'Ledger', 'Payroll', 'Incentive', 'Banking', 'Asset Management', 'Account Statement', 'Tax Connect', 'Regulatory Compliance', 'Budgeting'],
  'HRM': ['Employee Master', 'Leave Master', 'Holiday Master', 'Recruitment', 'Appraisal', 'Bonus'],
  'Project': ['Task Management', 'Project Management', 'Timesheet'],
  'Reports': ['Customer', 'Crm', 'Supplier', 'Orders', 'Financials', 'HRM', 'Project', 'Inventory', 'Management', 'Business Intelligence'],
  'DMS': ['Return', 'Accounts', 'Supplier', 'Customer', 'Order', 'Quotation', 'Inquiry', 'Order Fulfillment', 'Other Folders', 'Item'],
  'My Info': ['Holiday Calendar', 'My Favorite', 'Leave Management', 'My Dashboard', 'Message Board', 'Notifications', 'Calendar', 'Attendance Management', 'Ticketing'],
  'Setup': ['Role Mgmt', 'Bank Master', 'Accounting', 'Configuration', 'Company Setup', 'User Mgmt', 'Option Master', 'Variant Master', 'Auto Scheduler', 'Form Management'],
};

// ============== Presentation Form ==============
function PresentationForm({ data, setData, crId, leadId, presentations, refreshData, onOpenEmailModal }: any) {
  const [presSubTab, setPresSubTab] = useState('presentation');
  const [emailsSent, setEmailsSent] = useState<any[]>([]);
  const [presDocs, setPresDocs] = useState<any[]>([]);
  const [presEmailTemplates, setPresEmailTemplates] = useState<any[]>([]);
  const [presSelectedFile, setPresSelectedFile] = useState<File | null>(null);
  const [presUploading, setPresUploading] = useState(false);
  const presFileInputRef = React.useRef<HTMLInputElement>(null);
  const [saving, setSaving] = useState(false);
  const [presContacts, setPresContacts] = useState<any[]>([]);

  // Module checkboxes state
  const [modules, setModules] = useState<Record<string, string[]>>(() => {
    try {
      if (presentations?.length > 0 && presentations[0].presentation_modules) {
        return JSON.parse(presentations[0].presentation_modules);
      }
    } catch {}
    return {};
  });

  // Sub-tab states
  const [presSubTabDocs, setPresSubTabDocs] = useState<any[]>([]);
  const [presSubTabFile, setPresSubTabFile] = useState<File | null>(null);
  const [presSubTabNotes, setPresSubTabNotes] = useState('');
  const [presSubTabUploading, setPresSubTabUploading] = useState(false);
  const presSubTabFileRef = React.useRef<HTMLInputElement>(null);
  const [presFollowUps, setPresFollowUps] = useState<any[]>([]);
  const [showPresFollowUpModal, setShowPresFollowUpModal] = useState(false);
  const [editingPresFollowUp, setEditingPresFollowUp] = useState<any>(null);
  const [presFollowUpForm, setPresFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', end_date: '', end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: '', next_followup_time: '', channel_type: '', sent_to: '',
  });
  const [presMemos, setPresMemos] = useState<any[]>([]);
  const [showPresMemoModal, setShowPresMemoModal] = useState(false);
  const [editingPresMemo, setEditingPresMemo] = useState<any>(null);
  const [presMemoForm, setPresMemoForm] = useState({ content: '' });
  const presMemoEditorRef = React.useRef<HTMLDivElement>(null);
  const presFollowUpEditorRef = React.useRef<HTMLDivElement>(null);
  const [showPreviousActivities, setShowPreviousActivities] = useState(false);

  // Demo Date form state
  const [demoDateForm, setDemoDateForm] = useState({
    key_person_name: '', company_name: '', address: '', country: '', province: '', city: '', postal_code: '',
    company_phone: '', ext: '', fax: '', email: '', website: '', any_branch_office: '', branch_address: '',
    preferred_date: '', preferred_time: '', remark: '', timezone: ''
  });

  // Initialize demo date form from data
  useEffect(() => {
    if (data) {
      setDemoDateForm({
        key_person_name: data.contact_name || '',
        company_name: data.company_name || '',
        address: data.address_line1 || '',
        country: data.country_id?.toString() || '',
        province: data.state_id?.toString() || '',
        city: data.city_id?.toString() || '',
        postal_code: data.zip_code || '',
        company_phone: data.phone_no || '',
        ext: data.phone_ext || '',
        fax: data.fax || '',
        email: data.contact_email || '',
        website: data.website || '',
        any_branch_office: data.branch_office || '',
        branch_address: '',
        preferred_date: '',
        preferred_time: '',
        remark: '',
        timezone: data.timezone_id?.toString() || ''
      });
    }
  }, [data]);

  // Questions state
  const [questionsForm, setQuestionsForm] = useState({
    presentation_date: '', presentation_by: '', attended_by: []
  });
  const [questionRow, setQuestionRow] = useState({
    date: '', added_by: '', question: '', category: '', asked_by: '', answered: ''
  });
  const [questionsList, setQuestionsList] = useState<any[]>([]);

  const handleAddQuestion = () => {
    if (!questionRow.question) return;
    setQuestionsList([...questionsList, { ...questionRow, id: Date.now() }]);
    setQuestionRow({ date: '', added_by: '', question: '', category: '', asked_by: '', answered: '' });
  };

  const handleDeleteQuestion = (id: number) => {
    setQuestionsList(questionsList.filter(q => q.id !== id));
  };

  // Summary state
  const [summaryRow, setSummaryRow] = useState({
    category: '', asked_by: '', added_by: '', question: '', answered: '', module: '', notes: ''
  });
  const [summaryList, setSummaryList] = useState<any[]>([]);

  const handleAddSummary = () => {
    if (!summaryRow.question) return;
    setSummaryList([...summaryList, { ...summaryRow, id: Date.now() }]);
    setSummaryRow({ category: '', asked_by: '', added_by: '', question: '', answered: '', module: '', notes: '' });
  };

  const handleDeleteSummary = (id: number) => {
    setSummaryList(summaryList.filter(s => s.id !== id));
  };

  // Load contacts
  useEffect(() => {
    if (leadId) {
      api.getLeadContactsForEdit(leadId).then(setPresContacts).catch(() => setPresContacts([]));
    }
  }, [leadId]);

  // Load documents
  useEffect(() => {
    if (crId) {
      api.getCRDocuments(crId, 'presentation').then(setPresDocs).catch(() => setPresDocs([]));
    }
  }, [crId]);

  // Load email templates for Presentation tab
  useEffect(() => {
    api.getCRIEmailTemplates('Presentation').then(setPresEmailTemplates).catch(() => setPresEmailTemplates([]));
  }, []);

  // Load sub-tab data
  useEffect(() => {
    if (crId && presSubTab === 'follow-up') {
      api.getCRActivities(crId, 'presentation-followup').then(setPresFollowUps).catch(() => setPresFollowUps([]));
    }
  }, [crId, presSubTab]);

  useEffect(() => {
    if (crId && presSubTab === 'memo') {
      api.getCRMemos(crId, 'presentation').then(setPresMemos).catch(() => setPresMemos([]));
    }
  }, [crId, presSubTab]);

  useEffect(() => {
    if (crId && presSubTab === 'upload-file') {
      api.getCRDocuments(crId, 'presentation-upload').then(setPresSubTabDocs).catch(() => setPresSubTabDocs([]));
    }
  }, [crId, presSubTab]);

  // Sync modules from presentations prop
  useEffect(() => {
    try {
      if (presentations?.length > 0 && presentations[0].presentation_modules) {
        setModules(JSON.parse(presentations[0].presentation_modules));
      }
    } catch {}
  }, [presentations]);

  // Document handlers
  const handlePresChooseFile = () => presFileInputRef.current?.click();
  const handlePresFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setPresSelectedFile(e.target.files[0]); };
  const handlePresUploadFile = async () => {
    if (!presSelectedFile || !crId) { alert(!presSelectedFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setPresUploading(true);
    try {
      await api.uploadCRDocument(crId, presSelectedFile, 'presentation', 'Details');
      const docs = await api.getCRDocuments(crId, 'presentation');
      setPresDocs(docs);
      setPresSelectedFile(null);
      if (presFileInputRef.current) presFileInputRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setPresUploading(false); }
  };
  const handlePresDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setPresDocs(presDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  // Sub-tab upload handlers
  const handlePresSubTabChooseFile = () => presSubTabFileRef.current?.click();
  const handlePresSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setPresSubTabFile(e.target.files[0]); };
  const handlePresSubTabUpload = async () => {
    if (!presSubTabFile || !crId) { alert(!presSubTabFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setPresSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, presSubTabFile, 'presentation-upload', 'Upload File');
      const docs = await api.getCRDocuments(crId, 'presentation-upload');
      setPresSubTabDocs(docs);
      setPresSubTabFile(null); setPresSubTabNotes('');
      if (presSubTabFileRef.current) presSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setPresSubTabUploading(false); }
  };
  const handlePresSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setPresSubTabDocs(presSubTabDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  // Follow-up handlers
  const handleOpenPresFollowUp = (item?: any) => {
    if (item) { setEditingPresFollowUp(item); setPresFollowUpForm({ activity_type: item.activity_type || '', subject: item.subject || '', start_date: item.start_date || '', start_time: item.start_time || '', end_date: item.end_date || '', end_time: item.end_time || '', description: item.description || '', status: item.status || 'Open', contact_id: item.contact_id?.toString() || '', assigned_to: item.assigned_to?.toString() || '', priority: item.priority || '', next_followup_date: item.next_followup_date || '', next_followup_time: item.next_followup_time || '', channel_type: item.channel_type || '', sent_to: item.sent_to || '' }); }
    else { setEditingPresFollowUp(null); const now = new Date(); setPresFollowUpForm({ activity_type: '', subject: '', start_date: now.toISOString().split('T')[0], start_time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), end_date: now.toISOString().split('T')[0], end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: now.toISOString().split('T')[0], next_followup_time: '', channel_type: '', sent_to: '' }); }
    setShowPresFollowUpModal(true);
    setTimeout(() => {
      if (presFollowUpEditorRef.current) {
        presFollowUpEditorRef.current.innerHTML = item?.description || '';
      }
    }, 50);
  };
  const handlePresFollowUpExec = (command: string, value?: string) => {
    document.execCommand(command, false, value || '');
    presFollowUpEditorRef.current?.focus();
  };
  const handleSavePresFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = presFollowUpEditorRef.current?.innerHTML || presFollowUpForm.description;
    const formToSave = { ...presFollowUpForm, description: descriptionContent };
    try {
      if (editingPresFollowUp) { const updated = await api.updateCRActivity(crId, editingPresFollowUp.id, formToSave); setPresFollowUps(presFollowUps.map((a: any) => a.id === editingPresFollowUp.id ? updated : a)); }
      else { const created = await api.createCRActivity(crId, { ...formToSave, tab_name: 'presentation-followup' }); setPresFollowUps([...presFollowUps, created]); }
      setShowPresFollowUpModal(false); setEditingPresFollowUp(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeletePresFollowUp = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRActivity(crId, id); setPresFollowUps(presFollowUps.filter((a: any) => a.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleOpenPresMemo = (item?: any) => {
    if (item) { setEditingPresMemo(item); setPresMemoForm({ content: item.content || '' }); }
    else { setEditingPresMemo(null); setPresMemoForm({ content: '' }); }
    setShowPresMemoModal(true);
    setTimeout(() => {
      if (presMemoEditorRef.current) {
        presMemoEditorRef.current.innerHTML = item?.content || '';
      }
    }, 50);
  };
  const handlePresMemoExec = (command: string, value?: string) => {
    document.execCommand(command, false, value || '');
    presMemoEditorRef.current?.focus();
  };
  const handleSavePresMemo = async () => {
    if (!crId) return;
    const content = presMemoEditorRef.current?.innerHTML || presMemoForm.content;
    const payload = { content };
    try {
      if (editingPresMemo) { const updated = await api.updateCRMemo(crId, editingPresMemo.id, payload); setPresMemos(presMemos.map((m: any) => m.id === editingPresMemo.id ? updated : m)); }
      else { const created = await api.createCRMemo(crId, { ...payload, tab_name: 'presentation' }); setPresMemos([...presMemos, created]); }
      setShowPresMemoModal(false); setEditingPresMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeletePresMemo = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRMemo(crId, id); setPresMemos(presMemos.filter((m: any) => m.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Module checkbox handlers
  const toggleModule = (category: string, item: string) => {
    setModules(prev => {
      const catItems = prev[category] || [];
      const updated = catItems.includes(item)
        ? catItems.filter(i => i !== item)
        : [...catItems, item];
      return { ...prev, [category]: updated };
    });
  };

  const toggleCategory = (category: string) => {
    setModules(prev => {
      const allItems = PRESENTATION_MODULES[category];
      const catItems = prev[category] || [];
      const allSelected = allItems.every(i => catItems.includes(i));
      return { ...prev, [category]: allSelected ? [] : [...allItems] };
    });
  };

  const handleSaveModules = async () => {
    if (!crId) return;
    setSaving(true);
    try {
      const payload = { presentation_modules: JSON.stringify(modules), status: 'scheduled' };
      if (presentations?.length > 0) {
        await api.updateCRPresentation(crId, presentations[0].id, payload);
      } else {
        await api.createCRPresentation(crId, payload);
      }
      refreshData();
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save'); }
    finally { setSaving(false); }
  };

  const handleRefresh = () => {
    try {
      if (presentations?.length > 0 && presentations[0].presentation_modules) {
        setModules(JSON.parse(presentations[0].presentation_modules));
      } else {
        setModules({});
      }
    } catch { setModules({}); }
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-32 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-blue-50";
  const fieldSelectClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-blue-50";
  const rowClass = "flex items-center gap-2 mb-2";
  const thClass = "px-3 py-2 text-left text-xs font-medium text-white bg-blue-600 border-r border-blue-500 last:border-r-0";
  const tdClass = "px-3 py-2 text-xs border-b border-gray-200";

  const presSubTabs = ['Presentation', 'Process Flow', 'Link', 'Demo Date', 'Questions', 'Summary', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  return (
    <div className="space-y-4">
      {/* Top Form Section */}
      <div className="grid grid-cols-2 gap-6">
        {/* Left Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Company Name</label>
            <input type="text" value={data?.company_name || ''} onChange={(e) => setData({ ...data, company_name: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Name</label>
            <select value={data?.contact_id || ''} onChange={(e) => setData({ ...data, contact_id: e.target.value })} className={fieldSelectClass}>
              <option value="">Select Contact Name</option>
              <option value="1">Contact 1</option>
              <option value="2">Contact 2</option>
            </select>
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={data?.pres_email_format || ''} onChange={(e) => setData({ ...data, pres_email_format: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {presEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Presentation', '', presEmailTemplates.find((t: any) => t.email_format === data?.pres_email_format)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="mt-3 border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className={thClass}>Email Sent To</th>
                  <th className={thClass}>Attachments</th>
                  <th className={thClass}>Sent On</th>
                  <th className={thClass}>Action</th>
                </tr>
              </thead>
              <tbody>
                {emailsSent.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-gray-400 text-xs">No emails sent</td></tr>
                ) : (
                  emailsSent.map((email: any, index: number) => (
                    <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className={tdClass}>{email.to}</td>
                      <td className={tdClass}>{email.attachments || '-'}</td>
                      <td className={tdClass}>{email.sent_on}</td>
                      <td className={tdClass}>
                        <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Edit2 className="w-3 h-3" /></button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-1">
          <div className={rowClass}>
            <label className={fieldLabelClass}>Branch Office</label>
            <input type="text" value={data?.branch_office || ''} onChange={(e) => setData({ ...data, branch_office: e.target.value })} className={fieldInputClass} placeholder="Branch Office" />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Contact Email</label>
            <input type="email" value={data?.contact_email || ''} onChange={(e) => setData({ ...data, contact_email: e.target.value })} className={fieldInputClass} />
          </div>
          <div className={rowClass}>
            <label className={fieldLabelClass}>Document</label>
            <input type="text" className={fieldInputClass} readOnly value={presSelectedFile?.name || ''} placeholder="No file chosen" />
            <input ref={presFileInputRef} type="file" onChange={handlePresFileChange} className="hidden" style={{ display: 'none' }} />
            <button type="button" onClick={handlePresChooseFile} className="h-8 px-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button type="button" onClick={handlePresUploadFile} disabled={!presSelectedFile || presUploading} className="h-8 px-3 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed">
              {presUploading ? 'Uploading...' : 'Upload'}
            </button>
          </div>
          {/* Documents Table */}
          <div className="mt-3 border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className={thClass}>File Name</th>
                  <th className={thClass}>Link</th>
                  <th className={thClass}>Size</th>
                  <th className={thClass}>Upload On</th>
                  <th className={thClass}>Action</th>
                </tr>
              </thead>
              <tbody>
                {presDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs">No documents uploaded</td></tr>
                ) : (
                  presDocs.map((doc: any, index: number) => (
                    <tr key={doc.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className={`${tdClass} text-blue-600`}>{doc.file_name}</td>
                      <td className={`${tdClass} text-blue-600`}>
                        {doc.file_path ? (
                          <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">View</a>
                        ) : '-'}
                      </td>
                      <td className={tdClass}>{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className={tdClass}>{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className={tdClass}>
                        <div className="flex gap-1 justify-center">
                          <button type="button" onClick={() => handlePresDeleteDoc(doc.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Section */}
      <div className="border-t pt-4">
        <div className="flex gap-4 mb-4">
          {presSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-');
            const isActive = presSubTab === tabKey;
            return (
              <button
                key={tab}
                onClick={() => setPresSubTab(tabKey)}
                className={`px-2 py-1 text-xs font-medium border-b-2 ${
                  isActive
                    ? 'border-blue-600 text-blue-600 bg-blue-50 rounded-t'
                    : 'border-transparent text-orange-500 hover:text-orange-600'
                }`}
              >
                {tab}
              </button>
            );
          })}
        </div>

        {/* Presentation Sub-tab - Module Checkboxes */}
        {presSubTab === 'presentation' && (
          <div className="space-y-5">
            <div className="grid grid-cols-4 gap-4">
              {Object.entries(PRESENTATION_MODULES).map(([category, items]) => {
                const catItems = modules[category] || [];
                const allSelected = items.every(i => catItems.includes(i));
                return (
                  <div key={category} className="border rounded overflow-hidden">
                    <div className="flex items-center gap-2 px-3 py-2 bg-blue-800 text-white">
                      <input
                        type="checkbox"
                        checked={allSelected}
                        onChange={() => toggleCategory(category)}
                        className="w-3.5 h-3.5 rounded cursor-pointer"
                      />
                      <span className="text-xs font-bold">{category}</span>
                    </div>
                    <div className="p-2 space-y-1 bg-white">
                      {items.map((item) => (
                        <label key={item} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded">
                          <input
                            type="checkbox"
                            checked={catItems.includes(item)}
                            onChange={() => toggleModule(category, item)}
                            className="w-3.5 h-3.5 rounded cursor-pointer"
                          />
                          <span className="text-xs text-blue-600">{item}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
            {/* Bottom Buttons */}
            <div className="flex justify-center gap-3 pt-3">
              <button onClick={handleSaveModules} disabled={saving} className="px-5 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 disabled:opacity-50">
                {saving ? 'Saving...' : 'Save'}
              </button>
              <button className="px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                Generate Presentation
              </button>
              <button onClick={handleRefresh} className="px-5 py-2 text-sm font-medium text-white bg-gray-800 rounded hover:bg-gray-900">
                Refresh
              </button>
            </div>
          </div>
        )}

        {/* Process Flow Sub-tab */}
        {presSubTab === 'process-flow' && (() => {
          const boxStyle = "px-4 py-2 border-2 border-blue-400 rounded text-xs text-blue-600 font-medium text-center bg-white min-w-[160px] whitespace-nowrap";
          const arrowDown = <div className="flex justify-center my-1"><svg width="12" height="20" viewBox="0 0 12 20"><line x1="6" y1="0" x2="6" y2="14" stroke="#6366f1" strokeWidth="2"/><polygon points="1,14 6,20 11,14" fill="#6366f1"/></svg></div>;
          const arrowRight = <div className="flex items-center mx-1"><svg width="24" height="12" viewBox="0 0 24 12"><line x1="0" y1="6" x2="18" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="18,1 24,6 18,11" fill="#6366f1"/></svg></div>;
          const arrowBoth = <div className="flex items-center mx-1"><svg width="28" height="12" viewBox="0 0 28 12"><line x1="6" y1="6" x2="22" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="6,1 0,6 6,11" fill="#6366f1"/><polygon points="22,1 28,6 22,11" fill="#6366f1"/></svg></div>;
          const colTitle = "text-sm font-bold text-blue-600 mb-3 text-center uppercase tracking-wide";
          return (
          <div className="space-y-8 overflow-x-auto pb-4">
            {/* Row 1: CUSTOMER, ORDERS, SUPPLIER, PROJECT */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* CUSTOMER */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>CUSTOMER</h4>
                <div className={boxStyle}>Pre - Lead</div>
                {arrowDown}
                <div className={boxStyle}>Lead</div>
                {arrowDown}
                <div className={boxStyle}>Quality Lead</div>
                {arrowDown}
                <div className={boxStyle}>Customer</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Customer Master</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Campaign</div>
                {arrowDown}
                <div className={boxStyle}>Customer Survey</div>
              </div>

              {/* ORDERS */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>ORDERS</h4>
                <div className={boxStyle}>Customer Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Order</div>
              </div>

              {/* SUPPLIER */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>SUPPLIER</h4>
                <div className={boxStyle}>Supplier Master</div>
                {arrowDown}
                <div className={boxStyle}>Vendor Master</div>
                {arrowDown}
                <div className={boxStyle}>Manufacturer Master</div>
                {arrowDown}
                <div className={boxStyle}>Price List</div>
              </div>

              {/* PROJECT */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>PROJECT</h4>
                <div className={boxStyle}>Task Management</div>
                {arrowDown}
                <div className={boxStyle}>Project Management</div>
                {arrowDown}
                <div className={boxStyle}>Timesheet</div>
              </div>
            </div>

            {/* Row 2: INVENTORY, ORDERS continued, FINANCIAL, E-COMMERCE + HRM */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* INVENTORY */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>INVENTORY</h4>
                <div className={boxStyle}>Item Master</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Shipping Instruction</div>
                  {arrowBoth}
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Receiving</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Inventory</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Return Receive</div>
                {arrowDown}
                <div className={boxStyle}>Return Authorization</div>
              </div>

              {/* ORDERS continued */}
              <div className="flex flex-col items-center mt-[36px]">
                <div className="flex items-center">
                  <div className={boxStyle}>Supplier Purchase Order</div>
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Priority</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Order Pick - Pack</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Shipping</div>
                {arrowDown}
                <div className={boxStyle}>Order Tracking</div>
              </div>

              {/* FINANCIAL */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>FINANCIAL</h4>
                <div className={boxStyle}>Supplier Invoice</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Payment</div>
                {arrowDown}
                <div className={boxStyle}>Sales Invoice</div>
                {arrowDown}
                <div className={boxStyle}>Customer Payment</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Employee Payroll</div>
                  {arrowBoth}
                </div>
                {arrowDown}
                <div className={boxStyle}>Salary Payment</div>
                {arrowDown}
                <div className={boxStyle}>Tax Payment</div>
                {arrowDown}
                <div className={boxStyle}>Bank Reconciliation</div>
              </div>

              {/* E-COMMERCE + HRM */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>E-COMMERCE</h4>
                <div className={boxStyle}>E-Commerce</div>
                {arrowDown}
                <div className={boxStyle}>Credit Card Payment</div>
                <div className="mt-6">
                  <h4 className={colTitle}>HRM</h4>
                  <div className="flex flex-col items-center">
                    <div className={boxStyle}>Recruitment</div>
                    {arrowDown}
                    <div className={boxStyle}>Employee Master</div>
                    {arrowDown}
                    <div className={boxStyle}>Leave Management</div>
                    {arrowDown}
                    <div className={boxStyle}>Employee Assessment</div>
                    {arrowDown}
                    <div className={boxStyle}>Bonus - Increment</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Row 3: DOCUMENT MANAGEMENT, FINANCIAL continued, HRM continued */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* DOCUMENT MANAGEMENT */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>DOCUMENT MANAGEMENT</h4>
                <div className={boxStyle}>Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Order</div>
                {arrowDown}
                <div className={boxStyle}>Customer</div>
                {arrowDown}
                <div className={boxStyle}>Supplier</div>
                {arrowDown}
                <div className={boxStyle}>Accounts</div>
                {arrowDown}
                <div className={boxStyle}>Order Fulfillment</div>
                {arrowDown}
                <div className={boxStyle}>Return</div>
              </div>

              {/* Spacer */}
              <div className="min-w-[160px]"></div>

              {/* FINANCIAL continued */}
              <div className="flex flex-col items-center">
                <div className={boxStyle}>Journal Ledger</div>
                {arrowDown}
                <div className={boxStyle}>Ledger</div>
                {arrowDown}
                <div className={boxStyle}>Fixed Asset</div>
                {arrowDown}
                <div className={boxStyle}>Account Statements</div>
                {arrowDown}
                <div className={boxStyle}>Tax Return</div>
                {arrowDown}
                <div className={boxStyle}>Tax Payment</div>
                {arrowDown}
                <div className={boxStyle}>Budget</div>
              </div>

              {/* HRM continued */}
              <div className="flex flex-col items-center">
                <div className={boxStyle}>Holiday Master</div>
              </div>
            </div>

            {/* Generate PDF Button */}
            <div className="flex justify-center mt-6">
              <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                Generate PDF
              </button>
            </div>
          </div>
          );
        })()}

        {/* Link Sub-tab */}
        {presSubTab === 'link' && (
          <div className="space-y-3">
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-1/3">Module / Sub-Module</th>
                    <th className="px-4 py-2.5 text-center text-xs font-medium text-white">Presentation Link</th>
                  </tr>
                </thead>
                <tbody>
                  {(() => {
                    const selectedModules: { category: string; item: string }[] = [];
                    Object.entries(modules).forEach(([category, items]) => {
                      (items || []).forEach((item: string) => {
                        selectedModules.push({ category, item });
                      });
                    });
                    if (selectedModules.length === 0) {
                      return <tr><td colSpan={2} className="px-4 py-6 text-center text-gray-400 text-xs">No Data Found</td></tr>;
                    }
                    return selectedModules.map((mod, index) => (
                      <tr key={`${mod.category}-${mod.item}`} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-4 py-2 text-xs border-b border-gray-200 text-blue-600">{mod.category} / {mod.item}</td>
                        <td className="px-4 py-2 text-xs border-b border-gray-200 text-center text-blue-600">-</td>
                      </tr>
                    ));
                  })()}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Demo Date Sub-tab */}
        {presSubTab === 'demo-date' && (
          <div className="space-y-6">
            {/* DEMO DATE TIME Header */}
            <h3 className="text-sm font-bold text-gray-800">DEMO DATE TIME</h3>

            {/* GENERAL INFORMATION Section */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-4">GENERAL INFORMATION</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-3">
                {/* Left Column */}
                <div className="space-y-3">
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Key Person's Name:</label>
                    <input type="text" value={demoDateForm.key_person_name} onChange={(e) => setDemoDateForm({ ...demoDateForm, key_person_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Company Name:</label>
                    <input type="text" value={demoDateForm.company_name} onChange={(e) => setDemoDateForm({ ...demoDateForm, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Address:</label>
                    <input type="text" value={demoDateForm.address} onChange={(e) => setDemoDateForm({ ...demoDateForm, address: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Country</label>
                    <select value={demoDateForm.country} onChange={(e) => setDemoDateForm({ ...demoDateForm, country: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                      <option value="">Country</option>
                      <option value="1">India</option>
                      <option value="2">United States</option>
                      <option value="3">United Kingdom</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Province</label>
                    <select value={demoDateForm.province} onChange={(e) => setDemoDateForm({ ...demoDateForm, province: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                      <option value="">Select State</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">City</label>
                    <select value={demoDateForm.city} onChange={(e) => setDemoDateForm({ ...demoDateForm, city: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                      <option value="">Select City</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Postal Code:</label>
                    <input type="text" value={demoDateForm.postal_code} onChange={(e) => setDemoDateForm({ ...demoDateForm, postal_code: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                {/* Right Column */}
                <div className="space-y-3">
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Company Phone:</label>
                    <input type="text" value={demoDateForm.company_phone} onChange={(e) => setDemoDateForm({ ...demoDateForm, company_phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">EXT:</label>
                    <input type="text" value={demoDateForm.ext} onChange={(e) => setDemoDateForm({ ...demoDateForm, ext: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Fax:</label>
                    <input type="text" value={demoDateForm.fax} onChange={(e) => setDemoDateForm({ ...demoDateForm, fax: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Email:</label>
                    <input type="email" value={demoDateForm.email} onChange={(e) => setDemoDateForm({ ...demoDateForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Website:</label>
                    <input type="text" value={demoDateForm.website} onChange={(e) => setDemoDateForm({ ...demoDateForm, website: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Any Branch Office:</label>
                    <input type="text" value={demoDateForm.any_branch_office} onChange={(e) => setDemoDateForm({ ...demoDateForm, any_branch_office: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Branch Address:</label>
                    <input type="text" value={demoDateForm.branch_address} onChange={(e) => setDemoDateForm({ ...demoDateForm, branch_address: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
              </div>
            </div>

            {/* ARRANGE DEMO SESSION Section */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-4">ARRANGE DEMO SESSION</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-3">
                {/* Left Column */}
                <div className="space-y-3">
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Preferred Date:</label>
                    <input type="date" value={demoDateForm.preferred_date} onChange={(e) => setDemoDateForm({ ...demoDateForm, preferred_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Preferred Time:</label>
                    <input type="time" value={demoDateForm.preferred_time} onChange={(e) => setDemoDateForm({ ...demoDateForm, preferred_time: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                {/* Right Column */}
                <div className="space-y-3">
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Remark:</label>
                    <input type="text" value={demoDateForm.remark} onChange={(e) => setDemoDateForm({ ...demoDateForm, remark: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">TimeZone:</label>
                    <select value={demoDateForm.timezone} onChange={(e) => setDemoDateForm({ ...demoDateForm, timezone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                      <option value="">Select TimeZone</option>
                      <option value="1">UTC-12:00</option>
                      <option value="2">UTC-11:00</option>
                      <option value="3">UTC-10:00</option>
                      <option value="4">UTC-09:00</option>
                      <option value="5">UTC-08:00 (PST)</option>
                      <option value="6">UTC-07:00 (MST)</option>
                      <option value="7">UTC-06:00 (CST)</option>
                      <option value="8">UTC-05:00 (EST)</option>
                      <option value="9">UTC+00:00 (GMT)</option>
                      <option value="10">UTC+05:30 (IST)</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Questions Sub-tab */}
        {presSubTab === 'questions' && (
          <div className="space-y-4">
            {/* Top Row - Presentation Date and Attended By */}
            <div className="grid grid-cols-2 gap-x-8 gap-y-3">
              <div className="flex items-center gap-3">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap">Presentation Date</label>
                <input type="date" value={questionsForm.presentation_date} onChange={(e) => setQuestionsForm({ ...questionsForm, presentation_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
              </div>
              <div className="flex items-center gap-3">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap">Attended By</label>
                <select multiple value={questionsForm.attended_by} onChange={(e) => setQuestionsForm({ ...questionsForm, attended_by: Array.from(e.target.selectedOptions, opt => opt.value) })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="">Nothing selected</option>
                  {presContacts.map((contact: any) => (
                    <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                  ))}
                </select>
                <button type="button" className="w-8 h-8 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-50">
                  <Plus className="w-4 h-4" />
                </button>
              </div>
            </div>

            {/* Presentation By Row */}
            <div className="grid grid-cols-2 gap-x-8">
              <div className="flex items-center gap-3">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap">Presentation By</label>
                <select value={questionsForm.presentation_by} onChange={(e) => setQuestionsForm({ ...questionsForm, presentation_by: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="">Please Select Presentation By</option>
                  <option value="1">Admin User</option>
                  <option value="Junaid Ali">Junaid Ali</option>
                </select>
              </div>
            </div>

            {/* Questions Table */}
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Date</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Added By</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Question</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Category</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Asked by</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Answered</th>
                    <th className="px-2 py-2 text-center text-xs font-medium text-white w-16">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {/* Input Row */}
                  <tr className="bg-white">
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <div className="flex items-center gap-1">
                        <Calendar className="w-4 h-4 text-yellow-500" />
                        <input type="date" value={questionRow.date} onChange={(e) => setQuestionRow({ ...questionRow, date: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                      </div>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={questionRow.added_by} onChange={(e) => setQuestionRow({ ...questionRow, added_by: e.target.value })} placeholder="Added By" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={questionRow.question} onChange={(e) => setQuestionRow({ ...questionRow, question: e.target.value })} placeholder="Question" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={questionRow.category} onChange={(e) => setQuestionRow({ ...questionRow, category: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        <option value="Technical">Technical</option>
                        <option value="Functional">Functional</option>
                        <option value="Commercial">Commercial</option>
                        <option value="General">General</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={questionRow.asked_by} onChange={(e) => setQuestionRow({ ...questionRow, asked_by: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Asked By</option>
                        {presContacts.map((contact: any) => (
                          <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                        ))}
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={questionRow.answered} onChange={(e) => setQuestionRow({ ...questionRow, answered: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Answer</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="Pending">Pending</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200 text-center">
                      <button onClick={handleAddQuestion} className="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Add</button>
                    </td>
                  </tr>
                  {/* Data Rows */}
                  {questionsList.length === 0 ? (
                    <tr><td colSpan={7} className="px-4 py-6 text-center text-gray-400 text-xs">No questions added</td></tr>
                  ) : (
                    questionsList.map((q, index) => (
                      <tr key={q.id} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.date || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.added_by || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.question || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.category || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.asked_by || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.answered || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">
                          <button onClick={() => handleDeleteQuestion(q.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Summary Sub-tab */}
        {presSubTab === 'summary' && (
          <div className="space-y-3">
            {/* Summary Table */}
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Category</th>
                    <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Asked by</th>
                    <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-36">Added By</th>
                    <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Question</th>
                    <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Answered</th>
                    <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Module</th>
                    <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Notes</th>
                    <th className="px-2 py-2.5 text-center text-xs font-medium text-white w-16">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {/* Input Row */}
                  <tr className="bg-white">
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={summaryRow.category} onChange={(e) => setSummaryRow({ ...summaryRow, category: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        <option value="Technical">Technical</option>
                        <option value="Functional">Functional</option>
                        <option value="Commercial">Commercial</option>
                        <option value="General">General</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={summaryRow.asked_by} onChange={(e) => setSummaryRow({ ...summaryRow, asked_by: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Asked By</option>
                        {presContacts.map((contact: any) => (
                          <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                        ))}
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={summaryRow.added_by} onChange={(e) => setSummaryRow({ ...summaryRow, added_by: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Added By</option>
                        <option value="1">Admin User</option>
                        <option value="Junaid Ali">Junaid Ali</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={summaryRow.question} onChange={(e) => setSummaryRow({ ...summaryRow, question: e.target.value })} placeholder="Question" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={summaryRow.answered} onChange={(e) => setSummaryRow({ ...summaryRow, answered: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Answer</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="Pending">Pending</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={summaryRow.module} onChange={(e) => setSummaryRow({ ...summaryRow, module: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Module</option>
                        {Object.keys(PRESENTATION_MODULES).map(cat => (
                          <option key={cat} value={cat}>{cat}</option>
                        ))}
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={summaryRow.notes} onChange={(e) => setSummaryRow({ ...summaryRow, notes: e.target.value })} placeholder="Notes" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200 text-center">
                      <button onClick={handleAddSummary} className="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Add</button>
                    </td>
                  </tr>
                  {/* Data Rows */}
                  {summaryList.length === 0 ? (
                    <tr><td colSpan={8} className="px-4 py-6 text-center text-gray-400 text-xs">No summary items added</td></tr>
                  ) : (
                    summaryList.map((s, index) => (
                      <tr key={s.id} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{s.category || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{s.asked_by || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{s.added_by || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{s.question || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{s.answered || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{s.module || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{s.notes || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">
                          <button onClick={() => handleDeleteSummary(s.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Follow-Up Sub-tab */}
        {presSubTab === 'follow-up' && (
          <div className="space-y-3">
            <div>
              <button onClick={() => handleOpenPresFollowUp()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                    <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {presFollowUps.length === 0 ? (
                    <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                  ) : (
                    presFollowUps.map((activity: any, index: number) => (
                      <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                          <div className="flex gap-1 justify-center">
                            <button onClick={() => handleOpenPresFollowUp(activity)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                            <button onClick={() => handleDeletePresFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Memo Sub-tab */}
        {presSubTab === 'memo' && (
          <div className="space-y-3">
            <div>
              <button onClick={() => handleOpenPresMemo()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                    <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {presMemos.length === 0 ? (
                    <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                  ) : (
                    presMemos.map((memo: any, index: number) => (
                      <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                          <div className="flex gap-1 justify-center">
                            <button onClick={() => handleOpenPresMemo(memo)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                            <button onClick={() => handleDeletePresMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Upload File Sub-tab */}
        {presSubTab === 'upload-file' && (
          <div className="space-y-4">
            {/* Document Row */}
            <div className="flex items-center gap-4">
              <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
              <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={presSubTabFile?.name || ''} />
              <input ref={presSubTabFileRef} type="file" onChange={handlePresSubTabFileChange} className="hidden" style={{ display: 'none' }} />
              <button type="button" onClick={handlePresSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
              <button type="button" onClick={handlePresSubTabUpload} disabled={!presSubTabFile || presSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed">{presSubTabUploading ? 'Uploading...' : 'Upload'}</button>
            </div>
            {/* Notes Row */}
            <div className="flex items-center gap-4">
              <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
              <input type="text" value={presSubTabNotes} onChange={(e) => setPresSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            </div>
            {/* Table */}
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                    <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {presSubTabDocs.length === 0 ? (
                    <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                  ) : (
                    presSubTabDocs.map((doc: any, index: number) => (
                      <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                          <div className="flex gap-1 justify-center">
                            {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                            <button onClick={() => handlePresSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Workflow & Audit Trail Sub-tab */}
        {presSubTab === 'workflow-audit-trail' && (
          <div className="p-4 text-center text-gray-500 text-sm">
            Workflow & Audit Trail - Activity logs will appear here.
          </div>
        )}
      </div>

      {/* Follow-Up Modal */}
      {showPresFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button onClick={() => setShowPreviousActivities(!showPreviousActivities)} className="px-3 py-1 text-xs font-medium text-blue-900 bg-blue-500 rounded hover:bg-blue-400">View Previous Activities</button>
              </div>
              <button onClick={() => setShowPresFollowUpModal(false)} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            {/* Body */}
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                {/* Contact */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select
                    value={presFollowUpForm.contact_id}
                    onChange={(e) => {
                      const contactId = e.target.value;
                      const selectedContact = presContacts.find((c: any) => c.id?.toString() === contactId);
                      setPresFollowUpForm({
                        ...presFollowUpForm,
                        contact_id: contactId,
                        sent_to: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || ''
                      });
                    }}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  >
                    <option value="">Select Contact</option>
                    {presContacts.map((contact: any) => (
                      <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                    ))}
                  </select>
                </div>
                {/* Activity Subject */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={presFollowUpForm.subject} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                {/* Email */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={presFollowUpForm.sent_to} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readOnly />
                </div>
                {/* Activity Type */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={presFollowUpForm.activity_type} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                {/* Start Date / Time */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={presFollowUpForm.start_date} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <input type="time" value={presFollowUpForm.start_time} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                {/* Assigned To */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={presFollowUpForm.assigned_to} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select User</option>
                    <option value="1">Admin User</option>
                    <option value="Junaid Ali">Junaid Ali</option>
                  </select>
                </div>
                {/* Next Follow Up Date */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={presFollowUpForm.next_followup_date} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                {/* Status */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={presFollowUpForm.status} onChange={(e) => setPresFollowUpForm({ ...presFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              {/* Description */}
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                {/* Rich Text Toolbar */}
                <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresFollowUpExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded" title="Bold">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresFollowUpExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded" title="Italic">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresFollowUpExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded" title="Underline">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresFollowUpExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Highlight"><Edit2 className="w-3.5 h-3.5" /></button>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <select onChange={(e) => { handlePresFollowUpExec('fontName', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                  </select>
                  <select onChange={(e) => { handlePresFollowUpExec('fontSize', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                    <option value="1">8</option>
                    <option value="2">10</option>
                    <option value="3">12</option>
                    <option value="4">14</option>
                    <option value="5">18</option>
                    <option value="6">24</option>
                    <option value="7">36</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300" title="Text Color">A</button>
                    <input type="color" onChange={(e) => handlePresFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Text Color" />
                  </div>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresFollowUpExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Bullet List">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresFollowUpExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Numbered List">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                  <select onChange={(e) => { handlePresFollowUpExec(e.target.value === 'left' ? 'justifyLeft' : e.target.value === 'center' ? 'justifyCenter' : e.target.value === 'right' ? 'justifyRight' : 'justifyFull'); e.target.value = ''; }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer">
                    <option value="">Align</option>
                    <option value="left">Left</option>
                    <option value="center">Center</option>
                    <option value="right">Right</option>
                    <option value="justify">Justify</option>
                  </select>
                </div>
                {/* Rich Text Editor */}
                <div ref={presFollowUpEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y" style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }} suppressContentEditableWarning />
              </div>
              {/* Save Button */}
              <div className="flex justify-center mt-5">
                <button onClick={handleSavePresFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showPresMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => setShowPresMemoModal(false)} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresMemoExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded" title="Bold">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresMemoExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded" title="Italic">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresMemoExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded" title="Underline">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresMemoExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Highlight"><Edit2 className="w-3.5 h-3.5" /></button>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <select onChange={(e) => { handlePresMemoExec('fontName', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                  <option value="jost">jost</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Courier New">Courier New</option><option value="Georgia">Georgia</option><option value="Verdana">Verdana</option>
                </select>
                <select onChange={(e) => { handlePresMemoExec('fontSize', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                  <option value="1">8</option><option value="2">10</option><option value="3">12</option><option value="4">14</option><option value="5">18</option><option value="6">24</option><option value="7">36</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300" title="Text Color">A</button>
                  <input type="color" onChange={(e) => handlePresMemoExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Text Color" />
                </div>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresMemoExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Bullet List">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePresMemoExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Numbered List">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
                <select onChange={(e) => { handlePresMemoExec(e.target.value === 'left' ? 'justifyLeft' : e.target.value === 'center' ? 'justifyCenter' : e.target.value === 'right' ? 'justifyRight' : 'justifyFull'); e.target.value = ''; }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer">
                  <option value="">Align</option><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option><option value="justify">Justify</option>
                </select>
              </div>
              <div ref={presMemoEditorRef} contentEditable className="w-full min-h-[220px] max-h-[400px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y" style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5">
                <button onClick={handleSavePresMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Demo Module Categories ==============
const DEMO_MODULES: Record<string, string[]> = {
  'Customer': ['Customer Master', 'CRM', 'Campaign', 'Customer Survey'],
  'Supplier': ['Supplier Master', 'Vendor Master', 'Manufacturer Master', 'Price List'],
  'Inventory': ['Item Master', 'E-Commerce', 'Requisition', 'Shipping Instruction', 'Receiving', 'Discount', 'Return', 'Inventory'],
  'Orders': ['Inquiry', 'Quotation', 'Order', 'Fulfillment Priority', 'Order Fulfillment', 'Wave Pick', 'Order Tracking'],
  'Financials': ['Account Receivable', 'Account Payable', 'Journal Entry', 'Ledger', 'Payroll', 'Incentive', 'Banking', 'Asset Management', 'Account Statement', 'Tax Connect', 'Regulatory Compliance', 'Budgeting'],
  'HRM': ['Employee Master', 'Leave Master', 'Holiday Master', 'Recruitment', 'Appraisal', 'Bonus'],
  'Project': ['Task Management', 'Project Management', 'Timesheet'],
  'Reports': ['Customer', 'Crm', 'Supplier', 'Orders', 'Financials', 'HRM', 'Project', 'Inventory', 'Management', 'Business Intelligence'],
  'DMS': ['Return', 'Accounts', 'Supplier', 'Customer', 'Order', 'Quotation', 'Inquiry', 'Order Fulfillment', 'Other Folders', 'Item'],
  'My Info': ['Holiday Calendar', 'My Favorite', 'Leave Management', 'My Dashboard', 'Message Board', 'Notifications', 'Calendar', 'Attendance Management', 'Ticketing'],
  'Setup': ['Role Mgmt', 'Bank Master', 'Accounting', 'Configuration', 'Company Setup', 'User Mgmt', 'Option Master', 'Variant Master', 'Auto Scheduler', 'Form Management'],
};

// ============== Demo Form ==============
function DemoForm({ data, setData, crId, leadId, demos, refreshData, onOpenEmailModal }: any) {
  const [demoSubTab, setDemoSubTab] = useState('demo-video');
  const [demoContacts, setDemoContacts] = useState<any[]>([]);
  const [demoDocs, setDemoDocs] = useState<any[]>([]);
  const [demoEmailsSent, setDemoEmailsSent] = useState<any[]>([]);
  const [demoEmailTemplates, setDemoEmailTemplates] = useState<any[]>([]);
  const [saving, setSaving] = useState(false);

  // Form state
  const [demoFormData, setDemoFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });

  // File upload state
  const [demoFile, setDemoFile] = useState<File | null>(null);
  const [demoUploading, setDemoUploading] = useState(false);
  const demoFileRef = React.useRef<HTMLInputElement>(null);

  // Module checkboxes state
  const [demoModules, setDemoModules] = useState<Record<string, string[]>>({});

  // Sub-tab states
  const [demoFollowUps, setDemoFollowUps] = useState<any[]>([]);
  const [showDemoFollowUpModal, setShowDemoFollowUpModal] = useState(false);
  const [editingDemoFollowUp, setEditingDemoFollowUp] = useState<any>(null);
  const [demoFollowUpForm, setDemoFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', end_date: '', end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: '', next_followup_time: '', channel_type: '', sent_to: '',
  });
  const demoFollowUpEditorRef = React.useRef<HTMLDivElement>(null);
  const [showDemoPreviousActivities, setShowDemoPreviousActivities] = useState(false);

  const [demoMemos, setDemoMemos] = useState<any[]>([]);
  const [showDemoMemoModal, setShowDemoMemoModal] = useState(false);
  const [editingDemoMemo, setEditingDemoMemo] = useState<any>(null);
  const [demoMemoForm, setDemoMemoForm] = useState({ content: '' });
  const demoMemoEditorRef = React.useRef<HTMLDivElement>(null);

  const [demoSubTabDocs, setDemoSubTabDocs] = useState<any[]>([]);
  const [demoSubTabFile, setDemoSubTabFile] = useState<File | null>(null);
  const [demoSubTabNotes, setDemoSubTabNotes] = useState('');
  const [demoSubTabUploading, setDemoSubTabUploading] = useState(false);
  const demoSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Post-Demo Business Questionnaire State
  const [postDemoForm, setPostDemoForm] = useState({
    // General Information
    key_person_name: '', company_name: '', address: '', country: '', province: '', city: '', postal_code: '',
    company_phone: '', ext: '', fax: '', email: '', website: '', any_branch_office: '', branch_address: '',
    // Company Profile
    years_in_operation: '', company_size: '', annual_revenue: '', products_services_range: '', current_software_solution: '',
    company_legal_structure: '', industry: '', type_of_business: '', market: '', software_installation_type: '',
    // Notes
    completed_by: '', date: '', designation: ''
  });
  const [systemsSoftware, setSystemsSoftware] = useState<Record<string, string>>({});
  const [erpBenefits, setErpBenefits] = useState<Record<string, { checked: boolean; importance: string }>>({});
  const [currentFeatures, setCurrentFeatures] = useState<Record<string, { checked: boolean; method: string }>>({});
  const [newFeatures, setNewFeatures] = useState<Record<string, boolean>>({});

  // Demo Questions State
  const [demoQuestionsForm, setDemoQuestionsForm] = useState({
    presentation_date: '', attended_by: [] as string[], presentation_by: ''
  });
  const [demoQuestionRow, setDemoQuestionRow] = useState({
    date: '', added_by: '', question: '', category: '', asked_by: '', answered: ''
  });
  const [demoQuestionsList, setDemoQuestionsList] = useState<any[]>([]);

  const handleAddDemoQuestion = () => {
    if (!demoQuestionRow.question) return;
    setDemoQuestionsList([...demoQuestionsList, { ...demoQuestionRow, id: Date.now() }]);
    setDemoQuestionRow({ date: '', added_by: '', question: '', category: '', asked_by: '', answered: '' });
  };

  const handleDeleteDemoQuestion = (id: number) => {
    setDemoQuestionsList(demoQuestionsList.filter(q => q.id !== id));
  };

  // Demo Result State
  const [demoResultForm, setDemoResultForm] = useState({
    result_status: '', comments: '', next_step: ''
  });

  const handleSaveDemoResult = () => {
    console.log('Saving demo result:', demoResultForm);
    // API call would go here
  };

  // Demo Feedback Survey State
  const [demoFeedback, setDemoFeedback] = useState({
    // Section 1: General Experience
    q1_satisfaction: '',
    q2_informative: '',
    q3_expectations: '',
    // Section 2: Product Fit & Features
    q4_relevant_features: '',
    q5_explain_features: '',
    q6_alignment: '',
    // Section 3: Presentation & Communication
    q7_presenter_rating: '',
    q8_demo_length: '',
    // Section 4: Queries & Next Steps
    q9_questions: '',
    q10_followup: '',
    // Section 5: Final Feedback
    q11_likelihood: '',
    q12_additional_feedback: ''
  });

  // Initialize form from data
  useEffect(() => {
    if (data) {
      setDemoFormData({
        company_name: data.company_name || '',
        contact_name: data.contact_name || '',
        email_format_type: 'Email Demo Details to Customer',
        branch_office: data.branch_office || '',
        contact_email: data.contact_email || ''
      });
    }
  }, [data]);

  // Load contacts
  useEffect(() => {
    if (leadId) {
      api.getLeadContactsForEdit(leadId).then(setDemoContacts).catch(() => setDemoContacts([]));
    }
  }, [leadId]);

  // Load email templates for Demo tab
  useEffect(() => {
    api.getCRIEmailTemplates('Demo').then(setDemoEmailTemplates).catch(() => setDemoEmailTemplates([]));
  }, []);

  // Load documents
  useEffect(() => {
    if (crId) {
      api.getCRDocuments(crId, 'demo').then(setDemoDocs).catch(() => setDemoDocs([]));
    }
  }, [crId]);

  // Load sub-tab data
  useEffect(() => {
    if (crId && demoSubTab === 'follow-up') {
      api.getCRActivities(crId, 'demo-followup').then(setDemoFollowUps).catch(() => setDemoFollowUps([]));
    }
  }, [crId, demoSubTab]);

  useEffect(() => {
    if (crId && demoSubTab === 'memo') {
      api.getCRMemos(crId, 'demo').then(setDemoMemos).catch(() => setDemoMemos([]));
    }
  }, [crId, demoSubTab]);

  useEffect(() => {
    if (crId && demoSubTab === 'upload-file') {
      api.getCRDocuments(crId, 'demo-upload').then(setDemoSubTabDocs).catch(() => setDemoSubTabDocs([]));
    }
  }, [crId, demoSubTab]);

  // Document handlers
  const handleDemoChooseFile = () => demoFileRef.current?.click();
  const handleDemoFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setDemoFile(e.target.files[0]); };
  const handleDemoUpload = async () => {
    if (!demoFile || !crId) return;
    setDemoUploading(true);
    try {
      await api.uploadCRDocument(crId, demoFile, 'demo', 'Details');
      const docs = await api.getCRDocuments(crId, 'demo');
      setDemoDocs(docs);
      setDemoFile(null);
      if (demoFileRef.current) demoFileRef.current.value = '';
    } catch (err) { alert('Failed to upload'); }
    setDemoUploading(false);
  };
  const handleDemoDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setDemoDocs(demoDocs.filter(d => d.id !== docId)); } catch { alert('Failed to delete'); }
  };

  // Module toggle
  const toggleDemoModule = (category: string, item: string) => {
    setDemoModules(prev => {
      const current = prev[category] || [];
      const updated = current.includes(item) ? current.filter(i => i !== item) : [...current, item];
      return { ...prev, [category]: updated };
    });
  };

  // Follow-up handlers
  const handleOpenDemoFollowUp = (item?: any) => {
    if (item) { setEditingDemoFollowUp(item); setDemoFollowUpForm({ activity_type: item.activity_type || '', subject: item.subject || '', start_date: item.start_date || '', start_time: item.start_time || '', end_date: item.end_date || '', end_time: item.end_time || '', description: item.description || '', status: item.status || 'Open', contact_id: item.contact_id?.toString() || '', assigned_to: item.assigned_to?.toString() || '', priority: item.priority || '', next_followup_date: item.next_followup_date || '', next_followup_time: item.next_followup_time || '', channel_type: item.channel_type || '', sent_to: item.sent_to || '' }); }
    else { setEditingDemoFollowUp(null); const now = new Date(); setDemoFollowUpForm({ activity_type: '', subject: '', start_date: now.toISOString().split('T')[0], start_time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), end_date: now.toISOString().split('T')[0], end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: now.toISOString().split('T')[0], next_followup_time: '', channel_type: '', sent_to: '' }); }
    setShowDemoFollowUpModal(true);
    setTimeout(() => { if (demoFollowUpEditorRef.current) demoFollowUpEditorRef.current.innerHTML = item?.description || ''; }, 50);
  };
  const handleDemoFollowUpExec = (command: string, value?: string) => { document.execCommand(command, false, value || ''); demoFollowUpEditorRef.current?.focus(); };
  const handleSaveDemoFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = demoFollowUpEditorRef.current?.innerHTML || demoFollowUpForm.description;
    const formToSave = { ...demoFollowUpForm, description: descriptionContent };
    try {
      if (editingDemoFollowUp) { const updated = await api.updateCRActivity(crId, editingDemoFollowUp.id, formToSave); setDemoFollowUps(demoFollowUps.map((a: any) => a.id === editingDemoFollowUp.id ? updated : a)); }
      else { const created = await api.createCRActivity(crId, { ...formToSave, tab_name: 'demo-followup' }); setDemoFollowUps([...demoFollowUps, created]); }
      setShowDemoFollowUpModal(false); setEditingDemoFollowUp(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteDemoFollowUp = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRActivity(crId, id); setDemoFollowUps(demoFollowUps.filter((a: any) => a.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleOpenDemoMemo = (item?: any) => {
    if (item) { setEditingDemoMemo(item); setDemoMemoForm({ content: item.content || '' }); }
    else { setEditingDemoMemo(null); setDemoMemoForm({ content: '' }); }
    setShowDemoMemoModal(true);
    setTimeout(() => { if (demoMemoEditorRef.current) demoMemoEditorRef.current.innerHTML = item?.content || ''; }, 50);
  };
  const handleDemoMemoExec = (command: string, value?: string) => { document.execCommand(command, false, value || ''); demoMemoEditorRef.current?.focus(); };
  const handleSaveDemoMemo = async () => {
    if (!crId) return;
    const content = demoMemoEditorRef.current?.innerHTML || demoMemoForm.content;
    try {
      if (editingDemoMemo) { const updated = await api.updateCRMemo(crId, editingDemoMemo.id, { content }); setDemoMemos(demoMemos.map((m: any) => m.id === editingDemoMemo.id ? updated : m)); }
      else { const created = await api.createCRMemo(crId, { content, tab_name: 'demo' }); setDemoMemos([...demoMemos, created]); }
      setShowDemoMemoModal(false); setEditingDemoMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteDemoMemo = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRMemo(crId, id); setDemoMemos(demoMemos.filter((m: any) => m.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Sub-tab file handlers
  const handleDemoSubTabChooseFile = () => demoSubTabFileRef.current?.click();
  const handleDemoSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setDemoSubTabFile(e.target.files[0]); };
  const handleDemoSubTabUpload = async () => {
    if (!demoSubTabFile || !crId) return;
    setDemoSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, demoSubTabFile, 'demo-upload', demoSubTabNotes);
      const docs = await api.getCRDocuments(crId, 'demo-upload');
      setDemoSubTabDocs(docs);
      setDemoSubTabFile(null);
      setDemoSubTabNotes('');
      if (demoSubTabFileRef.current) demoSubTabFileRef.current.value = '';
    } catch (err) { alert('Failed to upload'); }
    setDemoSubTabUploading(false);
  };
  const handleDemoSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setDemoSubTabDocs(demoSubTabDocs.filter(d => d.id !== docId)); } catch { alert('Failed to delete'); }
  };

  // Save handler
  const handleSaveDemo = async () => {
    if (!crId) return;
    setSaving(true);
    try {
      // Save demo modules or other data as needed
      alert('Saved successfully');
    } catch (err) { alert('Failed to save'); }
    setSaving(false);
  };

  const demoSubTabs = [
    { id: 'demo-video', label: 'Demo Video' },
    { id: 'post-demo-questionnaire', label: 'Post-Demo Business Questionnaire' },
    { id: 'process-flow', label: 'Process Flow' },
    { id: 'link', label: 'Link' },
    { id: 'questions', label: 'Questions' },
    { id: 'result', label: 'Result' },
    { id: 'follow-up', label: 'Follow-Up' },
    { id: 'demo-feedback', label: 'Demo Feedback' },
    { id: 'memo', label: 'Memo' },
    { id: 'upload-file', label: 'Upload File' },
    { id: 'workflow-audit-trail', label: 'Workflow & Audit Trail' },
  ];

  const thClass = "px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600";
  const tdClass = "px-3 py-2 text-xs border-b border-gray-200";

  return (
    <div className="space-y-4">
      {/* Top Form Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={demoFormData.company_name} onChange={(e) => setDemoFormData({ ...demoFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-orange-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={demoFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = demoContacts.find((c: any) => c.id?.toString() === cid); setDemoFormData({ ...demoFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {demoContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={demoFormData.email_format_type} onChange={(e) => setDemoFormData({ ...demoFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {demoEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Demo', demoFormData.contact_email, demoEmailTemplates.find((t: any) => t.email_format === demoFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>
        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={demoFormData.branch_office} onChange={(e) => setDemoFormData({ ...demoFormData, branch_office: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={demoFormData.contact_email} onChange={(e) => setDemoFormData({ ...demoFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <div className="flex-1 flex gap-2">
              <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={demoFile?.name || ''} />
              <input ref={demoFileRef} type="file" onChange={handleDemoFileChange} className="hidden" />
              <button onClick={handleDemoChooseFile} className="h-8 px-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
              <button onClick={handleDemoUpload} disabled={!demoFile || demoUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{demoUploading ? 'Uploading...' : 'Upload'}</button>
            </div>
          </div>
        </div>
      </div>

      {/* Two Tables Row */}
      <div className="grid grid-cols-2 gap-4">
        {/* Email Sent To Table */}
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-700">
                <th className={thClass}>Email Sent To</th>
                <th className={thClass}>Attachments</th>
                <th className={thClass}>Sent On</th>
                <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-20">Action</th>
              </tr>
            </thead>
            <tbody>
              {demoEmailsSent.length === 0 ? (
                <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
              ) : (
                demoEmailsSent.map((email: any, index: number) => (
                  <tr key={email.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className={tdClass}>{email.sent_to || '-'}</td>
                    <td className={tdClass}>{email.attachments || '-'}</td>
                    <td className={tdClass}>{email.sent_on || '-'}</td>
                    <td className={`${tdClass} text-center`}>
                      <button className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

        {/* File Name Table */}
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-700">
                <th className={thClass}>File Name</th>
                <th className={thClass}>Link</th>
                <th className={thClass}>Size</th>
                <th className={thClass}>Upload On</th>
                <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-20">Action</th>
              </tr>
            </thead>
            <tbody>
              {demoDocs.length === 0 ? (
                <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
              ) : (
                demoDocs.map((doc: any, index: number) => (
                  <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className={`${tdClass} text-blue-600`}>{doc.file_name}</td>
                    <td className={`${tdClass} text-blue-600`}>{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service.delta.axieve...</a> : '-'}</td>
                    <td className={tdClass}>{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                    <td className={tdClass}>{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                    <td className={`${tdClass} text-center`}>
                      <div className="flex gap-1 justify-center">
                        <input type="checkbox" className="w-4 h-4" />
                        <button onClick={() => handleDemoDeleteDoc(doc.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Sub-tabs */}
      <div className="flex gap-1 border-b border-gray-200 overflow-x-auto">
        {demoSubTabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setDemoSubTab(tab.id)}
            className={`px-3 py-2 text-xs font-medium whitespace-nowrap rounded-t transition-colors ${demoSubTab === tab.id ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`}
          >
            {tab.label}
          </button>
        ))}
      </div>

      {/* Sub-tab Content */}
      <div className="min-h-[200px]">
        {/* Demo Video Sub-tab - Module Checkboxes */}
        {demoSubTab === 'demo-video' && (
          <div className="space-y-4">
            <div className="grid grid-cols-4 gap-4">
              {Object.entries(DEMO_MODULES).map(([category, items]) => (
                <div key={category} className="border rounded overflow-hidden">
                  <div className="bg-blue-700 px-3 py-2">
                    <span className="text-xs font-medium text-white">{category}</span>
                  </div>
                  <div className="p-2 space-y-1">
                    {items.map(item => (
                      <label key={item} className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={(demoModules[category] || []).includes(item)}
                          onChange={() => toggleDemoModule(category, item)}
                          className="w-3.5 h-3.5 rounded border-gray-300"
                        />
                        <span className="text-xs text-blue-600">{item}</span>
                      </label>
                    ))}
                  </div>
                </div>
              ))}
            </div>
            {/* Save and Refresh Buttons */}
            <div className="flex justify-center gap-2 mt-4">
              <button onClick={handleSaveDemo} disabled={saving} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
              <button onClick={refreshData} className="px-6 py-2 text-sm font-medium text-white bg-gray-500 rounded hover:bg-gray-600">Refresh</button>
            </div>
          </div>
        )}

        {/* Post-Demo Business Questionnaire Sub-tab */}
        {demoSubTab === 'post-demo-questionnaire' && (
          <div className="space-y-6 max-h-[600px] overflow-y-auto pr-2">
            {/* Header */}
            <div>
              <h3 className="text-sm font-bold text-gray-800 mb-2">POST-DEMO BUSINESS QUESTIONNAIRE</h3>
              <p className="text-xs text-gray-600 italic">
                This Post-Demo Business Questionnaire is a software needs analysis form! Your input is invaluable in helping us understand your company's unique requirements. Please provide accurate and detailed information to ensure we tailor our solutions to perfectly fit your needs. Let's begin!
              </p>
            </div>

            {/* GENERAL INFORMATION */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-3">GENERAL INFORMATION</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Key Person's Name:</label><input type="text" value={postDemoForm.key_person_name} onChange={(e) => setPostDemoForm({ ...postDemoForm, key_person_name: e.target.value })} placeholder="Key Person's Name" className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Company Phone:</label><input type="text" value={postDemoForm.company_phone} onChange={(e) => setPostDemoForm({ ...postDemoForm, company_phone: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Company Name:</label><input type="text" value={postDemoForm.company_name} onChange={(e) => setPostDemoForm({ ...postDemoForm, company_name: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">EXT:</label><input type="text" value={postDemoForm.ext} onChange={(e) => setPostDemoForm({ ...postDemoForm, ext: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Address:</label><input type="text" value={postDemoForm.address} onChange={(e) => setPostDemoForm({ ...postDemoForm, address: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Fax:</label><input type="text" value={postDemoForm.fax} onChange={(e) => setPostDemoForm({ ...postDemoForm, fax: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Country</label><select value={postDemoForm.country} onChange={(e) => setPostDemoForm({ ...postDemoForm, country: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Country</option><option value="1">India</option><option value="2">United States</option><option value="3">United Kingdom</option></select></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Email:</label><input type="email" value={postDemoForm.email} onChange={(e) => setPostDemoForm({ ...postDemoForm, email: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Province</label><select value={postDemoForm.province} onChange={(e) => setPostDemoForm({ ...postDemoForm, province: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select State</option></select></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Website:</label><input type="text" value={postDemoForm.website} onChange={(e) => setPostDemoForm({ ...postDemoForm, website: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">City</label><select value={postDemoForm.city} onChange={(e) => setPostDemoForm({ ...postDemoForm, city: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select City</option></select></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Any Branch Office:</label><input type="text" value={postDemoForm.any_branch_office} onChange={(e) => setPostDemoForm({ ...postDemoForm, any_branch_office: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Postal Code:</label><input type="text" value={postDemoForm.postal_code} onChange={(e) => setPostDemoForm({ ...postDemoForm, postal_code: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Branch Address:</label><input type="text" value={postDemoForm.branch_address} onChange={(e) => setPostDemoForm({ ...postDemoForm, branch_address: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
              </div>
            </div>

            {/* COMPANY PROFILE */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-3">COMPANY PROFILE</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Years in Operation:</label><select value={postDemoForm.years_in_operation} onChange={(e) => setPostDemoForm({ ...postDemoForm, years_in_operation: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Years in Operation</option><option value="0-1">0-1 Years</option><option value="1-5">1-5 Years</option><option value="5-10">5-10 Years</option><option value="10+">10+ Years</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Company Legal Structure:</label><select value={postDemoForm.company_legal_structure} onChange={(e) => setPostDemoForm({ ...postDemoForm, company_legal_structure: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Company Legal Structure</option><option value="Sole Proprietorship">Sole Proprietorship</option><option value="Partnership">Partnership</option><option value="LLC">LLC</option><option value="Corporation">Corporation</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Company Size:</label><select value={postDemoForm.company_size} onChange={(e) => setPostDemoForm({ ...postDemoForm, company_size: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Company Size</option><option value="1-10">1-10 Employees</option><option value="11-50">11-50 Employees</option><option value="51-200">51-200 Employees</option><option value="200+">200+ Employees</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Industry:</label><select value={postDemoForm.industry} onChange={(e) => setPostDemoForm({ ...postDemoForm, industry: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Industry</option><option value="Manufacturing">Manufacturing</option><option value="Retail">Retail</option><option value="Healthcare">Healthcare</option><option value="Technology">Technology</option><option value="Other">Other</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-orange-600">Annual Revenue ($):</label><select value={postDemoForm.annual_revenue} onChange={(e) => setPostDemoForm({ ...postDemoForm, annual_revenue: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Annual Revenue</option><option value="<100K">&lt;$100K</option><option value="100K-500K">$100K-$500K</option><option value="500K-1M">$500K-$1M</option><option value="1M+">$1M+</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Type of Business:</label><select value={postDemoForm.type_of_business} onChange={(e) => setPostDemoForm({ ...postDemoForm, type_of_business: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Type of Business</option><option value="B2B">B2B</option><option value="B2C">B2C</option><option value="Both">Both</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Products/Services Range:</label><select value={postDemoForm.products_services_range} onChange={(e) => setPostDemoForm({ ...postDemoForm, products_services_range: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Products/Services Range</option><option value="1-10">1-10</option><option value="11-50">11-50</option><option value="50+">50+</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Market: (Select Applicable)</label><select value={postDemoForm.market} onChange={(e) => setPostDemoForm({ ...postDemoForm, market: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Market</option><option value="Local">Local</option><option value="Regional">Regional</option><option value="National">National</option><option value="International">International</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Current Software Solution:</label><select value={postDemoForm.current_software_solution} onChange={(e) => setPostDemoForm({ ...postDemoForm, current_software_solution: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">No</option><option value="Yes">Yes</option></select></div>
                <div className="flex items-center"><label className="w-40 text-xs font-medium text-blue-600">Software Installation Type:</label><select value={postDemoForm.software_installation_type} onChange={(e) => setPostDemoForm({ ...postDemoForm, software_installation_type: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50"><option value="">Select Current Software Solution</option><option value="On-Premise">On-Premise</option><option value="Cloud">Cloud</option><option value="Hybrid">Hybrid</option></select></div>
              </div>
            </div>

            {/* SYSTEMS AND SOFTWARE */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-2">SYSTEMS AND SOFTWARE</h4>
              <p className="text-xs text-gray-600 mb-3">Identify current pain points or inefficiencies in the existing business processes/software.</p>
              <div className="space-y-2">
                {['Manual Data Entry', 'Data Silos', 'Lack of Integration', 'Inefficient Workflows', 'Poor Communication', 'Inventory Management Issues', 'Inadequate Real Time Reporting', 'Compliance Challenges', 'Customer Service Problems', 'Resource Allocation Challenges', 'Project Management Issues', 'Employee Productivity', 'Scalability Constraints', 'Supply Chain Disruptions', 'Legacy System Limitations', 'Insufficient Training and Support', 'High Cost of Maintenance', 'Customization Constraints', 'Complex User Interface', 'Data Security Concerns', 'Limited Mobile Access', 'Difficulty in Managing Multiple Locations'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="w-64 text-xs text-blue-600 flex items-center gap-1">{item}: <span className="text-blue-400 text-xs"></span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`sys_${item}`} value="No" checked={systemsSoftware[item] === 'No'} onChange={(e) => setSystemsSoftware({ ...systemsSoftware, [item]: e.target.value })} className="w-3 h-3" /> No</label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`sys_${item}`} value="Yes" checked={systemsSoftware[item] === 'Yes'} onChange={(e) => setSystemsSoftware({ ...systemsSoftware, [item]: e.target.value })} className="w-3 h-3" /> Yes</label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`sys_${item}`} value="Not Applicable" checked={systemsSoftware[item] === 'Not Applicable'} onChange={(e) => setSystemsSoftware({ ...systemsSoftware, [item]: e.target.value })} className="w-3 h-3" /> Not Applicable</label>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* WHAT BENEFITS DO YOU EXPECT FROM THE NEW ERP SOLUTIONS */}
            <div>
              <p className="text-xs text-gray-600 mb-3">What benefits do you expect from the new ERP solutions ?</p>
              <div className="space-y-2">
                {['Increased Efficiency', 'Better Data Visibility', 'Better Integration', 'Improved Workflow', 'Effective Communication Channels', 'Better Inventory Tracking', 'Optimal Inventory Level', 'Item Location in Warehouse', 'Wave Picking', 'Real-time Information', 'Enhanced Compliance and Regulatory Adherence', 'Advanced Reporting and Analytics', 'Multiple Currency', 'Easier Management of Multiple Locations', 'Training and Support', 'Reduced Manual Errors', 'Improved Customer Satisfaction', 'Scalable Operations', 'Reduced Operational Costs', 'Integrated Supply Chain', 'Seamless Integration with Other Systems', 'Low Maintenance', 'Easy to Use/User Friendly', 'Enhanced Security Measures', 'Mobile Access and Flexibility', 'Better Decision-making Capabilities', 'Other Requirements'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64">
                      <input type="checkbox" checked={erpBenefits[item]?.checked || false} onChange={(e) => setErpBenefits({ ...erpBenefits, [item]: { ...erpBenefits[item], checked: e.target.checked } })} className="w-3 h-3" />
                      <span className="text-xs text-blue-600">{item}</span>
                    </label>
                    <div className="flex gap-4">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`erp_${item}`} value="Critical" checked={erpBenefits[item]?.importance === 'Critical'} onChange={(e) => setErpBenefits({ ...erpBenefits, [item]: { ...erpBenefits[item], importance: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Critical</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`erp_${item}`} value="Important" checked={erpBenefits[item]?.importance === 'Important'} onChange={(e) => setErpBenefits({ ...erpBenefits, [item]: { ...erpBenefits[item], importance: e.target.value } })} className="w-3 h-3" /> <span className="text-orange-500">Important</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`erp_${item}`} value="Somewhat Important" checked={erpBenefits[item]?.importance === 'Somewhat Important'} onChange={(e) => setErpBenefits({ ...erpBenefits, [item]: { ...erpBenefits[item], importance: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Somewhat Important</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`erp_${item}`} value="Not Applicable" checked={erpBenefits[item]?.importance === 'Not Applicable'} onChange={(e) => setErpBenefits({ ...erpBenefits, [item]: { ...erpBenefits[item], importance: e.target.value } })} className="w-3 h-3" /> Not Applicable</label>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* LIST KEY FEATURES IN CURRENT SOFTWARE/PROCESS */}
            <div>
              <p className="text-xs text-gray-600 mb-3">List key features in the current software/Process (Please check all that apply) ?</p>

              {/* Customer Relationship Management */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Customer Relationship Management</h5>
              <div className="space-y-1 mb-4">
                {['Customer Master (Details)', 'Customer Interactions', 'Lead Details', 'Lead Tracking/Interactions', 'Marketing Campaigns (Bulk Emails)', 'Survey and Customer Satisfaction', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`crm_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`crm_${item}`]: { ...currentFeatures[`crm_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`crm_${item}`} value="Software" checked={currentFeatures[`crm_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`crm_${item}`]: { ...currentFeatures[`crm_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`crm_${item}`} value="Word/Excel" checked={currentFeatures[`crm_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`crm_${item}`]: { ...currentFeatures[`crm_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`crm_${item}`} value="Manual" checked={currentFeatures[`crm_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`crm_${item}`]: { ...currentFeatures[`crm_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>

              {/* Vendor/Supplier Management */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Vendor/Supplier Management</h5>
              <div className="space-y-1 mb-4">
                {['Vendor/Supplier Master', 'Manufacturer and Brand Management', 'Price List', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`vendor_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`vendor_${item}`]: { ...currentFeatures[`vendor_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`vendor_${item}`} value="Software" checked={currentFeatures[`vendor_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`vendor_${item}`]: { ...currentFeatures[`vendor_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`vendor_${item}`} value="Word/Excel" checked={currentFeatures[`vendor_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`vendor_${item}`]: { ...currentFeatures[`vendor_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`vendor_${item}`} value="Manual" checked={currentFeatures[`vendor_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`vendor_${item}`]: { ...currentFeatures[`vendor_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>

              {/* Supply Chain Management */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Supply Chain Management (Order Management)</h5>
              <div className="space-y-1 mb-4">
                {['Customer Inquiry', 'Supplier Inquiry', 'Supplier Quotations', 'Customer Quotations', 'Customer Sales Order', 'Supplier Purchase Order', 'Order Receiving', 'Order Fulfillment Priority', 'Order Fulfillment', 'Shipping', 'Order Tracking', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`scm_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`scm_${item}`]: { ...currentFeatures[`scm_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`scm_${item}`} value="Software" checked={currentFeatures[`scm_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`scm_${item}`]: { ...currentFeatures[`scm_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`scm_${item}`} value="Word/Excel" checked={currentFeatures[`scm_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`scm_${item}`]: { ...currentFeatures[`scm_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`scm_${item}`} value="Manual" checked={currentFeatures[`scm_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`scm_${item}`]: { ...currentFeatures[`scm_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>

              {/* Inventory Management */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Inventory Management</h5>
              <div className="space-y-1 mb-4">
                {['Inventory Control', 'Item Master', 'Real-time E-Commerce Integration', 'Barcode', 'Tariff', 'Logistics & Material Requisition', 'Discount Management', 'RMA (Return Material Authorization)', 'Return Receiving', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`inv_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`inv_${item}`]: { ...currentFeatures[`inv_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`inv_${item}`} value="Software" checked={currentFeatures[`inv_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`inv_${item}`]: { ...currentFeatures[`inv_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`inv_${item}`} value="Word/Excel" checked={currentFeatures[`inv_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`inv_${item}`]: { ...currentFeatures[`inv_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`inv_${item}`} value="Manual" checked={currentFeatures[`inv_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`inv_${item}`]: { ...currentFeatures[`inv_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>

              {/* Financial Management */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Financial Management</h5>
              <div className="space-y-1 mb-4">
                {['Account Receivable', 'Sales Invoice', 'Customer Payment', 'Credit Note', 'Account Payable', 'Supplier Payment', 'Debit Note', 'Voucher Payment', 'General Ledger', 'Payroll', 'Asset Management', 'Bank/Credit Card Accounts', 'Banking and Bank Reconciliation', 'Account Statements', 'Sales Commissions', 'Credit Card Payments', 'Budgeting and Forecasting', 'Regulatory Compliance', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`fin_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`fin_${item}`]: { ...currentFeatures[`fin_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`fin_${item}`} value="Software" checked={currentFeatures[`fin_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`fin_${item}`]: { ...currentFeatures[`fin_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`fin_${item}`} value="Word/Excel" checked={currentFeatures[`fin_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`fin_${item}`]: { ...currentFeatures[`fin_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`fin_${item}`} value="Manual" checked={currentFeatures[`fin_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`fin_${item}`]: { ...currentFeatures[`fin_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>

              {/* Human Resource Management */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Human Resource Management</h5>
              <div className="space-y-1 mb-4">
                {['Employee Details', 'Roles and Responsibilities', 'Time and Attendance', 'Tracking / Time Sheet', 'Leave Management', 'Performance and Appraisal', 'Bonus and Increments', 'Hiring', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`hr_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`hr_${item}`]: { ...currentFeatures[`hr_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`hr_${item}`} value="Software" checked={currentFeatures[`hr_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`hr_${item}`]: { ...currentFeatures[`hr_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`hr_${item}`} value="Word/Excel" checked={currentFeatures[`hr_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`hr_${item}`]: { ...currentFeatures[`hr_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`hr_${item}`} value="Manual" checked={currentFeatures[`hr_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`hr_${item}`]: { ...currentFeatures[`hr_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>

              {/* Project Management */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Project Management</h5>
              <div className="space-y-1 mb-4">
                {['Project planning', 'Resource Allocation', 'Task Management', 'Budgeting', 'Scheduling', 'Collaboration', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`proj_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`proj_${item}`]: { ...currentFeatures[`proj_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`proj_${item}`} value="Software" checked={currentFeatures[`proj_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`proj_${item}`]: { ...currentFeatures[`proj_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`proj_${item}`} value="Word/Excel" checked={currentFeatures[`proj_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`proj_${item}`]: { ...currentFeatures[`proj_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`proj_${item}`} value="Manual" checked={currentFeatures[`proj_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`proj_${item}`]: { ...currentFeatures[`proj_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>

              {/* Other Features */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Other Features</h5>
              <div className="space-y-1 mb-4">
                {['Business Intelligence and KPIs', 'Dashboard', 'Multi-currency Support', 'Multiple Office', 'Document Management System', 'E-commerce Integration', 'Customer Portal', 'Vendor / Supplier Portal', 'Integrated Email', 'Integrated Phone System', 'Integrated Calendar', 'Message Board', 'Mobile Access', 'Work Flow Integration', 'Other'].map(item => (
                  <div key={item} className="flex items-center gap-4">
                    <label className="flex items-center gap-2 w-64"><input type="checkbox" checked={currentFeatures[`other_${item}`]?.checked || false} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`other_${item}`]: { ...currentFeatures[`other_${item}`], checked: e.target.checked } })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`other_${item}`} value="Software" checked={currentFeatures[`other_${item}`]?.method === 'Software'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`other_${item}`]: { ...currentFeatures[`other_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-red-600">Software</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`other_${item}`} value="Word/Excel" checked={currentFeatures[`other_${item}`]?.method === 'Word/Excel'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`other_${item}`]: { ...currentFeatures[`other_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-green-600">Word/Excel</span></label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name={`other_${item}`} value="Manual" checked={currentFeatures[`other_${item}`]?.method === 'Manual'} onChange={(e) => setCurrentFeatures({ ...currentFeatures, [`other_${item}`]: { ...currentFeatures[`other_${item}`], method: e.target.value } })} className="w-3 h-3" /> <span className="text-blue-600">Manual</span></label>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* LIST KEY FEATURES REQUIRED IN NEW SOFTWARE */}
            <div>
              <p className="text-xs text-orange-600 mb-3">List key features required in the new software (Please check all that apply) ?</p>

              {/* Same categories but checkboxes only */}
              <h5 className="text-sm font-medium text-blue-600 mb-2">Customer Relationship Management</h5>
              <div className="space-y-1 mb-4">
                {['Customer Master (Details)', 'Customer Interactions', 'Lead Details', 'Lead Tracking/Interactions', 'Marketing Campaigns (Bulk Emails)', 'Survey and Customer Satisfaction', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_crm_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_crm_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>

              <h5 className="text-sm font-medium text-blue-600 mb-2">Vendor/Supplier Management</h5>
              <div className="space-y-1 mb-4">
                {['Vendor/Supplier Master', 'Manufacturer and Brand Management', 'Price List', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_vendor_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_vendor_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>

              <h5 className="text-sm font-medium text-blue-600 mb-2">Supply Chain Management (Order Management)</h5>
              <div className="space-y-1 mb-4">
                {['Customer Inquiry', 'Supplier Inquiry', 'Supplier Quotations', 'Customer Quotations', 'Customer Sales Order', 'Supplier Purchase Order', 'Order Receiving', 'Order Fulfillment Priority', 'Order Fulfillment', 'Shipping', 'Order Tracking', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_scm_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_scm_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>

              <h5 className="text-sm font-medium text-blue-600 mb-2">Inventory Management</h5>
              <div className="space-y-1 mb-4">
                {['Inventory Control', 'Item Master', 'Logistics & Material Requisition', 'Real-time E-Commerce Integration', 'Barcode', 'Tariff', 'Discount Management', 'RMA (Return Material Authorization)', 'Return Receiving', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_inv_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_inv_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>

              <h5 className="text-sm font-medium text-blue-600 mb-2">Financial Management</h5>
              <div className="space-y-1 mb-4">
                {['Account Receivable', 'Sales Invoice', 'Customer Payment', 'Credit Note', 'Account Payable', 'Supplier Payment', 'Debit Note', 'Voucher Payment', 'General Ledger', 'Payroll', 'Asset Management', 'Bank/Credit Card Accounts', 'Banking and Bank Reconciliation', 'Account Statements', 'Sales Commissions', 'Credit Card Payments', 'Budgeting and Forecasting', 'Regulatory Compliance', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_fin_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_fin_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>

              <h5 className="text-sm font-medium text-blue-600 mb-2">Human Resource Management</h5>
              <div className="space-y-1 mb-4">
                {['Employee Details', 'Roles and Responsibilities', 'Time and Attendance', 'Tracking / Time Sheet', 'Leave Management', 'Performance and Appraisal', 'Bonus and Increments', 'Hiring', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_hr_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_hr_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>

              <h5 className="text-sm font-medium text-blue-600 mb-2">Project Management</h5>
              <div className="space-y-1 mb-4">
                {['Project planning', 'Resource Allocation', 'Task Management', 'Budgeting', 'Scheduling', 'Collaboration', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_proj_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_proj_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>

              <h5 className="text-sm font-medium text-blue-600 mb-2">Other Features</h5>
              <div className="space-y-1 mb-4">
                {['Business Intelligence and KPIs', 'Dashboard', 'Multi-Currency Support', 'Multiple Office', 'Document Management System', 'E-commerce Integration', 'Customer Portal', 'Vendor / Supplier portal', 'Integrated Email', 'Integrated Phone System', 'Integrated Calendar', 'Message Board', 'Mobile Access', 'Work Flow Integration', 'Other'].map(item => (
                  <label key={item} className="flex items-center gap-2"><input type="checkbox" checked={newFeatures[`new_other_${item}`] || false} onChange={(e) => setNewFeatures({ ...newFeatures, [`new_other_${item}`]: e.target.checked })} className="w-3 h-3" /><span className="text-xs text-blue-600">{item}</span></label>
                ))}
              </div>
            </div>

            {/* NOTES */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-3">NOTES:</h4>
              <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Completed By:</label><input type="text" value={postDemoForm.completed_by} onChange={(e) => setPostDemoForm({ ...postDemoForm, completed_by: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Date:</label><input type="date" value={postDemoForm.date} onChange={(e) => setPostDemoForm({ ...postDemoForm, date: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
                <div className="flex items-center"><label className="w-32 text-xs font-medium text-blue-600">Designation</label><input type="text" value={postDemoForm.designation} onChange={(e) => setPostDemoForm({ ...postDemoForm, designation: e.target.value })} className="flex-1 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" /></div>
              </div>
            </div>
          </div>
        )}

        {demoSubTab === 'process-flow' && (() => {
          const boxStyle = "px-4 py-2 border-2 border-blue-400 rounded text-xs text-blue-600 font-medium text-center bg-white min-w-[160px] whitespace-nowrap";
          const arrowDown = <div className="flex justify-center my-1"><svg width="12" height="20" viewBox="0 0 12 20"><line x1="6" y1="0" x2="6" y2="14" stroke="#6366f1" strokeWidth="2"/><polygon points="1,14 6,20 11,14" fill="#6366f1"/></svg></div>;
          const arrowRight = <div className="flex items-center mx-1"><svg width="24" height="12" viewBox="0 0 24 12"><line x1="0" y1="6" x2="18" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="18,1 24,6 18,11" fill="#6366f1"/></svg></div>;
          const arrowBoth = <div className="flex items-center mx-1"><svg width="28" height="12" viewBox="0 0 28 12"><line x1="6" y1="6" x2="22" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="6,1 0,6 6,11" fill="#6366f1"/><polygon points="22,1 28,6 22,11" fill="#6366f1"/></svg></div>;
          const colTitle = "text-sm font-bold text-blue-600 mb-3 text-center uppercase tracking-wide";
          return (
          <div className="space-y-8 overflow-x-auto pb-4">
            {/* Row 1: CUSTOMER, ORDERS, SUPPLIER, PROJECT */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* CUSTOMER */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>CUSTOMER</h4>
                <div className={boxStyle}>Pre - Lead</div>
                {arrowDown}
                <div className={boxStyle}>Lead</div>
                {arrowDown}
                <div className={boxStyle}>Quality Lead</div>
                {arrowDown}
                <div className={boxStyle}>Customer</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Customer Master</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Campaign</div>
                {arrowDown}
                <div className={boxStyle}>Customer Survey</div>
              </div>

              {/* ORDERS */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>ORDERS</h4>
                <div className={boxStyle}>Customer Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Order</div>
              </div>

              {/* SUPPLIER */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>SUPPLIER</h4>
                <div className={boxStyle}>Supplier Master</div>
                {arrowDown}
                <div className={boxStyle}>Vendor Master</div>
                {arrowDown}
                <div className={boxStyle}>Manufacturer Master</div>
                {arrowDown}
                <div className={boxStyle}>Price List</div>
              </div>

              {/* PROJECT */}
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>PROJECT</h4>
                <div className={boxStyle}>Task Management</div>
                {arrowDown}
                <div className={boxStyle}>Project Management</div>
                {arrowDown}
                <div className={boxStyle}>Timesheet</div>
              </div>
            </div>

            {/* Row 2: INVENTORY, ORDERS continued, FINANCIAL, E-COMMERCE + HRM */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* INVENTORY */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>INVENTORY</h4>
                <div className={boxStyle}>Item Master</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Shipping Instruction</div>
                  {arrowBoth}
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Receiving</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Inventory</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Return Receive</div>
                {arrowDown}
                <div className={boxStyle}>Return Authorization</div>
              </div>

              {/* ORDERS continued */}
              <div className="flex flex-col items-center mt-[36px]">
                <div className="flex items-center">
                  <div className={boxStyle}>Supplier Purchase Order</div>
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Priority</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Order Pick - Pack</div>
                  {arrowRight}
                </div>
                {arrowDown}
                <div className={boxStyle}>Order Shipping</div>
                {arrowDown}
                <div className={boxStyle}>Order Tracking</div>
              </div>

              {/* FINANCIAL */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>FINANCIAL</h4>
                <div className={boxStyle}>Supplier Invoice</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Payment</div>
                {arrowDown}
                <div className={boxStyle}>Sales Invoice</div>
                {arrowDown}
                <div className={boxStyle}>Customer Payment</div>
                {arrowDown}
                <div className="flex items-center">
                  <div className={boxStyle}>Employee Payroll</div>
                  {arrowBoth}
                </div>
                {arrowDown}
                <div className={boxStyle}>Salary Payment</div>
                {arrowDown}
                <div className={boxStyle}>Tax Payment</div>
                {arrowDown}
                <div className={boxStyle}>Bank Reconciliation</div>
              </div>

              {/* E-COMMERCE + HRM */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>E-COMMERCE</h4>
                <div className={boxStyle}>E-Commerce</div>
                {arrowDown}
                <div className={boxStyle}>Credit Card Payment</div>
                <div className="mt-6">
                  <h4 className={colTitle}>HRM</h4>
                  <div className="flex flex-col items-center">
                    <div className={boxStyle}>Recruitment</div>
                    {arrowDown}
                    <div className={boxStyle}>Employee Master</div>
                    {arrowDown}
                    <div className={boxStyle}>Leave Management</div>
                    {arrowDown}
                    <div className={boxStyle}>Employee Assessment</div>
                    {arrowDown}
                    <div className={boxStyle}>Bonus - Increment</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Row 3: DOCUMENT MANAGEMENT, FINANCIAL continued, HRM continued */}
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              {/* DOCUMENT MANAGEMENT */}
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>DOCUMENT MANAGEMENT</h4>
                <div className={boxStyle}>Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Order</div>
                {arrowDown}
                <div className={boxStyle}>Customer</div>
                {arrowDown}
                <div className={boxStyle}>Supplier</div>
                {arrowDown}
                <div className={boxStyle}>Accounts</div>
                {arrowDown}
                <div className={boxStyle}>Order Fulfillment</div>
                {arrowDown}
                <div className={boxStyle}>Return</div>
              </div>

              {/* Spacer */}
              <div className="min-w-[160px]"></div>

              {/* FINANCIAL continued */}
              <div className="flex flex-col items-center">
                <div className={boxStyle}>Journal Ledger</div>
                {arrowDown}
                <div className={boxStyle}>Ledger</div>
                {arrowDown}
                <div className={boxStyle}>Fixed Asset</div>
                {arrowDown}
                <div className={boxStyle}>Account Statements</div>
                {arrowDown}
                <div className={boxStyle}>Tax Return</div>
                {arrowDown}
                <div className={boxStyle}>Tax Payment</div>
                {arrowDown}
                <div className={boxStyle}>Budget</div>
              </div>

              {/* HRM continued */}
              <div className="flex flex-col items-center">
                <div className={boxStyle}>Holiday Master</div>
              </div>
            </div>

            {/* Generate PDF Button */}
            <div className="flex justify-center mt-6">
              <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                Generate PDF
              </button>
            </div>
          </div>
          );
        })()}

        {demoSubTab === 'link' && (
          <div className="space-y-3">
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-1/3">Module / Sub-Module</th>
                    <th className="px-4 py-2.5 text-center text-xs font-medium text-white">Presentation Link</th>
                  </tr>
                </thead>
                <tbody>
                  {(() => {
                    const selectedModules: { category: string; item: string }[] = [];
                    Object.entries(demoModules).forEach(([category, items]) => {
                      (items || []).forEach((item: string) => {
                        selectedModules.push({ category, item });
                      });
                    });
                    if (selectedModules.length === 0) {
                      return <tr><td colSpan={2} className="px-4 py-6 text-center text-gray-400 text-xs">No Data Found</td></tr>;
                    }
                    return selectedModules.map((mod, index) => (
                      <tr key={`${mod.category}-${mod.item}`} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-4 py-2 text-xs border-b border-gray-200 text-blue-600">{mod.category} / {mod.item}</td>
                        <td className="px-4 py-2 text-xs border-b border-gray-200 text-center text-blue-600">-</td>
                      </tr>
                    ));
                  })()}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {demoSubTab === 'questions' && (
          <div className="space-y-4">
            {/* Top Row - Presentation Date and Attended By */}
            <div className="grid grid-cols-2 gap-x-8 gap-y-3">
              <div className="flex items-center gap-3">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap">Presentation Date</label>
                <input type="date" value={demoQuestionsForm.presentation_date} onChange={(e) => setDemoQuestionsForm({ ...demoQuestionsForm, presentation_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
              </div>
              <div className="flex items-center gap-3">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap">Attended By</label>
                <select multiple value={demoQuestionsForm.attended_by} onChange={(e) => setDemoQuestionsForm({ ...demoQuestionsForm, attended_by: Array.from(e.target.selectedOptions, opt => opt.value) })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="">Nothing selected</option>
                  {demoContacts.map((contact: any) => (
                    <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                  ))}
                </select>
                <button type="button" className="w-8 h-8 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-50">
                  <Plus className="w-4 h-4" />
                </button>
              </div>
            </div>

            {/* Presentation By Row */}
            <div className="grid grid-cols-2 gap-x-8">
              <div className="flex items-center gap-3">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap">Presentation By</label>
                <select value={demoQuestionsForm.presentation_by} onChange={(e) => setDemoQuestionsForm({ ...demoQuestionsForm, presentation_by: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="">Please Select Presentation By</option>
                  <option value="1">Admin User</option>
                  <option value="Junaid Ali">Junaid Ali</option>
                </select>
              </div>
            </div>

            {/* Questions Table */}
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Date</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Added By</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Question</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Category</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Asked by</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Answered</th>
                    <th className="px-2 py-2 text-center text-xs font-medium text-white w-16">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {/* Input Row */}
                  <tr className="bg-white">
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <div className="flex items-center gap-1">
                        <Calendar className="w-4 h-4 text-yellow-500" />
                        <input type="date" value={demoQuestionRow.date} onChange={(e) => setDemoQuestionRow({ ...demoQuestionRow, date: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                      </div>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={demoQuestionRow.added_by} onChange={(e) => setDemoQuestionRow({ ...demoQuestionRow, added_by: e.target.value })} placeholder="Added By" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={demoQuestionRow.question} onChange={(e) => setDemoQuestionRow({ ...demoQuestionRow, question: e.target.value })} placeholder="Question" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={demoQuestionRow.category} onChange={(e) => setDemoQuestionRow({ ...demoQuestionRow, category: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        <option value="Technical">Technical</option>
                        <option value="Functional">Functional</option>
                        <option value="Commercial">Commercial</option>
                        <option value="General">General</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={demoQuestionRow.asked_by} onChange={(e) => setDemoQuestionRow({ ...demoQuestionRow, asked_by: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Asked By</option>
                        {demoContacts.map((contact: any) => (
                          <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                        ))}
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={demoQuestionRow.answered} onChange={(e) => setDemoQuestionRow({ ...demoQuestionRow, answered: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Select Answer</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="Pending">Pending</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200 text-center">
                      <button onClick={handleAddDemoQuestion} className="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Add</button>
                    </td>
                  </tr>
                  {/* Data Rows */}
                  {demoQuestionsList.length === 0 ? (
                    <tr><td colSpan={7} className="px-4 py-6 text-center text-gray-400 text-xs">No questions added</td></tr>
                  ) : (
                    demoQuestionsList.map((q, index) => (
                      <tr key={q.id} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.date || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.added_by || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.question || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.category || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.asked_by || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200">{q.answered || '-'}</td>
                        <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">
                          <button onClick={() => handleDeleteDemoQuestion(q.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {demoSubTab === 'result' && (
          <div className="space-y-4">
            <div className="flex items-start gap-6">
              {/* Result Status */}
              <div className="flex items-center gap-3">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap">Result Status</label>
                <select value={demoResultForm.result_status} onChange={(e) => setDemoResultForm({ ...demoResultForm, result_status: e.target.value })} className="w-40 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="">Select Status</option>
                  <option value="Qualified">Qualified</option>
                  <option value="Not Qualified">Not Qualified</option>
                  <option value="Pending">Pending</option>
                  <option value="Follow Up Required">Follow Up Required</option>
                </select>
              </div>

              {/* Comments */}
              <div className="flex items-start gap-3 flex-1">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap pt-2">Comments</label>
                <textarea value={demoResultForm.comments} onChange={(e) => setDemoResultForm({ ...demoResultForm, comments: e.target.value })} className="flex-1 h-20 px-3 py-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" />
              </div>

              {/* Next Step */}
              <div className="flex items-start gap-3 flex-1">
                <label className="text-xs font-medium text-blue-600 whitespace-nowrap pt-2">Next Step</label>
                <textarea value={demoResultForm.next_step} onChange={(e) => setDemoResultForm({ ...demoResultForm, next_step: e.target.value })} className="flex-1 h-20 px-3 py-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" />
              </div>
            </div>

            {/* Save Button */}
            <div className="flex justify-center">
              <button onClick={handleSaveDemoResult} className="px-6 py-1.5 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">
                Save
              </button>
            </div>
          </div>
        )}

        {/* Follow-Up Sub-tab */}
        {demoSubTab === 'follow-up' && (
          <div className="space-y-3">
            <div>
              <button onClick={() => handleOpenDemoFollowUp()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                    <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {demoFollowUps.length === 0 ? (
                    <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                  ) : (
                    demoFollowUps.map((activity: any, index: number) => (
                      <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                          <div className="flex gap-1 justify-center">
                            <button onClick={() => handleOpenDemoFollowUp(activity)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                            <button onClick={() => handleDeleteDemoFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {demoSubTab === 'demo-feedback' && (
          <div className="space-y-6">
            {/* Header */}
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Demo Session Feedback Survey</h2>
              <p className="text-sm text-blue-600">Thank you for participating in our demo session. Your feedback is valuable to us. Please take a few moments to complete this survey.</p>
            </div>

            {/* Section 1: General Experience */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-gray-800">Section 1: General Experience</h3>

              {/* Q1 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">1. How satisfied were you with the overall demo session?</p>
                <div className="ml-4 space-y-1">
                  {['Very Satisfied', 'Satisfied', 'Neutral', 'Dissatisfied', 'Very Dissatisfied'].map(opt => (
                    <label key={opt} className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                      <input type="radio" name="q1" value={opt} checked={demoFeedback.q1_satisfaction === opt} onChange={(e) => setDemoFeedback({ ...demoFeedback, q1_satisfaction: e.target.value })} className="w-3.5 h-3.5 accent-blue-600" />
                      {opt}
                    </label>
                  ))}
                </div>
              </div>

              {/* Q2 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">2. Was the demo session informative and clear?</p>
                <div className="ml-4 space-y-1">
                  {['Yes, very clear', 'Somewhat clear', 'Neutral', 'Not very clear', 'Not clear at all'].map(opt => (
                    <label key={opt} className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                      <input type="radio" name="q2" value={opt} checked={demoFeedback.q2_informative === opt} onChange={(e) => setDemoFeedback({ ...demoFeedback, q2_informative: e.target.value })} className="w-3.5 h-3.5 accent-blue-600" />
                      {opt}
                    </label>
                  ))}
                </div>
              </div>

              {/* Q3 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">3. Did the demo meet your expectations?</p>
                <div className="ml-4 space-y-1">
                  {['Yes, fully', 'Partially', 'Neutral', 'Not really'].map(opt => (
                    <label key={opt} className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                      <input type="radio" name="q3" value={opt} checked={demoFeedback.q3_expectations === opt} onChange={(e) => setDemoFeedback({ ...demoFeedback, q3_expectations: e.target.value })} className="w-3.5 h-3.5 accent-blue-600" />
                      {opt}
                    </label>
                  ))}
                </div>
              </div>
            </div>

            {/* Section 2: Product Fit & Features */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-gray-800">Section 2: Product Fit & Features</h3>

              {/* Q4 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">4. Which features demonstrated were most relevant to your business?</p>
                <textarea value={demoFeedback.q4_relevant_features} onChange={(e) => setDemoFeedback({ ...demoFeedback, q4_relevant_features: e.target.value })} placeholder="Type your answer here..." className="w-full h-20 px-3 py-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" />
              </div>

              {/* Q5 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">5. Are there any features you would like us to explain in more detail?</p>
                <textarea value={demoFeedback.q5_explain_features} onChange={(e) => setDemoFeedback({ ...demoFeedback, q5_explain_features: e.target.value })} placeholder="Type your answer here..." className="w-full h-20 px-3 py-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" />
              </div>

              {/* Q6 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">6. How well does our solution align with your current business needs?</p>
                <div className="ml-4 space-y-1">
                  {['Perfectly aligned', 'Mostly aligned', 'Somewhat aligned', 'Not aligned'].map(opt => (
                    <label key={opt} className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                      <input type="radio" name="q6" value={opt} checked={demoFeedback.q6_alignment === opt} onChange={(e) => setDemoFeedback({ ...demoFeedback, q6_alignment: e.target.value })} className="w-3.5 h-3.5 accent-blue-600" />
                      {opt}
                    </label>
                  ))}
                </div>
              </div>
            </div>

            {/* Section 3: Presentation & Communication */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-gray-800">Section 3: Presentation & Communication</h3>

              {/* Q7 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">7. How would you rate the presenter's knowledge and communication?</p>
                <div className="ml-4 space-y-1">
                  {['Excellent', 'Good', 'Average', 'Poor'].map(opt => (
                    <label key={opt} className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                      <input type="radio" name="q7" value={opt} checked={demoFeedback.q7_presenter_rating === opt} onChange={(e) => setDemoFeedback({ ...demoFeedback, q7_presenter_rating: e.target.value })} className="w-3.5 h-3.5 accent-blue-600" />
                      {opt}
                    </label>
                  ))}
                </div>
              </div>

              {/* Q8 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">8. Was the demo length appropriate?</p>
                <div className="ml-4 space-y-1">
                  {['Too long', 'Just right', 'Too short'].map(opt => (
                    <label key={opt} className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                      <input type="radio" name="q8" value={opt} checked={demoFeedback.q8_demo_length === opt} onChange={(e) => setDemoFeedback({ ...demoFeedback, q8_demo_length: e.target.value })} className="w-3.5 h-3.5 accent-blue-600" />
                      {opt}
                    </label>
                  ))}
                </div>
              </div>
            </div>

            {/* Section 4: Queries & Next Steps */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-gray-800">Section 4: Queries & Next Steps</h3>

              {/* Q9 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">9. Do you have any specific questions or clarifications?</p>
                <textarea value={demoFeedback.q9_questions} onChange={(e) => setDemoFeedback({ ...demoFeedback, q9_questions: e.target.value })} placeholder="Type your answer here..." className="w-full h-20 px-3 py-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" />
              </div>

              {/* Q10 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">10. Would you like us to arrange a follow-up session or a more detailed discussion?</p>
                <div className="ml-4 space-y-1">
                  {['Yes', 'No'].map(opt => (
                    <label key={opt} className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                      <input type="radio" name="q10" value={opt} checked={demoFeedback.q10_followup === opt} onChange={(e) => setDemoFeedback({ ...demoFeedback, q10_followup: e.target.value })} className="w-3.5 h-3.5 accent-blue-600" />
                      {opt}
                    </label>
                  ))}
                </div>
              </div>
            </div>

            {/* Section 5: Final Feedback */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-gray-800">Section 5: Final Feedback</h3>

              {/* Q11 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">11. On a scale of <span className="text-red-500">110</span>, how likely are you to consider our solution for your organization?</p>
                <div className="ml-4">
                  <p className="text-xs text-gray-600 mb-2">Not Likely</p>
                  <div className="flex gap-2">
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                      <button key={num} type="button" onClick={() => setDemoFeedback({ ...demoFeedback, q11_likelihood: String(num) })} className={`w-8 h-8 rounded-full border text-sm font-medium ${demoFeedback.q11_likelihood === String(num) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}`}>
                        {num}
                      </button>
                    ))}
                  </div>
                  <p className="text-xs text-gray-600 mt-1">Highly Likely</p>
                </div>
              </div>

              {/* Q12 */}
              <div className="space-y-2">
                <p className="text-sm text-blue-600">12. Any additional feedback or suggestions?</p>
                <textarea value={demoFeedback.q12_additional_feedback} onChange={(e) => setDemoFeedback({ ...demoFeedback, q12_additional_feedback: e.target.value })} placeholder="Type your feedback here..." className="w-full h-20 px-3 py-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" />
              </div>
            </div>
          </div>
        )}

        {/* Memo Sub-tab */}
        {demoSubTab === 'memo' && (
          <div className="space-y-3">
            <div>
              <button onClick={() => handleOpenDemoMemo()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                    <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {demoMemos.length === 0 ? (
                    <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                  ) : (
                    demoMemos.map((memo: any, index: number) => (
                      <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                          <div className="flex gap-1 justify-center">
                            <button onClick={() => handleOpenDemoMemo(memo)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                            <button onClick={() => handleDeleteDemoMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Upload File Sub-tab */}
        {demoSubTab === 'upload-file' && (
          <div className="space-y-4">
            <div className="flex items-center gap-4">
              <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
              <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={demoSubTabFile?.name || ''} />
              <input ref={demoSubTabFileRef} type="file" onChange={handleDemoSubTabFileChange} className="hidden" />
              <button onClick={handleDemoSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
              <button onClick={handleDemoSubTabUpload} disabled={!demoSubTabFile || demoSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{demoSubTabUploading ? 'Uploading...' : 'Upload'}</button>
            </div>
            <div className="flex items-center gap-4">
              <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
              <input type="text" value={demoSubTabNotes} onChange={(e) => setDemoSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            </div>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-700">
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                    <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                    <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {demoSubTabDocs.length === 0 ? (
                    <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                  ) : (
                    demoSubTabDocs.map((doc: any, index: number) => (
                      <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                        <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                          <div className="flex gap-1 justify-center">
                            {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                            <button onClick={() => handleDemoSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {demoSubTab === 'workflow-audit-trail' && (
          <div className="p-4 text-center text-gray-500 text-sm">Workflow & Audit Trail content</div>
        )}
      </div>

      {/* Follow-Up Modal */}
      {showDemoFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button onClick={() => setShowDemoPreviousActivities(!showDemoPreviousActivities)} className="px-3 py-1 text-xs font-medium text-blue-900 bg-blue-500 rounded hover:bg-blue-400">View Previous Activities</button>
              </div>
              <button onClick={() => setShowDemoFollowUpModal(false)} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={demoFollowUpForm.contact_id} onChange={(e) => { const contactId = e.target.value; const selectedContact = demoContacts.find((c: any) => c.id?.toString() === contactId); setDemoFollowUpForm({ ...demoFollowUpForm, contact_id: contactId, sent_to: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select Contact</option>
                    {demoContacts.map((contact: any) => (<option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>))}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={demoFollowUpForm.subject} onChange={(e) => setDemoFollowUpForm({ ...demoFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={demoFollowUpForm.sent_to} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={demoFollowUpForm.activity_type} onChange={(e) => setDemoFollowUpForm({ ...demoFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select</option><option value="Call">Call</option><option value="Meeting">Meeting</option><option value="Email">Email</option><option value="Task">Task</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={demoFollowUpForm.start_date} onChange={(e) => setDemoFollowUpForm({ ...demoFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <input type="time" value={demoFollowUpForm.start_time} onChange={(e) => setDemoFollowUpForm({ ...demoFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={demoFollowUpForm.assigned_to} onChange={(e) => setDemoFollowUpForm({ ...demoFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select User</option><option value="1">Admin User</option><option value="Junaid Ali">Junaid Ali</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={demoFollowUpForm.next_followup_date} onChange={(e) => setDemoFollowUpForm({ ...demoFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={demoFollowUpForm.status} onChange={(e) => setDemoFollowUpForm({ ...demoFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="Open">Open</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option><option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoFollowUpExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoFollowUpExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoFollowUpExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoFollowUpExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded"><Edit2 className="w-3.5 h-3.5" /></button>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <select onChange={(e) => handleDemoFollowUpExec('fontName', e.target.value)} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                    <option value="jost">jost</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option>
                  </select>
                  <select onChange={(e) => handleDemoFollowUpExec('fontSize', e.target.value)} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                    <option value="1">8</option><option value="2">10</option><option value="3">12</option><option value="4">14</option><option value="5">18</option><option value="6">24</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300">A</button>
                    <input type="color" onChange={(e) => handleDemoFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                  </div>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoFollowUpExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoFollowUpExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                </div>
                <div ref={demoFollowUpEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y" style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveDemoFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showDemoMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => setShowDemoMemoModal(false)} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoMemoExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoMemoExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoMemoExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoMemoExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded"><Edit2 className="w-3.5 h-3.5" /></button>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <select onChange={(e) => handleDemoMemoExec('fontName', e.target.value)} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                  <option value="jost">jost</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option>
                </select>
                <select onChange={(e) => handleDemoMemoExec('fontSize', e.target.value)} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                  <option value="1">8</option><option value="2">10</option><option value="3">12</option><option value="4">14</option><option value="5">18</option><option value="6">24</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300">A</button>
                  <input type="color" onChange={(e) => handleDemoMemoExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                </div>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoMemoExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDemoMemoExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
              </div>
              <div ref={demoMemoEditorRef} contentEditable className="w-full min-h-[220px] max-h-[400px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y" style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveDemoMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Proposal Form ==============
const PROPOSAL_MODULES: Record<string, string[]> = {
  'Customer': ['Customer Master', 'CRM', 'Campaign', 'Customer Survey'],
  'Supplier': ['Supplier Master', 'Vendor Master', 'Manufacturer Master', 'Price List'],
  'Inventory': ['Item Master', 'E-Commerce', 'Requisition', 'Shipping Instruction', 'Receiving', 'Discount', 'Return', 'Inventory'],
  'Orders': ['Inquiry', 'Quotation', 'Order', 'Fulfillment Priority', 'Order Fulfillment', 'Wave Pick', 'Order Tracking'],
  'Financials': ['Account Receivable', 'Account Payable', 'Journal Entry', 'Ledger', 'Payroll', 'Incentive', 'Banking', 'Asset Management', 'Account Statement', 'Tax Connect', 'Regulatory Compliance', 'Budgeting'],
  'HRM': ['Employee Master', 'Leave Master', 'Holiday Master', 'Recruitment', 'Appraisal', 'Bonus'],
  'Project': ['Task Management', 'Project Management', 'Timesheet'],
  'Reports': ['Customer', 'Crm', 'Supplier', 'Orders', 'Financials', 'HRM', 'Project', 'Inventory', 'Management', 'Business Intelligence'],
  'DMS': ['Return', 'Accounts', 'Supplier', 'Customer', 'Order', 'Quotation', 'Inquiry', 'Order Fulfillment', 'Other Folders', 'Item'],
  'My Info': ['Holiday Calendar', 'My Favorite', 'Leave Management', 'My Dashboard', 'Message Board', 'Notifications', 'Calendar', 'Attendance Management', 'Ticketing'],
  'Setup': ['Role Mgmt', 'Bank Master', 'Accounting', 'Configuration', 'Company Setup', 'User Mgmt', 'Option Master', 'Variant Master', 'Auto Scheduler', 'Form Management']
};

function ProposalForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [proposalSubTab, setProposalSubTab] = useState('details');
  const proposalSubTabs = ['Details', 'Process Flow', 'Proposal', 'Proposal Date', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [proposalFormData, setProposalFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [proposalContacts, setProposalContacts] = useState<any[]>([]);
  const [proposalEmailTemplates, setProposalEmailTemplates] = useState<any[]>([]);
  const [proposalDocs, setProposalDocs] = useState<any[]>([]);
  const [proposalFile, setProposalFile] = useState<File | null>(null);
  const [proposalUploading, setProposalUploading] = useState(false);
  const proposalFileRef = React.useRef<HTMLInputElement>(null);
  const [emailSentList, setEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [detailsForm, setDetailsForm] = useState({
    company_name: '', contact_project_incharge: '', project_name: '', from_date: '', rev: '',
    project_manager: '', business_analyst: '', technical_lead: '', training_coordinator: ''
  });
  const [painPoints, setPainPoints] = useState<string[]>([]);
  const [selectedPainPoint, setSelectedPainPoint] = useState('');
  const [proposalModules, setProposalModules] = useState<Record<string, string[]>>({});

  // Project Timeline state
  const [phases, setPhases] = useState({
    initiation: '', planning: '', configuration_customization: '', training: '', testing: '', deployment: '', go_live: ''
  });
  const [milestones, setMilestones] = useState({
    initial_deposit: { pct: '', amt: '' },
    completion_planning: { pct: '', amt: '' },
    completion_customization: { pct: '', amt: '' },
    after_user_training: { pct: '', amt: '' },
    after_deployment: { pct: '', amt: '' },
    go_live: { pct: '', amt: '' },
    final_payment: { pct: '', amt: '' }
  });

  // Pricing state
  const [oneTimeCharges, setOneTimeCharges] = useState({
    customization: '', configuration: '', data_migration: '', user_training: '', deployment: '', go_live_support: ''
  });
  const [recurringCharges, setRecurringCharges] = useState({
    software_licensing: '', database_maintenance: '', server_disc_space: '', training_support: ''
  });
  const [pricingSummary, setPricingSummary] = useState({
    currency: '', one_time_cost: '15,000.00', monthly_cost: '1,000.00', number_of_months: '6', total_amount: ''
  });

  // Follow-up state
  const [proposalFollowUps, setProposalFollowUps] = useState<any[]>([]);
  const [showProposalFollowUpModal, setShowProposalFollowUpModal] = useState(false);
  const [editingProposalFollowUp, setEditingProposalFollowUp] = useState<any>(null);
  const [proposalFollowUpForm, setProposalFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', end_date: '', end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: '', next_followup_time: '', channel_type: '', sent_to: ''
  });
  const proposalFollowUpEditorRef = React.useRef<HTMLDivElement>(null);
  const [showProposalPreviousActivities, setShowProposalPreviousActivities] = useState(false);

  // Memo state
  const [proposalMemos, setProposalMemos] = useState<any[]>([]);
  const [showProposalMemoModal, setShowProposalMemoModal] = useState(false);
  const [editingProposalMemo, setEditingProposalMemo] = useState<any>(null);
  const [proposalMemoForm, setProposalMemoForm] = useState({ content: '' });
  const proposalMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [proposalSubTabDocs, setProposalSubTabDocs] = useState<any[]>([]);
  const [proposalSubTabFile, setProposalSubTabFile] = useState<File | null>(null);
  const [proposalSubTabNotes, setProposalSubTabNotes] = useState('');
  const [proposalSubTabUploading, setProposalSubTabUploading] = useState(false);
  const proposalSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Proposal content state
  const [proposalContent, setProposalContent] = useState('');
  const proposalEditorRef = React.useRef<HTMLDivElement>(null);

  // Proposal Date Form State
  const [proposalDateForm, setProposalDateForm] = useState({
    key_person_name: '', company_name: '', address: '', country: '', province: '', city: '', postal_code: '',
    company_phone: '', ext: '', fax: '', email: '', website: '', any_branch_office: '', branch_address: '',
    preferred_date: '', preferred_time: '', remark: '', timezone: ''
  });

  const handleProposalExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    proposalEditorRef.current?.focus();
  };

  const getProposalTemplate = () => {
    const companyName = data?.company_name || 'Company Name';
    const today = new Date();
    const dateStr = `${String(today.getDate()).padStart(2, '0')},${String(today.getMonth() + 1).padStart(2, '0')},${String(today.getFullYear()).slice(-2)}`;

    return `
<div style="font-family: Calibri, sans-serif;">
  <div style="margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
      <svg width="50" height="45" viewBox="0 0 59 55" style="flex-shrink: 0;">
        <polygon points="29.5,0 59,55 0,55" fill="#1e40af"/>
        <polygon points="29.5,15 45,45 14,45" fill="#fbbf24"/>
        <polygon points="29.5,25 38,40 21,40" fill="#7c3aed"/>
      </svg>
      <span style="font-size: 18px; font-weight: bold; color: #1e40af;">Axiever</span>
    </div>
  </div>

  <p style="font-size: 16pt; font-weight: bold; margin-bottom: 8px;">Axiever Business Management System (ERP) Implementation Proposal</p>
  <p style="font-size: 10pt; margin-bottom: 4px;"><strong>Prepared For:</strong> ${companyName}</p>
  <p style="font-size: 10pt; margin-bottom: 16px;"><strong>Proposal Date:</strong>${dateStr}</p>

  <p style="font-size: 12pt; font-weight: bold; margin-top: 16px; margin-bottom: 8px;">1. Introduction</p>
  <p style="font-size: 10pt; margin-bottom: 8px;">This proposal outlines the investment required to implement a modern Business Management System (ERP) system for your business. Our solution is designed to integrate your key operationssuch as finance, sales, and customer managementinto a single, streamlined platform. This will enhance data accuracy, improve decision-making, and drive operational efficiency.</p>

  <p style="font-size: 12pt; font-weight: bold; margin-top: 16px; margin-bottom: 8px;">2. Understanding Your Needs</p>
  <p style="font-size: 10pt; margin-bottom: 8px;">Based on our discussions, we understand that ${companyName} is currently facing challenges with:</p>
  <ul style="font-size: 10pt; margin-left: 20px; margin-bottom: 8px;">
    <li>Integrating sales data with accounting and financial reporting.</li>
    <li>Streamlining the order-to-cash process.</li>
    <li>Gaining a unified view of customer interactions.</li>
    <li>Manual data entry leading to errors and inefficiencies.</li>
  </ul>
  <p style="font-size: 10pt; margin-bottom: 8px;">Our proposed solution is specifically configured to address these pain points directly.</p>

  <p style="font-size: 12pt; font-weight: bold; margin-top: 16px; margin-bottom: 8px;">3. Our Proposed Solution</p>
  <p style="font-size: 10pt; margin-bottom: 8px;">We recommend the implementation of Axiever configured to meet your specific business processes.</p>
  <p style="font-size: 10pt; font-weight: bold; margin-bottom: 4px;">Key features and benefits you will gain:</p>
  <ul style="font-size: 10pt; margin-left: 20px; margin-bottom: 8px;">
    <li><strong>Integrated Financial Management:</strong> Automated invoicing, accounts receivable/payable, and financial reporting.</li>
    <li><strong>Customer and Vendor Management:</strong> Manage customers and vendors in one place.</li>
    <li><strong>Sales & Order Management:</strong> Manage inquiries, proposals, and customer order in one place.</li>
    <li><strong>Reporting & Analytics:</strong> Customizable dashboards and reports to monitor key business performance indicators (KPIs).</li>
    <li><strong>Document Management System:</strong> Manage all documents electronically with easy retrieval and management.</li>
    <li><strong>Additional Features:</strong> Follow-up, reminders and calendar.</li>
    <li><strong>Scalability:</strong> A system that will grow with your business.</li>
  </ul>

  <p style="font-size: 12pt; font-weight: bold; margin-top: 16px; margin-bottom: 8px;">4. Investment Overview</p>
  <p style="font-size: 10pt; margin-bottom: 8px;">The total cost is broken down into a one-time Initial Setup Cost and an ongoing Monthly Maintenance Cost, with flexible payment options for the recurring fees.</p>

  <p style="font-size: 10pt; font-weight: bold; margin-bottom: 8px;">Part 1: Initial Setup & Implementation (One-Time Cost)</p>
  <table style="width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 10pt;">
    <tr style="background-color: #f2f2f2;">
      <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Component</td>
      <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Description</td>
      <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Cost</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 5px;">Software License & Setup Fee</td>
      <td style="border: 1px solid #000; padding: 5px;">One-time fee for system provisioning, initial configuration, cloud server and establishing your company database.</td>
      <td style="border: 1px solid #000; padding: 5px;">$0</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 5px;">Data Migration</td>
      <td style="border: 1px solid #000; padding: 5px;">Cleansing and transferring existing customer, product, and vendor data.</td>
      <td style="border: 1px solid #000; padding: 5px;">$0</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 5px;">User Training & Onboarding</td>
      <td style="border: 1px solid #000; padding: 5px;">Comprehensive training sessions for your team.</td>
      <td style="border: 1px solid #000; padding: 5px;">$0</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 5px;">Customization & Integration</td>
      <td style="border: 1px solid #000; padding: 5px;">Basic customization of reports, dashboards, and integration.</td>
      <td style="border: 1px solid #000; padding: 5px;">$0</td>
    </tr>
    <tr style="background-color: #f2f2f2;">
      <td colspan="2" style="border: 1px solid #000; padding: 5px; font-weight: bold;">Total Initial Setup Cost</td>
      <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">$0</td>
    </tr>
  </table>

  <p style="font-size: 12pt; font-weight: bold; margin-top: 16px; margin-bottom: 8px;">5. Implementation Timeline</p>
  <ul style="font-size: 10pt; margin-left: 20px; margin-bottom: 8px;">
    <li><strong>Phase 1: Planning & Configuration (Week 1-2):</strong> Finalize requirements and begin system setup.</li>
    <li><strong>Phase 2: Data Migration:</strong> Transfer existing data.</li>
    <li><strong>Phase 3: User Training (Week 3):</strong> Hands-on training sessions for your team.</li>
    <li><strong>Phase 4: Go-Live & Support (Week 4):</strong> System launch with intensive first-week support.</li>
  </ul>

  <p style="font-size: 12pt; font-weight: bold; margin-top: 16px; margin-bottom: 8px;">Next Steps</p>
  <p style="font-size: 10pt; margin-bottom: 8px;">We are confident that this ERP solution will provide a significant return on investment. To proceed, please:</p>
  <ol style="font-size: 10pt; margin-left: 20px; margin-bottom: 16px;">
    <li>Review and approve this proposal.</li>
    <li>Select your preferred maintenance billing cycle.</li>
    <li>We will send an invoice for the initial setup cost.</li>
    <li>Schedule a kick-off meeting to begin the implementation process.</li>
  </ol>

  <p style="font-size: 10pt; margin-bottom: 16px;">We look forward to partnering with you to empower your business growth.</p>

  <p style="font-size: 10pt; margin-bottom: 4px;">Sincerely,</p>
  <p style="font-size: 10pt; font-weight: bold; margin-top: 16px; margin-bottom: 0;">Admin User</p>
  <p style="font-size: 10pt; margin-bottom: 0;">Axiever Inc.</p>
  <p style="font-size: 10pt; margin-bottom: 0;">Email: admin@example.com</p>
  <p style="font-size: 10pt; margin-bottom: 16px;">Phone: +1-905-997 4044</p>

  <p style="font-size: 12pt; font-weight: bold; margin-top: 16px; margin-bottom: 8px;">Acceptance</p>
  <p style="font-size: 10pt; margin-bottom: 8px;">By signing below, the client agrees to the terms and investment outlined in this proposal.</p>
  <p style="font-size: 10pt; margin-bottom: 4px;">Authorized Signature: _________________________________</p>
  <p style="font-size: 10pt; margin-bottom: 4px;">Printed Name: _______________________________________</p>
  <p style="font-size: 10pt; margin-bottom: 4px;">Title: _______________________________________________</p>
  <p style="font-size: 10pt; margin-bottom: 4px;">Date: _______________________________________________</p>
</div>
    `.trim();
  };

  // Initialize form
  useEffect(() => {
    if (data) {
      setProposalFormData({
        company_name: data.company_name || '',
        contact_name: data.contact_name || '',
        email_format_type: 'Email Proposal, Fix Time for Discussion',
        branch_office: data.branch_office || '',
        contact_email: data.contact_email || ''
      });
      setDetailsForm(prev => ({ ...prev, company_name: data.company_name || '' }));
    }
  }, [data]);

  // Load contacts
  useEffect(() => {
    if (leadId) {
      api.getLeadContactsForEdit(leadId).then(setProposalContacts).catch(() => setProposalContacts([]));
    }
  }, [leadId]);

  // Load email templates for Proposal tab
  useEffect(() => {
    api.getCRIEmailTemplates('Proposal').then(setProposalEmailTemplates).catch(() => setProposalEmailTemplates([]));
  }, []);

  // Load follow-ups
  useEffect(() => {
    if (crId && proposalSubTab === 'follow-up') {
      api.getCRActivities(crId, 'proposal-followup').then(setProposalFollowUps).catch(() => setProposalFollowUps([]));
    }
  }, [crId, proposalSubTab]);

  // Load memos
  useEffect(() => {
    if (crId && proposalSubTab === 'memo') {
      api.getCRMemos(crId, 'proposal').then(setProposalMemos).catch(() => setProposalMemos([]));
    }
  }, [crId, proposalSubTab]);

  // Follow-up handlers
  const handleOpenProposalFollowUp = (item?: any) => {
    if (item) {
      setEditingProposalFollowUp(item);
      setProposalFollowUpForm({
        activity_type: item.activity_type || '',
        subject: item.subject || '',
        start_date: item.start_date || '',
        start_time: item.start_time || '',
        end_date: item.end_date || '',
        end_time: item.end_time || '',
        description: item.description || '',
        status: item.status || 'Open',
        contact_id: item.contact_id?.toString() || '',
        assigned_to: item.assigned_to?.toString() || '',
        priority: item.priority || '',
        next_followup_date: item.next_followup_date || '',
        next_followup_time: item.next_followup_time || '',
        channel_type: item.channel_type || '',
        sent_to: item.sent_to || ''
      });
    } else {
      setEditingProposalFollowUp(null);
      const now = new Date();
      setProposalFollowUpForm({
        activity_type: '',
        subject: '',
        start_date: now.toISOString().split('T')[0],
        start_time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }),
        end_date: now.toISOString().split('T')[0],
        end_time: '',
        description: '',
        status: 'Open',
        contact_id: '',
        assigned_to: '',
        priority: '',
        next_followup_date: now.toISOString().split('T')[0],
        next_followup_time: '',
        channel_type: '',
        sent_to: ''
      });
    }
    setShowProposalFollowUpModal(true);
    setTimeout(() => {
      if (proposalFollowUpEditorRef.current) {
        proposalFollowUpEditorRef.current.innerHTML = item?.description || '';
      }
    }, 50);
  };

  const handleSaveProposalFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = proposalFollowUpEditorRef.current?.innerHTML || proposalFollowUpForm.description;
    const formToSave = { ...proposalFollowUpForm, description: descriptionContent };
    try {
      if (editingProposalFollowUp) {
        const updated = await api.updateCRActivity(crId, editingProposalFollowUp.id, formToSave);
        setProposalFollowUps(proposalFollowUps.map((a: any) => a.id === editingProposalFollowUp.id ? updated : a));
      } else {
        const created = await api.createCRActivity(crId, { ...formToSave, tab_name: 'proposal-followup' });
        setProposalFollowUps([...proposalFollowUps, created]);
      }
      setShowProposalFollowUpModal(false);
      setEditingProposalFollowUp(null);
    } catch (err: any) {
      alert(err?.response?.data?.detail || 'Failed to save follow-up');
    }
  };

  const handleDeleteProposalFollowUp = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try {
      await api.deleteCRActivity(crId, id);
      setProposalFollowUps(proposalFollowUps.filter((a: any) => a.id !== id));
    } catch {
      alert('Failed to delete');
    }
  };

  // Memo handlers
  const handleOpenProposalMemo = (item?: any) => {
    if (item) {
      setEditingProposalMemo(item);
      setProposalMemoForm({ content: item.content || '' });
    } else {
      setEditingProposalMemo(null);
      setProposalMemoForm({ content: '' });
    }
    setShowProposalMemoModal(true);
    setTimeout(() => {
      if (proposalMemoEditorRef.current) {
        proposalMemoEditorRef.current.innerHTML = item?.content || '';
      }
    }, 50);
  };

  const handleSaveProposalMemo = async () => {
    if (!crId) return;
    const content = proposalMemoEditorRef.current?.innerHTML || proposalMemoForm.content;
    const payload = { content };
    try {
      if (editingProposalMemo) {
        const updated = await api.updateCRMemo(crId, editingProposalMemo.id, payload);
        setProposalMemos(proposalMemos.map((m: any) => m.id === editingProposalMemo.id ? updated : m));
      } else {
        const created = await api.createCRMemo(crId, { ...payload, tab_name: 'proposal' });
        setProposalMemos([...proposalMemos, created]);
      }
      setShowProposalMemoModal(false);
      setEditingProposalMemo(null);
    } catch (err: any) {
      alert(err?.response?.data?.detail || 'Failed to save memo');
    }
  };

  const handleDeleteProposalMemo = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try {
      await api.deleteCRMemo(crId, id);
      setProposalMemos(proposalMemos.filter((m: any) => m.id !== id));
    } catch {
      alert('Failed to delete');
    }
  };

  // Load upload file documents
  useEffect(() => {
    if (crId && proposalSubTab === 'upload-file') {
      api.getCRDocuments(crId, 'proposal-upload').then(setProposalSubTabDocs).catch(() => setProposalSubTabDocs([]));
    }
  }, [crId, proposalSubTab]);

  // Upload file handlers
  const handleProposalSubTabChooseFile = () => proposalSubTabFileRef.current?.click();
  const handleProposalSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files?.length) setProposalSubTabFile(e.target.files[0]);
  };
  const handleProposalSubTabUpload = async () => {
    if (!proposalSubTabFile || !crId) {
      alert(!proposalSubTabFile ? 'Please choose a file first' : 'Please save the customer requirement first');
      return;
    }
    setProposalSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, proposalSubTabFile, 'proposal-upload', 'Upload File');
      const docs = await api.getCRDocuments(crId, 'proposal-upload');
      setProposalSubTabDocs(docs);
      setProposalSubTabFile(null);
      setProposalSubTabNotes('');
      if (proposalSubTabFileRef.current) proposalSubTabFileRef.current.value = '';
    } catch (err: any) {
      alert(err?.response?.data?.detail || 'Failed to upload file');
    } finally {
      setProposalSubTabUploading(false);
    }
  };
  const handleProposalSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try {
      await api.deleteCRDocument(crId, docId);
      setProposalSubTabDocs(proposalSubTabDocs.filter((d: any) => d.id !== docId));
    } catch {
      alert('Failed to delete document');
    }
  };

  // Toggle module checkbox
  const toggleProposalModule = (category: string, item: string) => {
    setProposalModules(prev => {
      const current = prev[category] || [];
      if (current.includes(item)) {
        return { ...prev, [category]: current.filter(i => i !== item) };
      }
      return { ...prev, [category]: [...current, item] };
    });
  };

  const handleAddPainPoint = () => {
    if (selectedPainPoint && !painPoints.includes(selectedPainPoint)) {
      setPainPoints([...painPoints, selectedPainPoint]);
      setSelectedPainPoint('');
    }
  };

  const handleProposalFollowUpExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    proposalFollowUpEditorRef.current?.focus();
  };

  const handleProposalMemoExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    proposalMemoEditorRef.current?.focus();
  };

  const calculateTotalOneTimeCost = () => {
    const values = Object.values(oneTimeCharges).map(v => parseFloat(v) || 0);
    return values.reduce((a, b) => a + b, 0).toFixed(2);
  };

  const calculateTotalRecurring = () => {
    const values = Object.values(recurringCharges).map(v => parseFloat(v) || 0);
    return values.reduce((a, b) => a + b, 0).toFixed(2);
  };

  const sectionTitle = "text-sm font-bold text-gray-800 mb-3";

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={proposalFormData.company_name} onChange={(e) => setProposalFormData({ ...proposalFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={proposalFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = proposalContacts.find((c: any) => c.id?.toString() === cid); setProposalFormData({ ...proposalFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {proposalContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={proposalFormData.email_format_type} onChange={(e) => setProposalFormData({ ...proposalFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {proposalEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Proposal', proposalFormData.contact_email, proposalEmailTemplates.find((t: any) => t.email_format === proposalFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={proposalFormData.branch_office} onChange={(e) => setProposalFormData({ ...proposalFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={proposalFormData.contact_email} onChange={(e) => setProposalFormData({ ...proposalFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={proposalFileRef} onChange={(e) => setProposalFile(e.target.files?.[0] || null)} className="hidden" />
            <button onClick={() => proposalFileRef.current?.click()} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Plus className="w-3 h-3" /> Choose File
            </button>
            <button className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50">Upload</button>
          </div>
        </div>
      </div>

      {/* Two Tables Row */}
      <div className="grid grid-cols-2 gap-4">
        {/* Email Sent To Table */}
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-700">
                <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Email Sent To</th>
                <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Attachments</th>
                <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Sent On</th>
                <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
              </tr>
            </thead>
            <tbody>
              {emailSentList.length === 0 ? (
                <tr><td colSpan={4} className="px-4 py-4 text-center text-gray-400 text-xs">No emails sent</td></tr>
              ) : (
                emailSentList.map((item, idx) => (
                  <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                    <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                    <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                    <td className="px-3 py-2 text-xs border-b text-center">-</td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

        {/* File Name Table */}
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-700">
                <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Link</th>
                <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Size</th>
                <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Upload On</th>
                <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
              </tr>
            </thead>
            <tbody>
              {proposalDocs.length === 0 ? (
                <>
                  <tr className="bg-white">
                    <td className="px-3 py-2 text-xs border-b text-orange-500 italic">Proposal Date Time</td>
                    <td className="px-3 py-2 text-xs border-b text-blue-600">service: delta.axieve...</td>
                    <td className="px-3 py-2 text-xs border-b">0 kb</td>
                    <td className="px-3 py-2 text-xs border-b">05/23/2024</td>
                    <td className="px-3 py-2 text-xs border-b text-center"><input type="checkbox" checked className="w-3.5 h-3.5 accent-blue-600" readOnly /></td>
                  </tr>
                  <tr className="bg-gray-50">
                    <td className="px-3 py-2 text-xs border-b text-orange-500 italic">pharma_erp_analysis_for_manager.docx</td>
                    <td className="px-3 py-2 text-xs border-b text-blue-600">service: delta.axieve...</td>
                    <td className="px-3 py-2 text-xs border-b">47.27 Kb</td>
                    <td className="px-3 py-2 text-xs border-b">11/17/2025</td>
                    <td className="px-3 py-2 text-xs border-b text-center"><input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" /><button className="ml-1 p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button></td>
                  </tr>
                  <tr className="bg-white">
                    <td className="px-3 py-2 text-xs border-b text-orange-500 italic">Proposal</td>
                    <td className="px-3 py-2 text-xs border-b text-blue-600">service: delta.axieve...</td>
                    <td className="px-3 py-2 text-xs border-b">36.63 Kb</td>
                    <td className="px-3 py-2 text-xs border-b">11/28/2025</td>
                    <td className="px-3 py-2 text-xs border-b text-center"><input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" /><button className="ml-1 p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button></td>
                  </tr>
                </>
              ) : (
                proposalDocs.map((doc, idx) => (
                  <tr key={doc.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-3 py-2 text-xs border-b text-orange-500 italic">{doc.file_name}</td>
                    <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.link || '-'}</td>
                    <td className="px-3 py-2 text-xs border-b">{doc.size || '-'}</td>
                    <td className="px-3 py-2 text-xs border-b">{doc.uploaded_on || '-'}</td>
                    <td className="px-3 py-2 text-xs border-b text-center"><input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" /></td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {proposalSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setProposalSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${proposalSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {proposalSubTab === 'details' && (
        <div className="space-y-6">
          {/* Customer and Axiever Sections */}
          <div className="grid grid-cols-2 gap-x-12">
            {/* CUSTOMER Section */}
            <div>
              <h4 className={sectionTitle}>CUSTOMER</h4>
              <div className="space-y-2.5">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">Company Name</label>
                  <input type="text" value={detailsForm.company_name} onChange={(e) => setDetailsForm({ ...detailsForm, company_name: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">Contact (Project Incharge)</label>
                  <select value={detailsForm.contact_project_incharge} onChange={(e) => setDetailsForm({ ...detailsForm, contact_project_incharge: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select Contact</option>
                    {proposalContacts.map((contact: any) => (
                      <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                    ))}
                  </select>
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">Project Name</label>
                  <input type="text" value={detailsForm.project_name} onChange={(e) => setDetailsForm({ ...detailsForm, project_name: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">From Date</label>
                  <div className="flex-1 flex items-center gap-2">
                    <input type="date" value={detailsForm.from_date} onChange={(e) => setDetailsForm({ ...detailsForm, from_date: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <span className="text-xs text-gray-600 font-medium">Rev</span>
                    <input type="text" value={detailsForm.rev} onChange={(e) => setDetailsForm({ ...detailsForm, rev: e.target.value })} className="w-24 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
              </div>
            </div>

            {/* AXIEVER Section */}
            <div>
              <h4 className={sectionTitle}>AXIEVER</h4>
              <div className="space-y-2.5">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">Project Manager</label>
                  <select value={detailsForm.project_manager} onChange={(e) => setDetailsForm({ ...detailsForm, project_manager: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">Business Analyst</label>
                  <select value={detailsForm.business_analyst} onChange={(e) => setDetailsForm({ ...detailsForm, business_analyst: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">Technical Lead</label>
                  <select value={detailsForm.technical_lead} onChange={(e) => setDetailsForm({ ...detailsForm, technical_lead: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600 flex-shrink-0">Training Coordinator</label>
                  <select value={detailsForm.training_coordinator} onChange={(e) => setDetailsForm({ ...detailsForm, training_coordinator: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          {/* Pain Points / Challenges */}
          <div>
            <div className="flex items-center gap-2 mb-3">
              <h4 className="text-sm font-bold text-gray-800">PAIN POINTS / CHALLENGES</h4>
              <RefreshCw className="w-4 h-4 text-green-500 cursor-pointer hover:text-green-600" />
            </div>
            <div className="flex items-center gap-2">
              <select value={selectedPainPoint} onChange={(e) => setSelectedPainPoint(e.target.value)} className="w-72 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Please Select</option>
                <option value="Data Management Issues">Data Management Issues</option>
                <option value="Process Inefficiency">Process Inefficiency</option>
                <option value="Lack of Integration">Lack of Integration</option>
                <option value="Reporting Challenges">Reporting Challenges</option>
              </select>
              <button onClick={handleAddPainPoint} className="w-8 h-8 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100 transition-colors">
                <Plus className="w-4 h-4" />
              </button>
            </div>
            {painPoints.length > 0 && (
              <div className="flex flex-wrap gap-2 mt-3">
                {painPoints.map((pp, idx) => (
                  <span key={idx} className="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">{pp}</span>
                ))}
              </div>
            )}
          </div>

          {/* Module Checkboxes - 4 columns grid */}
          <div className="grid grid-cols-4 gap-3">
            {Object.entries(PROPOSAL_MODULES).map(([category, items]) => (
              <div key={category}>
                <h5 className="text-xs font-bold text-white bg-blue-700 px-3 py-2">{category}</h5>
                <div className="border border-t-0 border-gray-200 bg-white p-2 space-y-0.5 min-h-[120px]">
                  {items.map(item => (
                    <label key={item} className="flex items-center gap-2 text-xs text-blue-600 cursor-pointer hover:bg-blue-50 px-1 py-0.5 rounded">
                      <input type="checkbox" checked={(proposalModules[category] || []).includes(item)} onChange={() => toggleProposalModule(category, item)} className="w-3.5 h-3.5 accent-blue-600 flex-shrink-0" />
                      <span className="truncate">{item}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          {/* Project Timeline and Pricing - 4 Column Layout */}
          <div className="flex gap-4">
            {/* Column 1: Project Timeline Label */}
            <div className="w-28 flex-shrink-0 pt-2">
              <h4 className="text-sm font-bold text-blue-600">Project Timeline</h4>
            </div>

            {/* Column 2: Phase and Milestone Tables */}
            <div className="flex-1 space-y-4">
              {/* Phase Table */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-700">
                      <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Phase</th>
                      <th className="px-3 py-2 text-center text-xs font-medium text-white w-16">Days</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[
                      { key: 'initiation', label: 'Initiation' },
                      { key: 'planning', label: 'Planning' },
                      { key: 'configuration_customization', label: 'Configuration and Customization' },
                      { key: 'training', label: 'Training' },
                      { key: 'testing', label: 'Testing' },
                      { key: 'deployment', label: 'Deployment' },
                      { key: 'go_live', label: 'Go Live' }
                    ].map((phase, idx) => (
                      <tr key={phase.key} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-1.5 text-xs border-b border-gray-200 text-blue-600">{phase.label}</td>
                        <td className="px-1 py-1 border-b border-gray-200">
                          <input type="text" value={(phases as any)[phase.key]} onChange={(e) => setPhases({ ...phases, [phase.key]: e.target.value })} className="w-full h-6 px-1 text-xs border border-gray-300 rounded text-center bg-white" />
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Milestone Table */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-700">
                      <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Milestone</th>
                      <th className="px-2 py-2 text-center text-xs font-medium text-white border-r border-blue-600 w-16">Pct. (%)</th>
                      <th className="px-2 py-2 text-center text-xs font-medium text-white w-16">Amt.</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[
                      { key: 'initial_deposit', label: 'Initial Deposit' },
                      { key: 'completion_planning', label: 'Completion of Planning' },
                      { key: 'completion_customization', label: 'Completion of Customization and Config...' },
                      { key: 'after_user_training', label: 'After User Training' },
                      { key: 'after_deployment', label: 'After Deployment' },
                      { key: 'go_live', label: 'Go Live' },
                      { key: 'final_payment', label: 'Final Payment' }
                    ].map((ms, idx) => (
                      <tr key={ms.key} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-1.5 text-xs border-b border-gray-200 text-blue-600">{ms.label}</td>
                        <td className="px-1 py-1 border-b border-gray-200">
                          <input type="text" value={(milestones as any)[ms.key]?.pct || ''} onChange={(e) => setMilestones({ ...milestones, [ms.key]: { ...(milestones as any)[ms.key], pct: e.target.value } })} className="w-full h-6 px-1 text-xs border border-gray-300 rounded text-center bg-white" />
                        </td>
                        <td className="px-1 py-1 border-b border-gray-200">
                          <input type="text" value={(milestones as any)[ms.key]?.amt || ''} onChange={(e) => setMilestones({ ...milestones, [ms.key]: { ...(milestones as any)[ms.key], amt: e.target.value } })} className="w-full h-6 px-1 text-xs border border-gray-300 rounded text-center bg-white" />
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Column 3: Pricing Label */}
            <div className="w-20 flex-shrink-0 pt-2">
              <h4 className="text-sm font-bold text-blue-600">Pricing</h4>
            </div>

            {/* Column 4: One Time Charges and Recurring Charges Tables */}
            <div className="flex-1 space-y-4">
              {/* One Time Charges */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-700">
                      <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">One Time Charges</th>
                      <th className="px-3 py-2 text-center text-xs font-medium text-white w-20">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[
                      { key: 'customization', label: 'Customization' },
                      { key: 'configuration', label: 'Configuration' },
                      { key: 'data_migration', label: 'Data Migration' },
                      { key: 'user_training', label: 'User Training' },
                      { key: 'deployment', label: 'Deployment' },
                      { key: 'go_live_support', label: 'Go-Live Support' }
                    ].map((item, idx) => (
                      <tr key={item.key} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-1.5 text-xs border-b border-gray-200 text-blue-600">{item.label}</td>
                        <td className="px-1 py-1 border-b border-gray-200">
                          <input type="text" value={(oneTimeCharges as any)[item.key]} onChange={(e) => setOneTimeCharges({ ...oneTimeCharges, [item.key]: e.target.value })} className="w-full h-6 px-2 text-xs border border-gray-300 rounded text-right bg-white" />
                        </td>
                      </tr>
                    ))}
                    <tr className="bg-gray-100">
                      <td className="px-3 py-1.5 text-xs border-b border-gray-200 text-blue-600 font-medium">Total One Time Cost</td>
                      <td className="px-1 py-1 border-b border-gray-200">
                        <input type="text" value={calculateTotalOneTimeCost()} readOnly className="w-full h-6 px-2 text-xs border border-gray-300 rounded text-right bg-gray-100" />
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              {/* Recurring Charges */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-700">
                      <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Recurring Charges</th>
                      <th className="px-3 py-2 text-center text-xs font-medium text-white w-20">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[
                      { key: 'software_licensing', label: 'Software Licensing' },
                      { key: 'database_maintenance', label: 'Database Maintenance' },
                      { key: 'server_disc_space', label: 'Server and Disc Space' },
                      { key: 'training_support', label: 'Training and Support' }
                    ].map((item, idx) => (
                      <tr key={item.key} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-1.5 text-xs border-b border-gray-200 text-blue-600">{item.label}</td>
                        <td className="px-1 py-1 border-b border-gray-200">
                          <input type="text" value={(recurringCharges as any)[item.key]} onChange={(e) => setRecurringCharges({ ...recurringCharges, [item.key]: e.target.value })} className="w-full h-6 px-2 text-xs border border-gray-300 rounded text-right bg-white" />
                        </td>
                      </tr>
                    ))}
                    <tr className="bg-gray-100">
                      <td className="px-3 py-1.5 text-xs border-b border-gray-200 text-blue-600 font-medium">Total Amount</td>
                      <td className="px-1 py-1 border-b border-gray-200">
                        <input type="text" value={calculateTotalRecurring()} readOnly className="w-full h-6 px-2 text-xs border border-gray-300 rounded text-right bg-gray-100" />
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          {/* Pricing Summary - Below Tables */}
          <div className="flex justify-end">
            <div className="space-y-2 pt-2">
              <div className="flex items-center">
                <label className="w-36 text-xs font-medium text-blue-600">Currency:</label>
                <select value={pricingSummary.currency} onChange={(e) => setPricingSummary({ ...pricingSummary, currency: e.target.value })} className="w-36 h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50">
                  <option value="">Please Select</option>
                  <option value="CAD">CAD</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </div>
              <div className="flex items-center">
                <label className="w-36 text-xs font-medium text-green-600">One Time Cost:</label>
                <span className="text-xs text-gray-700">{pricingSummary.one_time_cost} (CAD Fifteen Thou...)</span>
              </div>
              <div className="flex items-center">
                <label className="w-36 text-xs font-medium text-green-600">Monthly Cost:</label>
                <span className="text-xs text-gray-700">{pricingSummary.monthly_cost} (CAD One Thou...)</span>
              </div>
              <div className="flex items-center">
                <label className="w-36 text-xs font-medium text-green-600">Number of Months:</label>
                <input type="text" value={pricingSummary.number_of_months} onChange={(e) => setPricingSummary({ ...pricingSummary, number_of_months: e.target.value })} className="w-12 h-6 px-1 text-xs border border-gray-300 rounded text-center" />
                <span className="ml-2 text-xs text-gray-600">6,000.00 (CAD)</span>
              </div>
              <div className="flex items-center">
                <label className="w-36 text-xs font-medium text-green-600">Total Amount:</label>
                <input type="text" value={pricingSummary.total_amount} onChange={(e) => setPricingSummary({ ...pricingSummary, total_amount: e.target.value })} className="w-36 h-6 px-2 text-xs border border-gray-300 rounded bg-gray-50" />
              </div>
            </div>
          </div>

          {/* Save Button */}
          <div className="flex justify-center pt-4">
            <button className="px-10 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 transition-colors">Save</button>
          </div>
        </div>
      )}

      {/* Process Flow Sub-tab */}
      {proposalSubTab === 'process-flow' && (() => {
        const boxStyle = "px-4 py-2 border-2 border-blue-400 rounded text-xs text-blue-600 font-medium text-center bg-white min-w-[160px] whitespace-nowrap";
        const arrowDown = <div className="flex justify-center my-1"><svg width="12" height="20" viewBox="0 0 12 20"><line x1="6" y1="0" x2="6" y2="14" stroke="#6366f1" strokeWidth="2"/><polygon points="1,14 6,20 11,14" fill="#6366f1"/></svg></div>;
        const arrowRight = <div className="flex items-center mx-1"><svg width="24" height="12" viewBox="0 0 24 12"><line x1="0" y1="6" x2="18" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="18,1 24,6 18,11" fill="#6366f1"/></svg></div>;
        const arrowBoth = <div className="flex items-center mx-1"><svg width="28" height="12" viewBox="0 0 28 12"><line x1="6" y1="6" x2="22" y2="6" stroke="#6366f1" strokeWidth="2"/><polygon points="6,1 0,6 6,11" fill="#6366f1"/><polygon points="22,1 28,6 22,11" fill="#6366f1"/></svg></div>;
        const colTitle = "text-sm font-bold text-blue-600 mb-3 text-center uppercase tracking-wide";
        return (
          <div className="space-y-8 overflow-x-auto pb-4">
            <div className="flex gap-8 items-start justify-center min-w-[900px]">
              <div className="flex flex-col items-center">
                <h4 className={colTitle}>CUSTOMER</h4>
                <div className={boxStyle}>Pre - Lead</div>
                {arrowDown}
                <div className={boxStyle}>Lead</div>
                {arrowDown}
                <div className={boxStyle}>Quality Lead</div>
                {arrowDown}
                <div className={boxStyle}>Customer</div>
                {arrowDown}
                <div className="flex items-center"><div className={boxStyle}>Customer Master</div>{arrowRight}</div>
                {arrowDown}
                <div className={boxStyle}>Campaign</div>
                {arrowDown}
                <div className={boxStyle}>Customer Survey</div>
              </div>
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>ORDERS</h4>
                <div className={boxStyle}>Customer Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Inquiry</div>
                {arrowDown}
                <div className={boxStyle}>Supplier Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Quotation</div>
                {arrowDown}
                <div className={boxStyle}>Customer Order</div>
              </div>
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>SUPPLIER</h4>
                <div className={boxStyle}>Supplier Master</div>
                {arrowDown}
                <div className={boxStyle}>Vendor Master</div>
                {arrowDown}
                <div className={boxStyle}>Manufacturer Master</div>
                {arrowDown}
                <div className={boxStyle}>Price List</div>
              </div>
              <div className="flex flex-col items-center mt-[168px]">
                <h4 className={colTitle}>PROJECT</h4>
                <div className={boxStyle}>Task Management</div>
                {arrowDown}
                <div className={boxStyle}>Project Management</div>
                {arrowDown}
                <div className={boxStyle}>Timesheet</div>
              </div>
            </div>
            <div className="flex justify-center mt-6">
              <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Generate PDF</button>
            </div>
          </div>
        );
      })()}

      {/* Proposal Sub-tab */}
      {proposalSubTab === 'proposal' && (
        <div className="space-y-4">
          {/* Header */}
          <h4 className="text-sm font-bold text-gray-800">PROPOSAL</h4>

          {/* Rich Text Editor */}
          <div className="border rounded-lg overflow-hidden">
            {/* Toolbar */}
            <div className="flex items-center gap-1 p-2 border-b bg-gray-50 flex-wrap">
              <button onClick={() => handleProposalExec('bold')} className="p-1.5 hover:bg-gray-200 rounded" title="Bold">
                <Bold className="w-4 h-4" />
              </button>
              <button onClick={() => handleProposalExec('italic')} className="p-1.5 hover:bg-gray-200 rounded" title="Italic">
                <Italic className="w-4 h-4" />
              </button>
              <button onClick={() => handleProposalExec('underline')} className="p-1.5 hover:bg-gray-200 rounded" title="Underline">
                <Underline className="w-4 h-4" />
              </button>
              <div className="w-px h-5 bg-gray-300 mx-1" />
              <select onChange={(e) => handleProposalExec('fontName', e.target.value)} className="h-7 px-2 text-xs border border-gray-300 rounded bg-white">
                <option value="Calibri">Calibri</option>
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Georgia">Georgia</option>
                <option value="Verdana">Verdana</option>
              </select>
              <select onChange={(e) => handleProposalExec('fontSize', e.target.value)} className="h-7 px-2 text-xs border border-gray-300 rounded bg-white">
                <option value="1">8</option>
                <option value="2">10</option>
                <option value="3" selected>12</option>
                <option value="4">14</option>
                <option value="5">18</option>
                <option value="6">24</option>
                <option value="7">36</option>
              </select>
              <div className="relative">
                <input type="color" onChange={(e) => handleProposalExec('foreColor', e.target.value)} className="w-7 h-7 p-0.5 border border-gray-300 rounded cursor-pointer" title="Text Color" defaultValue="#000000" />
              </div>
              <div className="w-px h-5 bg-gray-300 mx-1" />
              <button onClick={() => handleProposalExec('insertUnorderedList')} className="p-1.5 hover:bg-gray-200 rounded" title="Bullet List">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
              </button>
              <button onClick={() => handleProposalExec('insertOrderedList')} className="p-1.5 hover:bg-gray-200 rounded" title="Numbered List">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
              </button>
              <button onClick={() => handleProposalExec('justifyLeft')} className="p-1.5 hover:bg-gray-200 rounded" title="Align Left">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h10M4 18h16" /></svg>
              </button>
            </div>

            {/* Editor Content */}
            <div
              ref={proposalEditorRef}
              contentEditable
              className="min-h-[500px] p-4 text-sm focus:outline-none overflow-y-auto bg-white"
              style={{ maxHeight: '600px' }}
              dangerouslySetInnerHTML={{ __html: proposalContent || getProposalTemplate() }}
              onInput={(e) => setProposalContent(e.currentTarget.innerHTML)}
            />
          </div>

          {/* Action Buttons */}
          <div className="flex justify-center gap-3">
            <button className="px-5 py-1.5 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600 transition-colors">
              Save
            </button>
            <button className="px-5 py-1.5 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors">
              Generate PDF
            </button>
            <button onClick={() => setProposalContent(getProposalTemplate())} className="px-5 py-1.5 text-sm font-medium text-white bg-gray-600 rounded hover:bg-gray-700 transition-colors">
              Refresh
            </button>
          </div>
        </div>
      )}

      {/* Proposal Date Sub-tab */}
      {proposalSubTab === 'proposal-date' && (
        <div className="space-y-6">
          {/* Header */}
          <h3 className="text-sm font-bold text-gray-800">PROPOSAL DATE TIME</h3>

          {/* GENERAL INFORMATION Section */}
          <div>
            <h4 className="text-sm font-bold text-gray-800 mb-4">GENERAL INFORMATION</h4>
            <div className="grid grid-cols-2 gap-x-12 gap-y-3">
              {/* Left Column */}
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Key Person's Name:</label>
                  <input type="text" value={proposalDateForm.key_person_name} onChange={(e) => setProposalDateForm({ ...proposalDateForm, key_person_name: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Company Name:</label>
                  <input type="text" value={proposalDateForm.company_name} onChange={(e) => setProposalDateForm({ ...proposalDateForm, company_name: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Address:</label>
                  <input type="text" value={proposalDateForm.address} onChange={(e) => setProposalDateForm({ ...proposalDateForm, address: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Country</label>
                  <select value={proposalDateForm.country} onChange={(e) => setProposalDateForm({ ...proposalDateForm, country: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Country</option>
                    <option value="Canada">Canada</option>
                    <option value="United States">United States</option>
                    <option value="United Kingdom">United Kingdom</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Province</label>
                  <select value={proposalDateForm.province} onChange={(e) => setProposalDateForm({ ...proposalDateForm, province: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select State</option>
                    <option value="Ontario">Ontario</option>
                    <option value="Quebec">Quebec</option>
                    <option value="British Columbia">British Columbia</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">City</label>
                  <select value={proposalDateForm.city} onChange={(e) => setProposalDateForm({ ...proposalDateForm, city: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select City</option>
                    <option value="Toronto">Toronto</option>
                    <option value="Vancouver">Vancouver</option>
                    <option value="Montreal">Montreal</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Postal Code:</label>
                  <input type="text" value={proposalDateForm.postal_code} onChange={(e) => setProposalDateForm({ ...proposalDateForm, postal_code: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>

              {/* Right Column */}
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Company Phone:</label>
                  <input type="text" value={proposalDateForm.company_phone} onChange={(e) => setProposalDateForm({ ...proposalDateForm, company_phone: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">EXT:</label>
                  <input type="text" value={proposalDateForm.ext} onChange={(e) => setProposalDateForm({ ...proposalDateForm, ext: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Fax:</label>
                  <input type="text" value={proposalDateForm.fax} onChange={(e) => setProposalDateForm({ ...proposalDateForm, fax: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Email:</label>
                  <input type="email" value={proposalDateForm.email} onChange={(e) => setProposalDateForm({ ...proposalDateForm, email: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Website:</label>
                  <input type="text" value={proposalDateForm.website} onChange={(e) => setProposalDateForm({ ...proposalDateForm, website: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Any Branch Office:</label>
                  <input type="text" value={proposalDateForm.any_branch_office} onChange={(e) => setProposalDateForm({ ...proposalDateForm, any_branch_office: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Branch Address:</label>
                  <input type="text" value={proposalDateForm.branch_address} onChange={(e) => setProposalDateForm({ ...proposalDateForm, branch_address: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* ARRANGE PROPOSAL SESSION Section */}
          <div>
            <h4 className="text-sm font-bold text-gray-800 mb-4">ARRANGE PROPOSAL SESSION</h4>
            <div className="grid grid-cols-2 gap-x-12 gap-y-3">
              {/* Left Column */}
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Preferred Date:</label>
                  <input type="date" value={proposalDateForm.preferred_date} onChange={(e) => setProposalDateForm({ ...proposalDateForm, preferred_date: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Preferred Time:</label>
                  <input type="time" value={proposalDateForm.preferred_time} onChange={(e) => setProposalDateForm({ ...proposalDateForm, preferred_time: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>

              {/* Right Column */}
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">Remark:</label>
                  <input type="text" value={proposalDateForm.remark} onChange={(e) => setProposalDateForm({ ...proposalDateForm, remark: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-36 text-xs font-medium text-blue-600 flex-shrink-0">TimeZone:</label>
                  <select value={proposalDateForm.timezone} onChange={(e) => setProposalDateForm({ ...proposalDateForm, timezone: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select TimeZone</option>
                    <option value="EST">Eastern Standard Time (EST)</option>
                    <option value="CST">Central Standard Time (CST)</option>
                    <option value="MST">Mountain Standard Time (MST)</option>
                    <option value="PST">Pacific Standard Time (PST)</option>
                    <option value="GMT">Greenwich Mean Time (GMT)</option>
                    <option value="UTC">Coordinated Universal Time (UTC)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {proposalSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => handleOpenProposalFollowUp()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {proposalFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  proposalFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => handleOpenProposalFollowUp(activity)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteProposalFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {proposalSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => handleOpenProposalMemo()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {proposalMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  proposalMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => handleOpenProposalMemo(memo)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteProposalMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {proposalSubTab === 'upload-file' && (
        <div className="space-y-4">
          {/* Document Row */}
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={proposalSubTabFile?.name || ''} />
            <input ref={proposalSubTabFileRef} type="file" onChange={handleProposalSubTabFileChange} className="hidden" style={{ display: 'none' }} />
            <button type="button" onClick={handleProposalSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button type="button" onClick={handleProposalSubTabUpload} disabled={!proposalSubTabFile || proposalSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed">{proposalSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* Notes Row */}
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={proposalSubTabNotes} onChange={(e) => setProposalSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          {/* Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {proposalSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  proposalSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleProposalSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {proposalSubTab === 'workflow--audit-trail' && (
        <div className="p-4 text-center text-gray-500 text-sm">Workflow & Audit Trail content</div>
      )}

      {/* Follow-Up Modal */}
      {showProposalFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button onClick={() => setShowProposalPreviousActivities(!showProposalPreviousActivities)} className="px-3 py-1 text-xs font-medium text-blue-900 bg-blue-500 rounded hover:bg-blue-400">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowProposalFollowUpModal(false); setEditingProposalFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            {/* Body */}
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                {/* Contact */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select
                    value={proposalFollowUpForm.contact_id}
                    onChange={(e) => {
                      const contactId = e.target.value;
                      const selectedContact = proposalContacts.find((c: any) => c.id?.toString() === contactId);
                      setProposalFollowUpForm({
                        ...proposalFollowUpForm,
                        contact_id: contactId,
                        sent_to: selectedContact?.email || ''
                      });
                    }}
                    className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  >
                    <option value="">Select Contact</option>
                    {proposalContacts.map((contact: any) => (
                      <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
                    ))}
                  </select>
                </div>
                {/* Activity Subject */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={proposalFollowUpForm.subject} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                {/* Email */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={proposalFollowUpForm.sent_to} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readOnly />
                </div>
                {/* Activity Type */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={proposalFollowUpForm.activity_type} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                {/* Start Date / Time */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={proposalFollowUpForm.start_date} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <input type="time" value={proposalFollowUpForm.start_time} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                {/* Assigned To */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={proposalFollowUpForm.assigned_to} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select User</option>
                    <option value="1">Admin User</option>
                    <option value="Junaid Ali">Junaid Ali</option>
                  </select>
                </div>
                {/* Next Follow Up Date */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={proposalFollowUpForm.next_followup_date} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                {/* Status */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={proposalFollowUpForm.status} onChange={(e) => setProposalFollowUpForm({ ...proposalFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              {/* Description */}
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                {/* Rich Text Toolbar */}
                <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalFollowUpExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded" title="Bold">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalFollowUpExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded" title="Italic">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalFollowUpExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded" title="Underline">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalFollowUpExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Highlight"><Edit2 className="w-3.5 h-3.5" /></button>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <select onChange={(e) => { handleProposalFollowUpExec('fontName', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                  </select>
                  <select onChange={(e) => { handleProposalFollowUpExec('fontSize', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                    <option value="1">8</option>
                    <option value="2">10</option>
                    <option value="3">12</option>
                    <option value="4">14</option>
                    <option value="5">18</option>
                    <option value="6">24</option>
                    <option value="7">36</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300" title="Text Color">A</button>
                    <input type="color" onChange={(e) => handleProposalFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Text Color" />
                  </div>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalFollowUpExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Bullet List">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalFollowUpExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Numbered List">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                  </button>
                  <select onChange={(e) => { handleProposalFollowUpExec(e.target.value === 'left' ? 'justifyLeft' : e.target.value === 'center' ? 'justifyCenter' : e.target.value === 'right' ? 'justifyRight' : 'justifyFull'); e.target.value = ''; }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer">
                    <option value="">Align</option>
                    <option value="left">Left</option>
                    <option value="center">Center</option>
                    <option value="right">Right</option>
                    <option value="justify">Justify</option>
                  </select>
                </div>
                {/* Rich Text Editor */}
                <div ref={proposalFollowUpEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y" style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }} suppressContentEditableWarning />
              </div>
              {/* Save Button */}
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveProposalFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showProposalMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowProposalMemoModal(false); setEditingProposalMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalMemoExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded" title="Bold">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalMemoExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded" title="Italic">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalMemoExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded" title="Underline">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalMemoExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Highlight"><Edit2 className="w-3.5 h-3.5" /></button>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <select onChange={(e) => { handleProposalMemoExec('fontName', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="jost">
                  <option value="jost">jost</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Courier New">Courier New</option><option value="Georgia">Georgia</option><option value="Verdana">Verdana</option>
                </select>
                <select onChange={(e) => { handleProposalMemoExec('fontSize', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="4">
                  <option value="1">8</option><option value="2">10</option><option value="3">12</option><option value="4">14</option><option value="5">18</option><option value="6">24</option><option value="7">36</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded bg-yellow-300" title="Text Color">A</button>
                  <input type="color" onChange={(e) => handleProposalMemoExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Text Color" />
                </div>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalMemoExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Bullet List">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleProposalMemoExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Numbered List">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
                </button>
                <select onChange={(e) => { handleProposalMemoExec(e.target.value === 'left' ? 'justifyLeft' : e.target.value === 'center' ? 'justifyCenter' : e.target.value === 'right' ? 'justifyRight' : 'justifyFull'); e.target.value = ''; }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer">
                  <option value="">Align</option><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option><option value="justify">Justify</option>
                </select>
              </div>
              <div ref={proposalMemoEditorRef} contentEditable className="w-full min-h-[220px] max-h-[400px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white resize-y" style={{ fontFamily: 'jost, sans-serif', fontSize: '14px' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveProposalMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Agreement Form ==============
function AgreementForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [agreementSubTab, setAgreementSubTab] = useState('details');
  const agreementSubTabs = ['Details', 'Agreement', 'Agreement Date', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [agreementFormData, setAgreementFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [agreementContacts, setAgreementContacts] = useState<any[]>([]);
  const [agreementEmailTemplates, setAgreementEmailTemplates] = useState<any[]>([]);
  const [agreementDocs, setAgreementDocs] = useState<any[]>([]);
  const [agreementFile, setAgreementFile] = useState<File | null>(null);
  const [agreementUploading, setAgreementUploading] = useState(false);
  const agreementFileRef = React.useRef<HTMLInputElement>(null);
  const [emailSentList, setEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [detailsForm, setDetailsForm] = useState({
    company_name: '', authorized_person: '', project_name: '', from_date: '', rev: '',
    axiever_authorized_person: '', project_manager: '', account_contact: '', training_coordinator: '',
    subscription_term: '', from_to_start: '', from_to_end: '',
    software_licensing_curr: '', software_licensing_amt: '',
    database_maintenance_curr: '', database_maintenance_amt: ''
  });

  // Agreement Date form state
  const [agreementDateForm, setAgreementDateForm] = useState({
    key_person_name: '', company_name: '', address: '', country: '', province: '', city: '', postal_code: '',
    company_phone: '', ext: '', fax: '', email: '', website: '', any_branch_office: '', branch_address: '',
    preferred_date: '', preferred_time: '', remark: '', timezone: ''
  });

  // Follow-up state
  const [agreementFollowUps, setAgreementFollowUps] = useState<any[]>([]);
  const [showAgreementFollowUpModal, setShowAgreementFollowUpModal] = useState(false);
  const [editingAgreementFollowUp, setEditingAgreementFollowUp] = useState<any>(null);
  const [agreementFollowUpForm, setAgreementFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', end_date: '', end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: '', next_followup_time: '', channel_type: '', sent_to: ''
  });
  const agreementFollowUpEditorRef = React.useRef<HTMLDivElement>(null);
  const [showAgreementPreviousActivities, setShowAgreementPreviousActivities] = useState(false);

  // Memo state
  const [agreementMemos, setAgreementMemos] = useState<any[]>([]);
  const [showAgreementMemoModal, setShowAgreementMemoModal] = useState(false);
  const [editingAgreementMemo, setEditingAgreementMemo] = useState<any>(null);
  const [agreementMemoForm, setAgreementMemoForm] = useState({ content: '' });
  const agreementMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [agreementSubTabDocs, setAgreementSubTabDocs] = useState<any[]>([]);
  const [agreementSubTabFile, setAgreementSubTabFile] = useState<File | null>(null);
  const [agreementSubTabNotes, setAgreementSubTabNotes] = useState('');
  const [agreementSubTabUploading, setAgreementSubTabUploading] = useState(false);
  const agreementSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Agreement sub-tab state
  const [agreementType, setAgreementType] = useState('master_services_agreement');
  const [agreementContent, setAgreementContent] = useState('');
  const agreementDocEditorRef = React.useRef<HTMLDivElement>(null);

  // Agreement type options
  const agreementTypeOptions = [
    { value: 'master_services_agreement', label: 'Master Services Agreement' },
    { value: 'subscription_saas_agreement', label: 'Subscription SaaS Agreement' },
    { value: 'end_user_license_agreement', label: 'End-User License Agreement' },
    { value: 'support_subscription_agreement', label: 'Support Subscription Agreement' }
  ];

  // Get default agreement template content
  const getAgreementTemplate = (type: string) => {
    const templates: { [key: string]: string } = {
      master_services_agreement: `
<h2 style="text-align: center;"><strong>MASTER SERVICES AGREEMENT</strong></h2>
<p>&nbsp;</p>
<p>This Master Services Agreement (the "<strong>Agreement</strong>") is entered into as of the date last signed below (the "<strong>Effective Date</strong>") by and between:</p>
<p>&nbsp;</p>
<p><strong>AXIEVER CONSULTING CORPORATION</strong>, a corporation organized under the laws of Ontario, Canada, with its principal place of business at 100 King Street West, Suite 5600, Toronto, Ontario M5X 1C9 (hereinafter referred to as "<strong>Axiever</strong>" or "<strong>Service Provider</strong>"),</p>
<p>&nbsp;</p>
<p>AND</p>
<p>&nbsp;</p>
<p><strong>[CUSTOMER NAME]</strong>, a [type of entity] organized under the laws of [jurisdiction], with its principal place of business at [address] (hereinafter referred to as "<strong>Customer</strong>" or "<strong>Client</strong>").</p>
<p>&nbsp;</p>
<p>(Each a "<strong>Party</strong>" and collectively the "<strong>Parties</strong>")</p>
<p>&nbsp;</p>
<h3><strong>RECITALS</strong></h3>
<p>WHEREAS, Axiever is engaged in the business of providing software development, consulting, implementation, and related professional services;</p>
<p>WHEREAS, Customer desires to engage Axiever to provide certain services as described in one or more Statements of Work executed pursuant to this Agreement;</p>
<p>NOW, THEREFORE, in consideration of the mutual covenants and agreements set forth herein, and for other good and valuable consideration, the receipt and sufficiency of which are hereby acknowledged, the Parties agree as follows:</p>
<p>&nbsp;</p>
<h3><strong>1. DEFINITIONS</strong></h3>
<p>1.1 "<strong>Confidential Information</strong>" means all non-public information disclosed by one Party to the other Party, whether orally or in writing, that is designated as confidential or that reasonably should be understood to be confidential given the nature of the information and the circumstances of disclosure.</p>
<p>1.2 "<strong>Deliverables</strong>" means the work product to be delivered by Axiever to Customer as specified in an applicable Statement of Work.</p>
<p>1.3 "<strong>Services</strong>" means the professional services to be provided by Axiever to Customer as described in a Statement of Work.</p>
<p>1.4 "<strong>Statement of Work</strong>" or "<strong>SOW</strong>" means a document describing the Services to be performed, Deliverables, timeline, fees, and other project-specific terms.</p>
<p>&nbsp;</p>
<h3><strong>2. SERVICES</strong></h3>
<p>2.1 <strong>Scope of Services.</strong> Axiever shall provide the Services as described in each Statement of Work executed by the Parties.</p>
<p>2.2 <strong>Performance.</strong> Axiever shall perform the Services in a professional and workmanlike manner in accordance with industry standards.</p>
<p>2.3 <strong>Change Orders.</strong> Any changes to the scope of Services shall be documented in a written change order signed by both Parties.</p>
<p>&nbsp;</p>
<h3><strong>3. FEES AND PAYMENT</strong></h3>
<p>3.1 <strong>Fees.</strong> Customer shall pay Axiever the fees specified in the applicable Statement of Work.</p>
<p>3.2 <strong>Invoicing.</strong> Axiever shall invoice Customer as specified in the Statement of Work, or monthly in arrears if not specified.</p>
<p>3.3 <strong>Payment Terms.</strong> All invoices are due and payable within thirty (30) days of receipt.</p>
<p>3.4 <strong>Late Payment.</strong> Late payments shall bear interest at the rate of 1.5% per month or the maximum rate permitted by law.</p>
<p>&nbsp;</p>
<h3><strong>4. TERM AND TERMINATION</strong></h3>
<p>4.1 <strong>Term.</strong> This Agreement shall commence on the Effective Date and continue until terminated by either Party.</p>
<p>4.2 <strong>Termination for Convenience.</strong> Either Party may terminate this Agreement upon thirty (30) days' written notice.</p>
<p>4.3 <strong>Termination for Cause.</strong> Either Party may terminate this Agreement immediately upon written notice if the other Party materially breaches this Agreement and fails to cure such breach within thirty (30) days of receiving written notice.</p>
<p>&nbsp;</p>
<h3><strong>5. CONFIDENTIALITY</strong></h3>
<p>5.1 Each Party agrees to hold the other Party's Confidential Information in strict confidence and not to disclose such information to any third party except as necessary to perform its obligations under this Agreement.</p>
<p>5.2 The obligations of confidentiality shall survive termination of this Agreement for a period of five (5) years.</p>
<p>&nbsp;</p>
<h3><strong>6. INTELLECTUAL PROPERTY</strong></h3>
<p>6.1 <strong>Pre-Existing IP.</strong> Each Party retains all rights in its pre-existing intellectual property.</p>
<p>6.2 <strong>Work Product.</strong> Subject to payment in full, all Deliverables created specifically for Customer shall be the property of Customer.</p>
<p>6.3 <strong>Axiever Tools.</strong> Axiever retains all rights in its proprietary tools, methodologies, and know-how.</p>
<p>&nbsp;</p>
<h3><strong>7. WARRANTIES AND DISCLAIMERS</strong></h3>
<p>7.1 Axiever warrants that the Services will be performed in a professional and workmanlike manner.</p>
<p>7.2 EXCEPT AS EXPRESSLY SET FORTH HEREIN, AXIEVER MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</p>
<p>&nbsp;</p>
<h3><strong>8. LIMITATION OF LIABILITY</strong></h3>
<p>8.1 IN NO EVENT SHALL EITHER PARTY BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES.</p>
<p>8.2 AXIEVER'S TOTAL LIABILITY SHALL NOT EXCEED THE FEES PAID BY CUSTOMER IN THE TWELVE (12) MONTHS PRECEDING THE CLAIM.</p>
<p>&nbsp;</p>
<h3><strong>9. GENERAL PROVISIONS</strong></h3>
<p>9.1 <strong>Governing Law.</strong> This Agreement shall be governed by the laws of the Province of Ontario, Canada.</p>
<p>9.2 <strong>Entire Agreement.</strong> This Agreement constitutes the entire agreement between the Parties.</p>
<p>9.3 <strong>Amendment.</strong> This Agreement may only be amended in writing signed by both Parties.</p>
<p>9.4 <strong>Severability.</strong> If any provision is held invalid, the remaining provisions shall continue in effect.</p>
<p>&nbsp;</p>
<p><strong>IN WITNESS WHEREOF</strong>, the Parties have executed this Agreement as of the Effective Date.</p>
<p>&nbsp;</p>
<table style="width: 100%;">
<tr>
<td style="width: 50%; vertical-align: top;">
<p><strong>AXIEVER CONSULTING CORPORATION</strong></p>
<p>&nbsp;</p>
<p>By: _______________________________</p>
<p>Name: ____________________________</p>
<p>Title: _____________________________</p>
<p>Date: _____________________________</p>
</td>
<td style="width: 50%; vertical-align: top;">
<p><strong>[CUSTOMER NAME]</strong></p>
<p>&nbsp;</p>
<p>By: _______________________________</p>
<p>Name: ____________________________</p>
<p>Title: _____________________________</p>
<p>Date: _____________________________</p>
</td>
</tr>
</table>
`,
      subscription_saas_agreement: `
<h2 style="text-align: center;"><strong>SUBSCRIPTION SAAS AGREEMENT</strong></h2>
<p>&nbsp;</p>
<p>This Subscription SaaS Agreement (the "<strong>Agreement</strong>") is entered into as of the Effective Date by and between:</p>
<p>&nbsp;</p>
<p><strong>AXIEVER CONSULTING CORPORATION</strong> ("<strong>Provider</strong>") and <strong>[CUSTOMER NAME]</strong> ("<strong>Subscriber</strong>").</p>
<p>&nbsp;</p>
<h3><strong>1. SUBSCRIPTION SERVICES</strong></h3>
<p>1.1 Provider grants Subscriber a non-exclusive, non-transferable right to access and use the Software as a Service (SaaS) platform during the Subscription Term.</p>
<p>1.2 The SaaS Services include access to the Provider's cloud-based software application and related support services.</p>
<p>&nbsp;</p>
<h3><strong>2. SUBSCRIPTION FEES</strong></h3>
<p>2.1 Subscriber shall pay the subscription fees as set forth in the Order Form.</p>
<p>2.2 Fees are billed in advance on a monthly/annual basis.</p>
<p>&nbsp;</p>
<h3><strong>3. TERM</strong></h3>
<p>3.1 The initial Subscription Term shall be as specified in the Order Form.</p>
<p>3.2 The subscription shall automatically renew for successive periods unless either Party provides notice of non-renewal.</p>
<p>&nbsp;</p>
<h3><strong>4. DATA PROTECTION</strong></h3>
<p>4.1 Provider shall implement appropriate technical and organizational measures to protect Subscriber data.</p>
<p>4.2 Provider shall comply with applicable data protection laws.</p>
`,
      end_user_license_agreement: `
<h2 style="text-align: center;"><strong>END-USER LICENSE AGREEMENT</strong></h2>
<p>&nbsp;</p>
<p>This End-User License Agreement (the "<strong>EULA</strong>") is a legal agreement between you ("<strong>End User</strong>") and <strong>AXIEVER CONSULTING CORPORATION</strong> ("<strong>Licensor</strong>").</p>
<p>&nbsp;</p>
<h3><strong>1. LICENSE GRANT</strong></h3>
<p>1.1 Subject to the terms of this EULA, Licensor grants End User a limited, non-exclusive, non-transferable license to use the Software.</p>
<p>&nbsp;</p>
<h3><strong>2. RESTRICTIONS</strong></h3>
<p>2.1 End User shall not: (a) copy, modify, or distribute the Software; (b) reverse engineer or decompile the Software; (c) sublicense or transfer the license to any third party.</p>
<p>&nbsp;</p>
<h3><strong>3. INTELLECTUAL PROPERTY</strong></h3>
<p>3.1 The Software is protected by copyright and other intellectual property laws. Licensor retains all rights, title, and interest in the Software.</p>
<p>&nbsp;</p>
<h3><strong>4. DISCLAIMER OF WARRANTIES</strong></h3>
<p>4.1 THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.</p>
`,
      support_subscription_agreement: `
<h2 style="text-align: center;"><strong>SUPPORT SUBSCRIPTION AGREEMENT</strong></h2>
<p>&nbsp;</p>
<p>This Support Subscription Agreement (the "<strong>Agreement</strong>") is entered into by and between <strong>AXIEVER CONSULTING CORPORATION</strong> ("<strong>Support Provider</strong>") and <strong>[CUSTOMER NAME]</strong> ("<strong>Customer</strong>").</p>
<p>&nbsp;</p>
<h3><strong>1. SUPPORT SERVICES</strong></h3>
<p>1.1 Support Provider shall provide the following support services during the Support Term:</p>
<ul>
<li>Technical support via email and phone</li>
<li>Bug fixes and security patches</li>
<li>Software updates and upgrades</li>
<li>Access to knowledge base and documentation</li>
</ul>
<p>&nbsp;</p>
<h3><strong>2. SERVICE LEVELS</strong></h3>
<p>2.1 <strong>Response Times:</strong></p>
<ul>
<li>Critical Issues: 4 hours</li>
<li>High Priority: 8 hours</li>
<li>Medium Priority: 24 hours</li>
<li>Low Priority: 48 hours</li>
</ul>
<p>&nbsp;</p>
<h3><strong>3. SUPPORT HOURS</strong></h3>
<p>3.1 Standard support is available Monday through Friday, 9:00 AM to 5:00 PM Eastern Time, excluding holidays.</p>
<p>3.2 Premium support options with extended hours are available for additional fees.</p>
<p>&nbsp;</p>
<h3><strong>4. SUBSCRIPTION FEES</strong></h3>
<p>4.1 Customer shall pay the support subscription fees as specified in the Order Form.</p>
`
    };
    return templates[type] || templates.master_services_agreement;
  };

  // Initialize form
  useEffect(() => {
    if (data) {
      setAgreementFormData({
        company_name: data.company_name || '',
        contact_name: data.contact_name || '',
        email_format_type: 'Email with Agreement for Signature',
        branch_office: data.branch_office || '',
        contact_email: data.contact_email || ''
      });
      setDetailsForm(prev => ({ ...prev, company_name: data.company_name || '' }));
    }
  }, [data]);

  // Load contacts
  useEffect(() => {
    if (leadId) {
      api.getLeadContactsForEdit(leadId).then(setAgreementContacts).catch(() => setAgreementContacts([]));
    }
  }, [leadId]);

  // Load email templates for Agreement tab
  useEffect(() => {
    api.getCRIEmailTemplates('agreement').then(setAgreementEmailTemplates).catch(() => setAgreementEmailTemplates([]));
  }, []);

  // Load documents
  useEffect(() => {
    if (crId) {
      api.getCRDocuments(crId, 'agreement').then(setAgreementDocs).catch(() => setAgreementDocs([]));
    }
  }, [crId]);

  // Load follow-ups
  useEffect(() => {
    if (crId && agreementSubTab === 'follow-up') {
      api.getCRActivities(crId, 'agreement-followup').then(setAgreementFollowUps).catch(() => setAgreementFollowUps([]));
    }
  }, [crId, agreementSubTab]);

  // Load memos
  useEffect(() => {
    if (crId && agreementSubTab === 'memo') {
      api.getCRMemos(crId, 'agreement').then(setAgreementMemos).catch(() => setAgreementMemos([]));
    }
  }, [crId, agreementSubTab]);

  // Load upload file documents
  useEffect(() => {
    if (crId && agreementSubTab === 'upload-file') {
      api.getCRDocuments(crId, 'agreement-upload').then(setAgreementSubTabDocs).catch(() => setAgreementSubTabDocs([]));
    }
  }, [crId, agreementSubTab]);

  // Initialize agreement content when sub-tab opens
  useEffect(() => {
    if (agreementSubTab === 'agreement') {
      const template = getAgreementTemplate(agreementType);
      setAgreementContent(template);
      setTimeout(() => {
        if (agreementDocEditorRef.current) {
          agreementDocEditorRef.current.innerHTML = template;
        }
      }, 50);
    }
  }, [agreementSubTab]);

  // Handle agreement type change
  const handleAgreementTypeChange = (type: string) => {
    setAgreementType(type);
    const template = getAgreementTemplate(type);
    setAgreementContent(template);
    if (agreementDocEditorRef.current) {
      agreementDocEditorRef.current.innerHTML = template;
    }
  };

  // Agreement document editor handlers
  const handleAgreementDocExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    agreementDocEditorRef.current?.focus();
  };

  // Save agreement content
  const handleSaveAgreement = async () => {
    const content = agreementDocEditorRef.current?.innerHTML || agreementContent;
    try {
      // TODO: API call to save agreement content
      alert('Agreement saved successfully!');
    } catch (err: any) {
      alert(err?.response?.data?.detail || 'Failed to save agreement');
    }
  };

  // Generate agreement PDF
  const handleGenerateAgreementPDF = async () => {
    try {
      // TODO: API call to generate PDF
      alert('PDF generation initiated');
    } catch (err: any) {
      alert(err?.response?.data?.detail || 'Failed to generate PDF');
    }
  };

  // Refresh agreement template
  const handleRefreshAgreement = () => {
    const template = getAgreementTemplate(agreementType);
    setAgreementContent(template);
    if (agreementDocEditorRef.current) {
      agreementDocEditorRef.current.innerHTML = template;
    }
  };

  // Document handlers
  const handleAgreementChooseFile = () => agreementFileRef.current?.click();
  const handleAgreementFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setAgreementFile(e.target.files[0]); };
  const handleAgreementUploadFile = async () => {
    if (!agreementFile || !crId) { alert(!agreementFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setAgreementUploading(true);
    try {
      await api.uploadCRDocument(crId, agreementFile, 'agreement', 'Details');
      const docs = await api.getCRDocuments(crId, 'agreement');
      setAgreementDocs(docs);
      setAgreementFile(null);
      if (agreementFileRef.current) agreementFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setAgreementUploading(false); }
  };
  const handleAgreementDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setAgreementDocs(agreementDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  // Follow-up handlers
  const handleAgreementFollowUpExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    agreementFollowUpEditorRef.current?.focus();
  };
  const handleOpenAgreementFollowUp = (item?: any) => {
    if (item) {
      setEditingAgreementFollowUp(item);
      setAgreementFollowUpForm({ activity_type: item.activity_type || '', subject: item.subject || '', start_date: item.start_date || '', start_time: item.start_time || '', end_date: item.end_date || '', end_time: item.end_time || '', description: item.description || '', status: item.status || 'Open', contact_id: item.contact_id?.toString() || '', assigned_to: item.assigned_to?.toString() || '', priority: item.priority || '', next_followup_date: item.next_followup_date || '', next_followup_time: item.next_followup_time || '', channel_type: item.channel_type || '', sent_to: item.sent_to || '' });
    } else {
      setEditingAgreementFollowUp(null);
      const now = new Date();
      setAgreementFollowUpForm({ activity_type: '', subject: '', start_date: now.toISOString().split('T')[0], start_time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), end_date: now.toISOString().split('T')[0], end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: now.toISOString().split('T')[0], next_followup_time: '', channel_type: '', sent_to: '' });
    }
    setShowAgreementFollowUpModal(true);
    setTimeout(() => { if (agreementFollowUpEditorRef.current) agreementFollowUpEditorRef.current.innerHTML = item?.description || ''; }, 50);
  };
  const handleSaveAgreementFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = agreementFollowUpEditorRef.current?.innerHTML || agreementFollowUpForm.description;
    const formToSave = { ...agreementFollowUpForm, description: descriptionContent };
    try {
      if (editingAgreementFollowUp) { const updated = await api.updateCRActivity(crId, editingAgreementFollowUp.id, formToSave); setAgreementFollowUps(agreementFollowUps.map((a: any) => a.id === editingAgreementFollowUp.id ? updated : a)); }
      else { const created = await api.createCRActivity(crId, { ...formToSave, tab_name: 'agreement-followup' }); setAgreementFollowUps([...agreementFollowUps, created]); }
      setShowAgreementFollowUpModal(false); setEditingAgreementFollowUp(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteAgreementFollowUp = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRActivity(crId, id); setAgreementFollowUps(agreementFollowUps.filter((a: any) => a.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleAgreementMemoExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    agreementMemoEditorRef.current?.focus();
  };
  const handleOpenAgreementMemo = (item?: any) => {
    if (item) { setEditingAgreementMemo(item); setAgreementMemoForm({ content: item.content || '' }); }
    else { setEditingAgreementMemo(null); setAgreementMemoForm({ content: '' }); }
    setShowAgreementMemoModal(true);
    setTimeout(() => { if (agreementMemoEditorRef.current) agreementMemoEditorRef.current.innerHTML = item?.content || ''; }, 50);
  };
  const handleSaveAgreementMemo = async () => {
    if (!crId) return;
    const content = agreementMemoEditorRef.current?.innerHTML || agreementMemoForm.content;
    try {
      if (editingAgreementMemo) { const updated = await api.updateCRMemo(crId, editingAgreementMemo.id, { content }); setAgreementMemos(agreementMemos.map((m: any) => m.id === editingAgreementMemo.id ? updated : m)); }
      else { const created = await api.createCRMemo(crId, { content, tab_name: 'agreement' }); setAgreementMemos([...agreementMemos, created]); }
      setShowAgreementMemoModal(false); setEditingAgreementMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteAgreementMemo = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRMemo(crId, id); setAgreementMemos(agreementMemos.filter((m: any) => m.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Upload file handlers
  const handleAgreementSubTabChooseFile = () => agreementSubTabFileRef.current?.click();
  const handleAgreementSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setAgreementSubTabFile(e.target.files[0]); };
  const handleAgreementSubTabUpload = async () => {
    if (!agreementSubTabFile || !crId) { alert(!agreementSubTabFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setAgreementSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, agreementSubTabFile, 'agreement-upload', 'Upload File');
      const docs = await api.getCRDocuments(crId, 'agreement-upload');
      setAgreementSubTabDocs(docs);
      setAgreementSubTabFile(null); setAgreementSubTabNotes('');
      if (agreementSubTabFileRef.current) agreementSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setAgreementSubTabUploading(false); }
  };
  const handleAgreementSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setAgreementSubTabDocs(agreementSubTabDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-36 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500";
  const fieldSelectClass = "flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500";

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={agreementFormData.company_name} onChange={(e) => setAgreementFormData({ ...agreementFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={agreementFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = agreementContacts.find((c: any) => c.id?.toString() === cid); setAgreementFormData({ ...agreementFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {agreementContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={agreementFormData.email_format_type} onChange={(e) => setAgreementFormData({ ...agreementFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {agreementEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Agreement', agreementFormData.contact_email, agreementEmailTemplates.find((t: any) => t.email_format === agreementFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {emailSentList.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No emails sent</td></tr>
                ) : (
                  emailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={agreementFormData.branch_office} onChange={(e) => setAgreementFormData({ ...agreementFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={agreementFormData.contact_email} onChange={(e) => setAgreementFormData({ ...agreementFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={agreementFileRef} onChange={handleAgreementFileChange} className="hidden" />
            <button onClick={handleAgreementChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleAgreementUploadFile} disabled={!agreementFile || agreementUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{agreementUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-600">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {agreementDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No documents uploaded</td></tr>
                ) : (
                  agreementDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-orange-500 italic">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handleAgreementDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {agreementSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setAgreementSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${agreementSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {agreementSubTab === 'details' && (
        <div className="space-y-6">
          {/* Customer and Axiever Sections */}
          <div className="grid grid-cols-2 gap-x-12">
            {/* CUSTOMER Section */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-4">CUSTOMER</h4>
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Company Name</label>
                  <input type="text" value={detailsForm.company_name} onChange={(e) => setDetailsForm({ ...detailsForm, company_name: e.target.value })} className={fieldInputClass} />
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Authorized Person</label>
                  <input type="text" value={detailsForm.authorized_person} onChange={(e) => setDetailsForm({ ...detailsForm, authorized_person: e.target.value })} className={fieldSelectClass} />
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Project Name</label>
                  <input type="text" value={detailsForm.project_name} onChange={(e) => setDetailsForm({ ...detailsForm, project_name: e.target.value })} className={fieldSelectClass} />
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>From Date</label>
                  <div className="flex-1 flex items-center gap-2">
                    <input type="date" value={detailsForm.from_date} onChange={(e) => setDetailsForm({ ...detailsForm, from_date: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <span className="text-xs text-gray-600 font-medium">Rev</span>
                    <input type="text" value={detailsForm.rev} onChange={(e) => setDetailsForm({ ...detailsForm, rev: e.target.value })} className="w-20 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
              </div>
            </div>

            {/* AXIEVER Section */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-4">AXIEVER</h4>
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Authorized Person</label>
                  <select value={detailsForm.axiever_authorized_person} onChange={(e) => setDetailsForm({ ...detailsForm, axiever_authorized_person: e.target.value })} className={fieldSelectClass}>
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Project Manager</label>
                  <select value={detailsForm.project_manager} onChange={(e) => setDetailsForm({ ...detailsForm, project_manager: e.target.value })} className={fieldSelectClass}>
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Account Contact</label>
                  <select value={detailsForm.account_contact} onChange={(e) => setDetailsForm({ ...detailsForm, account_contact: e.target.value })} className={fieldSelectClass}>
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Training Coordinator</label>
                  <select value={detailsForm.training_coordinator} onChange={(e) => setDetailsForm({ ...detailsForm, training_coordinator: e.target.value })} className={fieldSelectClass}>
                    <option value="">Please Select</option>
                    <option value="1">Admin User</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          {/* Other Details and Subscription Fee */}
          <div className="grid grid-cols-2 gap-x-12">
            {/* OTHER DETAILS Section */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-4">OTHER DETAILS</h4>
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Subscription Term</label>
                  <select value={detailsForm.subscription_term} onChange={(e) => setDetailsForm({ ...detailsForm, subscription_term: e.target.value })} className={fieldSelectClass}>
                    <option value="">Please Select</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="annually">Annually</option>
                  </select>
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>From - To</label>
                  <div className="flex-1 flex items-center gap-2">
                    <input type="date" value={detailsForm.from_to_start} onChange={(e) => setDetailsForm({ ...detailsForm, from_to_start: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <input type="date" value={detailsForm.from_to_end} onChange={(e) => setDetailsForm({ ...detailsForm, from_to_end: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
              </div>
            </div>

            {/* SUBSCRIPTION FEE Section */}
            <div>
              <h4 className="text-sm font-bold text-gray-800 mb-4">SUBSCRIPTION FEE</h4>
              <div className="space-y-3">
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Software Licensing</label>
                  <div className="flex-1 flex items-center gap-2">
                    <span className="text-xs text-gray-600">Curr</span>
                    <select value={detailsForm.software_licensing_curr} onChange={(e) => setDetailsForm({ ...detailsForm, software_licensing_curr: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="">Please Select</option>
                      <option value="CAD">CAD</option>
                      <option value="USD">USD</option>
                      <option value="EUR">EUR</option>
                    </select>
                    <input type="text" value={detailsForm.software_licensing_amt} onChange={(e) => setDetailsForm({ ...detailsForm, software_licensing_amt: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50" placeholder="Amount" />
                  </div>
                </div>
                <div className="flex items-center">
                  <label className={fieldLabelClass}>Database Maintenance</label>
                  <div className="flex-1 flex items-center gap-2">
                    <span className="text-xs text-gray-600">Curr</span>
                    <select value={detailsForm.database_maintenance_curr} onChange={(e) => setDetailsForm({ ...detailsForm, database_maintenance_curr: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="">Please Select</option>
                      <option value="CAD">CAD</option>
                      <option value="USD">USD</option>
                      <option value="EUR">EUR</option>
                    </select>
                    <input type="text" value={detailsForm.database_maintenance_amt} onChange={(e) => setDetailsForm({ ...detailsForm, database_maintenance_amt: e.target.value })} className="flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50" placeholder="Amount" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Save and Refresh Buttons */}
          <div className="flex justify-center gap-3 pt-4">
            <button className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
            <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Refresh</button>
          </div>
        </div>
      )}

      {/* Agreement Sub-tab */}
      {agreementSubTab === 'agreement' && (
        <div className="space-y-4">
          {/* Agreement Type Dropdown */}
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-24">Agreement</label>
            <select
              value={agreementType}
              onChange={(e) => handleAgreementTypeChange(e.target.value)}
              className="w-72 h-9 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500"
            >
              {agreementTypeOptions.map(opt => (
                <option key={opt.value} value={opt.value}>{opt.label}</option>
              ))}
            </select>
          </div>

          {/* Agreement Title */}
          <div className="border-b border-gray-200 pb-2">
            <h3 className="text-lg font-semibold text-gray-800">
              {agreementTypeOptions.find(opt => opt.value === agreementType)?.label || 'Master Services Agreement'}
            </h3>
          </div>

          {/* Rich Text Editor Toolbar */}
          <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white flex-wrap">
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded" title="Bold">B</button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded" title="Italic">I</button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded" title="Underline">U</button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('strikeThrough'); }} className="w-7 h-7 flex items-center justify-center line-through text-sm hover:bg-gray-100 rounded" title="Strikethrough">S</button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('hiliteColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded bg-yellow-200" title="Highlight"><Edit2 className="w-3.5 h-3.5" /></button>
            <div className="w-px h-5 bg-gray-300 mx-1"></div>
            <select onChange={(e) => { handleAgreementDocExec('fontName', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="Arial">
              <option value="Arial">Arial</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Courier New">Courier New</option>
              <option value="Georgia">Georgia</option>
              <option value="Verdana">Verdana</option>
              <option value="Tahoma">Tahoma</option>
            </select>
            <select onChange={(e) => { handleAgreementDocExec('fontSize', e.target.value); }} className="h-7 px-1 text-xs border border-gray-300 rounded bg-white cursor-pointer" defaultValue="3">
              <option value="1">8</option>
              <option value="2">10</option>
              <option value="3">12</option>
              <option value="4">14</option>
              <option value="5">18</option>
              <option value="6">24</option>
              <option value="7">36</option>
            </select>
            <div className="relative">
              <button type="button" className="w-7 h-7 flex items-center justify-center text-sm font-bold hover:bg-gray-100 rounded" title="Text Color" style={{ color: '#000' }}>A</button>
              <input type="color" onChange={(e) => handleAgreementDocExec('foreColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Text Color" />
            </div>
            <div className="relative">
              <button type="button" className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded bg-yellow-300" title="Background Color">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 12l-4-4h8l-4 4z"/></svg>
              </button>
              <input type="color" onChange={(e) => handleAgreementDocExec('hiliteColor', e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Background Color" />
            </div>
            <div className="w-px h-5 bg-gray-300 mx-1"></div>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Bullet List">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Numbered List">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg>
            </button>
            <div className="w-px h-5 bg-gray-300 mx-1"></div>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('justifyLeft'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Align Left">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="2" width="14" height="2"/><rect x="1" y="6" width="10" height="2"/><rect x="1" y="10" width="12" height="2"/><rect x="1" y="14" width="8" height="2"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('justifyCenter'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Align Center">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="2" width="14" height="2"/><rect x="3" y="6" width="10" height="2"/><rect x="2" y="10" width="12" height="2"/><rect x="4" y="14" width="8" height="2"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('justifyRight'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Align Right">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="2" width="14" height="2"/><rect x="5" y="6" width="10" height="2"/><rect x="3" y="10" width="12" height="2"/><rect x="7" y="14" width="8" height="2"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('justifyFull'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Justify">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="2" width="14" height="2"/><rect x="1" y="6" width="14" height="2"/><rect x="1" y="10" width="14" height="2"/><rect x="1" y="14" width="14" height="2"/></svg>
            </button>
            <div className="w-px h-5 bg-gray-300 mx-1"></div>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('indent'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Increase Indent">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="5" y="2" width="10" height="2"/><rect x="5" y="6" width="10" height="2"/><rect x="5" y="10" width="10" height="2"/><rect x="5" y="14" width="10" height="2"/><path d="M0 8l4-3v6l-4-3z"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('outdent'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Decrease Indent">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="5" y="2" width="10" height="2"/><rect x="5" y="6" width="10" height="2"/><rect x="5" y="10" width="10" height="2"/><rect x="5" y="14" width="10" height="2"/><path d="M4 8l-4-3v6l4-3z"/></svg>
            </button>
            <div className="w-px h-5 bg-gray-300 mx-1"></div>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); const url = prompt('Enter URL:'); if (url) handleAgreementDocExec('createLink', url); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Insert Link">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 9.5H4a2 2 0 1 1 0-4h2.354z"/><path d="M9.646 10.5H12a3 3 0 1 0 0-6H9a3 3 0 0 0-2.83 4H7c.086 0 .17-.01.25-.031A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4H9.646z"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('unlink'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Remove Link">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 9.5H4a2 2 0 1 1 0-4h2.354z"/><path d="M9.646 10.5H12a3 3 0 1 0 0-6H9a3 3 0 0 0-2.83 4H7c.086 0 .17-.01.25-.031A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4H9.646z"/><line x1="2" y1="14" x2="14" y2="2" stroke="currentColor" strokeWidth="2"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('insertHorizontalRule'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Horizontal Line">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="0" y="7" width="16" height="2"/></svg>
            </button>
            <div className="w-px h-5 bg-gray-300 mx-1"></div>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('undo'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Undo">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('redo'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Redo">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
            </button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementDocExec('removeFormat'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded" title="Clear Formatting">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M2.244 13.081l.943-2.803H6.66l.944 2.803H8.86L5.54 3.75H4.322L1 13.081h1.244zm2.7-7.923L6.34 9.314H3.51l1.4-4.156h.034zm6.108 7.923h1.234v-5.625h2.124v-.864h-5.484v.864h2.126v5.625z"/><line x1="2" y1="14" x2="14" y2="2" stroke="currentColor" strokeWidth="1.5"/></svg>
            </button>
          </div>

          {/* Rich Text Editor Content Area */}
          <div
            ref={agreementDocEditorRef}
            contentEditable
            className="w-full min-h-[600px] max-h-[800px] overflow-y-auto px-6 py-4 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
            style={{ fontFamily: 'Arial, sans-serif', fontSize: '14px', lineHeight: '1.6' }}
            suppressContentEditableWarning
          />

          {/* Action Buttons */}
          <div className="flex justify-center gap-3 pt-4">
            <button onClick={handleSaveAgreement} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
            <button onClick={handleGenerateAgreementPDF} className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Generate PDF</button>
            <button onClick={handleRefreshAgreement} className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Refresh</button>
          </div>
        </div>
      )}

      {/* Agreement Date Sub-tab */}
      {agreementSubTab === 'agreement-date' && (
        <div className="space-y-6">
          <h3 className="text-sm font-bold text-gray-800">AGREEMENT DATE TIME</h3>
          <div>
            <h4 className="text-sm font-bold text-gray-800 mb-4">GENERAL INFORMATION</h4>
            <div className="grid grid-cols-2 gap-x-12 gap-y-3">
              <div className="space-y-3">
                <div className="flex items-center"><label className={fieldLabelClass}>Key Person's Name:</label><input type="text" value={agreementDateForm.key_person_name} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, key_person_name: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Company Name:</label><input type="text" value={agreementDateForm.company_name} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, company_name: e.target.value })} className={fieldInputClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Address:</label><input type="text" value={agreementDateForm.address} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, address: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Country</label><select value={agreementDateForm.country} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, country: e.target.value })} className={fieldSelectClass}><option value="">Country</option><option value="Canada">Canada</option><option value="United States">United States</option></select></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Province</label><select value={agreementDateForm.province} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, province: e.target.value })} className={fieldSelectClass}><option value="">Select State</option><option value="Ontario">Ontario</option><option value="Quebec">Quebec</option></select></div>
                <div className="flex items-center"><label className={fieldLabelClass}>City</label><select value={agreementDateForm.city} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, city: e.target.value })} className={fieldSelectClass}><option value="">Select City</option><option value="Toronto">Toronto</option><option value="Vancouver">Vancouver</option></select></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Postal Code:</label><input type="text" value={agreementDateForm.postal_code} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, postal_code: e.target.value })} className={fieldSelectClass} /></div>
              </div>
              <div className="space-y-3">
                <div className="flex items-center"><label className={fieldLabelClass}>Company Phone:</label><input type="text" value={agreementDateForm.company_phone} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, company_phone: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>EXT:</label><input type="text" value={agreementDateForm.ext} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, ext: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Fax:</label><input type="text" value={agreementDateForm.fax} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, fax: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Email:</label><input type="email" value={agreementDateForm.email} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, email: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Website:</label><input type="text" value={agreementDateForm.website} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, website: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Any Branch Office:</label><input type="text" value={agreementDateForm.any_branch_office} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, any_branch_office: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Branch Address:</label><input type="text" value={agreementDateForm.branch_address} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, branch_address: e.target.value })} className={fieldSelectClass} /></div>
              </div>
            </div>
          </div>
          <div>
            <h4 className="text-sm font-bold text-gray-800 mb-4">ARRANGE AGREEMENT SESSION</h4>
            <div className="grid grid-cols-2 gap-x-12 gap-y-3">
              <div className="space-y-3">
                <div className="flex items-center"><label className={fieldLabelClass}>Preferred Date:</label><input type="date" value={agreementDateForm.preferred_date} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, preferred_date: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>Preferred Time:</label><input type="time" value={agreementDateForm.preferred_time} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, preferred_time: e.target.value })} className={fieldSelectClass} /></div>
              </div>
              <div className="space-y-3">
                <div className="flex items-center"><label className={fieldLabelClass}>Remark:</label><input type="text" value={agreementDateForm.remark} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, remark: e.target.value })} className={fieldSelectClass} /></div>
                <div className="flex items-center"><label className={fieldLabelClass}>TimeZone:</label><select value={agreementDateForm.timezone} onChange={(e) => setAgreementDateForm({ ...agreementDateForm, timezone: e.target.value })} className={fieldSelectClass}><option value="">Select TimeZone</option><option value="EST">Eastern Standard Time (EST)</option><option value="PST">Pacific Standard Time (PST)</option></select></div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {agreementSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div><button onClick={() => handleOpenAgreementFollowUp()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button></div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {agreementFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  agreementFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => handleOpenAgreementFollowUp(activity)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteAgreementFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {agreementSubTab === 'memo' && (
        <div className="space-y-3">
          <div><button onClick={() => handleOpenAgreementMemo()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button></div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {agreementMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  agreementMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => handleOpenAgreementMemo(memo)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteAgreementMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {agreementSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={agreementSubTabFile?.name || ''} />
            <input ref={agreementSubTabFileRef} type="file" onChange={handleAgreementSubTabFileChange} className="hidden" />
            <button onClick={handleAgreementSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handleAgreementSubTabUpload} disabled={!agreementSubTabFile || agreementSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{agreementSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={agreementSubTabNotes} onChange={(e) => setAgreementSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {agreementSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  agreementSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleAgreementSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {agreementSubTab === 'workflow--audit-trail' && (
        <div className="p-4 text-center text-gray-500 text-sm">Workflow & Audit Trail - Activity logs will appear here.</div>
      )}

      {/* Follow-Up Modal */}
      {showAgreementFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button onClick={() => setShowAgreementPreviousActivities(!showAgreementPreviousActivities)} className="px-3 py-1 text-xs font-medium text-blue-900 bg-blue-500 rounded hover:bg-blue-400">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowAgreementFollowUpModal(false); setEditingAgreementFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Contact</label><select value={agreementFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = agreementContacts.find((c: any) => c.id?.toString() === cid); setAgreementFollowUpForm({ ...agreementFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50"><option value="">Select Contact</option>{agreementContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}</select></div>
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label><input value={agreementFollowUpForm.subject} onChange={(e) => setAgreementFollowUpForm({ ...agreementFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" /></div>
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Email</label><input value={agreementFollowUpForm.sent_to} readOnly className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" /></div>
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label><select value={agreementFollowUpForm.activity_type} onChange={(e) => setAgreementFollowUpForm({ ...agreementFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50"><option value="">Select</option><option value="Call">Call</option><option value="Meeting">Meeting</option><option value="Email">Email</option><option value="Task">Task</option></select></div>
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label><div className="flex gap-2"><input type="date" value={agreementFollowUpForm.start_date} onChange={(e) => setAgreementFollowUpForm({ ...agreementFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" /><input type="time" value={agreementFollowUpForm.start_time} onChange={(e) => setAgreementFollowUpForm({ ...agreementFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" /></div></div>
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label><select value={agreementFollowUpForm.assigned_to} onChange={(e) => setAgreementFollowUpForm({ ...agreementFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50"><option value="">Select User</option><option value="1">Admin User</option></select></div>
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label><input type="date" value={agreementFollowUpForm.next_followup_date} onChange={(e) => setAgreementFollowUpForm({ ...agreementFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" /></div>
                <div><label className="text-xs font-medium text-blue-600 block mb-1">Status</label><select value={agreementFollowUpForm.status} onChange={(e) => setAgreementFollowUpForm({ ...agreementFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50"><option value="Open">Open</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option><option value="Cancelled">Cancelled</option></select></div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementFollowUpExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementFollowUpExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementFollowUpExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <div className="w-px h-5 bg-gray-300 mx-1"></div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementFollowUpExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg></button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementFollowUpExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg></button>
                </div>
                <div ref={agreementFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white" suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5"><button onClick={handleSaveAgreementFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showAgreementMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-900">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowAgreementMemoModal(false); setEditingAgreementMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementMemoExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementMemoExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementMemoExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <div className="w-px h-5 bg-gray-300 mx-1"></div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementMemoExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><circle cx="2" cy="4" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="2" cy="12" r="1.5"/><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg></button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleAgreementMemoExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><text x="0" y="5" fontSize="5" fontWeight="bold">1</text><text x="0" y="9.5" fontSize="5" fontWeight="bold">2</text><text x="0" y="14" fontSize="5" fontWeight="bold">3</text><rect x="5" y="3" width="10" height="2" rx="0.5"/><rect x="5" y="7" width="10" height="2" rx="0.5"/><rect x="5" y="11" width="10" height="2" rx="0.5"/></svg></button>
              </div>
              <div ref={agreementMemoEditorRef} contentEditable className="w-full min-h-[200px] max-h-[350px] overflow-y-auto px-3 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white" suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSaveAgreementMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Initiation Form ==============
function InitiationForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [initiationSubTab, setInitiationSubTab] = useState('details');
  const initiationSubTabs = ['Details', 'Contacts', 'Communication', 'Notes', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [initiationFormData, setInitiationFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [initiationContacts, setInitiationContacts] = useState<any[]>([]);
  const [initiationEmailTemplates, setInitiationEmailTemplates] = useState<any[]>([]);
  const [initiationDocs, setInitiationDocs] = useState<any[]>([]);
  const [initiationFile, setInitiationFile] = useState<File | null>(null);
  const [initiationUploading, setInitiationUploading] = useState(false);
  const initiationFileRef = React.useRef<HTMLInputElement>(null);
  const [emailSentList, setEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [detailsForm, setDetailsForm] = useState({
    project_name: '', instance_required: 'Warehouse', ecommerce_required: 'No', no_of_employees: '6-10', no_of_employees_text: '',
    sow_date_signed_start: '', sow_date_signed_end: '',
    agreement_date_signed_start: '', agreement_date_signed_end: '',
    implementation_start: '', implementation_end: '',
    support_start: '', support_end: ''
  });

  // Phase table state
  const [phases, setPhases] = useState([
    { key: 'initiation', label: 'Initiation', days: '', person_responsible: '' },
    { key: 'planning', label: 'Planning', days: '', person_responsible: '' },
    { key: 'configuration', label: 'Configuration and Customization', days: '', person_responsible: '' },
    { key: 'training', label: 'Training', days: '', person_responsible: '' },
    { key: 'testing', label: 'Testing', days: '', person_responsible: '' },
    { key: 'deployment', label: 'Deployment', days: '', person_responsible: '' },
    { key: 'go_live', label: 'Go Live', days: '', person_responsible: '' }
  ]);

  // Module checkboxes state
  const [selectedModules, setSelectedModules] = useState<Record<string, boolean>>({});

  // Module categories
  const moduleCategories = [
    { name: 'Customer', color: 'blue', items: ['Customer Master', 'CRM', 'Campaign', 'Customer Survey'] },
    { name: 'Supplier', color: 'blue', items: ['Supplier Master', 'Vendor Master', 'Manufacturer Master', 'Price List'] },
    { name: 'Inventory', color: 'green', items: ['Item Master', 'E-Commerce', 'Requisition', 'Shipping Instruction', 'Receiving', 'Discount', 'Return', 'Inventory'] },
    { name: 'Orders', color: 'blue', items: ['Inquiry', 'Quotation', 'Order', 'Fulfillment Priority', 'Order Fulfillment', 'Wave Pick', 'Order Tracking'] },
    { name: 'Financials', color: 'blue', items: ['Account Receivable', 'Account Payable', 'Journal Entry', 'Ledger', 'Payroll', 'Incentive', 'Banking', 'Asset Management', 'Account Statement', 'Tax Connect', 'Regulatory Compliance', 'Budgeting'] },
    { name: 'HRM', color: 'blue', items: ['Employee Master', 'Leave Master', 'Holiday Master', 'Recruitment', 'Appraisal', 'Bonus'] },
    { name: 'Project', color: 'green', items: ['Task Management', 'Project Management', 'Timesheet'] },
    { name: 'Reports', color: 'blue', items: ['Customer', 'Crm', 'Supplier', 'Orders', 'Financials', 'HRM', 'Project', 'Inventory', 'Management', 'Business Intelligence'] },
    { name: 'DMS', color: 'blue', items: ['Return', 'Accounts', 'Supplier', 'Customer', 'Order', 'Quotation', 'Inquiry', 'Order Fulfillment', 'Other Folders', 'Item'] },
    { name: 'My Info', color: 'blue', items: ['Holiday Calendar', 'My Favorite', 'Leave Management', 'My Dashboard', 'Message Board', 'Notifications', 'Calendar', 'Attendance Management', 'Ticketing'] },
    { name: 'Setup', color: 'green', items: ['Role Mgmt', 'Bank Master', 'Accounting', 'Configuration', 'Company Setup', 'User Mgmt', 'Option Master', 'Variant Master', 'Auto Scheduler', 'Form Management'] }
  ];

  // Follow-up state
  const [initiationFollowUps, setInitiationFollowUps] = useState<any[]>([]);
  const [showInitiationFollowUpModal, setShowInitiationFollowUpModal] = useState(false);
  const [editingInitiationFollowUp, setEditingInitiationFollowUp] = useState<any>(null);
  const [initiationFollowUpForm, setInitiationFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', end_date: '', end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: '', next_followup_time: '', channel_type: '', sent_to: ''
  });
  const initiationFollowUpEditorRef = React.useRef<HTMLDivElement>(null);

  // Memo state
  const [initiationMemos, setInitiationMemos] = useState<any[]>([]);
  const [showInitiationMemoModal, setShowInitiationMemoModal] = useState(false);
  const [editingInitiationMemo, setEditingInitiationMemo] = useState<any>(null);
  const [initiationMemoForm, setInitiationMemoForm] = useState({ content: '' });
  const initiationMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [initiationSubTabDocs, setInitiationSubTabDocs] = useState<any[]>([]);
  const [initiationSubTabFile, setInitiationSubTabFile] = useState<File | null>(null);
  const [initiationSubTabNotes, setInitiationSubTabNotes] = useState('');
  const [initiationSubTabUploading, setInitiationSubTabUploading] = useState(false);
  const initiationSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Communication sub-tab state
  const [communicationForm, setCommunicationForm] = useState({
    meeting_name: '', participant_org: '', participant_role: '', participant_name: '',
    purpose: '', frequency: '', start_date: '', end_date: '', time: '', zone: ''
  });
  const defaultMeetings = [
    { id: 1, meeting_name: 'Point of Contact (POC) Form Orientation', purpose: 'To help your team fill out the POC form correctly.', frequency: 'One Time' },
    { id: 2, meeting_name: 'Project Kick-Off Meeting', purpose: 'To introduce teams, align goals, and start the project.', frequency: 'One Time' },
    { id: 3, meeting_name: 'Implementation Forms Guidance Session', purpose: 'To guide your team in filling config, data, and training forms.', frequency: 'One Time' },
    { id: 4, meeting_name: 'Configuration Data Review Meeting', purpose: 'To review and confirm your configuration inputs.', frequency: 'One Time' },
    { id: 5, meeting_name: 'Training Schedule Review Meeting', purpose: 'To confirm training topics, dates, and participants.', frequency: 'One Time' },
    { id: 6, meeting_name: 'Training Facilitation Sessions', purpose: 'To deliver ERP training to your team.', frequency: 'One Time' },
    { id: 7, meeting_name: 'UAT (User Acceptance Testing)', purpose: 'To support your team during testing and resolve issues.', frequency: 'One Time' },
    { id: 8, meeting_name: 'Migrated Data Review Meeting', purpose: 'To check and confirm the accuracy of migrated data.', frequency: 'One Time' }
  ];
  const [communicationMeetings, setCommunicationMeetings] = useState<any[]>(defaultMeetings.map(m => ({
    ...m, participant_org: '', participant_role: '', participant_name: '', start_date: '', end_date: '', time: '', zone: ''
  })));

  // Notes sub-tab state
  const [initiationNotes, setInitiationNotes] = useState<any[]>([]);
  const [showInitiationNoteModal, setShowInitiationNoteModal] = useState(false);
  const [editingInitiationNote, setEditingInitiationNote] = useState<any>(null);
  const [initiationNoteForm, setInitiationNoteForm] = useState({ details: '' });
  const initiationNoteEditorRef = React.useRef<HTMLDivElement>(null);

  // Contacts sub-tab state
  const customerContactRoles = [
    'Project Sponsor', 'Project Manager', 'Configuration Coordinator',
    'Data Migration Coordinator', 'Training Coordinator', 'UAT Coordinator', 'Go Live Coordinator'
  ];
  const axieverContactRoles = [
    'Project Manager', 'Configuration Coordinator', 'Data Migration Coordinator',
    'Training Coordinator', 'UAT Coordinator', 'Go Live Coordinator'
  ];
  const [customerContacts, setCustomerContacts] = useState<Record<string, { name: string; email: string; phone: string; extension: string }>>(() => {
    const initial: Record<string, { name: string; email: string; phone: string; extension: string }> = {};
    customerContactRoles.forEach(role => { initial[role] = { name: '', email: '', phone: '', extension: '' }; });
    return initial;
  });
  const [axieverContacts, setAxieverContacts] = useState<Record<string, { name: string; email: string; phone: string; extension: string }>>(() => {
    const initial: Record<string, { name: string; email: string; phone: string; extension: string }> = {};
    axieverContactRoles.forEach(role => { initial[role] = { name: '', email: '', phone: '', extension: '' }; });
    return initial;
  });

  // Initialize form
  useEffect(() => {
    if (data) {
      setInitiationFormData({
        company_name: data.company_name || '',
        contact_name: data.contact_name || '',
        email_format_type: 'Request for point of contact',
        branch_office: data.branch_office || '',
        contact_email: data.contact_email || ''
      });
    }
  }, [data]);

  // Load contacts
  useEffect(() => {
    if (leadId) {
      api.getLeadContactsForEdit(leadId).then(setInitiationContacts).catch(() => setInitiationContacts([]));
    }
  }, [leadId]);

  // Load email templates for Initiation tab
  useEffect(() => {
    api.getCRIEmailTemplates('initiation').then(setInitiationEmailTemplates).catch(() => setInitiationEmailTemplates([]));
  }, []);

  // Load documents
  useEffect(() => {
    if (crId) {
      api.getCRDocuments(crId, 'initiation').then(setInitiationDocs).catch(() => setInitiationDocs([]));
    }
  }, [crId]);

  // Load follow-ups
  useEffect(() => {
    if (crId && initiationSubTab === 'follow-up') {
      api.getCRActivities(crId, 'initiation-followup').then(setInitiationFollowUps).catch(() => setInitiationFollowUps([]));
    }
  }, [crId, initiationSubTab]);

  // Load memos
  useEffect(() => {
    if (crId && initiationSubTab === 'memo') {
      api.getCRMemos(crId, 'initiation').then(setInitiationMemos).catch(() => setInitiationMemos([]));
    }
  }, [crId, initiationSubTab]);

  // Load notes
  useEffect(() => {
    if (crId && initiationSubTab === 'notes') {
      api.getCRMemos(crId, 'initiation-notes').then(setInitiationNotes).catch(() => setInitiationNotes([]));
    }
  }, [crId, initiationSubTab]);

  // Load upload file documents
  useEffect(() => {
    if (crId && initiationSubTab === 'upload-file') {
      api.getCRDocuments(crId, 'initiation-upload').then(setInitiationSubTabDocs).catch(() => setInitiationSubTabDocs([]));
    }
  }, [crId, initiationSubTab]);

  // Document handlers
  const handleInitiationChooseFile = () => initiationFileRef.current?.click();
  const handleInitiationFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setInitiationFile(e.target.files[0]); };
  const handleInitiationUploadFile = async () => {
    if (!initiationFile || !crId) { alert(!initiationFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setInitiationUploading(true);
    try {
      await api.uploadCRDocument(crId, initiationFile, 'initiation', 'Details');
      const docs = await api.getCRDocuments(crId, 'initiation');
      setInitiationDocs(docs);
      setInitiationFile(null);
      if (initiationFileRef.current) initiationFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setInitiationUploading(false); }
  };
  const handleInitiationDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setInitiationDocs(initiationDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  // Follow-up handlers
  const handleInitiationFollowUpExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    initiationFollowUpEditorRef.current?.focus();
  };
  const handleOpenInitiationFollowUp = (item?: any) => {
    if (item) {
      setEditingInitiationFollowUp(item);
      setInitiationFollowUpForm({ activity_type: item.activity_type || '', subject: item.subject || '', start_date: item.start_date || '', start_time: item.start_time || '', end_date: item.end_date || '', end_time: item.end_time || '', description: item.description || '', status: item.status || 'Open', contact_id: item.contact_id?.toString() || '', assigned_to: item.assigned_to?.toString() || '', priority: item.priority || '', next_followup_date: item.next_followup_date || '', next_followup_time: item.next_followup_time || '', channel_type: item.channel_type || '', sent_to: item.sent_to || '' });
    } else {
      setEditingInitiationFollowUp(null);
      const now = new Date();
      setInitiationFollowUpForm({ activity_type: '', subject: '', start_date: now.toISOString().split('T')[0], start_time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), end_date: now.toISOString().split('T')[0], end_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', priority: '', next_followup_date: now.toISOString().split('T')[0], next_followup_time: '', channel_type: '', sent_to: '' });
    }
    setShowInitiationFollowUpModal(true);
    setTimeout(() => { if (initiationFollowUpEditorRef.current) initiationFollowUpEditorRef.current.innerHTML = item?.description || ''; }, 50);
  };
  const handleSaveInitiationFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = initiationFollowUpEditorRef.current?.innerHTML || initiationFollowUpForm.description;
    const formToSave = { ...initiationFollowUpForm, description: descriptionContent };
    try {
      if (editingInitiationFollowUp) { const updated = await api.updateCRActivity(crId, editingInitiationFollowUp.id, formToSave); setInitiationFollowUps(initiationFollowUps.map((a: any) => a.id === editingInitiationFollowUp.id ? updated : a)); }
      else { const created = await api.createCRActivity(crId, { ...formToSave, tab_name: 'initiation-followup' }); setInitiationFollowUps([...initiationFollowUps, created]); }
      setShowInitiationFollowUpModal(false); setEditingInitiationFollowUp(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteInitiationFollowUp = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRActivity(crId, id); setInitiationFollowUps(initiationFollowUps.filter((a: any) => a.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleInitiationMemoExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    initiationMemoEditorRef.current?.focus();
  };
  const handleOpenInitiationMemo = (item?: any) => {
    if (item) { setEditingInitiationMemo(item); setInitiationMemoForm({ content: item.content || '' }); }
    else { setEditingInitiationMemo(null); setInitiationMemoForm({ content: '' }); }
    setShowInitiationMemoModal(true);
    setTimeout(() => { if (initiationMemoEditorRef.current) initiationMemoEditorRef.current.innerHTML = item?.content || ''; }, 50);
  };
  const handleSaveInitiationMemo = async () => {
    if (!crId) return;
    const content = initiationMemoEditorRef.current?.innerHTML || initiationMemoForm.content;
    try {
      if (editingInitiationMemo) { const updated = await api.updateCRMemo(crId, editingInitiationMemo.id, { content }); setInitiationMemos(initiationMemos.map((m: any) => m.id === editingInitiationMemo.id ? updated : m)); }
      else { const created = await api.createCRMemo(crId, { content, tab_name: 'initiation' }); setInitiationMemos([...initiationMemos, created]); }
      setShowInitiationMemoModal(false); setEditingInitiationMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteInitiationMemo = async (id: number) => {
    if (!crId || !confirm('Are you sure?')) return;
    try { await api.deleteCRMemo(crId, id); setInitiationMemos(initiationMemos.filter((m: any) => m.id !== id)); } catch { alert('Failed to delete'); }
  };

  // Note handlers
  const handleInitiationNoteExec = (cmd: string, value?: string) => {
    document.execCommand(cmd, false, value);
    initiationNoteEditorRef.current?.focus();
  };
  const handleOpenInitiationNote = (item?: any) => {
    if (item) { setEditingInitiationNote(item); setInitiationNoteForm({ details: item.content || '' }); }
    else { setEditingInitiationNote(null); setInitiationNoteForm({ details: '' }); }
    setShowInitiationNoteModal(true);
    setTimeout(() => { if (initiationNoteEditorRef.current) initiationNoteEditorRef.current.innerHTML = item?.content || ''; }, 50);
  };
  const handleSaveInitiationNote = async () => {
    if (!crId) return;
    const content = initiationNoteEditorRef.current?.innerHTML || initiationNoteForm.details;
    try {
      if (editingInitiationNote) { const updated = await api.updateCRMemo(crId, editingInitiationNote.id, { content }); setInitiationNotes(initiationNotes.map((n: any) => n.id === editingInitiationNote.id ? updated : n)); }
      else { const created = await api.createCRMemo(crId, { content, tab_name: 'initiation-notes' }); setInitiationNotes([...initiationNotes, created]); }
      setShowInitiationNoteModal(false); setEditingInitiationNote(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save note'); }
  };
  const handleDeleteInitiationNote = async (id: number) => {
    if (!crId || !confirm('Are you sure you want to delete this note?')) return;
    try { await api.deleteCRMemo(crId, id); setInitiationNotes(initiationNotes.filter((n: any) => n.id !== id)); } catch { alert('Failed to delete note'); }
  };

  // Upload file handlers
  const handleInitiationSubTabChooseFile = () => initiationSubTabFileRef.current?.click();
  const handleInitiationSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => { if (e.target.files?.length) setInitiationSubTabFile(e.target.files[0]); };
  const handleInitiationSubTabUpload = async () => {
    if (!initiationSubTabFile || !crId) { alert(!initiationSubTabFile ? 'Please choose a file first' : 'Please save the customer requirement first'); return; }
    setInitiationSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, initiationSubTabFile, 'initiation-upload', 'Upload File');
      const docs = await api.getCRDocuments(crId, 'initiation-upload');
      setInitiationSubTabDocs(docs);
      setInitiationSubTabFile(null); setInitiationSubTabNotes('');
      if (initiationSubTabFileRef.current) initiationSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setInitiationSubTabUploading(false); }
  };
  const handleInitiationSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Are you sure you want to delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); setInitiationSubTabDocs(initiationSubTabDocs.filter((d: any) => d.id !== docId)); } catch { alert('Failed to delete document'); }
  };

  // Toggle module checkbox
  const toggleModule = (moduleName: string) => {
    setSelectedModules(prev => ({ ...prev, [moduleName]: !prev[moduleName] }));
  };

  // Update phase
  const updatePhase = (index: number, field: string, value: string) => {
    const updated = [...phases];
    (updated[index] as any)[field] = value;
    setPhases(updated);
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-40 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500";
  const fieldSelectClass = "flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500";

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={initiationFormData.company_name} onChange={(e) => setInitiationFormData({ ...initiationFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={initiationFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = initiationContacts.find((c: any) => c.id?.toString() === cid); setInitiationFormData({ ...initiationFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {initiationContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={initiationFormData.email_format_type} onChange={(e) => setInitiationFormData({ ...initiationFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {initiationEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Initiation', initiationFormData.contact_email, initiationEmailTemplates.find((t: any) => t.email_format === initiationFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Type</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {emailSentList.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  emailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.email_type}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={initiationFormData.branch_office} onChange={(e) => setInitiationFormData({ ...initiationFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={initiationFormData.contact_email} onChange={(e) => setInitiationFormData({ ...initiationFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={initiationFileRef} onChange={handleInitiationFileChange} className="hidden" />
            <button onClick={handleInitiationChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleInitiationUploadFile} disabled={!initiationFile || initiationUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{initiationUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {initiationDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  initiationDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handleInitiationDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {initiationSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setInitiationSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${initiationSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {initiationSubTab === 'details' && (
        <div className="space-y-6">
          {/* Project Details Section */}
          <div className="grid grid-cols-2 gap-x-12 gap-y-3">
            <div className="space-y-3">
              <div className="flex items-center">
                <label className={fieldLabelClass}>Project Name</label>
                <input type="text" value={detailsForm.project_name} onChange={(e) => setDetailsForm({ ...detailsForm, project_name: e.target.value })} className={fieldInputClass} />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Instance Required</label>
                <select value={detailsForm.instance_required} onChange={(e) => setDetailsForm({ ...detailsForm, instance_required: e.target.value })} className={fieldSelectClass}>
                  <option value="Warehouse">Warehouse</option>
                  <option value="Manufacturing">Manufacturing</option>
                  <option value="Retail">Retail</option>
                  <option value="Service">Service</option>
                </select>
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>E-Commerce Required</label>
                <input type="text" value={detailsForm.ecommerce_required} onChange={(e) => setDetailsForm({ ...detailsForm, ecommerce_required: e.target.value })} className={fieldSelectClass} />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>No. of Employees/Logins</label>
                <select value={detailsForm.no_of_employees} onChange={(e) => setDetailsForm({ ...detailsForm, no_of_employees: e.target.value })} className="w-24 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2">
                  <option value="1-5">1-5</option>
                  <option value="6-10">6-10</option>
                  <option value="11-20">11-20</option>
                  <option value="21-50">21-50</option>
                  <option value="51+">51+</option>
                </select>
                <input type="text" value={detailsForm.no_of_employees_text} onChange={(e) => setDetailsForm({ ...detailsForm, no_of_employees_text: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
            </div>
            <div className="space-y-3">
              <div className="flex items-center">
                <label className={fieldLabelClass}>SOW Date / Signed</label>
                <input type="date" value={detailsForm.sow_date_signed_start} onChange={(e) => setDetailsForm({ ...detailsForm, sow_date_signed_start: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" />
                <input type="date" value={detailsForm.sow_date_signed_end} onChange={(e) => setDetailsForm({ ...detailsForm, sow_date_signed_end: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Agreement Date / Signed</label>
                <input type="date" value={detailsForm.agreement_date_signed_start} onChange={(e) => setDetailsForm({ ...detailsForm, agreement_date_signed_start: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" />
                <input type="date" value={detailsForm.agreement_date_signed_end} onChange={(e) => setDetailsForm({ ...detailsForm, agreement_date_signed_end: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Implementation Start / End</label>
                <input type="date" value={detailsForm.implementation_start} onChange={(e) => setDetailsForm({ ...detailsForm, implementation_start: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" />
                <input type="date" value={detailsForm.implementation_end} onChange={(e) => setDetailsForm({ ...detailsForm, implementation_end: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Support Start / End</label>
                <input type="date" value={detailsForm.support_start} onChange={(e) => setDetailsForm({ ...detailsForm, support_start: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" />
                <input type="date" value={detailsForm.support_end} onChange={(e) => setDetailsForm({ ...detailsForm, support_end: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
            </div>
          </div>

          {/* Phase Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-64">Phase</th>
                  <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-32">Days</th>
                  <th className="px-4 py-2.5 text-left text-xs font-medium text-white">Person Responsible</th>
                </tr>
              </thead>
              <tbody>
                {phases.map((phase, index) => (
                  <tr key={phase.key} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-4 py-2 text-xs border-b border-gray-200 text-blue-600">{phase.label}</td>
                    <td className="px-4 py-2 text-xs border-b border-gray-200">
                      <input type="text" value={phase.days} onChange={(e) => updatePhase(index, 'days', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-4 py-2 text-xs border-b border-gray-200">
                      <select value={phase.person_responsible} onChange={(e) => updatePhase(index, 'person_responsible', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Please Select</option>
                        <option value="admin">Admin User</option>
                        <option value="manager">Project Manager</option>
                      </select>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Module Categories - 4 columns grid */}
          <div className="grid grid-cols-4 gap-4">
            {moduleCategories.slice(0, 4).map((category) => (
              <div key={category.name} className="border rounded overflow-hidden">
                <div className={`px-3 py-2 text-xs font-medium text-white ${category.color === 'green' ? 'bg-green-600' : 'bg-blue-600'}`}>
                  {category.name}
                </div>
                <div className="p-2 space-y-1 bg-white">
                  {category.items.map((item) => (
                    <label key={item} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                      <input type="checkbox" checked={selectedModules[item] || false} onChange={() => toggleModule(item)} className="w-3.5 h-3.5 accent-blue-600" />
                      <span className="text-gray-700">{item}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="grid grid-cols-4 gap-4">
            {moduleCategories.slice(4, 8).map((category) => (
              <div key={category.name} className="border rounded overflow-hidden">
                <div className={`px-3 py-2 text-xs font-medium text-white ${category.color === 'green' ? 'bg-green-600' : 'bg-blue-600'}`}>
                  {category.name}
                </div>
                <div className="p-2 space-y-1 bg-white max-h-64 overflow-y-auto">
                  {category.items.map((item) => (
                    <label key={item} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                      <input type="checkbox" checked={selectedModules[item] || false} onChange={() => toggleModule(item)} className="w-3.5 h-3.5 accent-blue-600" />
                      <span className="text-gray-700">{item}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="grid grid-cols-4 gap-4">
            {moduleCategories.slice(8).map((category) => (
              <div key={category.name} className="border rounded overflow-hidden">
                <div className={`px-3 py-2 text-xs font-medium text-white ${category.color === 'green' ? 'bg-green-600' : 'bg-blue-600'}`}>
                  {category.name}
                </div>
                <div className="p-2 space-y-1 bg-white max-h-64 overflow-y-auto">
                  {category.items.map((item) => (
                    <label key={item} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                      <input type="checkbox" checked={selectedModules[item] || false} onChange={() => toggleModule(item)} className="w-3.5 h-3.5 accent-blue-600" />
                      <span className="text-gray-700">{item}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          {/* Save and Refresh Buttons */}
          <div className="flex justify-center gap-3 pt-4">
            <button className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
            <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Refresh</button>
          </div>
        </div>
      )}

      {/* Contacts Sub-tab */}
      {initiationSubTab === 'contacts' && (
        <div className="space-y-6">
          {/* Customer Section */}
          <div>
            <h4 className="text-sm font-bold text-blue-600 mb-3 underline">Customer</h4>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-52">Contact</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500">Name</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500">Email</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500">Phone</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white">Extension</th>
                  </tr>
                </thead>
                <tbody>
                  {customerContactRoles.map((role, index) => (
                    <tr key={role} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-4 py-2 text-xs border-b border-gray-200 text-blue-600 italic">{role}</td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <input
                          type="text"
                          value={customerContacts[role]?.name || ''}
                          onChange={(e) => setCustomerContacts(prev => ({ ...prev, [role]: { ...prev[role], name: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <input
                          type="email"
                          value={customerContacts[role]?.email || ''}
                          onChange={(e) => setCustomerContacts(prev => ({ ...prev, [role]: { ...prev[role], email: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <input
                          type="text"
                          value={customerContacts[role]?.phone || ''}
                          onChange={(e) => setCustomerContacts(prev => ({ ...prev, [role]: { ...prev[role], phone: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <input
                          type="text"
                          value={customerContacts[role]?.extension || ''}
                          onChange={(e) => setCustomerContacts(prev => ({ ...prev, [role]: { ...prev[role], extension: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* AXIEVER Section */}
          <div>
            <h4 className="text-sm font-bold text-gray-800 mb-3 underline">AXIEVER</h4>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-52">Contact</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500">Name</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500">Email</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500">Phone</th>
                    <th className="px-4 py-2.5 text-left text-xs font-medium text-white">Extension</th>
                  </tr>
                </thead>
                <tbody>
                  {axieverContactRoles.map((role, index) => (
                    <tr key={role} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-4 py-2 text-xs border-b border-gray-200 text-blue-600 italic">{role}</td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <select
                          value={axieverContacts[role]?.name || ''}
                          onChange={(e) => setAxieverContacts(prev => ({ ...prev, [role]: { ...prev[role], name: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        >
                          <option value="">Please Select</option>
                          <option value="Admin User">Admin User</option>
                          <option value="Project Manager">Project Manager</option>
                          <option value="Technical Lead">Technical Lead</option>
                        </select>
                      </td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <input
                          type="email"
                          value={axieverContacts[role]?.email || ''}
                          onChange={(e) => setAxieverContacts(prev => ({ ...prev, [role]: { ...prev[role], email: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <input
                          type="text"
                          value={axieverContacts[role]?.phone || ''}
                          onChange={(e) => setAxieverContacts(prev => ({ ...prev, [role]: { ...prev[role], phone: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </td>
                      <td className="px-4 py-1.5 border-b border-gray-200">
                        <input
                          type="text"
                          value={axieverContacts[role]?.extension || ''}
                          onChange={(e) => setAxieverContacts(prev => ({ ...prev, [role]: { ...prev[role], extension: e.target.value } }))}
                          className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Save and Refresh Buttons */}
          <div className="flex justify-center gap-3 pt-4">
            <button className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
            <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Refresh</button>
          </div>
        </div>
      )}

      {/* Communication Sub-tab */}
      {initiationSubTab === 'communication' && (
        <div className="space-y-3">
          <div className="flex justify-end">
            <button className="px-4 py-1.5 text-xs font-medium text-white bg-gray-600 rounded hover:bg-gray-700">Generate PDF</button>
          </div>
          <div className="border rounded overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full" style={{ minWidth: '1200px' }}>
                <thead>
                  {/* Header Row */}
                  <tr className="bg-blue-600">
                    <th rowSpan={2} className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '180px', verticalAlign: 'middle' }}>Meeting Name</th>
                    <th colSpan={3} className="px-3 py-2 text-center text-xs font-medium text-white border-r border-blue-500">Participant</th>
                    <th rowSpan={2} className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '140px', verticalAlign: 'middle' }}>Purpose</th>
                    <th rowSpan={2} className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '110px', verticalAlign: 'middle' }}>Frequency</th>
                    <th rowSpan={2} className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '100px', verticalAlign: 'middle' }}>Start Date</th>
                    <th rowSpan={2} className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '100px', verticalAlign: 'middle' }}>End Date</th>
                    <th rowSpan={2} className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '90px', verticalAlign: 'middle' }}>Time</th>
                    <th rowSpan={2} className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '100px', verticalAlign: 'middle' }}>Zone</th>
                    <th rowSpan={2} className="px-3 py-2 text-center text-xs font-medium text-white" style={{ width: '100px', verticalAlign: 'middle' }}>Action</th>
                  </tr>
                  {/* Sub Header for Participant */}
                  <tr className="bg-blue-600">
                    <th className="px-2 py-1.5 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '100px' }}>organisation</th>
                    <th className="px-2 py-1.5 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '80px' }}>Role</th>
                    <th className="px-2 py-1.5 text-left text-xs font-medium text-white border-r border-blue-500" style={{ width: '100px' }}>Name</th>
                  </tr>
                  {/* Input Row */}
                  <tr className="bg-blue-500">
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <input type="text" placeholder="Meeting Name" value={communicationForm.meeting_name} onChange={(e) => setCommunicationForm({ ...communicationForm, meeting_name: e.target.value })} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <input type="text" placeholder="organisation" value={communicationForm.participant_org} onChange={(e) => setCommunicationForm({ ...communicationForm, participant_org: e.target.value })} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <input type="text" placeholder="Role" value={communicationForm.participant_role} onChange={(e) => setCommunicationForm({ ...communicationForm, participant_role: e.target.value })} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <input type="text" placeholder="Name" value={communicationForm.participant_name} onChange={(e) => setCommunicationForm({ ...communicationForm, participant_name: e.target.value })} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <input type="text" placeholder="Purpose" value={communicationForm.purpose} onChange={(e) => setCommunicationForm({ ...communicationForm, purpose: e.target.value })} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <select value={communicationForm.frequency} onChange={(e) => setCommunicationForm({ ...communicationForm, frequency: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none">
                        <option value="">Select Frequency</option>
                        <option value="One-Time">One-Time</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Bi-Weekly">Bi-Weekly</option>
                        <option value="Monthly">Monthly</option>
                      </select>
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <div className="relative">
                        <input type="date" value={communicationForm.start_date} onChange={(e) => setCommunicationForm({ ...communicationForm, start_date: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                      </div>
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <div className="relative">
                        <input type="date" value={communicationForm.end_date} onChange={(e) => setCommunicationForm({ ...communicationForm, end_date: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                      </div>
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <input type="text" placeholder="HH:MM AM" value={communicationForm.time} onChange={(e) => setCommunicationForm({ ...communicationForm, time: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none" />
                    </td>
                    <td className="px-2 py-1.5 border-r border-blue-400">
                      <select value={communicationForm.zone} onChange={(e) => setCommunicationForm({ ...communicationForm, zone: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none">
                        <option value="">Select Zone</option>
                        <option value="EST">EST</option>
                        <option value="CST">CST</option>
                        <option value="MST">MST</option>
                        <option value="PST">PST</option>
                        <option value="UTC">UTC</option>
                      </select>
                    </td>
                    <td className="px-2 py-1.5 text-center">
                      <button className="h-7 px-4 text-xs font-medium text-blue-600 bg-white border border-blue-300 rounded hover:bg-blue-50">Add</button>
                    </td>
                  </tr>
                </thead>
                <tbody>
                  {communicationMeetings.map((meeting, index) => (
                    <tr key={meeting.id} className="bg-white border-b border-gray-200">
                      <td className="px-3 py-2.5 text-xs text-blue-600 border-r border-gray-100 align-top">{meeting.meeting_name}</td>
                      <td className="px-2 py-1.5 border-r border-gray-100 align-top">
                        <input type="text" value={meeting.participant_org || ''} onChange={(e) => {
                          const updated = [...communicationMeetings];
                          updated[index] = { ...updated[index], participant_org: e.target.value };
                          setCommunicationMeetings(updated);
                        }} className="w-full h-6 px-1 text-xs border border-gray-200 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                      </td>
                      <td className="px-2 py-1.5 border-r border-gray-100 align-top">
                        <input type="text" value={meeting.participant_role || ''} onChange={(e) => {
                          const updated = [...communicationMeetings];
                          updated[index] = { ...updated[index], participant_role: e.target.value };
                          setCommunicationMeetings(updated);
                        }} className="w-full h-6 px-1 text-xs border border-gray-200 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                      </td>
                      <td className="px-2 py-1.5 border-r border-gray-100 align-top">
                        <input type="text" value={meeting.participant_name || ''} onChange={(e) => {
                          const updated = [...communicationMeetings];
                          updated[index] = { ...updated[index], participant_name: e.target.value };
                          setCommunicationMeetings(updated);
                        }} className="w-full h-6 px-1 text-xs border border-gray-200 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                      </td>
                      <td className="px-3 py-2.5 text-xs text-gray-600 border-r border-gray-100 align-top">{meeting.purpose}</td>
                      <td className="px-3 py-2.5 text-xs border-r border-gray-100 align-top">{meeting.frequency}</td>
                      <td className="px-3 py-2.5 text-xs border-r border-gray-100 align-top">{meeting.start_date || 'N/A'}</td>
                      <td className="px-3 py-2.5 text-xs border-r border-gray-100 align-top">{meeting.end_date || 'N/A'}</td>
                      <td className="px-3 py-2.5 text-xs border-r border-gray-100 align-top">{meeting.time || 'N/A'}</td>
                      <td className="px-3 py-2.5 text-xs border-r border-gray-100 align-top">{meeting.zone || 'N/A'}</td>
                      <td className="px-2 py-2 text-xs text-center align-top">
                        <div className="flex gap-1 justify-center">
                          <button className="w-6 h-6 flex items-center justify-center text-blue-600 bg-white border border-blue-300 rounded hover:bg-blue-50"><Edit2 className="w-3 h-3" /></button>
                          <button className="w-6 h-6 flex items-center justify-center text-red-600 bg-white border border-red-300 rounded hover:bg-red-50"><Trash2 className="w-3 h-3" /></button>
                          <button className="w-6 h-6 flex items-center justify-center text-green-600 bg-white border border-green-300 rounded hover:bg-green-50"><Plus className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      {/* Notes Sub-tab */}
      {initiationSubTab === 'notes' && (
        <div className="space-y-3">
          <div><button onClick={() => handleOpenInitiationNote()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Note</button></div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600" style={{ width: '150px' }}>Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600" style={{ width: '150px' }}>Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white" style={{ width: '100px' }}>Action</th>
                </tr>
              </thead>
              <tbody>
                {initiationNotes.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  initiationNotes.map((note: any, index: number) => (
                    <tr key={note.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{note.created_at ? new Date(note.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{note.created_by_name || 'Admin'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: note.content || '-' }} /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => handleOpenInitiationNote(note)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteInitiationNote(note.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {initiationSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => handleOpenInitiationFollowUp()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {initiationFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  initiationFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => handleOpenInitiationFollowUp(activity)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteInitiationFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {initiationSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => handleOpenInitiationMemo()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {initiationMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  initiationMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => handleOpenInitiationMemo(memo)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteInitiationMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {initiationSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={initiationSubTabFile?.name || ''} />
            <input ref={initiationSubTabFileRef} type="file" onChange={handleInitiationSubTabFileChange} className="hidden" />
            <button onClick={handleInitiationSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handleInitiationSubTabUpload} disabled={!initiationSubTabFile || initiationSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{initiationSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={initiationSubTabNotes} onChange={(e) => setInitiationSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {initiationSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  initiationSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleInitiationSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {initiationSubTab === 'workflow--audit-trail' && (
        <div className="p-4 text-center text-gray-500 text-sm">Workflow & Audit Trail - Activity logs will appear here.</div>
      )}

      {/* Follow-Up Modal */}
      {showInitiationFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button className="px-3 py-1 text-xs font-medium text-white bg-blue-800 rounded hover:bg-blue-900">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowInitiationFollowUpModal(false); setEditingInitiationFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={initiationFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = initiationContacts.find((c: any) => c.id?.toString() === cid); setInitiationFollowUpForm({ ...initiationFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Contact</option>
                    {initiationContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={initiationFollowUpForm.subject} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={initiationFollowUpForm.sent_to} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={initiationFollowUpForm.activity_type} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={initiationFollowUpForm.start_date} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={initiationFollowUpForm.start_time} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={initiationFollowUpForm.assigned_to} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    {initiationContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={initiationFollowUpForm.next_followup_date} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={initiationFollowUpForm.status} onChange={(e) => setInitiationFollowUpForm({ ...initiationFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationFollowUpExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationFollowUpExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationFollowUpExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationFollowUpExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                  </button>
                  <select onChange={(e) => handleInitiationFollowUpExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                  </select>
                  <select onChange={(e) => handleInitiationFollowUpExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="1">10</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                    <option value="5">18</option>
                    <option value="6">24</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                    <input type="color" onChange={(e) => handleInitiationFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                  </div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationFollowUpExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationFollowUpExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationFollowUpExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                  </button>
                </div>
                <div ref={initiationFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveInitiationFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showInitiationMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowInitiationMemoModal(false); setEditingInitiationMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationMemoExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationMemoExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationMemoExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationMemoExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                </button>
                <select onChange={(e) => handleInitiationMemoExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                </select>
                <select onChange={(e) => handleInitiationMemoExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="3">14</option>
                  <option value="1">10</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                  <option value="5">18</option>
                  <option value="6">24</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                  <input type="color" onChange={(e) => handleInitiationMemoExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                </div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationMemoExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationMemoExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationMemoExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                </button>
              </div>
              <div ref={initiationMemoEditorRef} contentEditable className="w-full min-h-[200px] max-h-[350px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSaveInitiationMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}

      {/* Note Modal */}
      {showInitiationNoteModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">NOTE DETAILS</h3>
              <button onClick={() => { setShowInitiationNoteModal(false); setEditingInitiationNote(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-gray-50 flex-wrap">
                {/* Basic Formatting */}
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('strikeThrough'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white line-through">S</button>
                <div className="w-px h-6 bg-gray-300 mx-1"></div>
                {/* Font Family */}
                <select onChange={(e) => handleInitiationNoteExec('fontName', e.target.value)} className="h-7 px-2 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50 focus:outline-none">
                  <option value="Calibri">Calibri</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                </select>
                {/* Font Size */}
                <select onChange={(e) => handleInitiationNoteExec('fontSize', e.target.value)} className="h-7 px-2 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50 focus:outline-none">
                  <option value="3">14</option>
                  <option value="1">10</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                  <option value="5">18</option>
                  <option value="6">24</option>
                </select>
                {/* Font Color */}
                <div className="relative">
                  <button type="button" className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white font-bold">
                    <span className="bg-yellow-300 px-1">A</span>
                  </button>
                  <input type="color" onChange={(e) => handleInitiationNoteExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                </div>
                <div className="w-px h-6 bg-gray-300 mx-1"></div>
                {/* Lists */}
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /><circle cx="2" cy="6" r="1" fill="currentColor" /><circle cx="2" cy="12" r="1" fill="currentColor" /><circle cx="2" cy="18" r="1" fill="currentColor" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /><text x="2" y="7" fontSize="6" fill="currentColor">1</text><text x="2" y="13" fontSize="6" fill="currentColor">2</text><text x="2" y="19" fontSize="6" fill="currentColor">3</text></svg>
                </button>
                <div className="w-px h-6 bg-gray-300 mx-1"></div>
                {/* Indent */}
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('outdent'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 6h10M11 12h10M11 18h10M3 12l4-4m0 8l-4-4" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleInitiationNoteExec('indent'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-200 rounded border border-gray-300 bg-white">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 6h10M11 12h10M11 18h10M7 8l-4 4 4 4" /></svg>
                </button>
              </div>
              <div ref={initiationNoteEditorRef} contentEditable className="w-full min-h-[200px] max-h-[300px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white" style={{ fontFamily: 'Calibri, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveInitiationNote} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Call Logs List ==============
function CallLogsList({ callLogs, onAdd, onEdit, crId, refreshData, leadData }: any) {
  const [callLogForm, setCallLogForm] = useState({
    lead_name: '', sales_rep: '', action_to_be_taken: '', call_for: '', start_time: '', end_time: '', call_type: '',
    contact: '', date: '', call_via: '', call_outcome: '', duration: '', call_activity: '', description: ''
  });
  const [callLogFilter, setCallLogFilter] = useState({
    date: '', sales_rep: '', call_via: '', call_type: '', call_activity: '', call_for: '', call_outcome: '', start_time: '', end_time: '', duration: '', description: ''
  });
  const [contacts, setContacts] = useState<any[]>([]);
  const callLogEditorRef = React.useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (crId) {
      api.getCRContacts(crId).then(res => setContacts(res)).catch(() => setContacts([]));
    }
  }, [crId]);

  useEffect(() => {
    if (leadData) {
      setCallLogForm(prev => ({
        ...prev,
        lead_name: leadData.company_name || '',
        sales_rep: leadData.sales_rep || ''
      }));
    }
  }, [leadData]);

  // Auto-calculate duration when start_time or end_time changes
  useEffect(() => {
    if (callLogForm.start_time && callLogForm.end_time) {
      const [startHour, startMin] = callLogForm.start_time.split(':').map(Number);
      const [endHour, endMin] = callLogForm.end_time.split(':').map(Number);
      const startMinutes = startHour * 60 + startMin;
      const endMinutes = endHour * 60 + endMin;
      let durationMinutes = endMinutes - startMinutes;
      if (durationMinutes < 0) durationMinutes += 24 * 60; // Handle overnight calls
      setCallLogForm(prev => ({ ...prev, duration: durationMinutes.toString() }));
    }
  }, [callLogForm.start_time, callLogForm.end_time]);

  const handleCallLogExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };

  const handleSaveCallLog = async () => {
    if (!crId) return;
    const descriptionContent = callLogEditorRef.current?.innerHTML || '';
    const formToSave = {
      call_date: callLogForm.date,
      call_time: callLogForm.start_time,
      call_type: callLogForm.call_type,
      subject: callLogForm.call_for,
      duration_minutes: callLogForm.duration ? parseInt(callLogForm.duration) : 0,
      outcome: callLogForm.call_outcome,
      notes: descriptionContent,
      contact_id: callLogForm.contact,
      call_via: callLogForm.call_via,
      call_activity: callLogForm.call_activity,
      action_to_be_taken: callLogForm.action_to_be_taken,
      end_time: callLogForm.end_time
    };
    try {
      await api.createCRCallLog(crId, formToSave);
      refreshData();
      setCallLogForm({
        lead_name: leadData?.company_name || '', sales_rep: leadData?.sales_rep || '', action_to_be_taken: '', call_for: '', start_time: '', end_time: '', call_type: '',
        contact: '', date: '', call_via: '', call_outcome: '', duration: '', call_activity: '', description: ''
      });
      if (callLogEditorRef.current) callLogEditorRef.current.innerHTML = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save call log'); }
  };

  const handleSearchCallLogs = () => {
    console.log('Searching call logs with filters:', callLogFilter);
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 block mb-1";
  const fieldInputClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500";
  const fieldSelectClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500";

  return (
    <div className="space-y-4">
      {/* Form Section */}
      <div className="flex gap-6">
        {/* Left Column */}
        <div className="w-[220px] space-y-2">
          <div>
            <label className={fieldLabelClass}>Lead Name</label>
            <input type="text" value={callLogForm.lead_name} onChange={(e) => setCallLogForm({ ...callLogForm, lead_name: e.target.value })} className={fieldInputClass} />
          </div>
          <div>
            <label className={fieldLabelClass}>Sales Rep.</label>
            <input type="text" value={callLogForm.sales_rep} onChange={(e) => setCallLogForm({ ...callLogForm, sales_rep: e.target.value })} className={fieldInputClass} />
          </div>
          <div>
            <label className={fieldLabelClass}>Action to be Taken</label>
            <input type="text" value={callLogForm.action_to_be_taken} onChange={(e) => setCallLogForm({ ...callLogForm, action_to_be_taken: e.target.value })} className={fieldInputClass} />
          </div>
          <div>
            <label className={fieldLabelClass}>Call For</label>
            <select value={callLogForm.call_for} onChange={(e) => setCallLogForm({ ...callLogForm, call_for: e.target.value })} className={fieldSelectClass}>
              <option value="">Select</option>
              <option value="Introduction">Introduction</option>
              <option value="Follow-up">Follow-up</option>
              <option value="Demo">Demo</option>
              <option value="Support">Support</option>
              <option value="Closing">Closing</option>
            </select>
          </div>
          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className={fieldLabelClass}>Start time</label>
              <input type="time" value={callLogForm.start_time} onChange={(e) => setCallLogForm({ ...callLogForm, start_time: e.target.value })} className={fieldInputClass} />
            </div>
            <div>
              <label className={fieldLabelClass}>End time</label>
              <input type="time" value={callLogForm.end_time} onChange={(e) => setCallLogForm({ ...callLogForm, end_time: e.target.value })} className={fieldInputClass} />
            </div>
          </div>
          <div>
            <label className={fieldLabelClass}>Call Type</label>
            <select value={callLogForm.call_type} onChange={(e) => setCallLogForm({ ...callLogForm, call_type: e.target.value })} className={fieldSelectClass}>
              <option value="">Select</option>
              <option value="Outbound">Outbound</option>
              <option value="Inbound">Inbound</option>
            </select>
          </div>
        </div>

        {/* Middle Column */}
        <div className="w-[220px] space-y-2">
          <div>
            <label className={fieldLabelClass}>Contact</label>
            <select value={callLogForm.contact} onChange={(e) => setCallLogForm({ ...callLogForm, contact: e.target.value })} className={fieldSelectClass}>
              <option value="">Select Contact</option>
              {contacts?.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
            </select>
          </div>
          <div>
            <label className={fieldLabelClass}>Date</label>
            <input type="date" value={callLogForm.date} onChange={(e) => setCallLogForm({ ...callLogForm, date: e.target.value })} className={fieldInputClass} />
          </div>
          <div>
            <label className={fieldLabelClass}>Call Via</label>
            <select value={callLogForm.call_via} onChange={(e) => setCallLogForm({ ...callLogForm, call_via: e.target.value })} className={fieldSelectClass}>
              <option value="">Select</option>
              <option value="VOIP">VOIP</option>
              <option value="Phone">Phone</option>
              <option value="Mobile">Mobile</option>
              <option value="Video Call">Video Call</option>
            </select>
          </div>
          <div>
            <label className={fieldLabelClass}>Call Outcome</label>
            <select value={callLogForm.call_outcome} onChange={(e) => setCallLogForm({ ...callLogForm, call_outcome: e.target.value })} className={fieldSelectClass}>
              <option value="">Select</option>
              <option value="Introductory Email to Customer (Oil and Gas)">Introductory Email to Customer (Oil and Gas)</option>
              <option value="Connected">Connected</option>
              <option value="No Answer">No Answer</option>
              <option value="Voicemail">Voicemail</option>
              <option value="Callback Scheduled">Callback Scheduled</option>
            </select>
          </div>
          <div>
            <label className={fieldLabelClass}>Duration</label>
            <input type="text" value={callLogForm.duration} onChange={(e) => setCallLogForm({ ...callLogForm, duration: e.target.value })} className={fieldInputClass} />
          </div>
          <div>
            <label className={fieldLabelClass}>Call Activity</label>
            <div className="flex gap-1">
              <select value={callLogForm.call_activity} onChange={(e) => setCallLogForm({ ...callLogForm, call_activity: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select</option>
                <option value="Cold Call">Cold Call</option>
                <option value="Warm Call">Warm Call</option>
                <option value="Follow-up Call">Follow-up Call</option>
                <option value="Demo Call">Demo Call</option>
              </select>
              <button className="h-8 w-8 flex items-center justify-center border border-gray-300 rounded bg-gray-50 hover:bg-gray-100 text-gray-600">+</button>
            </div>
          </div>
        </div>

        {/* Right Column - Description */}
        <div className="flex-1">
          <label className={fieldLabelClass}>Add Description</label>
          <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
            <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('strikeThrough'); }} className="w-7 h-7 flex items-center justify-center line-through text-sm hover:bg-gray-100 rounded">S</button>
            <select onChange={(e) => handleCallLogExec('fontName', e.target.value)} className="h-7 px-1 text-xs border border-gray-200 rounded bg-white">
              <option value="jost">jost</option>
              <option value="Arial">Arial</option>
              <option value="Times New Roman">Times New Roman</option>
            </select>
            <select onChange={(e) => handleCallLogExec('fontSize', e.target.value)} className="h-7 px-1 text-xs border border-gray-200 rounded bg-white">
              <option value="3">14</option>
              <option value="2">12</option>
              <option value="4">16</option>
            </select>
            <div className="flex items-center">
              <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('foreColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded bg-yellow-300 font-bold">A</button>
              <span className="text-xs"></span>
            </div>
            <div className="flex items-center">
              <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
              </button>
            </div>
            <div className="flex items-center">
              <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg>
              </button>
            </div>
            <div className="flex items-center">
              <button type="button" onMouseDown={(e) => { e.preventDefault(); handleCallLogExec('outdent'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 19l-7-7 7-7m8 14V5" /></svg>
              </button>
              <span className="text-xs"></span>
            </div>
          </div>
          <div ref={callLogEditorRef} contentEditable className="w-full h-[220px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
        </div>
      </div>

      {/* Save Button */}
      <div className="flex justify-center">
        <button onClick={handleSaveCallLog} className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
      </div>

      {/* Table with Filters */}
      <div className="overflow-x-auto">
        <table className="w-full text-xs border border-gray-300">
          <thead>
            <tr className="bg-blue-600 text-white">
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 w-10">No.</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Date</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Sales Rep.</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Call Via</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Call Type</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Call Activity</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Call For</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Call Outcome</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Start Time</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">End Time</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Duration</th>
              <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Description</th>
              <th className="px-2 py-1.5 text-center font-medium w-20">Action</th>
            </tr>
          </thead>
          <tbody>
            {/* Filter Row */}
            <tr className="bg-white border-t">
              <td className="px-1 py-1.5 border-r border-gray-200"></td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <input type="date" value={callLogFilter.date} onChange={(e) => setCallLogFilter({ ...callLogFilter, date: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white" />
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <select value={callLogFilter.sales_rep} onChange={(e) => setCallLogFilter({ ...callLogFilter, sales_rep: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="">Sales Rep</option>
                </select>
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <select value={callLogFilter.call_via} onChange={(e) => setCallLogFilter({ ...callLogFilter, call_via: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="">Call Via</option>
                  <option value="VOIP">VOIP</option>
                  <option value="Phone">Phone</option>
                </select>
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <select value={callLogFilter.call_type} onChange={(e) => setCallLogFilter({ ...callLogFilter, call_type: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="">Call Type</option>
                  <option value="Outbound">Outbound</option>
                  <option value="Inbound">Inbound</option>
                </select>
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <select value={callLogFilter.call_activity} onChange={(e) => setCallLogFilter({ ...callLogFilter, call_activity: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="">Call Activity</option>
                  <option value="Cold Call">Cold Call</option>
                  <option value="Warm Call">Warm Call</option>
                </select>
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <select value={callLogFilter.call_for} onChange={(e) => setCallLogFilter({ ...callLogFilter, call_for: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="">Call For</option>
                  <option value="Introduction">Introduction</option>
                  <option value="Follow-up">Follow-up</option>
                </select>
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <select value={callLogFilter.call_outcome} onChange={(e) => setCallLogFilter({ ...callLogFilter, call_outcome: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="">Call Outcome</option>
                  <option value="Connected">Connected</option>
                  <option value="No Answer">No Answer</option>
                </select>
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <input type="time" value={callLogFilter.start_time} onChange={(e) => setCallLogFilter({ ...callLogFilter, start_time: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white" />
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <input type="time" value={callLogFilter.end_time} onChange={(e) => setCallLogFilter({ ...callLogFilter, end_time: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white" />
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <input type="text" value={callLogFilter.duration} onChange={(e) => setCallLogFilter({ ...callLogFilter, duration: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white" />
              </td>
              <td className="px-1 py-1.5 border-r border-gray-200">
                <input type="text" value={callLogFilter.description} onChange={(e) => setCallLogFilter({ ...callLogFilter, description: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white" />
              </td>
              <td className="px-1 py-1.5 text-center">
                <button onClick={handleSearchCallLogs} className="h-7 px-4 text-xs font-medium text-white bg-green-500 rounded hover:bg-green-600">Search</button>
              </td>
            </tr>
            {/* Data Rows */}
            {callLogs.length === 0 ? (
              <tr><td colSpan={13} className="px-2 py-4 text-center text-gray-400 border-t">No call logs found</td></tr>
            ) : (
              callLogs.map((log: any, index: number) => (
                <tr key={log.id} className="border-t hover:bg-gray-50">
                  <td className="px-2 py-1.5 border-r">{index + 1}</td>
                  <td className="px-2 py-1.5 border-r text-blue-600">{log.call_date || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.sales_rep || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.call_via || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.call_type || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.call_activity || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.subject || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.outcome || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.call_time || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.end_time || '-'}</td>
                  <td className="px-2 py-1.5 border-r">{log.duration_minutes ? `${log.duration_minutes} min` : '-'}</td>
                  <td className="px-2 py-1.5 border-r max-w-[150px] truncate" dangerouslySetInnerHTML={{ __html: log.notes || '-' }} />
                  <td className="px-2 py-1.5 text-center">
                    <button onClick={() => onEdit(log)} className="text-blue-500 hover:text-blue-700"><Edit2 className="w-3.5 h-3.5" /></button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ============== Activities Section ==============
function ActivitiesSection({ activities, onAdd, onEdit, onDelete }: any) {
  const thClass = "px-4 py-2.5 text-left text-xs font-medium text-white bg-blue-600 border-r border-blue-500 last:border-r-0";
  const tdClass = "px-4 py-2.5 text-xs border-b border-gray-200";

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-sm font-bold text-blue-600">ACTIVITIES</h3>
        <button onClick={onAdd} className="px-4 py-1.5 text-xs font-medium text-white bg-green-500 rounded hover:bg-green-600 flex items-center gap-1">
          <Plus className="w-3.5 h-3.5" /> Add New
        </button>
      </div>
      <div className="border rounded-lg overflow-hidden">
        <table className="w-full">
          <thead>
            <tr>
              <th className={thClass}>S.No</th>
              <th className={thClass}>Type</th>
              <th className={thClass}>Subject</th>
              <th className={thClass}>Start Date</th>
              <th className={thClass}>End Date</th>
              <th className={thClass}>Priority</th>
              <th className={thClass}>Status</th>
              <th className={thClass}>Actions</th>
            </tr>
          </thead>
          <tbody>
            {activities.length === 0 ? (
              <tr><td colSpan={8} className="px-4 py-12 text-center text-gray-500 text-sm bg-gray-50">No activities found</td></tr>
            ) : (
              activities.map((activity: any, index: number) => (
                <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                  <td className={tdClass}>{index + 1}</td>
                  <td className={`${tdClass} text-blue-600`}>{activity.activity_type}</td>
                  <td className={tdClass}>{activity.subject}</td>
                  <td className={tdClass}>{activity.start_date || '-'}</td>
                  <td className={tdClass}>{activity.end_date || '-'}</td>
                  <td className={tdClass}><span className={`px-2 py-0.5 text-xs rounded ${activity.priority === 'high' ? 'bg-red-100 text-red-700' : activity.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>{activity.priority || '-'}</span></td>
                  <td className={tdClass}><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                  <td className={tdClass}>
                    <div className="flex gap-1">
                      <button onClick={() => onEdit(activity)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3.5 h-3.5" /></button>
                      <button onClick={() => onDelete(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3.5 h-3.5" /></button>
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ============== Documents Section ==============
function DocumentsSection({ documents, onUpload, onDelete, crId, refreshData }: any) {
  const fileInputRef = React.useRef<HTMLInputElement>(null);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [notes, setNotes] = useState('');
  const [uploading, setUploading] = useState(false);

  const handleChooseFile = () => {
    fileInputRef.current?.click();
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleUpload = async () => {
    if (!selectedFile || !crId) return;
    setUploading(true);
    try {
      await api.uploadCRDocument(crId, selectedFile, 'upload-file', notes || 'Uploaded Document');
      setSelectedFile(null);
      setNotes('');
      if (fileInputRef.current) fileInputRef.current.value = '';
      // Trigger reload of documents list
      if (refreshData) refreshData();
    } catch (err: any) {
      alert(err?.response?.data?.detail || 'Failed to upload file');
    } finally {
      setUploading(false);
    }
  };

  return (
    <div className="space-y-6">
      {/* Upload Form */}
      <div className="flex justify-center">
        <div className="space-y-3 w-full max-w-2xl">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20">Document</label>
            <input
              type="text"
              value={selectedFile?.name || ''}
              readOnly
              className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50"
              placeholder=""
            />
            <input
              ref={fileInputRef}
              type="file"
              onChange={handleFileChange}
              className="hidden"
            />
            <button
              onClick={handleChooseFile}
              className="h-8 px-4 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1"
            >
              <CheckCircle className="w-3 h-3" /> Choose File
            </button>
            <button
              onClick={handleUpload}
              disabled={!selectedFile || uploading}
              className="h-8 px-4 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 disabled:opacity-50"
            >
              {uploading ? 'Uploading...' : 'Upload'}
            </button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20">Notes</label>
            <input
              type="text"
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50"
            />
          </div>
        </div>
      </div>

      {/* Documents Table */}
      <div className="overflow-x-auto">
        <table className="w-full text-xs border border-gray-300">
          <thead>
            <tr className="bg-blue-600 text-white">
              <th className="px-3 py-2 text-left font-medium border-r border-blue-500">File Name</th>
              <th className="px-3 py-2 text-left font-medium border-r border-blue-500">Uploaded on</th>
              <th className="px-3 py-2 text-left font-medium border-r border-blue-500">Size</th>
              <th className="px-3 py-2 text-left font-medium border-r border-blue-500">Notes</th>
              <th className="px-3 py-2 text-center font-medium w-24">Action</th>
            </tr>
          </thead>
          <tbody>
            {documents.length === 0 ? (
              <tr><td colSpan={5} className="px-3 py-8 text-center text-gray-400">No documents found</td></tr>
            ) : (
              documents.map((doc: any) => (
                <tr key={doc.id} className="border-t hover:bg-gray-50">
                  <td className="px-3 py-2 border-r border-gray-200 text-blue-600">{doc.file_name || '-'}</td>
                  <td className="px-3 py-2 border-r border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : doc.created_at ? new Date(doc.created_at).toLocaleDateString() : '-'}</td>
                  <td className="px-3 py-2 border-r border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} KB` : '-'}</td>
                  <td className="px-3 py-2 border-r border-gray-200">{doc.notes || doc.description || '-'}</td>
                  <td className="px-3 py-2 text-center">
                    <div className="flex gap-1 justify-center">
                      <a href={doc.file_path || doc.file_url} target="_blank" rel="noopener noreferrer" className="p-1 text-blue-600 hover:bg-blue-100 rounded"><Download className="w-3.5 h-3.5" /></a>
                      <button onClick={() => onDelete(doc.id)} className="p-1 text-red-600 hover:bg-red-100 rounded"><Trash2 className="w-3.5 h-3.5" /></button>
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ============== Memos Section ==============
function MemosSection({ memos, onAdd, onEdit, onDelete }: any) {
  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h3 className="text-sm font-semibold text-gray-700">Memos</h3>
        <button
          onClick={onAdd}
          className="px-3 py-1.5 text-xs font-medium text-white bg-green-500 rounded hover:bg-green-600 flex items-center gap-1"
        >
          <Plus className="w-3.5 h-3.5" /> Add Memo
        </button>
      </div>
      <div className="border border-gray-200 rounded-lg overflow-hidden">
        {memos.length === 0 ? (
          <div className="text-center text-gray-500 text-sm py-8 bg-gray-50">No memos found</div>
        ) : (
          <div className="divide-y divide-gray-200">
            {memos.map((memo: any, index: number) => (
              <div key={memo.id} className={`p-3 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                <div className="flex justify-between items-start">
                  <div className="flex items-start gap-3">
                    <span className="flex-shrink-0 w-6 h-6 flex items-center justify-center text-xs font-medium bg-blue-100 text-blue-600 rounded">{index + 1}</span>
                    <div>
                      <h4 className="font-medium text-sm text-gray-800">{memo.title || 'Untitled'}</h4>
                      <p className="text-xs text-gray-500 mt-0.5">{new Date(memo.created_at).toLocaleString()}</p>
                    </div>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => onEdit(memo)} className="p-1 text-blue-600 hover:bg-blue-100 rounded border border-blue-200"><Edit2 className="w-3.5 h-3.5" /></button>
                    <button onClick={() => onDelete(memo.id)} className="p-1 text-red-600 hover:bg-red-100 rounded border border-red-200"><Trash2 className="w-3.5 h-3.5" /></button>
                  </div>
                </div>
                <p className="text-sm text-gray-600 mt-2 pl-9 whitespace-pre-wrap">{memo.content}</p>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// ============== Planning Form ==============
function PlanningForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [planningSubTab, setPlanningSubTab] = useState('details');
  const planningSubTabs = ['Details', 'Configuration', 'Data Migration', 'Training', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [planningFormData, setPlanningFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [planningContacts, setPlanningContacts] = useState<any[]>([]);
  const [planningEmailTemplates, setPlanningEmailTemplates] = useState<any[]>([]);
  const [planningDocs, setPlanningDocs] = useState<any[]>([]);
  const [planningFile, setPlanningFile] = useState<File | null>(null);
  const [planningUploading, setPlanningUploading] = useState(false);
  const planningFileRef = React.useRef<HTMLInputElement>(null);
  const [planningEmailSentList, setPlanningEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [planningDetailsForm, setPlanningDetailsForm] = useState({
    project_sponsor: '', sponsor_email: '', sponsor_phone: '',
    project_name: '', instance_required: 'Warehouse', ecommerce_required: 'No', no_of_employees: 'Select the Employee', no_of_employees_text: '',
    sow_date: '', sow_signed: '',
    agreement_date: '', agreement_signed: '',
    implementation_start: '', implementation_end: '',
    support_start: '', support_end: ''
  });

  // Phase table state
  const [planningPhases, setPlanningPhases] = useState([
    { key: 'initiation', label: 'Initiation', days: '', person_responsible: '' },
    { key: 'planning', label: 'Planning', days: '', person_responsible: '' },
    { key: 'configuration', label: 'Configuration and Customization', days: '', person_responsible: '' },
    { key: 'training', label: 'Training', days: '', person_responsible: '' },
    { key: 'testing', label: 'Testing', days: '', person_responsible: '' },
    { key: 'deployment', label: 'Deployment', days: '', person_responsible: '' },
    { key: 'go_live', label: 'Go Live', days: '', person_responsible: '' }
  ]);

  // Module checkboxes state
  const [planningSelectedModules, setPlanningSelectedModules] = useState<Record<string, boolean>>({});

  // Module categories
  const planningModuleCategories = [
    { name: 'Customer', color: 'blue', items: ['Customer Master', 'CRM', 'Campaign', 'Customer Survey'] },
    { name: 'Supplier', color: 'blue', items: ['Supplier Master', 'Vendor Master', 'Manufacturer Master', 'Price List'] },
    { name: 'Inventory', color: 'green', items: ['Item Master', 'E-Commerce', 'Requisition', 'Shipping Instruction', 'Receiving', 'Discount', 'Return', 'Inventory'] },
    { name: 'Orders', color: 'blue', items: ['Inquiry', 'Quotation', 'Order', 'Fulfillment Priority', 'Order Fulfillment', 'Wave Pick', 'Order Tracking'] },
    { name: 'Financials', color: 'blue', items: ['Account Receivable', 'Account Payable', 'Journal Entry', 'Ledger', 'Payroll', 'Incentive', 'Banking', 'Asset Management', 'Account Statement', 'Tax Connect', 'Regulatory Compliance', 'Budgeting'] },
    { name: 'HRM', color: 'blue', items: ['Employee Master', 'Leave Master', 'Holiday Master', 'Recruitment', 'Appraisal', 'Bonus'] },
    { name: 'Project', color: 'green', items: ['Task Management', 'Project Management', 'Timesheet'] },
    { name: 'Reports', color: 'blue', items: ['Customer', 'Crm', 'Supplier', 'Orders', 'Financials', 'HRM', 'Project', 'Inventory', 'Management', 'Business Intelligence'] },
    { name: 'DMS', color: 'blue', items: ['Return', 'Accounts', 'Supplier', 'Customer', 'Order', 'Quotation', 'Inquiry', 'Order Fulfillment', 'Other Folders', 'Item'] },
    { name: 'My Info', color: 'blue', items: ['Holiday Calendar', 'My Favorite', 'Leave Management', 'My Dashboard', 'Message Board', 'Notifications', 'Calendar', 'Attendance Management', 'Ticketing'] },
    { name: 'Setup', color: 'green', items: ['Role Mgmt', 'Bank Master', 'Accounting', 'Configuration', 'Company Setup', 'User Mgmt', 'Option Master', 'Variant Master', 'Auto Scheduler', 'Form Management'] }
  ];

  // Follow-up state
  const [planningFollowUps, setPlanningFollowUps] = useState<any[]>([]);
  const [showPlanningFollowUpModal, setShowPlanningFollowUpModal] = useState(false);
  const [editingPlanningFollowUp, setEditingPlanningFollowUp] = useState<any>(null);
  const [planningFollowUpForm, setPlanningFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: ''
  });
  const planningFollowUpEditorRef = React.useRef<HTMLDivElement>(null);

  // Memo state
  const [planningMemos, setPlanningMemos] = useState<any[]>([]);
  const [showPlanningMemoModal, setShowPlanningMemoModal] = useState(false);
  const [editingPlanningMemo, setEditingPlanningMemo] = useState<any>(null);
  const planningMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [planningSubTabDocs, setPlanningSubTabDocs] = useState<any[]>([]);
  const [planningSubTabFile, setPlanningSubTabFile] = useState<File | null>(null);
  const [planningSubTabNotes, setPlanningSubTabNotes] = useState('');
  const [planningSubTabUploading, setPlanningSubTabUploading] = useState(false);
  const planningSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Configuration sub-tab state
  const [configInnerTab, setConfigInnerTab] = useState('company-master');
  const configInnerTabs = ['Company Master', 'Key Code Config', 'Email Config', 'Tax-Applicability', 'Currency'];
  const [companyMasterForm, setCompanyMasterForm] = useState({
    company_name: '', street_address_1: '', street_address_2: '', country: '', province: '', city: '',
    postal_code: '', phone_no: '', fax: '', company_since: '', website: '', name_of_rep: '',
    contact_phone: '', email_address: '', company_reg_no: '',
    instance: '', fulfillment_with_pick_list: 'Yes', inventory_items: 'Single Box',
    customer_discount: 'Applied on Base Price - Yes', default_order_type: 'Normal Order',
    quotation_price: '', display_fixed_cost: '', auto_adjust: 'Yes', shipping_invoice: 'Yes',
    enable_chat: 'Yes', pdf_without_price: 'Yes', payment_gateway: 'Yes',
    tax_id_number: '', print_tax_id_on_invoice: 'Yes', default_currency: '', second_currency: '',
    ecom_integration: 'Yes', accounts_opening_date: '', date_format: 'mm/dd/yyyy (06/28/2016)',
    work_timings_from: '', work_timings_to: '', signature_authority: '',
    digital_signature: 'Disable',
    tax_freight: false, tax_duty: false, tax_packing: false, tax_clearance: false,
    tax_certificates: false, tax_bank_charges: false, tax_insurance: false, tax_other_charges: false
  });
  const [companyLogoFile, setCompanyLogoFile] = useState<File | null>(null);
  const companyLogoRef = React.useRef<HTMLInputElement>(null);
  const [invoiceAddresses, setInvoiceAddresses] = useState<any[]>([{ name: '', address: '', country: '', state: '', city: '', zip_code: '', phone: '', ext: '', fax: '' }]);
  const [deliveryAddresses, setDeliveryAddresses] = useState<any[]>([{ company_name: '', address: '', country: '', state: '', city: '', zip_code: '', phone: '', ext: '', attention: '' }]);
  const [officeUseForm, setOfficeUseForm] = useState({
    display_company_name: '', subdomain_name: '', number_of_license: '',
    access_start_date: '', renewal: '', billing_amount: '', billing_frequency: ''
  });

  // Key Code Config state
  const [keyCodeSelectedModule, setKeyCodeSelectedModule] = useState('Inquiry Number');
  const [keyCodeRows, setKeyCodeRows] = useState<any[]>([
    { module_identifier: 'Code', element1: 'None', identifier1: 'Year', element2: 'None', identifier2: 'Year', element3: 'None', series: '00001', pattern: 'Yearly', number: '' }
  ]);

  // Fetch data
  useEffect(() => {
    if (crId) {
      fetchPlanningContacts();
      fetchPlanningDocs();
      fetchPlanningFollowUps();
      fetchPlanningMemos();
      fetchPlanningSubTabDocs();
    }
  }, [crId]);

  // Load email templates for Planning tab
  useEffect(() => {
    api.getCRIEmailTemplates('planning').then(setPlanningEmailTemplates).catch(() => setPlanningEmailTemplates([]));
  }, []);

  const fetchPlanningContacts = async () => {
    try {
      const res = await api.getLeadContactsForEdit(leadId);
      setPlanningContacts(res);
    } catch (err) { console.error('Failed to fetch contacts:', err); }
  };

  const fetchPlanningDocs = async () => {
    try {
      const res = await api.getCRDocuments(crId, 'planning');
      setPlanningDocs(res);
    } catch (err) { console.error('Failed to fetch docs:', err); }
  };

  const fetchPlanningFollowUps = async () => {
    try {
      const res = await api.getCRActivities(crId, 'planning-followup');
      setPlanningFollowUps(res);
    } catch (err) { console.error('Failed to fetch follow-ups:', err); }
  };

  const fetchPlanningMemos = async () => {
    try {
      const res = await api.getCRMemos(crId, 'planning-memo');
      setPlanningMemos(res);
    } catch (err) { console.error('Failed to fetch memos:', err); }
  };

  const fetchPlanningSubTabDocs = async () => {
    try {
      const res = await api.getCRDocuments(crId, 'planning-upload');
      setPlanningSubTabDocs(res);
    } catch (err) { console.error('Failed to fetch upload docs:', err); }
  };

  // File handlers
  const handlePlanningChooseFile = () => planningFileRef.current?.click();
  const handlePlanningFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setPlanningFile(e.target.files[0]);
  };
  const handlePlanningUploadFile = async () => {
    if (!crId || !planningFile) return;
    setPlanningUploading(true);
    try {
      await api.uploadCRDocument(crId, planningFile, 'planning', 'Planning Document');
      fetchPlanningDocs();
      setPlanningFile(null);
      if (planningFileRef.current) planningFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setPlanningUploading(false); }
  };
  const handlePlanningDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchPlanningDocs(); } catch { alert('Failed to delete'); }
  };

  // Follow-up handlers
  const handlePlanningFollowUpExec = (cmd: string, val?: string) => {
    document.execCommand(cmd, false, val);
  };
  const handleSavePlanningFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = planningFollowUpEditorRef.current?.innerHTML || '';
    const formToSave = { ...planningFollowUpForm, description: descriptionContent };
    try {
      if (editingPlanningFollowUp) {
        await api.updateCRActivity(crId, editingPlanningFollowUp.id, { ...formToSave, activity_category: 'planning-followup' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'planning-followup' });
      }
      fetchPlanningFollowUps();
      setShowPlanningFollowUpModal(false);
      setEditingPlanningFollowUp(null);
      setPlanningFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' });
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeletePlanningFollowUp = async (id: number) => {
    if (!crId || !confirm('Delete this follow-up?')) return;
    try { await api.deleteCRActivity(crId, id); fetchPlanningFollowUps(); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handlePlanningMemoExec = (cmd: string, val?: string) => {
    document.execCommand(cmd, false, val);
  };
  const handleSavePlanningMemo = async () => {
    if (!crId) return;
    const content = planningMemoEditorRef.current?.innerHTML || '';
    try {
      if (editingPlanningMemo) {
        await api.updateCRMemo(crId, editingPlanningMemo.id, { content, memo_category: 'planning-memo' });
      } else {
        await api.createCRMemo(crId, { content, memo_category: 'planning-memo' });
      }
      fetchPlanningMemos();
      setShowPlanningMemoModal(false);
      setEditingPlanningMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeletePlanningMemo = async (id: number) => {
    if (!crId || !confirm('Delete this memo?')) return;
    try { await api.deleteCRMemo(crId, id); fetchPlanningMemos(); } catch { alert('Failed to delete'); }
  };

  // Upload sub-tab handlers
  const handlePlanningSubTabChooseFile = () => planningSubTabFileRef.current?.click();
  const handlePlanningSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setPlanningSubTabFile(e.target.files[0]);
  };
  const handlePlanningSubTabUpload = async () => {
    if (!crId || !planningSubTabFile) return;
    setPlanningSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, planningSubTabFile, 'planning-upload', 'Upload File');
      fetchPlanningSubTabDocs();
      setPlanningSubTabFile(null);
      setPlanningSubTabNotes('');
      if (planningSubTabFileRef.current) planningSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload'); } finally { setPlanningSubTabUploading(false); }
  };
  const handlePlanningSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchPlanningSubTabDocs(); } catch { alert('Failed to delete'); }
  };

  // Toggle module checkbox
  const togglePlanningModule = (moduleName: string) => {
    setPlanningSelectedModules(prev => ({ ...prev, [moduleName]: !prev[moduleName] }));
  };

  // Update phase
  const updatePlanningPhase = (index: number, field: string, value: string) => {
    const updated = [...planningPhases];
    (updated[index] as any)[field] = value;
    setPlanningPhases(updated);
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-40 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-3 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500";

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={planningFormData.company_name} onChange={(e) => setPlanningFormData({ ...planningFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={planningFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = planningContacts.find((c: any) => c.id?.toString() === cid); setPlanningFormData({ ...planningFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {planningContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={planningFormData.email_format_type} onChange={(e) => setPlanningFormData({ ...planningFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {planningEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Planning', planningFormData.contact_email, planningEmailTemplates.find((t: any) => t.email_format === planningFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Type</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {planningEmailSentList.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  planningEmailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.email_type}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={planningFormData.branch_office} onChange={(e) => setPlanningFormData({ ...planningFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={planningFormData.contact_email} onChange={(e) => setPlanningFormData({ ...planningFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={planningFileRef} onChange={handlePlanningFileChange} className="hidden" />
            <button onClick={handlePlanningChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handlePlanningUploadFile} disabled={!planningFile || planningUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{planningUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {planningDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  planningDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handlePlanningDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {planningSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setPlanningSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${planningSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {planningSubTab === 'details' && (
        <div className="space-y-6">
          {/* Project Details Section */}
          <div className="grid grid-cols-2 gap-x-12 gap-y-3">
            <div className="space-y-3">
              <div className="flex items-center">
                <label className={fieldLabelClass}>Project Sponsor</label>
                <input type="text" value={planningDetailsForm.project_sponsor} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, project_sponsor: e.target.value })} className={fieldInputClass} />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Email</label>
                <input type="email" value={planningDetailsForm.sponsor_email} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, sponsor_email: e.target.value })} className={fieldInputClass} />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Phone</label>
                <input type="text" value={planningDetailsForm.sponsor_phone} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, sponsor_phone: e.target.value })} className={fieldInputClass} />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Project Name</label>
                <input type="text" value={planningDetailsForm.project_name} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, project_name: e.target.value })} className={fieldInputClass} />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Instance Required</label>
                <select value={planningDetailsForm.instance_required} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, instance_required: e.target.value })} className={fieldInputClass}>
                  <option value="Warehouse">Warehouse</option>
                  <option value="Manufacturing">Manufacturing</option>
                  <option value="Retail">Retail</option>
                  <option value="Service">Service</option>
                </select>
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>E-Commerce Required</label>
                <input type="text" value={planningDetailsForm.ecommerce_required} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, ecommerce_required: e.target.value })} className={fieldInputClass} />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>No. of Employees/Logins</label>
                <select value={planningDetailsForm.no_of_employees} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, no_of_employees: e.target.value })} className="w-36 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2">
                  <option value="Select the Employee">Select the Employee</option>
                  <option value="1-5">1-5</option>
                  <option value="6-10">6-10</option>
                  <option value="11-20">11-20</option>
                  <option value="21-50">21-50</option>
                  <option value="51+">51+</option>
                </select>
                <input type="text" value={planningDetailsForm.no_of_employees_text} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, no_of_employees_text: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
            </div>
            <div className="space-y-3">
              <div className="flex items-center">
                <label className={fieldLabelClass}>SOW Date / Signed</label>
                <input type="date" value={planningDetailsForm.sow_date} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, sow_date: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" placeholder="Date" />
                <input type="date" value={planningDetailsForm.sow_signed} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, sow_signed: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" placeholder="Date" />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Agreement Date / Signed</label>
                <input type="date" value={planningDetailsForm.agreement_date} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, agreement_date: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" placeholder="Date" />
                <input type="date" value={planningDetailsForm.agreement_signed} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, agreement_signed: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" placeholder="Date" />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Implementation Start / End</label>
                <input type="date" value={planningDetailsForm.implementation_start} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, implementation_start: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" placeholder="Date" />
                <input type="date" value={planningDetailsForm.implementation_end} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, implementation_end: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" placeholder="Date" />
              </div>
              <div className="flex items-center">
                <label className={fieldLabelClass}>Support Start / End</label>
                <input type="date" value={planningDetailsForm.support_start} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, support_start: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" placeholder="Date" />
                <input type="date" value={planningDetailsForm.support_end} onChange={(e) => setPlanningDetailsForm({ ...planningDetailsForm, support_end: e.target.value })} className="w-32 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" placeholder="Date" />
              </div>
            </div>
          </div>

          {/* Phase Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-64">Phase</th>
                  <th className="px-4 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-32">Days</th>
                  <th className="px-4 py-2.5 text-left text-xs font-medium text-white">Person Responsible</th>
                </tr>
              </thead>
              <tbody>
                {planningPhases.map((phase, index) => (
                  <tr key={phase.key} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-4 py-2 text-xs border-b border-gray-200 text-blue-600">{phase.label}</td>
                    <td className="px-4 py-2 text-xs border-b border-gray-200">
                      <input type="text" value={phase.days} onChange={(e) => updatePlanningPhase(index, 'days', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-4 py-2 text-xs border-b border-gray-200">
                      <select value={phase.person_responsible} onChange={(e) => updatePlanningPhase(index, 'person_responsible', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Please Select</option>
                        {planningContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                      </select>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Module Categories - 4 columns grid */}
          <div className="grid grid-cols-4 gap-4">
            {planningModuleCategories.slice(0, 4).map((category) => (
              <div key={category.name} className="border rounded overflow-hidden">
                <div className={`px-3 py-2 text-xs font-medium text-white ${category.color === 'green' ? 'bg-green-600' : 'bg-blue-600'}`}>
                  {category.name}
                </div>
                <div className="p-2 space-y-1 bg-white">
                  {category.items.map((item) => (
                    <label key={item} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                      <input type="checkbox" checked={planningSelectedModules[item] || false} onChange={() => togglePlanningModule(item)} className="w-3.5 h-3.5 accent-blue-600" />
                      <span className="text-gray-700">{item}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="grid grid-cols-4 gap-4">
            {planningModuleCategories.slice(4, 8).map((category) => (
              <div key={category.name} className="border rounded overflow-hidden">
                <div className={`px-3 py-2 text-xs font-medium text-white ${category.color === 'green' ? 'bg-green-600' : 'bg-blue-600'}`}>
                  {category.name}
                </div>
                <div className="p-2 space-y-1 bg-white max-h-64 overflow-y-auto">
                  {category.items.map((item) => (
                    <label key={item} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                      <input type="checkbox" checked={planningSelectedModules[item] || false} onChange={() => togglePlanningModule(item)} className="w-3.5 h-3.5 accent-blue-600" />
                      <span className="text-gray-700">{item}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="grid grid-cols-4 gap-4">
            {planningModuleCategories.slice(8).map((category) => (
              <div key={category.name} className="border rounded overflow-hidden">
                <div className={`px-3 py-2 text-xs font-medium text-white ${category.color === 'green' ? 'bg-green-600' : 'bg-blue-600'}`}>
                  {category.name}
                </div>
                <div className="p-2 space-y-1 bg-white max-h-64 overflow-y-auto">
                  {category.items.map((item) => (
                    <label key={item} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                      <input type="checkbox" checked={planningSelectedModules[item] || false} onChange={() => togglePlanningModule(item)} className="w-3.5 h-3.5 accent-blue-600" />
                      <span className="text-gray-700">{item}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          {/* Save and Refresh Buttons */}
          <div className="flex justify-center gap-3 pt-4">
            <button className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
            <button className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Refresh</button>
          </div>
        </div>
      )}

      {/* Configuration Sub-tab */}
      {planningSubTab === 'configuration' && (
        <div className="space-y-4">
          {/* Inner Tabs */}
          <div className="flex gap-0.5 border-b border-gray-200">
            {configInnerTabs.map((tab) => {
              const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/-/g, '-');
              return (
                <button key={tab} onClick={() => setConfigInnerTab(tabKey)} className={`px-4 py-2 text-xs font-medium rounded-t transition-colors ${configInnerTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                  {tab}
                </button>
              );
            })}
          </div>

          {/* Company Master Tab */}
          {configInnerTab === 'company-master' && (
            <div className="space-y-6">
              {/* Header Message */}
              <div className="text-xs text-gray-700 font-medium uppercase tracking-wide">
                WE ARE EXCITED TO BEGIN THE ERP IMPLEMENTATION FOR "{planningFormData.company_name || 'FINTECH COMPANY'}". TO ENSURE A SMOOTH AND ACCURATE SETUP, WE KINDLY REQUEST THE FOLLOWING DETAILS:
              </div>

              {/* Two Column Form */}
              <div className="grid grid-cols-2 gap-x-12 gap-y-2">
                {/* Left Column */}
                <div className="space-y-2">
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">Company Name <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.company_name} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">Street Address <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.street_address_1} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, street_address_1: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600"></label>
                    <input type="text" value={companyMasterForm.street_address_2} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, street_address_2: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">Country <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.country} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, country: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="">Select</option>
                      <option value="India">India</option>
                      <option value="USA">USA</option>
                      <option value="UK">UK</option>
                      <option value="Canada">Canada</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">Province <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.province} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, province: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="">Select</option>
                      <option value="Jharkhand">Jharkhand</option>
                      <option value="Maharashtra">Maharashtra</option>
                      <option value="Delhi">Delhi</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">City <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.city} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, city: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="">Select</option>
                      <option value="Dhanbad">Dhanbad</option>
                      <option value="Mumbai">Mumbai</option>
                      <option value="Delhi">Delhi</option>
                    </select>
                    <button className="ml-2 w-8 h-8 flex items-center justify-center border border-gray-300 rounded bg-white hover:bg-gray-50 text-lg">+</button>
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">Postal Code <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.postal_code} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, postal_code: e.target.value })} placeholder="Zip/Postal Code" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">Phone No. <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.phone_no} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, phone_no: e.target.value })} placeholder="+212638963387" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600 flex items-center gap-1">Fax <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.fax} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, fax: e.target.value })} placeholder="+(Country Code)(Area Code)(Fax Number)" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 text-gray-400" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-orange-500">Company Since</label>
                    <input type="date" value={companyMasterForm.company_since} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, company_since: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-gray-600">Website</label>
                    <input type="text" value={companyMasterForm.website} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, website: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-gray-600 flex items-center gap-1">Name of Rep. <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.name_of_rep} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, name_of_rep: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-gray-600 flex items-center gap-1">Contact Phone <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.contact_phone} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, contact_phone: e.target.value })} placeholder="+212638963387" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-gray-600 flex items-center gap-1">Email Address <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="email" value={companyMasterForm.email_address} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, email_address: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-32 text-xs font-medium text-blue-600">Company Reg. No.</label>
                    <input type="text" value={companyMasterForm.company_reg_no} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, company_reg_no: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>

                {/* Right Column */}
                <div className="space-y-2">
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-gray-600">Instance</label>
                    <input type="text" value={companyMasterForm.instance} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, instance: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Fulfillment With Pick List <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.fulfillment_with_pick_list} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, fulfillment_with_pick_list: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Inventory Items <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.inventory_items} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, inventory_items: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Single Box">Single Box</option>
                      <option value="Multiple Box">Multiple Box</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Customer Discount <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.customer_discount} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, customer_discount: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Applied on Base Price - Yes">Applied on Base Price - Yes</option>
                      <option value="Applied on Base Price - No">Applied on Base Price - No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Default Order Type <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.default_order_type} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, default_order_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Normal Order">Normal Order</option>
                      <option value="Rush Order">Rush Order</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Quotation Price <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.quotation_price} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, quotation_price: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Display Fixed Cost <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.display_fixed_cost} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, display_fixed_cost: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Auto Adjust <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.auto_adjust} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, auto_adjust: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-orange-500 flex items-center gap-1">Shipping Invoice <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.shipping_invoice} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, shipping_invoice: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Enable Chat <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.enable_chat} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, enable_chat: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-orange-500 flex items-center gap-1">PDF Without Price <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.pdf_without_price} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, pdf_without_price: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Payment Gateway <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.payment_gateway} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, payment_gateway: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Tax ID Number (HST No.) <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.tax_id_number} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_id_number: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-orange-500 flex items-center gap-1">Print Tax ID on Invoice <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.print_tax_id_on_invoice} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, print_tax_id_on_invoice: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Default Currency <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.default_currency} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, default_currency: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Second Currency <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.second_currency} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, second_currency: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Ecom. Integration <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.ecom_integration} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, ecom_integration: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Accounts Opening Date <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="date" value={companyMasterForm.accounts_opening_date} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, accounts_opening_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Date Format <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <select value={companyMasterForm.date_format} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, date_format: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                      <option value="mm/dd/yyyy (06/28/2016)">mm/dd/yyyy (06/28/2016)</option>
                      <option value="dd/mm/yyyy (28/06/2016)">dd/mm/yyyy (28/06/2016)</option>
                      <option value="yyyy-mm-dd (2016-06-28)">yyyy-mm-dd (2016-06-28)</option>
                    </select>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Work Timings <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.work_timings_from} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, work_timings_from: e.target.value })} placeholder="From HH:MM" className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 mr-2" />
                    <input type="text" value={companyMasterForm.work_timings_to} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, work_timings_to: e.target.value })} placeholder="From HH:MM" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Signature Authority <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="text" value={companyMasterForm.signature_authority} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, signature_authority: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Company Logo <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <input type="file" ref={companyLogoRef} onChange={(e) => { if (e.target.files && e.target.files[0]) setCompanyLogoFile(e.target.files[0]); }} className="hidden" accept="image/*" />
                    <button onClick={() => companyLogoRef.current?.click()} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
                      <Upload className="w-3 h-3" /> Choose File
                    </button>
                    <button className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50">Upload</button>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-gray-600"></label>
                    <div className="flex-1 h-24 border border-gray-300 rounded bg-gray-50 flex items-center justify-center text-gray-400 text-sm">Photo</div>
                  </div>
                  <div className="flex items-center">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1">Digital Signature <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <div className="flex items-center gap-4">
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name="digital_signature" value="Disable" checked={companyMasterForm.digital_signature === 'Disable'} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, digital_signature: e.target.value })} className="accent-blue-600" /> Disable</label>
                      <label className="flex items-center gap-1 text-xs"><input type="radio" name="digital_signature" value="Enable" checked={companyMasterForm.digital_signature === 'Enable'} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, digital_signature: e.target.value })} className="accent-blue-600" /> Enable</label>
                    </div>
                  </div>
                  <div className="flex items-start">
                    <label className="w-44 text-xs font-medium text-blue-600 flex items-center gap-1 pt-1">Tax Applicability <span className="text-blue-400 cursor-help">&#9432;</span></label>
                    <div className="flex-1 grid grid-cols-2 gap-2">
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_freight} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_freight: e.target.checked })} className="accent-blue-600" /> Freight</label>
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_duty} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_duty: e.target.checked })} className="accent-blue-600" /> Duty</label>
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_packing} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_packing: e.target.checked })} className="accent-blue-600" /> Packing</label>
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_clearance} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_clearance: e.target.checked })} className="accent-blue-600" /> Clearance</label>
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_certificates} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_certificates: e.target.checked })} className="accent-blue-600" /> Certificates</label>
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_bank_charges} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_bank_charges: e.target.checked })} className="accent-blue-600" /> Bank Charges</label>
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_insurance} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_insurance: e.target.checked })} className="accent-blue-600" /> Insurance</label>
                      <label className="flex items-center gap-2 text-xs"><input type="checkbox" checked={companyMasterForm.tax_other_charges} onChange={(e) => setCompanyMasterForm({ ...companyMasterForm, tax_other_charges: e.target.checked })} className="accent-blue-600" /> Other Charges</label>
                    </div>
                  </div>
                </div>
              </div>

              {/* Invoice Address Section */}
              <div className="mt-6">
                <h4 className="text-xs font-bold text-orange-500 uppercase mb-2">INVOICE ADDRESS</h4>
                <div className="border rounded overflow-hidden">
                  <table className="w-full">
                    <thead>
                      <tr className="bg-blue-600">
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Name</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Address</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Country</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">State</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">City</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Zip Code</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Phone</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Ext.</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Fax</th>
                        <th className="px-2 py-2 text-center text-xs font-medium text-white">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {invoiceAddresses.map((addr, idx) => (
                        <tr key={idx} className="bg-blue-50">
                          <td className="px-1 py-1"><input type="text" value={addr.name} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].name = e.target.value; setInvoiceAddresses(newAddrs); }} placeholder="Name" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.address} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].address = e.target.value; setInvoiceAddresses(newAddrs); }} placeholder="Street Address" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><select value={addr.country} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].country = e.target.value; setInvoiceAddresses(newAddrs); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option value="">Select</option><option value="India">India</option><option value="USA">USA</option></select></td>
                          <td className="px-1 py-1"><select value={addr.state} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].state = e.target.value; setInvoiceAddresses(newAddrs); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option value="">State</option></select></td>
                          <td className="px-1 py-1"><select value={addr.city} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].city = e.target.value; setInvoiceAddresses(newAddrs); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option value="">City</option></select></td>
                          <td className="px-1 py-1"><input type="text" value={addr.zip_code} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].zip_code = e.target.value; setInvoiceAddresses(newAddrs); }} placeholder="Code" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.phone} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].phone = e.target.value; setInvoiceAddresses(newAddrs); }} placeholder="+(Country code)(Area" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.ext} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].ext = e.target.value; setInvoiceAddresses(newAddrs); }} placeholder="Ext." className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.fax} onChange={(e) => { const newAddrs = [...invoiceAddresses]; newAddrs[idx].fax = e.target.value; setInvoiceAddresses(newAddrs); }} placeholder="+(Country code)(Area" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1 text-center"></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Delivery Address Section */}
              <div className="mt-6">
                <h4 className="text-xs font-bold text-gray-700 uppercase mb-2">DELIVERY ADDRESS</h4>
                <div className="border rounded overflow-hidden">
                  <table className="w-full">
                    <thead>
                      <tr className="bg-blue-600">
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Company Name</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Address</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Country</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">State</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">City</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Zip Code</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Phone</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Ext.</th>
                        <th className="px-2 py-2 text-left text-xs font-medium text-white">Attention</th>
                        <th className="px-2 py-2 text-center text-xs font-medium text-white">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {deliveryAddresses.map((addr, idx) => (
                        <tr key={idx} className="bg-blue-50">
                          <td className="px-1 py-1"><input type="text" value={addr.company_name} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].company_name = e.target.value; setDeliveryAddresses(newAddrs); }} placeholder="Name" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.address} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].address = e.target.value; setDeliveryAddresses(newAddrs); }} placeholder="Street Address" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><select value={addr.country} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].country = e.target.value; setDeliveryAddresses(newAddrs); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option value="">Select</option><option value="India">India</option><option value="USA">USA</option></select></td>
                          <td className="px-1 py-1"><select value={addr.state} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].state = e.target.value; setDeliveryAddresses(newAddrs); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option value="">State</option></select></td>
                          <td className="px-1 py-1"><select value={addr.city} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].city = e.target.value; setDeliveryAddresses(newAddrs); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option value="">City</option></select></td>
                          <td className="px-1 py-1"><input type="text" value={addr.zip_code} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].zip_code = e.target.value; setDeliveryAddresses(newAddrs); }} placeholder="Code" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.phone} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].phone = e.target.value; setDeliveryAddresses(newAddrs); }} placeholder="+(Country code)(Area" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.ext} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].ext = e.target.value; setDeliveryAddresses(newAddrs); }} placeholder="Ext." className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1"><input type="text" value={addr.attention} onChange={(e) => { const newAddrs = [...deliveryAddresses]; newAddrs[idx].attention = e.target.value; setDeliveryAddresses(newAddrs); }} placeholder="Attention" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                          <td className="px-1 py-1 text-center"></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* For Office Use Section */}
              <div className="mt-6">
                <h4 className="text-xs font-bold text-gray-700 uppercase mb-3">FOR OFFICE USE</h4>
                <div className="grid grid-cols-2 gap-x-12 gap-y-2">
                  <div className="space-y-2">
                    <div className="flex items-center">
                      <label className="w-40 text-xs font-medium text-blue-600">Display Company Name</label>
                      <input type="text" value={officeUseForm.display_company_name} onChange={(e) => setOfficeUseForm({ ...officeUseForm, display_company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    </div>
                    <div className="flex items-center">
                      <label className="w-40 text-xs font-medium text-blue-600">subdomain name</label>
                      <input type="text" value={officeUseForm.subdomain_name} onChange={(e) => setOfficeUseForm({ ...officeUseForm, subdomain_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    </div>
                    <div className="flex items-center">
                      <label className="w-40 text-xs font-medium text-blue-600">Number of License</label>
                      <input type="text" value={officeUseForm.number_of_license} onChange={(e) => setOfficeUseForm({ ...officeUseForm, number_of_license: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    </div>
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-center">
                      <label className="w-40 text-xs font-medium text-blue-600">Access Start Date</label>
                      <input type="date" value={officeUseForm.access_start_date} onChange={(e) => setOfficeUseForm({ ...officeUseForm, access_start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    </div>
                    <div className="flex items-center">
                      <label className="w-40 text-xs font-medium text-blue-600">Renewal</label>
                      <input type="date" value={officeUseForm.renewal} onChange={(e) => setOfficeUseForm({ ...officeUseForm, renewal: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    </div>
                    <div className="flex items-center">
                      <label className="w-40 text-xs font-medium text-blue-600">Billing Amount</label>
                      <input type="text" value={officeUseForm.billing_amount} onChange={(e) => setOfficeUseForm({ ...officeUseForm, billing_amount: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    </div>
                    <div className="flex items-center">
                      <label className="w-40 text-xs font-medium text-blue-600">Billing Frequency</label>
                      <input type="text" value={officeUseForm.billing_frequency} onChange={(e) => setOfficeUseForm({ ...officeUseForm, billing_frequency: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Key Code Config Tab */}
          {configInnerTab === 'key-code-config' && (
            <div className="space-y-4">
              {/* Header */}
              <h4 className="text-xs font-bold text-orange-500 uppercase">KEY CODE GENERATION</h4>

              {/* Select Module */}
              <div className="flex items-center gap-4">
                <label className="text-xs font-medium text-blue-600">Select Module</label>
                <select value={keyCodeSelectedModule} onChange={(e) => setKeyCodeSelectedModule(e.target.value)} className="flex-1 max-w-md h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                  <option value="Inquiry Number">Inquiry Number</option>
                  <option value="Quotation Number">Quotation Number</option>
                  <option value="Order Number">Order Number</option>
                  <option value="Invoice Number">Invoice Number</option>
                  <option value="Purchase Order">Purchase Order</option>
                  <option value="Customer Code">Customer Code</option>
                  <option value="Supplier Code">Supplier Code</option>
                  <option value="Item Code">Item Code</option>
                </select>
              </div>

              {/* Key Code Table */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-600">
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">Module Identifier</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">Element</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">1st Identifier</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">Element</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">2nd Identifier</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">Element</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">Series</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">Pattern</th>
                      <th className="px-2 py-2 text-left text-xs font-medium text-white">Number</th>
                      <th className="px-2 py-2 text-center text-xs font-medium text-white">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {keyCodeRows.map((row, idx) => (
                      <tr key={idx} className="bg-blue-50">
                        <td className="px-1 py-1">
                          <select value={row.module_identifier} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].module_identifier = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100">
                            <option value="Code">Code</option>
                            <option value="Name">Name</option>
                            <option value="Prefix">Prefix</option>
                          </select>
                        </td>
                        <td className="px-1 py-1">
                          <select value={row.element1} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].element1 = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100">
                            <option value="None">None</option>
                            <option value="-">-</option>
                            <option value="/">/</option>
                            <option value="_">_</option>
                          </select>
                        </td>
                        <td className="px-1 py-1">
                          <select value={row.identifier1} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].identifier1 = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100">
                            <option value="Year">Year</option>
                            <option value="Month">Month</option>
                            <option value="Day">Day</option>
                            <option value="None">None</option>
                          </select>
                        </td>
                        <td className="px-1 py-1">
                          <select value={row.element2} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].element2 = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100">
                            <option value="None">None</option>
                            <option value="-">-</option>
                            <option value="/">/</option>
                            <option value="_">_</option>
                          </select>
                        </td>
                        <td className="px-1 py-1">
                          <select value={row.identifier2} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].identifier2 = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100">
                            <option value="Year">Year</option>
                            <option value="Month">Month</option>
                            <option value="Day">Day</option>
                            <option value="None">None</option>
                          </select>
                        </td>
                        <td className="px-1 py-1">
                          <select value={row.element3} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].element3 = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100">
                            <option value="None">None</option>
                            <option value="-">-</option>
                            <option value="/">/</option>
                            <option value="_">_</option>
                          </select>
                        </td>
                        <td className="px-1 py-1">
                          <input type="text" value={row.series} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].series = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                        </td>
                        <td className="px-1 py-1">
                          <select value={row.pattern} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].pattern = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100">
                            <option value="Yearly">Yearly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Daily">Daily</option>
                            <option value="Continuous">Continuous</option>
                          </select>
                        </td>
                        <td className="px-1 py-1">
                          <input type="text" value={row.number} onChange={(e) => { const newRows = [...keyCodeRows]; newRows[idx].number = e.target.value; setKeyCodeRows(newRows); }} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                        </td>
                        <td className="px-1 py-1 text-center">
                          <button onClick={() => { const newRows = keyCodeRows.filter((_, i) => i !== idx); setKeyCodeRows(newRows); }} className="text-red-500 hover:text-red-700 text-xs">
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Add Row Button */}
              <div className="flex justify-end">
                <button onClick={() => setKeyCodeRows([...keyCodeRows, { module_identifier: 'Code', element1: 'None', identifier1: 'Year', element2: 'None', identifier2: 'Year', element3: 'None', series: '00001', pattern: 'Yearly', number: '' }])} className="px-4 py-2 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
                  <Plus className="w-4 h-4" /> Add Row
                </button>
              </div>
            </div>
          )}

          {/* Email Config Tab */}
          {configInnerTab === 'email-config' && (
            <div className="space-y-4">
              {/* Header */}
              <h4 className="text-xs font-bold text-orange-500 uppercase">EMAIL CONFIGURATION</h4>

              {/* Email Config Table */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-600">
                      <th className="px-3 py-2 text-left text-xs font-medium text-white w-48">Module</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white">Email ID</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white w-64">CC Email ID</th>
                      <th className="px-3 py-2 text-center text-xs font-medium text-white w-24">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr className="bg-blue-50">
                      <td className="px-2 py-2">
                        <select className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100">
                          <option value="">Select</option>
                          <option value="Sales">Sales</option>
                          <option value="Purchase">Purchase</option>
                          <option value="Inventory">Inventory</option>
                          <option value="Accounts">Accounts</option>
                          <option value="HR">HR</option>
                          <option value="Support">Support</option>
                        </select>
                      </td>
                      <td className="px-2 py-2">
                        <input type="email" placeholder="Email_id" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                      </td>
                      <td className="px-2 py-2">
                        <input type="email" placeholder="CC Email ID" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                      </td>
                      <td className="px-2 py-2 text-center">
                        <button className="text-red-500 hover:text-red-700">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              {/* Add Row Button */}
              <div className="flex justify-end">
                <button className="px-4 py-2 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
                  <Plus className="w-4 h-4" /> Add Row
                </button>
              </div>
            </div>
          )}

          {/* Tax-Applicability Tab */}
          {configInnerTab === 'tax-applicability' && (
            <div className="space-y-4">
              {/* Header */}
              <h4 className="text-xs font-bold text-orange-500 uppercase">TAX TYPE & TAX RATE</h4>

              {/* Tax Applicability Table */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-600">
                      <th className="px-3 py-2 text-left text-xs font-medium text-white w-56">Tax Type</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white">Tax Code</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white">Tax Desc.</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white w-48">Tax Rate(%)</th>
                      <th className="px-3 py-2 text-center text-xs font-medium text-white w-24">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr className="bg-blue-50">
                      <td className="px-2 py-2">
                        <select className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100">
                          <option value="">Select Tax Type</option>
                          <option value="GST">GST</option>
                          <option value="VAT">VAT</option>
                          <option value="HST">HST</option>
                          <option value="PST">PST</option>
                          <option value="Sales Tax">Sales Tax</option>
                          <option value="Service Tax">Service Tax</option>
                          <option value="Excise">Excise</option>
                          <option value="Customs">Customs</option>
                        </select>
                      </td>
                      <td className="px-2 py-2">
                        <input type="text" placeholder="Tax Code" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                      </td>
                      <td className="px-2 py-2">
                        <input type="text" placeholder="Tax Description" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                      </td>
                      <td className="px-2 py-2">
                        <input type="text" placeholder="Tax Rate(%)" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                      </td>
                      <td className="px-2 py-2 text-center">
                        <button className="text-red-500 hover:text-red-700">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              {/* Add Row Button */}
              <div className="flex justify-end">
                <button className="px-4 py-2 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
                  <Plus className="w-4 h-4" /> Add Row
                </button>
              </div>
            </div>
          )}

          {/* Currency Tab */}
          {configInnerTab === 'currency' && (
            <div className="space-y-4">
              {/* Currency Table */}
              <div className="border rounded overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-blue-600">
                      <th className="px-3 py-2 text-left text-xs font-medium text-white w-16">No.</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white">Currency Name</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white">Currency Code</th>
                      <th className="px-3 py-2 text-center text-xs font-medium text-white w-24">Status</th>
                      <th className="px-3 py-2 text-left text-xs font-medium text-white">Country</th>
                      <th className="px-3 py-2 text-center text-xs font-medium text-white w-24">Tick Mark</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[
                      { no: 1, name: 'Australian Dollar', code: 'AUD', status: true, country: 'Australia' },
                      { no: 2, name: 'Bulgarian Lev', code: 'BGN', status: false, country: 'Bulgaria' },
                      { no: 3, name: 'Brazilian Real', code: 'BRL', status: false, country: 'Brazil' },
                      { no: 4, name: 'Canadian Dollar', code: 'CAD', status: true, country: 'Canada' },
                      { no: 5, name: 'Swiss Franc', code: 'CHF', status: false, country: 'Switzerland' },
                      { no: 6, name: 'Yuan Renminbi', code: 'CNY', status: true, country: 'Yuan' },
                      { no: 7, name: 'Czech Koruna', code: 'CZK', status: false, country: 'Czech Republic' },
                      { no: 8, name: 'Danish Krone', code: 'DKK', status: true, country: 'Denmark' },
                      { no: 9, name: 'Euro', code: 'EUR', status: true, country: 'European Country' },
                      { no: 10, name: 'Pound Sterling', code: 'GBP', status: true, country: 'Great Britain' },
                      { no: 11, name: 'Hong Kong Dollar', code: 'HKD', status: true, country: 'Hong Kong' },
                      { no: 12, name: 'Kuna', code: 'HRK', status: false, country: 'Croatia' },
                      { no: 13, name: 'Forint', code: 'HUF', status: false, country: 'Hungary' },
                      { no: 14, name: 'Rupiah', code: 'IDR', status: true, country: 'Indonesia' },
                      { no: 15, name: 'Indian Rupee', code: 'INR', status: true, country: 'India' },
                      { no: 16, name: 'Japanese Yen', code: 'JPY', status: true, country: 'Japan' },
                      { no: 17, name: 'Korean Won', code: 'KRW', status: true, country: 'South Korea' },
                      { no: 18, name: 'Mexican Peso', code: 'MXN', status: false, country: 'Mexico' },
                      { no: 19, name: 'Malaysian Ringgit', code: 'MYR', status: true, country: 'Malaysia' },
                      { no: 20, name: 'US Dollar', code: 'USD', status: true, country: 'United States' },
                    ].map((currency, idx) => (
                      <tr key={currency.no} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-3 py-2 text-xs text-gray-600">{currency.no}</td>
                        <td className="px-3 py-2 text-xs text-blue-600">{currency.name}</td>
                        <td className="px-3 py-2 text-xs text-blue-600">{currency.code}</td>
                        <td className="px-3 py-2 text-center">
                          {currency.status ? (
                            <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-green-500 text-white">
                              <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                            </span>
                          ) : (
                            <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-500 text-white">
                              <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                            </span>
                          )}
                        </td>
                        <td className="px-3 py-2 text-xs text-blue-600">{currency.country}</td>
                        <td className="px-3 py-2 text-center">
                          <input type="checkbox" className="w-4 h-4 accent-blue-600" />
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Data Migration Sub-tab */}
      {planningSubTab === 'data-migration' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-4 py-2 rounded-t text-sm font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-4 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Data Migration Coordinator</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-gray-600">Email</label>
                  <input type="email" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-gray-600">Phone</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-4 py-2 rounded-t text-sm font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-4 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Data Migration Coordinator</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-gray-600">Email</label>
                  <input type="email" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-gray-600">Phone</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
              </div>
            </div>
          </div>

          {/* Message */}
          <div className="text-xs text-gray-700 font-medium uppercase tracking-wide">
            WE ARE EXCITED TO BEGIN THE ERP IMPLEMENTATION FOR [CUSTOMER'S COMPANY NAME]. TO ENSURE A SMOOTH AND ACCURATE DATA MIGRATION, WE KINDLY REQUEST THE FOLLOWING DETAILS:
          </div>

          {/* 1. Current Software Section */}
          <div>
            <h4 className="text-xs font-bold text-orange-500 uppercase mb-3">1. CURRENT SOFTWARE USED FOR BUSINESS OPERATIONS.</h4>
            <div className="border rounded overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className="px-2 py-2 text-left text-xs font-medium text-white">Software Name</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white">Software Type</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white">Installation Type</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white">Data Type</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white">Database Output</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white">Data Quality</th>
                    <th className="px-2 py-2 text-left text-xs font-medium text-white">Remarks / Notes</th>
                    <th className="px-2 py-2 text-center text-xs font-medium text-white w-20">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr className="bg-blue-50">
                    <td className="px-1 py-1"><input type="text" placeholder="Software Name" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                    <td className="px-1 py-1"><select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option>Software Type</option><option>ERP</option><option>CRM</option><option>Accounting</option></select></td>
                    <td className="px-1 py-1"><select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option>Installation Type</option><option>Cloud</option><option>On-Premise</option><option>Hybrid</option></select></td>
                    <td className="px-1 py-1"><select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option>Data Type</option><option>Structured</option><option>Unstructured</option></select></td>
                    <td className="px-1 py-1"><select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option>Process specific</option><option>Full Export</option><option>Partial</option></select></td>
                    <td className="px-1 py-1"><select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-blue-100"><option>Evaluation</option><option>Good</option><option>Average</option><option>Poor</option></select></td>
                    <td className="px-1 py-1"><input type="text" placeholder="Remarks" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-blue-100" /></td>
                    <td className="px-1 py-1 text-center"><button className="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Add</button></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          {/* 2. Module-wise Data Details */}
          <div>
            <h4 className="text-xs font-bold text-orange-500 uppercase mb-1">2. MODULE-WISE DATA DETAILS: <span className="font-normal text-gray-600">PLEASE PROVIDE DETAILS FOR EACH MODULE RELEVANT TO YOUR OPERATIONS.</span></h4>
            <div className="border rounded overflow-hidden mt-3">
              <table className="w-full">
                <thead>
                  <tr className="bg-blue-600">
                    <th className="px-3 py-2 text-left text-xs font-medium text-white w-40">Module Name</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-white">Approximate Number Of Records</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-white">Current Data Format</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-white">Data Complexity</th>
                    <th className="px-3 py-2 text-center text-xs font-medium text-white w-36">Required Format</th>
                  </tr>
                </thead>
                <tbody>
                  {['Customers', 'Suppliers', 'Vendors', 'Products', 'Inventory', 'Sales Orders', 'Purchase Orders', 'Vendor Orders', 'Customer Invoices', 'Supplier Invoices', 'Vendor Invoices', 'Customer Advances', 'Customer Payments', 'Supplier Advances', 'Supplier Payments', 'Vendor Payments', 'Chart of Accounts', 'Fixed Assets', 'Employees', 'Others', 'Contractors', 'Services', 'Work Orders', 'Contractor Invoices', 'Contractor Advances', 'Contractor Payments'].map((module, idx) => (
                    <tr key={module} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs text-blue-600">{module}</td>
                      <td className="px-2 py-1"><input type="text" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white" /></td>
                      <td className="px-2 py-1"><select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white"><option>Please Select</option><option>Excel</option><option>CSV</option><option>XML</option><option>JSON</option><option>Database</option></select></td>
                      <td className="px-2 py-1"><select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white"><option>Please Select</option><option>Simple</option><option>Moderate</option><option>Complex</option></select></td>
                      <td className="px-2 py-1 text-center"><button className="px-3 py-1 text-xs font-medium text-white bg-green-500 rounded hover:bg-green-600">Download Format</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* 3. Data Quality and Preparation */}
          <div>
            <h4 className="text-xs font-bold text-gray-800 uppercase mb-3">3. DATA QUALITY AND PREPARATION:</h4>
            <div className="space-y-4 pl-4">
              <div>
                <p className="text-xs text-blue-600 mb-2">Do you need assistance with data cleansing before migration? <span className="text-orange-500">(Tick one)</span></p>
                <div className="space-y-2">
                  <label className="flex items-center gap-2 text-xs">
                    <input type="radio" name="data_cleansing" value="yes" className="accent-blue-600" />
                    <span>Yes</span>
                    <input type="text" placeholder="Fill assistance data" className="ml-2 flex-1 max-w-md h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" />
                  </label>
                  <label className="flex items-center gap-2 text-xs">
                    <input type="radio" name="data_cleansing" value="no" className="accent-blue-600" />
                    <span>No</span>
                  </label>
                </div>
              </div>
              <div>
                <p className="text-xs text-orange-500 mb-2">Are there duplicate, outdated, or inconsistent records that need to be addressed? <span className="text-orange-500">(Tick one)</span></p>
                <div className="space-y-2">
                  <label className="flex items-center gap-2 text-xs">
                    <input type="radio" name="duplicate_records" value="yes" className="accent-blue-600" />
                    <span>Yes</span>
                    <input type="text" placeholder="Fill assistance data" className="ml-2 flex-1 max-w-md h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" />
                  </label>
                  <label className="flex items-center gap-2 text-xs">
                    <input type="radio" name="duplicate_records" value="no" className="accent-blue-600" />
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          {/* 4. Customer Fields and Data Mapping */}
          <div>
            <h4 className="text-xs font-bold text-orange-500 uppercase mb-3">4. CUSTOMER FIELDS AND DATA MAPPING:</h4>
            <div className="pl-4">
              <p className="text-xs text-blue-600 mb-2">Do you have customer fields or specific data mapping requirements? <span className="text-orange-500">(Tick one)</span></p>
              <div className="space-y-2">
                <label className="flex items-center gap-2 text-xs">
                  <input type="radio" name="data_mapping" value="yes" className="accent-blue-600" />
                  <span>Yes</span>
                  <input type="text" placeholder="Fill assistance data" className="ml-2 flex-1 max-w-md h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" />
                </label>
                <label className="flex items-center gap-2 text-xs">
                  <input type="radio" name="data_mapping" value="no" className="accent-blue-600" />
                  <span>No</span>
                </label>
              </div>
            </div>
          </div>

          {/* 5. Historical Data Migration */}
          <div>
            <h4 className="text-xs font-bold text-gray-800 uppercase mb-3">5. HISTORICAL DATA MIGRATION:</h4>
            <div className="pl-4">
              <p className="text-xs text-blue-600 mb-2">Do you require migration of historical data? <span className="text-orange-500">(Tick one)</span></p>
              <div className="space-y-2">
                <label className="flex items-center gap-2 text-xs">
                  <input type="radio" name="historical_data" value="yes" className="accent-blue-600" />
                  <span>Yes</span>
                  <input type="text" placeholder="Fill assistance data" className="ml-2 flex-1 max-w-md h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" />
                </label>
                <label className="flex items-center gap-2 text-xs">
                  <input type="radio" name="historical_data" value="no" className="accent-blue-600" />
                  <span>No</span>
                </label>
              </div>
            </div>
          </div>

          {/* 6. Migration Timeline and Resources */}
          <div>
            <h4 className="text-xs font-bold text-orange-500 uppercase mb-3">6. MIGRATION TIMELINE AND RESOURCES:</h4>
            <div className="pl-4 space-y-4">
              <div className="flex items-center">
                <label className="w-64 text-xs font-medium text-blue-600">Preferred Data Migration Start Date</label>
                <input type="date" className="w-48 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
              <div>
                <p className="text-xs text-blue-600 mb-2">Do you have internal resources allocated for this migration? <span className="text-orange-500">(Tick one)</span></p>
                <div className="space-y-2">
                  <label className="flex items-center gap-2 text-xs">
                    <input type="radio" name="internal_resources" value="yes" className="accent-blue-600" />
                    <span>Yes</span>
                    <input type="text" placeholder="Fill assistance data" className="ml-2 flex-1 max-w-md h-7 px-2 text-xs border border-gray-300 rounded bg-gray-50" />
                  </label>
                  <label className="flex items-center gap-2 text-xs">
                    <input type="radio" name="internal_resources" value="no" className="accent-blue-600" />
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          {/* 7. Additional Information */}
          <div>
            <h4 className="text-xs font-bold text-gray-800 uppercase mb-3">7. ADDITIONAL INFORMATION:</h4>
            <div className="pl-4">
              <p className="text-xs text-blue-600 mb-2">Any additional comments or special instructions:</p>
              <textarea placeholder="Add comments or special instructions" className="w-full max-w-lg h-24 px-3 py-2 text-sm border border-gray-300 rounded bg-gray-50 resize-y" />
            </div>
          </div>

          {/* Save Button */}
          <div className="flex justify-center pt-4">
            <button className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
          </div>
        </div>
      )}

      {/* Training Sub-tab */}
      {planningSubTab === 'training' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-4 py-2 rounded-t text-sm font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-4 space-y-3">
                <div className="flex items-center">
                  <label className="w-40 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-40 text-xs font-medium text-gray-600">Email</label>
                  <input type="email" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-40 text-xs font-medium text-gray-600">Phone</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-4 py-2 rounded-t text-sm font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-4 space-y-3">
                <div className="flex items-center">
                  <label className="w-40 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-40 text-xs font-medium text-gray-600">Email</label>
                  <input type="email" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center">
                  <label className="w-40 text-xs font-medium text-gray-600">Phone</label>
                  <input type="text" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
              </div>
            </div>
          </div>

          {/* Training Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white">Employee Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white">Department</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white">Email</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white">Phone</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white">Employee Role</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white">Module / Sub-Module Training</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr className="bg-blue-50">
                  <td className="px-2 py-2">
                    <input type="text" placeholder="Employee Name" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                  </td>
                  <td className="px-2 py-2">
                    <input type="text" placeholder="Department" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                  </td>
                  <td className="px-2 py-2">
                    <input type="email" placeholder="Email" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                  </td>
                  <td className="px-2 py-2">
                    <input type="text" placeholder="Phone" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                  </td>
                  <td className="px-2 py-2">
                    <input type="text" placeholder="Department Role" className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100" />
                  </td>
                  <td className="px-2 py-2">
                    <select className="w-full h-8 px-2 text-xs border border-gray-300 rounded bg-blue-100">
                      <option value="">Module / Sub-Module Training</option>
                      <option value="Sales">Sales</option>
                      <option value="Purchase">Purchase</option>
                      <option value="Inventory">Inventory</option>
                      <option value="Accounts">Accounts</option>
                      <option value="HR">HR</option>
                      <option value="CRM">CRM</option>
                      <option value="Reports">Reports</option>
                      <option value="Admin">Admin</option>
                    </select>
                  </td>
                  <td className="px-2 py-2 text-center">
                    <button className="px-4 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 border border-blue-700">Add</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* Save Button */}
          <div className="flex justify-center pt-4">
            <button className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {planningSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowPlanningFollowUpModal(true); setEditingPlanningFollowUp(null); setPlanningFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' }); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {planningFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  planningFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingPlanningFollowUp(activity); setPlanningFollowUpForm(activity); setShowPlanningFollowUpModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeletePlanningFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {planningSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowPlanningMemoModal(true); setEditingPlanningMemo(null); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {planningMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  planningMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingPlanningMemo(memo); setShowPlanningMemoModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeletePlanningMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {planningSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={planningSubTabFile?.name || ''} />
            <input ref={planningSubTabFileRef} type="file" onChange={handlePlanningSubTabFileChange} className="hidden" />
            <button onClick={handlePlanningSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handlePlanningSubTabUpload} disabled={!planningSubTabFile || planningSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{planningSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={planningSubTabNotes} onChange={(e) => setPlanningSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {planningSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  planningSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handlePlanningSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {planningSubTab === 'workflow--audit-trail' && (
        <div className="text-center py-8 text-gray-500 text-sm">Workflow & Audit Trail content will be displayed here.</div>
      )}

      {/* Follow-Up Modal */}
      {showPlanningFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button className="px-3 py-1 text-xs font-medium text-white bg-blue-800 rounded hover:bg-blue-900">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowPlanningFollowUpModal(false); setEditingPlanningFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={planningFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = planningContacts.find((c: any) => c.id?.toString() === cid); setPlanningFollowUpForm({ ...planningFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Contact</option>
                    {planningContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={planningFollowUpForm.subject} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={planningFollowUpForm.sent_to} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={planningFollowUpForm.activity_type} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={planningFollowUpForm.start_date} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={planningFollowUpForm.start_time} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={planningFollowUpForm.assigned_to} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    {planningContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={planningFollowUpForm.next_followup_date} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={planningFollowUpForm.status} onChange={(e) => setPlanningFollowUpForm({ ...planningFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningFollowUpExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningFollowUpExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningFollowUpExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningFollowUpExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                  </button>
                  <select onChange={(e) => handlePlanningFollowUpExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                  </select>
                  <select onChange={(e) => handlePlanningFollowUpExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="1">10</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                    <option value="5">18</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                    <input type="color" onChange={(e) => handlePlanningFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" />
                  </div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningFollowUpExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningFollowUpExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningFollowUpExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                  </button>
                </div>
                <div ref={planningFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSavePlanningFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showPlanningMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowPlanningMemoModal(false); setEditingPlanningMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningMemoExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningMemoExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningMemoExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningMemoExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                </button>
                <select onChange={(e) => handlePlanningMemoExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                </select>
                <select onChange={(e) => handlePlanningMemoExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="3">14</option>
                  <option value="1">10</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                  <option value="5">18</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                  <input type="color" onChange={(e) => handlePlanningMemoExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" />
                </div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningMemoExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningMemoExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handlePlanningMemoExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                </button>
              </div>
              <div ref={planningMemoEditorRef} contentEditable className="w-full min-h-[200px] max-h-[350px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSavePlanningMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Configuration Form ==============
function ConfigurationForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [configSubTab, setConfigSubTab] = useState('details');
  const configSubTabs = ['Details', 'Summary', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [configFormData, setConfigFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [configContacts, setConfigContacts] = useState<any[]>([]);
  const [configEmailTemplates, setConfigEmailTemplates] = useState<any[]>([]);
  const [configDocs, setConfigDocs] = useState<any[]>([]);
  const [configFile, setConfigFile] = useState<File | null>(null);
  const [configUploading, setConfigUploading] = useState(false);
  const configFileRef = React.useRef<HTMLInputElement>(null);
  const [configEmailSentList, setConfigEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [configCustomerForm, setConfigCustomerForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [configAxieverForm, setConfigAxieverForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [configTasks, setConfigTasks] = useState<any[]>([
    { id: 1, task: 'Login Id Creation', required_hours: '0:30:00', responsible: 'Abdoul Abdoul', start_date_time: '01/01/1970', end_date_time: '01/01/1970', done_by: 'Abdoul Abdoul', total_hours: '0.00', difference: '0.00', checked_by: '', date: '', remarks: '', status: '' },
    { id: 2, task: 'Login Id Creation', required_hours: '0:30:00', responsible: '', start_date_time: '', end_date_time: '', done_by: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 3, task: 'Modules to be Activated', required_hours: '1:00:00', responsible: '', start_date_time: '', end_date_time: '', done_by: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' }
  ]);

  // Summary sub-tab tasks
  const [configSummaryTasks, setConfigSummaryTasks] = useState<any[]>([
    { id: 1, task: 'Login Id Creation', responsible: '30', done_by: '30', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '0.00', difference: '0.00', checked_by: 'dvs', date: '', remarks: '', status: '' },
    { id: 2, task: 'Login Id Creation', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 3, task: 'Modules to be Activated', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 4, task: 'Customer Master Preparation', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 5, task: 'Company Information configuration', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 6, task: 'Key Code Generation', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 7, task: 'SMTP Configuration', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 8, task: 'Email Address Configuration', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 9, task: 'Dates to be Set for Financial Reporting', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 10, task: 'E-Commerce Configuration', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 11, task: 'Digital Signature Configuration', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 12, task: 'Logo to be Added', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 13, task: 'Tax Rate, Tax %, Tax Applicability Configuration', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 14, task: 'Tariff Charges Configuration', responsible: '', done_by: '', required_hours: '0:30:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 15, task: 'Warehouse Dimension Configuration', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 16, task: 'Warehouse Related Misc. Information to be Added', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '01/01/1970', end_date_time: '01/01/1970', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' }
  ]);

  // Follow-up state
  const [configFollowUps, setConfigFollowUps] = useState<any[]>([]);
  const [showConfigFollowUpModal, setShowConfigFollowUpModal] = useState(false);
  const [editingConfigFollowUp, setEditingConfigFollowUp] = useState<any>(null);
  const [configFollowUpForm, setConfigFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: ''
  });
  const configFollowUpEditorRef = React.useRef<HTMLDivElement>(null);

  // Memo state
  const [configMemos, setConfigMemos] = useState<any[]>([]);
  const [showConfigMemoModal, setShowConfigMemoModal] = useState(false);
  const [editingConfigMemo, setEditingConfigMemo] = useState<any>(null);
  const configMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Task modal state
  const [showConfigTaskModal, setShowConfigTaskModal] = useState(false);
  const [editingConfigTask, setEditingConfigTask] = useState<any>(null);
  const [configTaskForm, setConfigTaskForm] = useState({
    task: '', responsible: '', done_by: '', required_hours: '', start_date: '', start_time: '', status: '', remarks: '',
    total_hours: '', difference: '', checked_by: '', date: '', end_date: '', end_time: ''
  });
  const configTaskEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [configSubTabDocs, setConfigSubTabDocs] = useState<any[]>([]);
  const [configSubTabFile, setConfigSubTabFile] = useState<File | null>(null);
  const [configSubTabNotes, setConfigSubTabNotes] = useState('');
  const [configSubTabUploading, setConfigSubTabUploading] = useState(false);
  const configSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Fetch data
  useEffect(() => {
    if (crId) {
      fetchConfigContacts();
      fetchConfigDocs();
      fetchConfigFollowUps();
      fetchConfigMemos();
      fetchConfigSubTabDocs();
    }
  }, [crId]);

  // Load email templates for Configuration tab
  useEffect(() => {
    api.getCRIEmailTemplates('Configuration').then(setConfigEmailTemplates).catch(() => setConfigEmailTemplates([]));
  }, []);

  const fetchConfigContacts = async () => {
    try { const res = await api.getLeadContactsForEdit(leadId); setConfigContacts(res); } catch (err) { console.error('Failed to fetch contacts:', err); }
  };
  const fetchConfigDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'configuration'); setConfigDocs(res); } catch (err) { console.error('Failed to fetch docs:', err); }
  };
  const fetchConfigFollowUps = async () => {
    try { const res = await api.getCRActivities(crId, 'configuration-followup'); setConfigFollowUps(res); } catch (err) { console.error('Failed to fetch follow-ups:', err); }
  };
  const fetchConfigMemos = async () => {
    try { const res = await api.getCRMemos(crId, 'configuration-memo'); setConfigMemos(res); } catch (err) { console.error('Failed to fetch memos:', err); }
  };
  const fetchConfigSubTabDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'configuration-upload'); setConfigSubTabDocs(res); } catch (err) { console.error('Failed to fetch upload docs:', err); }
  };

  // File handlers
  const handleConfigChooseFile = () => configFileRef.current?.click();
  const handleConfigFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setConfigFile(e.target.files[0]);
  };
  const handleConfigUploadFile = async () => {
    if (!crId || !configFile) return;
    setConfigUploading(true);
    try {
      await api.uploadCRDocument(crId, configFile, 'configuration', 'Configuration Document');
      fetchConfigDocs();
      setConfigFile(null);
      if (configFileRef.current) configFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setConfigUploading(false); }
  };
  const handleConfigDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchConfigDocs(); } catch { alert('Failed to delete'); }
  };

  // Follow-up handlers
  const handleConfigFollowUpExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveConfigFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = configFollowUpEditorRef.current?.innerHTML || '';
    const formToSave = { ...configFollowUpForm, description: descriptionContent };
    try {
      if (editingConfigFollowUp) {
        await api.updateCRActivity(crId, editingConfigFollowUp.id, { ...formToSave, activity_category: 'configuration-followup' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'configuration-followup' });
      }
      fetchConfigFollowUps();
      setShowConfigFollowUpModal(false);
      setEditingConfigFollowUp(null);
      setConfigFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' });
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteConfigFollowUp = async (id: number) => {
    if (!crId || !confirm('Delete this follow-up?')) return;
    try { await api.deleteCRActivity(crId, id); fetchConfigFollowUps(); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleConfigMemoExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveConfigMemo = async () => {
    if (!crId) return;
    const content = configMemoEditorRef.current?.innerHTML || '';
    try {
      if (editingConfigMemo) {
        await api.updateCRMemo(crId, editingConfigMemo.id, { content, memo_category: 'configuration-memo' });
      } else {
        await api.createCRMemo(crId, { content, memo_category: 'configuration-memo' });
      }
      fetchConfigMemos();
      setShowConfigMemoModal(false);
      setEditingConfigMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteConfigMemo = async (id: number) => {
    if (!crId || !confirm('Delete this memo?')) return;
    try { await api.deleteCRMemo(crId, id); fetchConfigMemos(); } catch { alert('Failed to delete'); }
  };

  // Task handlers
  const handleConfigTaskExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleOpenConfigTaskModal = (task?: any) => {
    if (task) {
      setEditingConfigTask(task);
      setConfigTaskForm({
        task: task.task || '',
        responsible: task.responsible || '',
        done_by: task.done_by || '',
        required_hours: task.required_hours || '',
        start_date: task.start_date || '',
        start_time: task.start_time || '',
        status: task.status || '',
        remarks: task.remarks || '',
        total_hours: task.total_hours || '',
        difference: task.difference || '',
        checked_by: task.checked_by || '',
        date: task.date || '',
        end_date: task.end_date || '',
        end_time: task.end_time || ''
      });
    } else {
      setEditingConfigTask(null);
      setConfigTaskForm({
        task: '', responsible: '', done_by: '', required_hours: '', start_date: '', start_time: '', status: '', remarks: '',
        total_hours: '', difference: '', checked_by: '', date: '', end_date: '', end_time: ''
      });
    }
    setShowConfigTaskModal(true);
  };
  const handleSaveConfigTask = () => {
    const remarksContent = configTaskEditorRef.current?.innerHTML || configTaskForm.remarks;
    const taskData = {
      ...configTaskForm,
      remarks: remarksContent,
      start_date_time: configTaskForm.start_date ? `${configTaskForm.start_date}${configTaskForm.start_time ? ' ' + configTaskForm.start_time : ''}` : '',
      end_date_time: configTaskForm.end_date ? `${configTaskForm.end_date}${configTaskForm.end_time ? ' ' + configTaskForm.end_time : ''}` : ''
    };
    if (editingConfigTask) {
      setConfigTasks(prev => prev.map(t => t.id === editingConfigTask.id ? { ...t, ...taskData } : t));
    } else {
      const newId = Math.max(...configTasks.map(t => t.id), 0) + 1;
      setConfigTasks(prev => [...prev, { id: newId, ...taskData }]);
    }
    setShowConfigTaskModal(false);
    setEditingConfigTask(null);
  };
  const handleDeleteConfigTask = (taskId: number) => {
    if (!confirm('Delete this task?')) return;
    setConfigTasks(prev => prev.filter(t => t.id !== taskId));
  };

  // Upload sub-tab handlers
  const handleConfigSubTabChooseFile = () => configSubTabFileRef.current?.click();
  const handleConfigSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setConfigSubTabFile(e.target.files[0]);
  };
  const handleConfigSubTabUpload = async () => {
    if (!crId || !configSubTabFile) return;
    setConfigSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, configSubTabFile, 'configuration-upload', 'Upload File');
      fetchConfigSubTabDocs();
      setConfigSubTabFile(null);
      setConfigSubTabNotes('');
      if (configSubTabFileRef.current) configSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload'); } finally { setConfigSubTabUploading(false); }
  };
  const handleConfigSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchConfigSubTabDocs(); } catch { alert('Failed to delete'); }
  };

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={configFormData.company_name} onChange={(e) => setConfigFormData({ ...configFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={configFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = configContacts.find((c: any) => c.id?.toString() === cid); setConfigFormData({ ...configFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {configContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={configFormData.email_format_type} onChange={(e) => setConfigFormData({ ...configFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {configEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Configuration', configFormData.contact_email, configEmailTemplates.find((t: any) => t.email_format === configFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Type</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {configEmailSentList.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  configEmailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.email_type}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={configFormData.branch_office} onChange={(e) => setConfigFormData({ ...configFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={configFormData.contact_email} onChange={(e) => setConfigFormData({ ...configFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={configFileRef} onChange={handleConfigFileChange} className="hidden" />
            <button onClick={handleConfigChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleConfigUploadFile} disabled={!configFile || configUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{configUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {configDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  configDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handleConfigDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {configSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setConfigSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${configSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {configSubTab === 'details' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Configuration Coordinator</label>
                  <input type="text" value={configCustomerForm.coordinator} onChange={(e) => setConfigCustomerForm({ ...configCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={configCustomerForm.email} onChange={(e) => setConfigCustomerForm({ ...configCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={configCustomerForm.phone} onChange={(e) => setConfigCustomerForm({ ...configCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Configuration Coordinator</label>
                  <input type="text" value={configAxieverForm.coordinator} onChange={(e) => setConfigAxieverForm({ ...configAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={configAxieverForm.email} onChange={(e) => setConfigAxieverForm({ ...configAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={configAxieverForm.phone} onChange={(e) => setConfigAxieverForm({ ...configAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Add New Task Button */}
          <div>
            <button onClick={() => handleOpenConfigTaskModal()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Task</button>
          </div>

          {/* Task Table - No horizontal scroll */}
          <div className="border rounded overflow-hidden">
            <table className="w-full table-fixed">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[12%]">Task</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-[6%]">Req. Hrs</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[8%]">Responsible</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[8%]">Start Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[8%]">End Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[8%]">Done By</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-[5%]">Total</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-[5%]">Diff</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[8%]">Checked By</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[7%]">Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[12%]">Remarks</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-[6%]">Status</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white w-[7%]">Action</th>
                </tr>
              </thead>
              <tbody>
                {configTasks.map((task, index) => (
                  <tr key={task.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-blue-600 truncate">{task.task}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.required_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.responsible}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.start_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.end_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.done_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.total_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.difference}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.checked_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.date}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate"><div dangerouslySetInnerHTML={{ __html: task.remarks || '' }} /></td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.status}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">
                      <div className="flex gap-1 justify-center">
                        <button onClick={() => handleOpenConfigTaskModal(task)} className="p-1 text-blue-600 hover:bg-blue-50 rounded border border-gray-300"><Edit2 className="w-3 h-3" /></button>
                        <button onClick={() => handleDeleteConfigTask(task.id)} className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Summary Sub-tab */}
      {configSubTab === 'summary' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Configuration Coordinator</label>
                  <input type="text" value={configCustomerForm.coordinator} onChange={(e) => setConfigCustomerForm({ ...configCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={configCustomerForm.email} onChange={(e) => setConfigCustomerForm({ ...configCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={configCustomerForm.phone} onChange={(e) => setConfigCustomerForm({ ...configCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Configuration Coordinator</label>
                  <input type="text" value={configAxieverForm.coordinator} onChange={(e) => setConfigAxieverForm({ ...configAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={configAxieverForm.email} onChange={(e) => setConfigAxieverForm({ ...configAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={configAxieverForm.phone} onChange={(e) => setConfigAxieverForm({ ...configAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Summary Task Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500">Task</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-20">Responsible</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-20">Done By</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-24">Required Hours</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-24">Start Date/Time</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-24">End Date/Time</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-20">Total Hours</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-20">Difference</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-20">Checked By</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white border-r border-blue-500 w-20">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-28">Remarks</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-20">Status</th>
                </tr>
              </thead>
              <tbody>
                {configSummaryTasks.map((task, index) => (
                  <tr key={task.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{task.task}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.responsible}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.done_by}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.required_hours}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.start_date_time}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.end_date_time}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.total_hours}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.difference}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.checked_by}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.date}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200">{task.remarks}</td>
                    <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">{task.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {configSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowConfigFollowUpModal(true); setEditingConfigFollowUp(null); setConfigFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' }); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {configFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  configFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingConfigFollowUp(activity); setConfigFollowUpForm(activity); setShowConfigFollowUpModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteConfigFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {configSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowConfigMemoModal(true); setEditingConfigMemo(null); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {configMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  configMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingConfigMemo(memo); setShowConfigMemoModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteConfigMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {configSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={configSubTabFile?.name || ''} />
            <input ref={configSubTabFileRef} type="file" onChange={handleConfigSubTabFileChange} className="hidden" />
            <button onClick={handleConfigSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handleConfigSubTabUpload} disabled={!configSubTabFile || configSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{configSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={configSubTabNotes} onChange={(e) => setConfigSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {configSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  configSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleConfigSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {configSubTab === 'workflow--audit-trail' && (
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-600">
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-28">Date</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-32">User</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-24">Action</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white">Details</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
            </tbody>
          </table>
        </div>
      )}

      {/* Follow-Up Modal */}
      {showConfigFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button className="px-3 py-1 text-xs font-medium text-white bg-blue-800 rounded hover:bg-blue-900">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowConfigFollowUpModal(false); setEditingConfigFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={configFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = configContacts.find((c: any) => c.id?.toString() === cid); setConfigFollowUpForm({ ...configFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Contact</option>
                    {configContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={configFollowUpForm.subject} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={configFollowUpForm.sent_to} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={configFollowUpForm.activity_type} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={configFollowUpForm.start_date} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={configFollowUpForm.start_time} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={configFollowUpForm.assigned_to} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    {configContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={configFollowUpForm.next_followup_date} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                {/* Right Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={configFollowUpForm.status} onChange={(e) => setConfigFollowUpForm({ ...configFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigFollowUpExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigFollowUpExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigFollowUpExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigFollowUpExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                  </button>
                  <select onChange={(e) => handleConfigFollowUpExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                  </select>
                  <select onChange={(e) => handleConfigFollowUpExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="1">10</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                    <option value="5">18</option>
                    <option value="6">24</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                    <input type="color" onChange={(e) => handleConfigFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                  </div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigFollowUpExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigFollowUpExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigFollowUpExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                  </button>
                </div>
                <div ref={configFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveConfigFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showConfigMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowConfigMemoModal(false); setEditingConfigMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigMemoExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigMemoExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigMemoExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigMemoExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                </button>
                <select onChange={(e) => handleConfigMemoExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                </select>
                <select onChange={(e) => handleConfigMemoExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="3">14</option>
                  <option value="1">10</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                  <option value="5">18</option>
                  <option value="6">24</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                  <input type="color" onChange={(e) => handleConfigMemoExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                </div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigMemoExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigMemoExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigMemoExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                </button>
              </div>
              <div ref={configMemoEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSaveConfigMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}

      {/* Task Modal */}
      {showConfigTaskModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-4 py-3 bg-blue-600">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">NEW TASK</h3>
              <button onClick={() => { setShowConfigTaskModal(false); setEditingConfigTask(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-4">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                {/* Left Column */}
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Task</label>
                  <input type="text" value={configTaskForm.task} onChange={(e) => setConfigTaskForm({ ...configTaskForm, task: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Total Hours</label>
                  <input type="text" value={configTaskForm.total_hours} onChange={(e) => setConfigTaskForm({ ...configTaskForm, total_hours: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Responsible</label>
                  <select value={configTaskForm.responsible} onChange={(e) => setConfigTaskForm({ ...configTaskForm, responsible: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Abdoul Abdoul">Abdoul Abdoul</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Difference</label>
                  <input type="text" value={configTaskForm.difference} onChange={(e) => setConfigTaskForm({ ...configTaskForm, difference: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Done By</label>
                  <select value={configTaskForm.done_by} onChange={(e) => setConfigTaskForm({ ...configTaskForm, done_by: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Abdoul Abdoul">Abdoul Abdoul</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Checked By</label>
                  <select value={configTaskForm.checked_by} onChange={(e) => setConfigTaskForm({ ...configTaskForm, checked_by: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Required Hours</label>
                  <input type="text" value={configTaskForm.required_hours} onChange={(e) => setConfigTaskForm({ ...configTaskForm, required_hours: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Date</label>
                  <input type="date" value={configTaskForm.date} onChange={(e) => setConfigTaskForm({ ...configTaskForm, date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={configTaskForm.start_date} onChange={(e) => setConfigTaskForm({ ...configTaskForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <input type="time" value={configTaskForm.start_time} onChange={(e) => setConfigTaskForm({ ...configTaskForm, start_time: e.target.value })} className="w-20 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">End Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={configTaskForm.end_date} onChange={(e) => setConfigTaskForm({ ...configTaskForm, end_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    <input type="time" value={configTaskForm.end_time} onChange={(e) => setConfigTaskForm({ ...configTaskForm, end_time: e.target.value })} className="w-20 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                <div className="col-span-2">
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={configTaskForm.status} onChange={(e) => setConfigTaskForm({ ...configTaskForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select Priority</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="On Hold">On Hold</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Remarks</label>
                <div className="flex items-center gap-2 px-2 py-1.5 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigTaskExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigTaskExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigTaskExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <span className="text-gray-300">|</span>
                  <select onChange={(e) => handleConfigTaskExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times</option>
                    <option value="Georgia">Georgia</option>
                  </select>
                  <select onChange={(e) => handleConfigTaskExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                    <option value="5">18</option>
                  </select>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigTaskExec('foreColor', '#facc15'); }} className="w-6 h-6 flex items-center justify-center text-yellow-400 font-bold text-sm hover:bg-gray-100 rounded border border-gray-200">A</button>
                  <span className="text-gray-300">|</span>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigTaskExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center hover:bg-gray-100 rounded">&#8226;</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleConfigTaskExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center hover:bg-gray-100 rounded text-xs">1.</button>
                </div>
                <div ref={configTaskEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-2 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white" suppressContentEditableWarning dangerouslySetInnerHTML={{ __html: configTaskForm.remarks }} />
              </div>
              <div className="flex justify-center mt-4">
                <button onClick={handleSaveConfigTask} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Training Form ==============
function TrainingForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [trainingSubTab, setTrainingSubTab] = useState('details');
  const trainingSubTabs = ['Details', 'Mapping', 'Schedule', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [trainingFormData, setTrainingFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [trainingContacts, setTrainingContacts] = useState<any[]>([]);
  const [trainingEmailTemplates, setTrainingEmailTemplates] = useState<any[]>([]);
  const [trainingDocs, setTrainingDocs] = useState<any[]>([]);
  const [trainingFile, setTrainingFile] = useState<File | null>(null);
  const [trainingUploading, setTrainingUploading] = useState(false);
  const trainingFileRef = React.useRef<HTMLInputElement>(null);
  const [trainingEmailSentList, setTrainingEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [trainingCustomerForm, setTrainingCustomerForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [trainingAxieverForm, setTrainingAxieverForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [trainingEmployees, setTrainingEmployees] = useState<any[]>([
    { id: 1, employee_name: '', department: '', email: '', phone: '', employee_role: '', module_training: '' }
  ]);

  // Mapping sub-tab state
  const [trainingMappings, setTrainingMappings] = useState<any[]>([]);

  // Schedule sub-tab state
  const [trainingSchedules, setTrainingSchedules] = useState<any[]>([
    { id: 1, date: '', session: '', start_time: '17:05', end_time: '17:05', hours: '', module: '', sub_module: '', employee_name: '', trainer: '' }
  ]);
  const [showTrainingScheduleModal, setShowTrainingScheduleModal] = useState(false);
  const [editingTrainingSchedule, setEditingTrainingSchedule] = useState<any>(null);
  const [trainingScheduleForm, setTrainingScheduleForm] = useState({
    training_topic: '', trainer: '', start_date: '', start_time: '', end_date: '', end_time: '', location: '', status: 'Scheduled', notes: ''
  });

  // Follow-up state
  const [trainingFollowUps, setTrainingFollowUps] = useState<any[]>([]);
  const [showTrainingFollowUpModal, setShowTrainingFollowUpModal] = useState(false);
  const [editingTrainingFollowUp, setEditingTrainingFollowUp] = useState<any>(null);
  const [trainingFollowUpForm, setTrainingFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: ''
  });
  const trainingFollowUpEditorRef = React.useRef<HTMLDivElement>(null);

  // Memo state
  const [trainingMemos, setTrainingMemos] = useState<any[]>([]);
  const [showTrainingMemoModal, setShowTrainingMemoModal] = useState(false);
  const [editingTrainingMemo, setEditingTrainingMemo] = useState<any>(null);
  const trainingMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [trainingSubTabDocs, setTrainingSubTabDocs] = useState<any[]>([]);
  const [trainingSubTabFile, setTrainingSubTabFile] = useState<File | null>(null);
  const [trainingSubTabNotes, setTrainingSubTabNotes] = useState('');
  const [trainingSubTabUploading, setTrainingSubTabUploading] = useState(false);
  const trainingSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Fetch data
  useEffect(() => {
    if (crId) {
      fetchTrainingContacts();
      fetchTrainingDocs();
      fetchTrainingFollowUps();
      fetchTrainingMemos();
      fetchTrainingSubTabDocs();
    }
  }, [crId]);

  // Load email templates for Training tab
  useEffect(() => {
    api.getCRIEmailTemplates('training').then(setTrainingEmailTemplates).catch(() => setTrainingEmailTemplates([]));
  }, []);

  const fetchTrainingContacts = async () => {
    try { const res = await api.getLeadContactsForEdit(leadId); setTrainingContacts(res); } catch (err) { console.error('Failed to fetch contacts:', err); }
  };
  const fetchTrainingDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'training'); setTrainingDocs(res); } catch (err) { console.error('Failed to fetch docs:', err); }
  };
  const fetchTrainingFollowUps = async () => {
    try { const res = await api.getCRActivities(crId, 'training-followup'); setTrainingFollowUps(res); } catch (err) { console.error('Failed to fetch follow-ups:', err); }
  };
  const fetchTrainingMemos = async () => {
    try { const res = await api.getCRMemos(crId, 'training-memo'); setTrainingMemos(res); } catch (err) { console.error('Failed to fetch memos:', err); }
  };
  const fetchTrainingSubTabDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'training-upload'); setTrainingSubTabDocs(res); } catch (err) { console.error('Failed to fetch upload docs:', err); }
  };

  // File handlers
  const handleTrainingChooseFile = () => trainingFileRef.current?.click();
  const handleTrainingFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setTrainingFile(e.target.files[0]);
  };
  const handleTrainingUploadFile = async () => {
    if (!crId || !trainingFile) return;
    setTrainingUploading(true);
    try {
      await api.uploadCRDocument(crId, trainingFile, 'training', 'Training Document');
      fetchTrainingDocs();
      setTrainingFile(null);
      if (trainingFileRef.current) trainingFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setTrainingUploading(false); }
  };
  const handleTrainingDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchTrainingDocs(); } catch { alert('Failed to delete'); }
  };

  // Follow-up handlers
  const handleTrainingFollowUpExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveTrainingFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = trainingFollowUpEditorRef.current?.innerHTML || '';
    const formToSave = { ...trainingFollowUpForm, description: descriptionContent };
    try {
      if (editingTrainingFollowUp) {
        await api.updateCRActivity(crId, editingTrainingFollowUp.id, { ...formToSave, activity_category: 'training-followup' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'training-followup' });
      }
      fetchTrainingFollowUps();
      setShowTrainingFollowUpModal(false);
      setEditingTrainingFollowUp(null);
      setTrainingFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' });
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteTrainingFollowUp = async (id: number) => {
    if (!crId || !confirm('Delete this follow-up?')) return;
    try { await api.deleteCRActivity(crId, id); fetchTrainingFollowUps(); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleTrainingMemoExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveTrainingMemo = async () => {
    if (!crId) return;
    const content = trainingMemoEditorRef.current?.innerHTML || '';
    try {
      if (editingTrainingMemo) {
        await api.updateCRMemo(crId, editingTrainingMemo.id, { content, memo_category: 'training-memo' });
      } else {
        await api.createCRMemo(crId, { content, memo_category: 'training-memo' });
      }
      fetchTrainingMemos();
      setShowTrainingMemoModal(false);
      setEditingTrainingMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteTrainingMemo = async (id: number) => {
    if (!crId || !confirm('Delete this memo?')) return;
    try { await api.deleteCRMemo(crId, id); fetchTrainingMemos(); } catch { alert('Failed to delete'); }
  };

  // Employee handlers
  const handleAddEmployee = () => {
    const newId = Math.max(...trainingEmployees.map(e => e.id), 0) + 1;
    setTrainingEmployees(prev => [...prev, { id: newId, employee_name: '', department: '', email: '', phone: '', employee_role: '', module_training: '' }]);
  };
  const handleDeleteEmployee = (employeeId: number) => {
    if (!confirm('Delete this employee?')) return;
    setTrainingEmployees(prev => prev.filter(e => e.id !== employeeId));
  };
  const handleEmployeeChange = (id: number, field: string, value: string) => {
    setTrainingEmployees(prev => prev.map(e => e.id === id ? { ...e, [field]: value } : e));
  };

  // Upload sub-tab handlers
  const handleTrainingSubTabChooseFile = () => trainingSubTabFileRef.current?.click();
  const handleTrainingSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setTrainingSubTabFile(e.target.files[0]);
  };
  const handleTrainingSubTabUpload = async () => {
    if (!crId || !trainingSubTabFile) return;
    setTrainingSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, trainingSubTabFile, 'training-upload', 'Upload File');
      fetchTrainingSubTabDocs();
      setTrainingSubTabFile(null);
      setTrainingSubTabNotes('');
      if (trainingSubTabFileRef.current) trainingSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload'); } finally { setTrainingSubTabUploading(false); }
  };
  const handleTrainingSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchTrainingSubTabDocs(); } catch { alert('Failed to delete'); }
  };

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={trainingFormData.company_name} onChange={(e) => setTrainingFormData({ ...trainingFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={trainingFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = trainingContacts.find((c: any) => c.id?.toString() === cid); setTrainingFormData({ ...trainingFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {trainingContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={trainingFormData.email_format_type} onChange={(e) => setTrainingFormData({ ...trainingFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {trainingEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Training', trainingFormData.contact_email, trainingEmailTemplates.find((t: any) => t.email_format === trainingFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {trainingEmailSentList.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  trainingEmailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={trainingFormData.branch_office} onChange={(e) => setTrainingFormData({ ...trainingFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={trainingFormData.contact_email} onChange={(e) => setTrainingFormData({ ...trainingFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={trainingFileRef} onChange={handleTrainingFileChange} className="hidden" />
            <button onClick={handleTrainingChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleTrainingUploadFile} disabled={!trainingFile || trainingUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{trainingUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {trainingDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  trainingDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handleTrainingDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {trainingSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setTrainingSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${trainingSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {trainingSubTab === 'details' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" value={trainingCustomerForm.coordinator} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={trainingCustomerForm.email} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={trainingCustomerForm.phone} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" value={trainingAxieverForm.coordinator} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={trainingAxieverForm.email} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={trainingAxieverForm.phone} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Employee Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Employee Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Department</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Email</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Phone</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Employee Role</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Module / Sub-Module Training</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {trainingEmployees.map((emp, index) => (
                  <tr key={emp.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.employee_name} onChange={(e) => handleEmployeeChange(emp.id, 'employee_name', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.department} onChange={(e) => handleEmployeeChange(emp.id, 'department', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="email" value={emp.email} onChange={(e) => handleEmployeeChange(emp.id, 'email', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.phone} onChange={(e) => handleEmployeeChange(emp.id, 'phone', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.employee_role} onChange={(e) => handleEmployeeChange(emp.id, 'employee_role', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.module_training} onChange={(e) => handleEmployeeChange(emp.id, 'module_training', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200 text-center">
                      <div className="flex gap-1 justify-center">
                        <button onClick={handleAddEmployee} className="p-1 text-green-600 hover:bg-green-50 rounded border border-gray-300"><Plus className="w-3 h-3" /></button>
                        <button onClick={() => handleDeleteEmployee(emp.id)} className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Mapping Sub-tab */}
      {trainingSubTab === 'mapping' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" value={trainingCustomerForm.coordinator} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={trainingCustomerForm.email} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={trainingCustomerForm.phone} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" value={trainingAxieverForm.coordinator} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={trainingAxieverForm.email} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={trainingAxieverForm.phone} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Mapping Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Module / Sub-Module Training</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Employee Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Department</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Employee Role</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-20">Days</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-28">Date</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-20">Action</th>
                </tr>
              </thead>
              <tbody>
                {trainingMappings.length === 0 ? (
                  <tr><td colSpan={7} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  trainingMappings.map((mapping: any, index: number) => (
                    <tr key={mapping.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{mapping.module_training || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{mapping.employee_name || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{mapping.department || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{mapping.employee_role || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{mapping.days || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{mapping.date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Schedule Sub-tab */}
      {trainingSubTab === 'schedule' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" value={trainingCustomerForm.coordinator} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={trainingCustomerForm.email} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={trainingCustomerForm.phone} onChange={(e) => setTrainingCustomerForm({ ...trainingCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Training Coordinator</label>
                  <input type="text" value={trainingAxieverForm.coordinator} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={trainingAxieverForm.email} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={trainingAxieverForm.phone} onChange={(e) => setTrainingAxieverForm({ ...trainingAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Schedule Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full table-fixed">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[10%]">Session</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[9%]">Start Time</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[9%]">End Time</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[6%]">Hours</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[12%]">Module</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[12%]">Sub-Module</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[14%]">Employee Name</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[12%]">Trainer</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white w-[8%]">Action</th>
                </tr>
              </thead>
              <tbody>
                {trainingSchedules.map((schedule: any, index: number) => (
                  <tr key={schedule.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="date" value={schedule.date || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, date: e.target.value } : s); setTrainingSchedules(updated); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={schedule.session || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, session: e.target.value } : s); setTrainingSchedules(updated); }} placeholder="Session" className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="time" value={schedule.start_time || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, start_time: e.target.value } : s); setTrainingSchedules(updated); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="time" value={schedule.end_time || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, end_time: e.target.value } : s); setTrainingSchedules(updated); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" value={schedule.hours || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, hours: e.target.value } : s); setTrainingSchedules(updated); }} placeholder="Hours" className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={schedule.module || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, module: e.target.value } : s); setTrainingSchedules(updated); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Module</option>
                        <option value="Sales">Sales</option>
                        <option value="Inventory">Inventory</option>
                        <option value="Finance">Finance</option>
                        <option value="HR">HR</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={schedule.sub_module || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, sub_module: e.target.value } : s); setTrainingSchedules(updated); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Sub-Module</option>
                        <option value="Orders">Orders</option>
                        <option value="Reports">Reports</option>
                        <option value="Settings">Settings</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={schedule.employee_name || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, employee_name: e.target.value } : s); setTrainingSchedules(updated); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Employee</option>
                        {trainingEmployees.map((emp: any) => (
                          <option key={emp.id} value={emp.employee_name}>{emp.employee_name || `Employee ${emp.id}`}</option>
                        ))}
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select value={schedule.trainer || ''} onChange={(e) => { const updated = trainingSchedules.map((s: any) => s.id === schedule.id ? { ...s, trainer: e.target.value } : s); setTrainingSchedules(updated); }} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Training By</option>
                        <option value="Admin User">Admin User</option>
                        <option value="Project Manager">Project Manager</option>
                        <option value="Trainer 1">Trainer 1</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200 text-center">
                      <div className="flex gap-1 justify-center">
                        <button onClick={() => { const newId = Math.max(...trainingSchedules.map((s: any) => s.id), 0) + 1; setTrainingSchedules([...trainingSchedules, { id: newId, date: '', session: '', start_time: '', end_time: '', hours: '', module: '', sub_module: '', employee_name: '', trainer: '' }]); }} className="p-1 text-green-600 hover:bg-green-50 rounded border border-gray-300"><Plus className="w-3 h-3" /></button>
                        <button onClick={() => { if (trainingSchedules.length > 1) setTrainingSchedules(trainingSchedules.filter((s: any) => s.id !== schedule.id)); }} className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                ))}
                {trainingSchedules.length === 0 && (
                  <tr className="bg-white">
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="date" className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" placeholder="Session" className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="time" defaultValue="17:05" className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="time" defaultValue="17:05" className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <input type="text" placeholder="Hours" className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Module</option>
                        <option value="Sales">Sales</option>
                        <option value="Inventory">Inventory</option>
                        <option value="Finance">Finance</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Sub-Module</option>
                        <option value="Orders">Orders</option>
                        <option value="Reports">Reports</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Employee</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200">
                      <select className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">Training By</option>
                      </select>
                    </td>
                    <td className="px-1 py-1.5 border-b border-gray-200 text-center">
                      <div className="flex gap-1 justify-center">
                        <button onClick={() => { setTrainingSchedules([{ id: 1, date: '', session: '', start_time: '17:05', end_time: '17:05', hours: '', module: '', sub_module: '', employee_name: '', trainer: '' }]); }} className="p-1 text-green-600 hover:bg-green-50 rounded border border-gray-300"><Plus className="w-3 h-3" /></button>
                        <button className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {trainingSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowTrainingFollowUpModal(true); setEditingTrainingFollowUp(null); setTrainingFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' }); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {trainingFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  trainingFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingTrainingFollowUp(activity); setTrainingFollowUpForm(activity); setShowTrainingFollowUpModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteTrainingFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {trainingSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowTrainingMemoModal(true); setEditingTrainingMemo(null); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {trainingMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  trainingMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingTrainingMemo(memo); setShowTrainingMemoModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteTrainingMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {trainingSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={trainingSubTabFile?.name || ''} />
            <input ref={trainingSubTabFileRef} type="file" onChange={handleTrainingSubTabFileChange} className="hidden" />
            <button onClick={handleTrainingSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handleTrainingSubTabUpload} disabled={!trainingSubTabFile || trainingSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{trainingSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={trainingSubTabNotes} onChange={(e) => setTrainingSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {trainingSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  trainingSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleTrainingSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {trainingSubTab === 'workflow--audit-trail' && (
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-600">
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-28">Date</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-32">User</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-24">Action</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white">Details</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
            </tbody>
          </table>
        </div>
      )}

      {/* Follow-Up Modal */}
      {showTrainingFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button className="px-3 py-1 text-xs font-medium text-white bg-blue-800 rounded hover:bg-blue-900">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowTrainingFollowUpModal(false); setEditingTrainingFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={trainingFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = trainingContacts.find((c: any) => c.id?.toString() === cid); setTrainingFollowUpForm({ ...trainingFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Contact</option>
                    {trainingContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={trainingFollowUpForm.subject} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={trainingFollowUpForm.sent_to} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={trainingFollowUpForm.activity_type} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={trainingFollowUpForm.start_date} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={trainingFollowUpForm.start_time} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={trainingFollowUpForm.assigned_to} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    {trainingContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={trainingFollowUpForm.next_followup_date} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={trainingFollowUpForm.status} onChange={(e) => setTrainingFollowUpForm({ ...trainingFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingFollowUpExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingFollowUpExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingFollowUpExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingFollowUpExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                  </button>
                  <select onChange={(e) => handleTrainingFollowUpExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                  </select>
                  <select onChange={(e) => handleTrainingFollowUpExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="1">10</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                    <option value="5">18</option>
                    <option value="6">24</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                    <input type="color" onChange={(e) => handleTrainingFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                  </div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingFollowUpExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingFollowUpExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingFollowUpExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                  </button>
                </div>
                <div ref={trainingFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveTrainingFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showTrainingMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowTrainingMemoModal(false); setEditingTrainingMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingMemoExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingMemoExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingMemoExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingMemoExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                </button>
                <select onChange={(e) => handleTrainingMemoExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                </select>
                <select onChange={(e) => handleTrainingMemoExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="3">14</option>
                  <option value="1">10</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                  <option value="5">18</option>
                  <option value="6">24</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                  <input type="color" onChange={(e) => handleTrainingMemoExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                </div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingMemoExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingMemoExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleTrainingMemoExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                </button>
              </div>
              <div ref={trainingMemoEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSaveTrainingMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}

      {/* Schedule Modal */}
      {showTrainingScheduleModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">TRAINING SCHEDULE</h3>
              <button onClick={() => { setShowTrainingScheduleModal(false); setEditingTrainingSchedule(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5 space-y-3">
              <div>
                <label className="text-xs font-medium text-blue-600 block mb-1">Training Topic</label>
                <input value={trainingScheduleForm.training_topic} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, training_topic: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
              <div>
                <label className="text-xs font-medium text-blue-600 block mb-1">Trainer</label>
                <select value={trainingScheduleForm.trainer} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, trainer: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                  <option value="">Select Trainer</option>
                  {trainingContacts.map((c: any) => <option key={c.id} value={`${c.first_name || ''} ${c.last_name || ''}`.trim()}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                </select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={trainingScheduleForm.start_date} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={trainingScheduleForm.start_time} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, start_time: e.target.value })} className="w-24 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">End Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={trainingScheduleForm.end_date} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, end_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={trainingScheduleForm.end_time} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, end_time: e.target.value })} className="w-24 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
              </div>
              <div>
                <label className="text-xs font-medium text-blue-600 block mb-1">Location</label>
                <input value={trainingScheduleForm.location} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, location: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
              <div>
                <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                <select value={trainingScheduleForm.status} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                  <option value="Scheduled">Scheduled</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
              <div>
                <label className="text-xs font-medium text-blue-600 block mb-1">Notes</label>
                <textarea value={trainingScheduleForm.notes} onChange={(e) => setTrainingScheduleForm({ ...trainingScheduleForm, notes: e.target.value })} className="w-full h-20 px-2 py-1 text-sm border border-gray-300 rounded bg-gray-50" />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={() => { setShowTrainingScheduleModal(false); }} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== UAT Form ==============
function UATForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [uatSubTab, setUatSubTab] = useState('details');
  const uatSubTabs = ['Details', 'Result', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [uatFormData, setUatFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [uatContacts, setUatContacts] = useState<any[]>([]);
  const [uatEmailTemplates, setUatEmailTemplates] = useState<any[]>([]);
  const [uatDocs, setUatDocs] = useState<any[]>([]);
  const [uatFile, setUatFile] = useState<File | null>(null);
  const [uatUploading, setUatUploading] = useState(false);
  const uatFileRef = React.useRef<HTMLInputElement>(null);
  const [uatEmailSentList, setUatEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [uatCustomerForm, setUatCustomerForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [uatAxieverForm, setUatAxieverForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [uatEmployees, setUatEmployees] = useState<any[]>([
    { id: 1, employee_name: '', department: '', employee_role: '', module_training: '', uat_process_sheet: '' }
  ]);

  // Result sub-tab state
  const [uatResults, setUatResults] = useState<any[]>([]);

  // Follow-up state
  const [uatFollowUps, setUatFollowUps] = useState<any[]>([]);
  const [showUatFollowUpModal, setShowUatFollowUpModal] = useState(false);
  const [editingUatFollowUp, setEditingUatFollowUp] = useState<any>(null);
  const [uatFollowUpForm, setUatFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: ''
  });
  const uatFollowUpEditorRef = React.useRef<HTMLDivElement>(null);

  // Memo state
  const [uatMemos, setUatMemos] = useState<any[]>([]);
  const [showUatMemoModal, setShowUatMemoModal] = useState(false);
  const [editingUatMemo, setEditingUatMemo] = useState<any>(null);
  const uatMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [uatSubTabDocs, setUatSubTabDocs] = useState<any[]>([]);
  const [uatSubTabFile, setUatSubTabFile] = useState<File | null>(null);
  const [uatSubTabNotes, setUatSubTabNotes] = useState('');
  const [uatSubTabUploading, setUatSubTabUploading] = useState(false);
  const uatSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Fetch data
  useEffect(() => {
    if (crId) {
      fetchUatContacts();
      fetchUatDocs();
      fetchUatFollowUps();
      fetchUatMemos();
      fetchUatSubTabDocs();
    }
  }, [crId]);

  // Load email templates for UAT tab
  useEffect(() => {
    api.getCRIEmailTemplates('UAT').then(setUatEmailTemplates).catch(() => setUatEmailTemplates([]));
  }, []);

  const fetchUatContacts = async () => {
    try { const res = await api.getLeadContactsForEdit(leadId); setUatContacts(res); } catch (err) { console.error('Failed to fetch contacts:', err); }
  };
  const fetchUatDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'uat'); setUatDocs(res); } catch (err) { console.error('Failed to fetch docs:', err); }
  };
  const fetchUatFollowUps = async () => {
    try { const res = await api.getCRActivities(crId, 'uat-followup'); setUatFollowUps(res); } catch (err) { console.error('Failed to fetch follow-ups:', err); }
  };
  const fetchUatMemos = async () => {
    try { const res = await api.getCRMemos(crId, 'uat-memo'); setUatMemos(res); } catch (err) { console.error('Failed to fetch memos:', err); }
  };
  const fetchUatSubTabDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'uat-upload'); setUatSubTabDocs(res); } catch (err) { console.error('Failed to fetch upload docs:', err); }
  };

  // File handlers
  const handleUatChooseFile = () => uatFileRef.current?.click();
  const handleUatFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setUatFile(e.target.files[0]);
  };
  const handleUatUploadFile = async () => {
    if (!crId || !uatFile) return;
    setUatUploading(true);
    try {
      await api.uploadCRDocument(crId, uatFile, 'uat', 'UAT Document');
      fetchUatDocs();
      setUatFile(null);
      if (uatFileRef.current) uatFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setUatUploading(false); }
  };
  const handleUatDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchUatDocs(); } catch { alert('Failed to delete'); }
  };

  // Follow-up handlers
  const handleUatFollowUpExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveUatFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = uatFollowUpEditorRef.current?.innerHTML || '';
    const formToSave = { ...uatFollowUpForm, description: descriptionContent };
    try {
      if (editingUatFollowUp) {
        await api.updateCRActivity(crId, editingUatFollowUp.id, { ...formToSave, activity_category: 'uat-followup' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'uat-followup' });
      }
      fetchUatFollowUps();
      setShowUatFollowUpModal(false);
      setEditingUatFollowUp(null);
      setUatFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' });
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteUatFollowUp = async (id: number) => {
    if (!crId || !confirm('Delete this follow-up?')) return;
    try { await api.deleteCRActivity(crId, id); fetchUatFollowUps(); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleUatMemoExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveUatMemo = async () => {
    if (!crId) return;
    const content = uatMemoEditorRef.current?.innerHTML || '';
    try {
      if (editingUatMemo) {
        await api.updateCRMemo(crId, editingUatMemo.id, { content, memo_category: 'uat-memo' });
      } else {
        await api.createCRMemo(crId, { content, memo_category: 'uat-memo' });
      }
      fetchUatMemos();
      setShowUatMemoModal(false);
      setEditingUatMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteUatMemo = async (id: number) => {
    if (!crId || !confirm('Delete this memo?')) return;
    try { await api.deleteCRMemo(crId, id); fetchUatMemos(); } catch { alert('Failed to delete'); }
  };

  // Employee handlers
  const handleAddUatEmployee = () => {
    const newId = Math.max(...uatEmployees.map(e => e.id), 0) + 1;
    setUatEmployees(prev => [...prev, { id: newId, employee_name: '', department: '', employee_role: '', module_training: '', uat_process_sheet: '' }]);
  };
  const handleDeleteUatEmployee = (employeeId: number) => {
    if (!confirm('Delete this employee?')) return;
    setUatEmployees(prev => prev.filter(e => e.id !== employeeId));
  };
  const handleUatEmployeeChange = (id: number, field: string, value: string) => {
    setUatEmployees(prev => prev.map(e => e.id === id ? { ...e, [field]: value } : e));
  };

  // Upload sub-tab handlers
  const handleUatSubTabChooseFile = () => uatSubTabFileRef.current?.click();
  const handleUatSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setUatSubTabFile(e.target.files[0]);
  };
  const handleUatSubTabUpload = async () => {
    if (!crId || !uatSubTabFile) return;
    setUatSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, uatSubTabFile, 'uat-upload', 'Upload File');
      fetchUatSubTabDocs();
      setUatSubTabFile(null);
      setUatSubTabNotes('');
      if (uatSubTabFileRef.current) uatSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload'); } finally { setUatSubTabUploading(false); }
  };
  const handleUatSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchUatSubTabDocs(); } catch { alert('Failed to delete'); }
  };

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={uatFormData.company_name} onChange={(e) => setUatFormData({ ...uatFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={uatFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = uatContacts.find((c: any) => c.id?.toString() === cid); setUatFormData({ ...uatFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {uatContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={uatFormData.email_format_type} onChange={(e) => setUatFormData({ ...uatFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {uatEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('UAT', uatFormData.contact_email, uatEmailTemplates.find((t: any) => t.email_format === uatFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {uatEmailSentList.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  uatEmailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={uatFormData.branch_office} onChange={(e) => setUatFormData({ ...uatFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={uatFormData.contact_email} onChange={(e) => setUatFormData({ ...uatFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={uatFileRef} onChange={handleUatFileChange} className="hidden" />
            <button onClick={handleUatChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleUatUploadFile} disabled={!uatFile || uatUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{uatUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {uatDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  uatDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handleUatDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {uatSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setUatSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${uatSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {uatSubTab === 'details' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">UAT Coordinator</label>
                  <input type="text" value={uatCustomerForm.coordinator} onChange={(e) => setUatCustomerForm({ ...uatCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={uatCustomerForm.email} onChange={(e) => setUatCustomerForm({ ...uatCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={uatCustomerForm.phone} onChange={(e) => setUatCustomerForm({ ...uatCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">UAT Coordinator</label>
                  <input type="text" value={uatAxieverForm.coordinator} onChange={(e) => setUatAxieverForm({ ...uatAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={uatAxieverForm.email} onChange={(e) => setUatAxieverForm({ ...uatAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-44 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={uatAxieverForm.phone} onChange={(e) => setUatAxieverForm({ ...uatAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Employee Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Employee Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Department</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Employee Role</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Module / Sub-Module Training</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">UAT Process Sheet</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {uatEmployees.map((emp, index) => (
                  <tr key={emp.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.employee_name} onChange={(e) => handleUatEmployeeChange(emp.id, 'employee_name', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.department} onChange={(e) => handleUatEmployeeChange(emp.id, 'department', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.employee_role} onChange={(e) => handleUatEmployeeChange(emp.id, 'employee_role', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.module_training} onChange={(e) => handleUatEmployeeChange(emp.id, 'module_training', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200">
                      <input type="text" value={emp.uat_process_sheet} onChange={(e) => handleUatEmployeeChange(emp.id, 'uat_process_sheet', e.target.value)} className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    </td>
                    <td className="px-2 py-1.5 border-b border-gray-200 text-center">
                      <div className="flex gap-1 justify-center">
                        <button onClick={handleAddUatEmployee} className="p-1 text-green-600 hover:bg-green-50 rounded border border-gray-300"><Plus className="w-3 h-3" /></button>
                        <button onClick={() => handleDeleteUatEmployee(emp.id)} className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Result Sub-tab */}
      {uatSubTab === 'result' && (
        <div className="space-y-4">
          {/* Filter Section - Two Columns */}
          <div className="grid grid-cols-2 gap-x-8">
            <div className="flex items-center">
              <label className="w-32 text-xs font-medium text-blue-600">Employee Name</label>
              <select className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Contact Name</option>
                {uatEmployees.map((emp: any) => (
                  <option key={emp.id} value={emp.employee_name}>{emp.employee_name || `Employee ${emp.id}`}</option>
                ))}
              </select>
            </div>
            <div className="flex items-center">
              <label className="w-32 text-xs font-medium text-blue-600">Module</label>
              <select className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Contact Name</option>
                <option value="Sales">Sales</option>
                <option value="Inventory">Inventory</option>
                <option value="Finance">Finance</option>
                <option value="HR">HR</option>
              </select>
            </div>
          </div>

          {/* Result Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full table-fixed">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Test Case Id</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[10%]">Module</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[14%]">Description</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Setup No.</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[10%]">Test Setup</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Action</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[18%]">Expected Result</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Status</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white w-[16%]">Remarks</th>
                </tr>
              </thead>
              <tbody>
                {uatResults.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  uatResults.map((result: any, index: number) => (
                    <tr key={result.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-2 py-2 text-xs border-b border-gray-200 text-blue-600">{result.test_case_id || '-'}</td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200">{result.module || '-'}</td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{result.description || '-'}</td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200">{result.setup_no || '-'}</td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200">{result.test_setup || '-'}</td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200">{result.action || '-'}</td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{result.expected_result || '-'}</td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${result.status === 'Pass' ? 'bg-green-100 text-green-700' : result.status === 'Fail' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}`}>{result.status || '-'}</span></td>
                      <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{result.remarks || '-'}</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {uatSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowUatFollowUpModal(true); setEditingUatFollowUp(null); setUatFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' }); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {uatFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  uatFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingUatFollowUp(activity); setUatFollowUpForm(activity); setShowUatFollowUpModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteUatFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {uatSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowUatMemoModal(true); setEditingUatMemo(null); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {uatMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  uatMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingUatMemo(memo); setShowUatMemoModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteUatMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {uatSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={uatSubTabFile?.name || ''} />
            <input ref={uatSubTabFileRef} type="file" onChange={handleUatSubTabFileChange} className="hidden" />
            <button onClick={handleUatSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handleUatSubTabUpload} disabled={!uatSubTabFile || uatSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{uatSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={uatSubTabNotes} onChange={(e) => setUatSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {uatSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  uatSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleUatSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {uatSubTab === 'workflow--audit-trail' && (
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-600">
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-28">Date</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-32">User</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-24">Action</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white">Details</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
            </tbody>
          </table>
        </div>
      )}

      {/* Follow-Up Modal */}
      {showUatFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button className="px-3 py-1 text-xs font-medium text-white bg-blue-800 rounded hover:bg-blue-900">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowUatFollowUpModal(false); setEditingUatFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={uatFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = uatContacts.find((c: any) => c.id?.toString() === cid); setUatFollowUpForm({ ...uatFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Contact</option>
                    {uatContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={uatFollowUpForm.subject} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={uatFollowUpForm.sent_to} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={uatFollowUpForm.activity_type} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={uatFollowUpForm.start_date} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={uatFollowUpForm.start_time} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={uatFollowUpForm.assigned_to} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    {uatContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={uatFollowUpForm.next_followup_date} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={uatFollowUpForm.status} onChange={(e) => setUatFollowUpForm({ ...uatFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatFollowUpExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatFollowUpExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatFollowUpExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatFollowUpExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                  </button>
                  <select onChange={(e) => handleUatFollowUpExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                  </select>
                  <select onChange={(e) => handleUatFollowUpExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="1">10</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                    <option value="5">18</option>
                    <option value="6">24</option>
                  </select>
                  <div className="relative">
                    <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                    <input type="color" onChange={(e) => handleUatFollowUpExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                  </div>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatFollowUpExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatFollowUpExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatFollowUpExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                  </button>
                </div>
                <div ref={uatFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveUatFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showUatMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowUatMemoModal(false); setEditingUatMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatMemoExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatMemoExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatMemoExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatMemoExec('strikeThrough'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                </button>
                <select onChange={(e) => handleUatMemoExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                </select>
                <select onChange={(e) => handleUatMemoExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="3">14</option>
                  <option value="1">10</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                  <option value="5">18</option>
                  <option value="6">24</option>
                </select>
                <div className="relative">
                  <button type="button" className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded font-bold"><span className="bg-yellow-300 px-1">A</span></button>
                  <input type="color" onChange={(e) => handleUatMemoExec('foreColor', e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Font Color" />
                </div>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatMemoExec('insertUnorderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatMemoExec('insertOrderedList'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 6h13M7 12h13M7 18h13" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleUatMemoExec('indent'); }} className="w-6 h-6 flex items-center justify-center text-sm hover:bg-gray-100 rounded">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h8m-8 6h16" /></svg>
                </button>
              </div>
              <div ref={uatMemoEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSaveUatMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Data Migration Form ==============
function DataMigrationForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [dmSubTab, setDmSubTab] = useState('details');
  const dmSubTabs = ['Details', 'Summary', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [dmFormData, setDmFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [dmContacts, setDmContacts] = useState<any[]>([]);
  const [dmEmailTemplates, setDmEmailTemplates] = useState<any[]>([]);
  const [dmDocs, setDmDocs] = useState<any[]>([]);
  const [dmFile, setDmFile] = useState<File | null>(null);
  const [dmUploading, setDmUploading] = useState(false);
  const dmFileRef = React.useRef<HTMLInputElement>(null);
  const [dmEmailSentList, setDmEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [dmCustomerForm, setDmCustomerForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [dmAxieverForm, setDmAxieverForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [dmTasks, setDmTasks] = useState<any[]>([
    { id: 1, task: '', responsible: '', done_by: '', required_hours: '', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' }
  ]);

  // Summary sub-tab tasks
  const [dmSummaryTasks, setDmSummaryTasks] = useState<any[]>([
    { id: 1, task: 'Data Extraction', responsible: '', done_by: '', required_hours: '2:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 2, task: 'Data Cleansing', responsible: '', done_by: '', required_hours: '3:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 3, task: 'Data Transformation', responsible: '', done_by: '', required_hours: '2:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 4, task: 'Data Loading', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 5, task: 'Data Validation', responsible: '', done_by: '', required_hours: '2:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' }
  ]);

  // Task modal state
  const [showDmTaskModal, setShowDmTaskModal] = useState(false);
  const [editingDmTask, setEditingDmTask] = useState<any>(null);
  const [dmTaskForm, setDmTaskForm] = useState({
    task: '', responsible: '', done_by: '', required_hours: '', start_date: '', start_time: '', status: '', remarks: '',
    total_hours: '', difference: '', checked_by: '', date: '', end_date: '', end_time: ''
  });
  const dmTaskEditorRef = React.useRef<HTMLDivElement>(null);

  // Follow-up state
  const [dmFollowUps, setDmFollowUps] = useState<any[]>([]);
  const [showDmFollowUpModal, setShowDmFollowUpModal] = useState(false);
  const [editingDmFollowUp, setEditingDmFollowUp] = useState<any>(null);
  const [dmFollowUpForm, setDmFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: ''
  });
  const dmFollowUpEditorRef = React.useRef<HTMLDivElement>(null);

  // Memo state
  const [dmMemos, setDmMemos] = useState<any[]>([]);
  const [showDmMemoModal, setShowDmMemoModal] = useState(false);
  const [editingDmMemo, setEditingDmMemo] = useState<any>(null);
  const dmMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [dmSubTabDocs, setDmSubTabDocs] = useState<any[]>([]);
  const [dmSubTabFile, setDmSubTabFile] = useState<File | null>(null);
  const [dmSubTabNotes, setDmSubTabNotes] = useState('');
  const [dmSubTabUploading, setDmSubTabUploading] = useState(false);
  const dmSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Fetch data
  useEffect(() => {
    if (crId) {
      fetchDmContacts();
      fetchDmDocs();
      fetchDmFollowUps();
      fetchDmMemos();
      fetchDmSubTabDocs();
    }
  }, [crId]);

  // Load email templates for Data Migration tab
  useEffect(() => {
    api.getCRIEmailTemplates('Data Migration').then(setDmEmailTemplates).catch(() => setDmEmailTemplates([]));
  }, []);

  const fetchDmContacts = async () => {
    try { const res = await api.getLeadContactsForEdit(leadId); setDmContacts(res); } catch (err) { console.error('Failed to fetch contacts:', err); }
  };
  const fetchDmDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'data-migration'); setDmDocs(res); } catch (err) { console.error('Failed to fetch docs:', err); }
  };
  const fetchDmFollowUps = async () => {
    try { const res = await api.getCRActivities(crId, 'data-migration-followup'); setDmFollowUps(res); } catch (err) { console.error('Failed to fetch follow-ups:', err); }
  };
  const fetchDmMemos = async () => {
    try { const res = await api.getCRMemos(crId, 'data-migration-memo'); setDmMemos(res); } catch (err) { console.error('Failed to fetch memos:', err); }
  };
  const fetchDmSubTabDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'data-migration-upload'); setDmSubTabDocs(res); } catch (err) { console.error('Failed to fetch upload docs:', err); }
  };

  // File handlers
  const handleDmChooseFile = () => dmFileRef.current?.click();
  const handleDmFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setDmFile(e.target.files[0]);
  };
  const handleDmUploadFile = async () => {
    if (!crId || !dmFile) return;
    setDmUploading(true);
    try {
      await api.uploadCRDocument(crId, dmFile, 'data-migration', 'Data Migration Document');
      fetchDmDocs();
      setDmFile(null);
      if (dmFileRef.current) dmFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setDmUploading(false); }
  };
  const handleDmDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchDmDocs(); } catch { alert('Failed to delete'); }
  };

  // Task handlers
  const handleDmTaskExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleOpenDmTaskModal = (task?: any) => {
    if (task) {
      setEditingDmTask(task);
      setDmTaskForm({
        task: task.task || '', responsible: task.responsible || '', done_by: task.done_by || '', required_hours: task.required_hours || '',
        start_date: task.start_date || '', start_time: task.start_time || '', status: task.status || '', remarks: task.remarks || '',
        total_hours: task.total_hours || '', difference: task.difference || '', checked_by: task.checked_by || '', date: task.date || '',
        end_date: task.end_date || '', end_time: task.end_time || ''
      });
    } else {
      setEditingDmTask(null);
      setDmTaskForm({ task: '', responsible: '', done_by: '', required_hours: '', start_date: '', start_time: '', status: '', remarks: '', total_hours: '', difference: '', checked_by: '', date: '', end_date: '', end_time: '' });
    }
    setShowDmTaskModal(true);
  };
  const handleSaveDmTask = () => {
    const remarksContent = dmTaskEditorRef.current?.innerHTML || dmTaskForm.remarks;
    const taskData = {
      ...dmTaskForm, remarks: remarksContent,
      start_date_time: dmTaskForm.start_date ? `${dmTaskForm.start_date}${dmTaskForm.start_time ? ' ' + dmTaskForm.start_time : ''}` : '',
      end_date_time: dmTaskForm.end_date ? `${dmTaskForm.end_date}${dmTaskForm.end_time ? ' ' + dmTaskForm.end_time : ''}` : ''
    };
    if (editingDmTask) {
      setDmTasks(prev => prev.map(t => t.id === editingDmTask.id ? { ...t, ...taskData } : t));
    } else {
      const newId = Math.max(...dmTasks.map(t => t.id), 0) + 1;
      setDmTasks(prev => [...prev, { id: newId, ...taskData }]);
    }
    setShowDmTaskModal(false);
    setEditingDmTask(null);
  };
  const handleDeleteDmTask = (taskId: number) => {
    if (!confirm('Delete this task?')) return;
    setDmTasks(prev => prev.filter(t => t.id !== taskId));
  };

  // Follow-up handlers
  const handleDmFollowUpExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveDmFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = dmFollowUpEditorRef.current?.innerHTML || '';
    const formToSave = { ...dmFollowUpForm, description: descriptionContent };
    try {
      if (editingDmFollowUp) {
        await api.updateCRActivity(crId, editingDmFollowUp.id, { ...formToSave, activity_category: 'data-migration-followup' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'data-migration-followup' });
      }
      fetchDmFollowUps();
      setShowDmFollowUpModal(false);
      setEditingDmFollowUp(null);
      setDmFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' });
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteDmFollowUp = async (id: number) => {
    if (!crId || !confirm('Delete this follow-up?')) return;
    try { await api.deleteCRActivity(crId, id); fetchDmFollowUps(); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleDmMemoExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveDmMemo = async () => {
    if (!crId) return;
    const content = dmMemoEditorRef.current?.innerHTML || '';
    try {
      if (editingDmMemo) {
        await api.updateCRMemo(crId, editingDmMemo.id, { content, memo_category: 'data-migration-memo' });
      } else {
        await api.createCRMemo(crId, { content, memo_category: 'data-migration-memo' });
      }
      fetchDmMemos();
      setShowDmMemoModal(false);
      setEditingDmMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteDmMemo = async (id: number) => {
    if (!crId || !confirm('Delete this memo?')) return;
    try { await api.deleteCRMemo(crId, id); fetchDmMemos(); } catch { alert('Failed to delete'); }
  };

  // Upload sub-tab handlers
  const handleDmSubTabChooseFile = () => dmSubTabFileRef.current?.click();
  const handleDmSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setDmSubTabFile(e.target.files[0]);
  };
  const handleDmSubTabUpload = async () => {
    if (!crId || !dmSubTabFile) return;
    setDmSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, dmSubTabFile, 'data-migration-upload', 'Upload File');
      fetchDmSubTabDocs();
      setDmSubTabFile(null);
      setDmSubTabNotes('');
      if (dmSubTabFileRef.current) dmSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload'); } finally { setDmSubTabUploading(false); }
  };
  const handleDmSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchDmSubTabDocs(); } catch { alert('Failed to delete'); }
  };

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={dmFormData.company_name} onChange={(e) => setDmFormData({ ...dmFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={dmFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = dmContacts.find((c: any) => c.id?.toString() === cid); setDmFormData({ ...dmFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {dmContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={dmFormData.email_format_type} onChange={(e) => setDmFormData({ ...dmFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {dmEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Data Migration', dmFormData.contact_email, dmEmailTemplates.find((t: any) => t.email_format === dmFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {dmEmailSentList.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  dmEmailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={dmFormData.branch_office} onChange={(e) => setDmFormData({ ...dmFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={dmFormData.contact_email} onChange={(e) => setDmFormData({ ...dmFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={dmFileRef} onChange={handleDmFileChange} className="hidden" />
            <button onClick={handleDmChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleDmUploadFile} disabled={!dmFile || dmUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{dmUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {dmDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  dmDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handleDmDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {dmSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setDmSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${dmSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {dmSubTab === 'details' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Data Migration Coordinator</label>
                  <input type="text" value={dmCustomerForm.coordinator} onChange={(e) => setDmCustomerForm({ ...dmCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={dmCustomerForm.email} onChange={(e) => setDmCustomerForm({ ...dmCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={dmCustomerForm.phone} onChange={(e) => setDmCustomerForm({ ...dmCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Data Migration Coordinator</label>
                  <input type="text" value={dmAxieverForm.coordinator} onChange={(e) => setDmAxieverForm({ ...dmAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={dmAxieverForm.email} onChange={(e) => setDmAxieverForm({ ...dmAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={dmAxieverForm.phone} onChange={(e) => setDmAxieverForm({ ...dmAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Add New Task Button */}
          <div>
            <button onClick={() => handleOpenDmTaskModal()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Task</button>
          </div>

          {/* Task Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full table-fixed">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[12%]">Task</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Responsible</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[7%]">Done By</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[6%]">Req. Hrs</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Start Date/Time</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">End Date/Time</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[5%]">Total</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[5%]">Diff</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[7%]">Checked By</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[6%]">Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[10%]">Remarks</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[6%]">Status</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white w-[7%]">Action</th>
                </tr>
              </thead>
              <tbody>
                {dmTasks.map((task, index) => (
                  <tr key={task.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-blue-600 truncate">{task.task}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.responsible}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.done_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.required_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.start_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.end_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.total_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.difference}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.checked_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.date}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate"><div dangerouslySetInnerHTML={{ __html: task.remarks || '' }} /></td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.status}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">
                      <div className="flex gap-1 justify-center">
                        <button onClick={() => handleOpenDmTaskModal(task)} className="p-1 text-blue-600 hover:bg-blue-50 rounded border border-gray-300"><Edit2 className="w-3 h-3" /></button>
                        <button onClick={() => handleDeleteDmTask(task.id)} className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Summary Sub-tab */}
      {dmSubTab === 'summary' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Data Migration Coordinator</label>
                  <input type="text" value={dmCustomerForm.coordinator} onChange={(e) => setDmCustomerForm({ ...dmCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={dmCustomerForm.email} onChange={(e) => setDmCustomerForm({ ...dmCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={dmCustomerForm.phone} onChange={(e) => setDmCustomerForm({ ...dmCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-green-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Data Migration Coordinator</label>
                  <input type="text" value={dmAxieverForm.coordinator} onChange={(e) => setDmAxieverForm({ ...dmAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={dmAxieverForm.email} onChange={(e) => setDmAxieverForm({ ...dmAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={dmAxieverForm.phone} onChange={(e) => setDmAxieverForm({ ...dmAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Status Field */}
          <div className="flex items-center">
            <label className="w-20 text-xs font-medium text-blue-600">Status</label>
            <select className="flex-1 max-w-md h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Priority</option>
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="On Hold">On Hold</option>
            </select>
          </div>

          {/* Summary Task Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full table-fixed">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[12%]">Task</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[8%]">Responsible</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Done By</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[8%]">Required Hours</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[9%]">Start Date/Time</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[9%]">End Date/Time</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Total Hours</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Difference</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[8%]">Checked By</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[10%]">Remarks</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white w-[8%]">Status</th>
                </tr>
              </thead>
              <tbody>
                {dmSummaryTasks.map((task, index) => (
                  <tr key={task.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-blue-600 truncate">{task.task}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.responsible}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.done_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.required_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.start_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.end_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.total_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.difference}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.checked_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.date}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.remarks}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {dmSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowDmFollowUpModal(true); setEditingDmFollowUp(null); setDmFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' }); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {dmFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  dmFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingDmFollowUp(activity); setDmFollowUpForm(activity); setShowDmFollowUpModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteDmFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {dmSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowDmMemoModal(true); setEditingDmMemo(null); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {dmMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  dmMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingDmMemo(memo); setShowDmMemoModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteDmMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {dmSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={dmSubTabFile?.name || ''} />
            <input ref={dmSubTabFileRef} type="file" onChange={handleDmSubTabFileChange} className="hidden" />
            <button onClick={handleDmSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handleDmSubTabUpload} disabled={!dmSubTabFile || dmSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{dmSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={dmSubTabNotes} onChange={(e) => setDmSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {dmSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  dmSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleDmSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {dmSubTab === 'workflow--audit-trail' && (
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-600">
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-28">Date</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-32">User</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-24">Action</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white">Details</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
            </tbody>
          </table>
        </div>
      )}

      {/* Follow-Up Modal */}
      {showDmFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button className="px-3 py-1 text-xs font-medium text-white bg-blue-800 rounded hover:bg-blue-900">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowDmFollowUpModal(false); setEditingDmFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={dmFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = dmContacts.find((c: any) => c.id?.toString() === cid); setDmFollowUpForm({ ...dmFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Contact</option>
                    {dmContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={dmFollowUpForm.subject} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={dmFollowUpForm.sent_to} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={dmFollowUpForm.activity_type} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={dmFollowUpForm.start_date} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={dmFollowUpForm.start_time} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={dmFollowUpForm.assigned_to} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    {dmContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={dmFollowUpForm.next_followup_date} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={dmFollowUpForm.status} onChange={(e) => setDmFollowUpForm({ ...dmFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmFollowUpExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmFollowUpExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmFollowUpExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <select onChange={(e) => handleDmFollowUpExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                  </select>
                  <select onChange={(e) => handleDmFollowUpExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                  </select>
                </div>
                <div ref={dmFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveDmFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showDmMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowDmMemoModal(false); setEditingDmMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmMemoExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmMemoExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmMemoExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <select onChange={(e) => handleDmMemoExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                </select>
                <select onChange={(e) => handleDmMemoExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="3">14</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                </select>
              </div>
              <div ref={dmMemoEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSaveDmMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}

      {/* Task Modal */}
      {showDmTaskModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-4 py-3 bg-blue-600">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">NEW TASK</h3>
              <button onClick={() => { setShowDmTaskModal(false); setEditingDmTask(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-4">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Task</label>
                  <input type="text" value={dmTaskForm.task} onChange={(e) => setDmTaskForm({ ...dmTaskForm, task: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Total Hours</label>
                  <input type="text" value={dmTaskForm.total_hours} onChange={(e) => setDmTaskForm({ ...dmTaskForm, total_hours: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Responsible</label>
                  <select value={dmTaskForm.responsible} onChange={(e) => setDmTaskForm({ ...dmTaskForm, responsible: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Difference</label>
                  <input type="text" value={dmTaskForm.difference} onChange={(e) => setDmTaskForm({ ...dmTaskForm, difference: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Done By</label>
                  <select value={dmTaskForm.done_by} onChange={(e) => setDmTaskForm({ ...dmTaskForm, done_by: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Checked By</label>
                  <select value={dmTaskForm.checked_by} onChange={(e) => setDmTaskForm({ ...dmTaskForm, checked_by: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Required Hours</label>
                  <input type="text" value={dmTaskForm.required_hours} onChange={(e) => setDmTaskForm({ ...dmTaskForm, required_hours: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Date</label>
                  <input type="date" value={dmTaskForm.date} onChange={(e) => setDmTaskForm({ ...dmTaskForm, date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={dmTaskForm.start_date} onChange={(e) => setDmTaskForm({ ...dmTaskForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={dmTaskForm.start_time} onChange={(e) => setDmTaskForm({ ...dmTaskForm, start_time: e.target.value })} className="w-20 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">End Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={dmTaskForm.end_date} onChange={(e) => setDmTaskForm({ ...dmTaskForm, end_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={dmTaskForm.end_time} onChange={(e) => setDmTaskForm({ ...dmTaskForm, end_time: e.target.value })} className="w-20 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div className="col-span-2">
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={dmTaskForm.status} onChange={(e) => setDmTaskForm({ ...dmTaskForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Status</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Remarks</label>
                <div className="flex items-center gap-2 px-2 py-1.5 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmTaskExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmTaskExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleDmTaskExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                </div>
                <div ref={dmTaskEditorRef} contentEditable className="w-full min-h-[100px] max-h-[200px] overflow-y-auto px-2 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white" suppressContentEditableWarning dangerouslySetInnerHTML={{ __html: dmTaskForm.remarks }} />
              </div>
              <div className="flex justify-center mt-4">
                <button onClick={handleSaveDmTask} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Go Live Form ==============
function GoLiveForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [glSubTab, setGlSubTab] = useState('details');
  const glSubTabs = ['Details', 'Activity', 'Summary', 'Follow-Up', 'Memo', 'Upload File', 'Workflow & Audit Trail'];

  // Top section state
  const [glFormData, setGlFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [glContacts, setGlContacts] = useState<any[]>([]);
  const [glEmailTemplates, setGlEmailTemplates] = useState<any[]>([]);
  const [glDocs, setGlDocs] = useState<any[]>([]);
  const [glFile, setGlFile] = useState<File | null>(null);
  const [glUploading, setGlUploading] = useState(false);
  const glFileRef = React.useRef<HTMLInputElement>(null);
  const [glEmailSentList, setGlEmailSentList] = useState<any[]>([]);

  // Details sub-tab state
  const [glCustomerForm, setGlCustomerForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [glAxieverForm, setGlAxieverForm] = useState({
    coordinator: '', email: '', phone: ''
  });
  const [glTasks, setGlTasks] = useState<any[]>([
    { id: 1, task: '', responsible: '', done_by: '', required_hours: '', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' }
  ]);

  // Summary sub-tab state
  const [glSummaryStatus, setGlSummaryStatus] = useState('');
  const [glSummaryTasks, setGlSummaryTasks] = useState<any[]>([
    { id: 1, task: 'Pre Go-Live Check', responsible: '', done_by: '', required_hours: '2:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 2, task: 'System Deployment', responsible: '', done_by: '', required_hours: '4:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 3, task: 'Data Verification', responsible: '', done_by: '', required_hours: '2:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 4, task: 'User Access Setup', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' },
    { id: 5, task: 'Go-Live Sign-off', responsible: '', done_by: '', required_hours: '1:00:00', start_date_time: '', end_date_time: '', total_hours: '', difference: '', checked_by: '', date: '', remarks: '', status: '' }
  ]);

  // Task modal state
  const [showGlTaskModal, setShowGlTaskModal] = useState(false);
  const [editingGlTask, setEditingGlTask] = useState<any>(null);
  const [glTaskForm, setGlTaskForm] = useState({
    task: '', responsible: '', done_by: '', required_hours: '', start_date: '', start_time: '', status: '', remarks: '',
    total_hours: '', difference: '', checked_by: '', date: '', end_date: '', end_time: ''
  });
  const glTaskEditorRef = React.useRef<HTMLDivElement>(null);

  // Activity sub-tab state
  const [glActivities, setGlActivities] = useState<any[]>([]);
  const [showGlActivityModal, setShowGlActivityModal] = useState(false);
  const [editingGlActivity, setEditingGlActivity] = useState<any>(null);
  const [glActivityForm, setGlActivityForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: ''
  });
  const glActivityEditorRef = React.useRef<HTMLDivElement>(null);

  // Follow-up state
  const [glFollowUps, setGlFollowUps] = useState<any[]>([]);
  const [showGlFollowUpModal, setShowGlFollowUpModal] = useState(false);
  const [editingGlFollowUp, setEditingGlFollowUp] = useState<any>(null);
  const [glFollowUpForm, setGlFollowUpForm] = useState({
    activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: ''
  });
  const glFollowUpEditorRef = React.useRef<HTMLDivElement>(null);

  // Memo state
  const [glMemos, setGlMemos] = useState<any[]>([]);
  const [showGlMemoModal, setShowGlMemoModal] = useState(false);
  const [editingGlMemo, setEditingGlMemo] = useState<any>(null);
  const glMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Upload file sub-tab state
  const [glSubTabDocs, setGlSubTabDocs] = useState<any[]>([]);
  const [glSubTabFile, setGlSubTabFile] = useState<File | null>(null);
  const [glSubTabNotes, setGlSubTabNotes] = useState('');
  const [glSubTabUploading, setGlSubTabUploading] = useState(false);
  const glSubTabFileRef = React.useRef<HTMLInputElement>(null);

  // Fetch data
  useEffect(() => {
    if (crId) {
      fetchGlContacts();
      fetchGlDocs();
      fetchGlActivities();
      fetchGlFollowUps();
      fetchGlMemos();
      fetchGlSubTabDocs();
    }
  }, [crId]);

  // Load email templates for Go Live tab
  useEffect(() => {
    api.getCRIEmailTemplates('Go-Live').then(setGlEmailTemplates).catch(() => setGlEmailTemplates([]));
  }, []);

  const fetchGlContacts = async () => {
    try { const res = await api.getLeadContactsForEdit(leadId); setGlContacts(res); } catch (err) { console.error('Failed to fetch contacts:', err); }
  };
  const fetchGlDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'go-live'); setGlDocs(res); } catch (err) { console.error('Failed to fetch docs:', err); }
  };
  const fetchGlActivities = async () => {
    try { const res = await api.getCRActivities(crId, 'go-live-activity'); setGlActivities(res); } catch (err) { console.error('Failed to fetch activities:', err); }
  };
  const fetchGlFollowUps = async () => {
    try { const res = await api.getCRActivities(crId, 'go-live-followup'); setGlFollowUps(res); } catch (err) { console.error('Failed to fetch follow-ups:', err); }
  };
  const fetchGlMemos = async () => {
    try { const res = await api.getCRMemos(crId, 'go-live-memo'); setGlMemos(res); } catch (err) { console.error('Failed to fetch memos:', err); }
  };
  const fetchGlSubTabDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'go-live-upload'); setGlSubTabDocs(res); } catch (err) { console.error('Failed to fetch upload docs:', err); }
  };

  // File handlers
  const handleGlChooseFile = () => glFileRef.current?.click();
  const handleGlFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setGlFile(e.target.files[0]);
  };
  const handleGlUploadFile = async () => {
    if (!crId || !glFile) return;
    setGlUploading(true);
    try {
      await api.uploadCRDocument(crId, glFile, 'go-live', 'Go Live Document');
      fetchGlDocs();
      setGlFile(null);
      if (glFileRef.current) glFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setGlUploading(false); }
  };
  const handleGlDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchGlDocs(); } catch { alert('Failed to delete'); }
  };

  // Task handlers
  const handleGlTaskExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleOpenGlTaskModal = (task?: any) => {
    if (task) {
      setEditingGlTask(task);
      setGlTaskForm({
        task: task.task || '', responsible: task.responsible || '', done_by: task.done_by || '', required_hours: task.required_hours || '',
        start_date: task.start_date || '', start_time: task.start_time || '', status: task.status || '', remarks: task.remarks || '',
        total_hours: task.total_hours || '', difference: task.difference || '', checked_by: task.checked_by || '', date: task.date || '',
        end_date: task.end_date || '', end_time: task.end_time || ''
      });
    } else {
      setEditingGlTask(null);
      setGlTaskForm({ task: '', responsible: '', done_by: '', required_hours: '', start_date: '', start_time: '', status: '', remarks: '', total_hours: '', difference: '', checked_by: '', date: '', end_date: '', end_time: '' });
    }
    setShowGlTaskModal(true);
  };
  const handleSaveGlTask = () => {
    const remarksContent = glTaskEditorRef.current?.innerHTML || glTaskForm.remarks;
    const taskData = {
      ...glTaskForm, remarks: remarksContent,
      start_date_time: glTaskForm.start_date ? `${glTaskForm.start_date}${glTaskForm.start_time ? ' ' + glTaskForm.start_time : ''}` : '',
      end_date_time: glTaskForm.end_date ? `${glTaskForm.end_date}${glTaskForm.end_time ? ' ' + glTaskForm.end_time : ''}` : ''
    };
    if (editingGlTask) {
      setGlTasks(prev => prev.map(t => t.id === editingGlTask.id ? { ...t, ...taskData } : t));
    } else {
      const newId = Math.max(...glTasks.map(t => t.id), 0) + 1;
      setGlTasks(prev => [...prev, { id: newId, ...taskData }]);
    }
    setShowGlTaskModal(false);
    setEditingGlTask(null);
  };
  const handleDeleteGlTask = (taskId: number) => {
    if (!confirm('Delete this task?')) return;
    setGlTasks(prev => prev.filter(t => t.id !== taskId));
  };

  // Activity handlers
  const handleGlActivityExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveGlActivity = async () => {
    if (!crId) return;
    const descriptionContent = glActivityEditorRef.current?.innerHTML || '';
    const formToSave = { ...glActivityForm, description: descriptionContent };
    try {
      if (editingGlActivity) {
        await api.updateCRActivity(crId, editingGlActivity.id, { ...formToSave, activity_category: 'go-live-activity' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'go-live-activity' });
      }
      fetchGlActivities();
      setShowGlActivityModal(false);
      setEditingGlActivity(null);
      setGlActivityForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' });
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save activity'); }
  };
  const handleDeleteGlActivity = async (id: number) => {
    if (!crId || !confirm('Delete this activity?')) return;
    try { await api.deleteCRActivity(crId, id); fetchGlActivities(); } catch { alert('Failed to delete'); }
  };

  // Follow-up handlers
  const handleGlFollowUpExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveGlFollowUp = async () => {
    if (!crId) return;
    const descriptionContent = glFollowUpEditorRef.current?.innerHTML || '';
    const formToSave = { ...glFollowUpForm, description: descriptionContent };
    try {
      if (editingGlFollowUp) {
        await api.updateCRActivity(crId, editingGlFollowUp.id, { ...formToSave, activity_category: 'go-live-followup' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'go-live-followup' });
      }
      fetchGlFollowUps();
      setShowGlFollowUpModal(false);
      setEditingGlFollowUp(null);
      setGlFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' });
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save follow-up'); }
  };
  const handleDeleteGlFollowUp = async (id: number) => {
    if (!crId || !confirm('Delete this follow-up?')) return;
    try { await api.deleteCRActivity(crId, id); fetchGlFollowUps(); } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleGlMemoExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveGlMemo = async () => {
    if (!crId) return;
    const content = glMemoEditorRef.current?.innerHTML || '';
    try {
      if (editingGlMemo) {
        await api.updateCRMemo(crId, editingGlMemo.id, { content, memo_category: 'go-live-memo' });
      } else {
        await api.createCRMemo(crId, { content, memo_category: 'go-live-memo' });
      }
      fetchGlMemos();
      setShowGlMemoModal(false);
      setEditingGlMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteGlMemo = async (id: number) => {
    if (!crId || !confirm('Delete this memo?')) return;
    try { await api.deleteCRMemo(crId, id); fetchGlMemos(); } catch { alert('Failed to delete'); }
  };

  // Upload sub-tab handlers
  const handleGlSubTabChooseFile = () => glSubTabFileRef.current?.click();
  const handleGlSubTabFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setGlSubTabFile(e.target.files[0]);
  };
  const handleGlSubTabUpload = async () => {
    if (!crId || !glSubTabFile) return;
    setGlSubTabUploading(true);
    try {
      await api.uploadCRDocument(crId, glSubTabFile, 'go-live-upload', 'Upload File');
      fetchGlSubTabDocs();
      setGlSubTabFile(null);
      setGlSubTabNotes('');
      if (glSubTabFileRef.current) glSubTabFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload'); } finally { setGlSubTabUploading(false); }
  };
  const handleGlSubTabDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchGlSubTabDocs(); } catch { alert('Failed to delete'); }
  };

  return (
    <div className="space-y-4">
      {/* Top Header Section */}
      <div className="grid grid-cols-2 gap-x-8 gap-y-3">
        {/* Left Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Company Name</label>
            <input type="text" value={glFormData.company_name} onChange={(e) => setGlFormData({ ...glFormData, company_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Contact Name</label>
            <select value={glFormData.contact_name} onChange={(e) => { const cid = e.target.value; const selectedContact = glContacts.find((c: any) => c.id?.toString() === cid); setGlFormData({ ...glFormData, contact_name: cid, contact_email: selectedContact?.work_email || selectedContact?.personal_email || selectedContact?.email || '' }); }} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Contact Name</option>
              {glContacts.map((contact: any) => (
                <option key={contact.id} value={contact.id}>{`${contact.first_name || ''} ${contact.last_name || ''}`.trim()}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center">
            <label className="w-36 text-xs font-medium text-blue-600">Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={glFormData.email_format_type} onChange={(e) => setGlFormData({ ...glFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {glEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Go Live', glFormData.contact_email, glEmailTemplates.find((t: any) => t.email_format === glFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
          {/* Email Sent To Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Sent To</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Email Type</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Attachments</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Sent On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {glEmailSentList.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  glEmailSentList.map((item, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b">{item.email}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.email_type}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.attachments}</td>
                      <td className="px-3 py-2 text-xs border-b">{item.sent_on}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">-</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-3">
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Branch Office</label>
            <input type="text" value={glFormData.branch_office} onChange={(e) => setGlFormData({ ...glFormData, branch_office: e.target.value })} placeholder="Branch Office" className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Contact Email</label>
            <input type="email" value={glFormData.contact_email} onChange={(e) => setGlFormData({ ...glFormData, contact_email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="flex items-center">
            <label className="w-32 text-xs font-medium text-blue-600">Document</label>
            <input type="file" ref={glFileRef} onChange={handleGlFileChange} className="hidden" />
            <button onClick={handleGlChooseFile} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <Upload className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleGlUploadFile} disabled={!glFile || glUploading} className="ml-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">{glUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          {/* File Name Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-600">
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">File Name</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Link</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Size</th>
                  <th className="px-3 py-2 text-left text-xs font-medium text-white border-r border-blue-500">Upload On</th>
                  <th className="px-3 py-2 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {glDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-gray-400 text-xs bg-gray-50"></td></tr>
                ) : (
                  glDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b text-blue-600">{doc.file_path ? <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="hover:underline">service: delta.axieve...</a> : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b text-center">
                        <div className="flex items-center justify-center gap-1">
                          <input type="checkbox" className="w-3.5 h-3.5 accent-blue-600" />
                          <button onClick={() => handleGlDeleteDoc(doc.id)} className="p-0.5 text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Sub-tabs Navigation */}
      <div className="border-b border-gray-200">
        <div className="flex gap-0.5">
          {glSubTabs.map((tab) => {
            const tabKey = tab.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
            return (
              <button key={tab} onClick={() => setGlSubTab(tabKey)} className={`px-3 py-2 text-xs font-medium rounded-t transition-colors ${glSubTab === tabKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                {tab}
              </button>
            );
          })}
        </div>
      </div>

      {/* Details Sub-tab */}
      {glSubTab === 'details' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Go Live Coordinator</label>
                  <input type="text" value={glCustomerForm.coordinator} onChange={(e) => setGlCustomerForm({ ...glCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={glCustomerForm.email} onChange={(e) => setGlCustomerForm({ ...glCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={glCustomerForm.phone} onChange={(e) => setGlCustomerForm({ ...glCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Go Live Coordinator</label>
                  <input type="text" value={glAxieverForm.coordinator} onChange={(e) => setGlAxieverForm({ ...glAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={glAxieverForm.email} onChange={(e) => setGlAxieverForm({ ...glAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={glAxieverForm.phone} onChange={(e) => setGlAxieverForm({ ...glAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Add New Task Button */}
          <div>
            <button onClick={() => handleOpenGlTaskModal()} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Task</button>
          </div>

          {/* Task Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full table-fixed">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[12%]">Task</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Responsible</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[7%]">Done By</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[6%]">Req. Hrs</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">Start Date/Time</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[8%]">End Date/Time</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[5%]">Total</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[5%]">Diff</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[7%]">Checked By</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[6%]">Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[10%]">Remarks</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[6%]">Status</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white w-[7%]">Action</th>
                </tr>
              </thead>
              <tbody>
                {glTasks.map((task, index) => (
                  <tr key={task.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-blue-600 truncate">{task.task}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.responsible}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.done_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.required_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.start_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.end_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.total_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.difference}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.checked_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.date}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate"><div dangerouslySetInnerHTML={{ __html: task.remarks || '' }} /></td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200">{task.status}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">
                      <div className="flex gap-1 justify-center">
                        <button onClick={() => handleOpenGlTaskModal(task)} className="p-1 text-blue-600 hover:bg-blue-50 rounded border border-gray-300"><Edit2 className="w-3 h-3" /></button>
                        <button onClick={() => handleDeleteGlTask(task.id)} className="p-1 text-red-600 hover:bg-red-50 rounded border border-gray-300"><Trash2 className="w-3 h-3" /></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Activity Sub-tab */}
      {glSubTab === 'activity' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowGlActivityModal(true); setEditingGlActivity(null); setGlActivityForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' }); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {glActivities.length === 0 ? (
                  <tr><td colSpan={6} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  glActivities.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingGlActivity(activity); setGlActivityForm(activity); setShowGlActivityModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteGlActivity(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Summary Sub-tab */}
      {glSubTab === 'summary' && (
        <div className="space-y-6">
          {/* Contact Section - Two Columns */}
          <div className="grid grid-cols-2 gap-6">
            {/* Customer Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Customer</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Go Live Coordinator</label>
                  <input type="text" value={glCustomerForm.coordinator} onChange={(e) => setGlCustomerForm({ ...glCustomerForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={glCustomerForm.email} onChange={(e) => setGlCustomerForm({ ...glCustomerForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={glCustomerForm.phone} onChange={(e) => setGlCustomerForm({ ...glCustomerForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
            {/* Axiever Section */}
            <div>
              <div className="bg-blue-600 text-white px-3 py-2 rounded-t text-xs font-medium">Axiever</div>
              <div className="border border-t-0 rounded-b p-3 space-y-3">
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Go Live Coordinator</label>
                  <input type="text" value={glAxieverForm.coordinator} onChange={(e) => setGlAxieverForm({ ...glAxieverForm, coordinator: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Email</label>
                  <input type="email" value={glAxieverForm.email} onChange={(e) => setGlAxieverForm({ ...glAxieverForm, email: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div className="flex items-center">
                  <label className="w-48 text-xs font-medium text-blue-600">Phone</label>
                  <input type="text" value={glAxieverForm.phone} onChange={(e) => setGlAxieverForm({ ...glAxieverForm, phone: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          {/* Status Field */}
          <div className="flex items-center">
            <label className="w-20 text-xs font-medium text-blue-600">Status</label>
            <select value={glSummaryStatus} onChange={(e) => setGlSummaryStatus(e.target.value)} className="flex-1 max-w-md h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select Priority</option>
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="On Hold">On Hold</option>
            </select>
          </div>

          {/* Summary Task Table */}
          <div className="border rounded overflow-hidden">
            <table className="w-full table-fixed">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[12%]">Task</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[8%]">Responsible</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Done By</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[8%]">Required Hours</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[9%]">Start Date/Time</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[9%]">End Date/Time</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Total Hours</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Difference</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[8%]">Checked By</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white border-r border-blue-600 w-[7%]">Date</th>
                  <th className="px-2 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-[10%]">Remarks</th>
                  <th className="px-2 py-2.5 text-center text-xs font-medium text-white w-[8%]">Status</th>
                </tr>
              </thead>
              <tbody>
                {glSummaryTasks.map((task, index) => (
                  <tr key={task.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-blue-600 truncate">{task.task}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.responsible}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.done_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.required_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.start_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.end_date_time}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.total_hours}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.difference}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.checked_by}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.date}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 truncate">{task.remarks}</td>
                    <td className="px-2 py-2 text-xs border-b border-gray-200 text-center">{task.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Follow-Up Sub-tab */}
      {glSubTab === 'follow-up' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowGlFollowUpModal(true); setEditingGlFollowUp(null); setGlFollowUpForm({ activity_type: '', subject: '', start_date: '', start_time: '', description: '', status: 'Open', contact_id: '', assigned_to: '', next_followup_date: '', sent_to: '' }); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add New Activity</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Activity Subject</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Date & Time</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Next Follow-up Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Channel Type</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Assigned To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Sent To</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Status</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white">Action</th>
                </tr>
              </thead>
              <tbody>
                {glFollowUps.length === 0 ? (
                  <tr><td colSpan={9} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  glFollowUps.map((activity: any, index: number) => (
                    <tr key={activity.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{activity.activity_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.subject || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.start_date ? `${activity.start_date} ${activity.start_time || ''}`.trim() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.next_followup_date || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.channel_type || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.assigned_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{activity.sent_to || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><span className={`px-2 py-0.5 text-xs rounded ${activity.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{activity.status}</span></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingGlFollowUp(activity); setGlFollowUpForm(activity); setShowGlFollowUpModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteGlFollowUp(activity.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Memo Sub-tab */}
      {glSubTab === 'memo' && (
        <div className="space-y-3">
          <div>
            <button onClick={() => { setShowGlMemoModal(true); setEditingGlMemo(null); }} className="px-4 py-1.5 text-xs border border-gray-400 rounded hover:bg-gray-50">Add Memo</button>
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-32">Date</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Added By</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Details</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Action</th>
                </tr>
              </thead>
              <tbody>
                {glMemos.length === 0 ? (
                  <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  glMemos.map((memo: any, index: number) => (
                    <tr key={memo.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.created_at ? new Date(memo.created_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{memo.added_by || 'Admin User'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200"><div dangerouslySetInnerHTML={{ __html: memo.content || '-' }} className="max-w-full text-xs" /></td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          <button onClick={() => { setEditingGlMemo(memo); setShowGlMemoModal(true); }} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Edit2 className="w-3 h-3" /></button>
                          <button onClick={() => handleDeleteGlMemo(memo.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Upload File Sub-tab */}
      {glSubTab === 'upload-file' && (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Document</label>
            <input type="text" className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50" readOnly value={glSubTabFile?.name || ''} />
            <input ref={glSubTabFileRef} type="file" onChange={handleGlSubTabFileChange} className="hidden" />
            <button onClick={handleGlSubTabChooseFile} className="h-8 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center gap-1"><Upload className="w-3 h-3" /> Choose File</button>
            <button onClick={handleGlSubTabUpload} disabled={!glSubTabFile || glSubTabUploading} className="h-8 px-4 border border-gray-300 rounded hover:bg-gray-50 text-xs disabled:opacity-50">{glSubTabUploading ? 'Uploading...' : 'Upload'}</button>
          </div>
          <div className="flex items-center gap-4">
            <label className="text-xs font-medium text-blue-600 w-20 text-right">Notes</label>
            <input type="text" value={glSubTabNotes} onChange={(e) => setGlSubTabNotes(e.target.value)} className="h-8 flex-1 max-w-md px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="border rounded overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="bg-blue-700">
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">File Name</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-40">Uploaded On</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600 w-24">Size</th>
                  <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-600">Notes</th>
                  <th className="px-3 py-2.5 text-center text-xs font-medium text-white w-24">Actions</th>
                </tr>
              </thead>
              <tbody>
                {glSubTabDocs.length === 0 ? (
                  <tr><td colSpan={5} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
                ) : (
                  glSubTabDocs.map((doc: any, index: number) => (
                    <tr key={doc.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-blue-600">{doc.file_name}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200">{doc.notes || '-'}</td>
                      <td className="px-3 py-2 text-xs border-b border-gray-200 text-center">
                        <div className="flex gap-1 justify-center">
                          {doc.file_path && <a href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="p-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200"><Download className="w-3 h-3" /></a>}
                          <button onClick={() => handleGlSubTabDeleteDoc(doc.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded border border-red-200"><Trash2 className="w-3 h-3" /></button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {glSubTab === 'workflow--audit-trail' && (
        <div className="border rounded overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-blue-600">
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-28">Date</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-32">User</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white border-r border-blue-500 w-24">Action</th>
                <th className="px-3 py-2.5 text-left text-xs font-medium text-white">Details</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colSpan={4} className="px-3 py-4 text-center text-orange-400 text-xs">No Data Available</td></tr>
            </tbody>
          </table>
        </div>
      )}

      {/* Activity Modal */}
      {showGlActivityModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">NEW ACTIVITY</h3>
              <button onClick={() => { setShowGlActivityModal(false); setEditingGlActivity(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-8 gap-y-4">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity</label>
                  <input type="text" value={glActivityForm.activity_type} onChange={(e) => setGlActivityForm({ ...glActivityForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Schedule Date</label>
                  <div className="relative">
                    <input type="date" value={glActivityForm.start_date} onChange={(e) => setGlActivityForm({ ...glActivityForm, start_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Responsibility</label>
                  <input type="text" value={glActivityForm.assigned_to} onChange={(e) => setGlActivityForm({ ...glActivityForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Schedule Time</label>
                  <div className="relative">
                    <input type="time" value={glActivityForm.start_time} onChange={(e) => setGlActivityForm({ ...glActivityForm, start_time: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded border border-gray-200">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded border border-gray-200">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded border border-gray-200">U</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('strikeThrough'); }} className="w-7 h-7 flex items-center justify-center line-through text-sm hover:bg-gray-100 rounded border border-gray-200">S</button>
                  <select onChange={(e) => handleGlActivityExec('fontName', e.target.value)} className="h-7 px-1 text-xs border border-gray-200 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                  </select>
                  <select onChange={(e) => handleGlActivityExec('fontSize', e.target.value)} className="h-7 px-1 text-xs border border-gray-200 rounded bg-white">
                    <option value="3">14</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                    <option value="5">18</option>
                  </select>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('foreColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200 bg-yellow-300 font-bold">A</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg>
                  </button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlActivityExec('outdent'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 19l-7-7 7-7m8 14V5" /></svg>
                  </button>
                </div>
                <div ref={glActivityEditorRef} contentEditable className="w-full min-h-[180px] max-h-[280px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveGlActivity} className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Follow-Up Modal */}
      {showGlFollowUpModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-600">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-bold text-yellow-400 uppercase tracking-wide">NEW ACTIVITY</h3>
                <button className="px-3 py-1 text-xs font-medium text-white bg-blue-800 rounded hover:bg-blue-900">View Previous Activities</button>
              </div>
              <button onClick={() => { setShowGlFollowUpModal(false); setEditingGlFollowUp(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Contact</label>
                  <select value={glFollowUpForm.contact_id} onChange={(e) => { const cid = e.target.value; const sc = glContacts.find((c: any) => c.id?.toString() === cid); setGlFollowUpForm({ ...glFollowUpForm, contact_id: cid, sent_to: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Contact</option>
                    {glContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Subject</label>
                  <input value={glFollowUpForm.subject} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, subject: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Email</label>
                  <input value={glFollowUpForm.sent_to} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, sent_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Activity Type</label>
                  <select value={glFollowUpForm.activity_type} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, activity_type: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    <option value="Call">Call</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Email">Email</option>
                    <option value="Task">Task</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={glFollowUpForm.start_date} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={glFollowUpForm.start_time} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, start_time: e.target.value })} className="w-28 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Assigned To</label>
                  <select value={glFollowUpForm.assigned_to} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, assigned_to: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select</option>
                    {glContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Next Follow Up Date</label>
                  <input type="date" value={glFollowUpForm.next_followup_date} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, next_followup_date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={glFollowUpForm.status} onChange={(e) => setGlFollowUpForm({ ...glFollowUpForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Description</label>
                <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlFollowUpExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlFollowUpExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlFollowUpExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                  <select onChange={(e) => handleGlFollowUpExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="jost">jost</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                  </select>
                  <select onChange={(e) => handleGlFollowUpExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                    <option value="3">14</option>
                    <option value="2">12</option>
                    <option value="4">16</option>
                  </select>
                </div>
                <div ref={glFollowUpEditorRef} contentEditable className="w-full min-h-[150px] max-h-[250px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              </div>
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveGlFollowUp} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Memo Modal */}
      {showGlMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowGlMemoModal(false); setEditingGlMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlMemoExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlMemoExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlMemoExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                <select onChange={(e) => handleGlMemoExec('fontName', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                </select>
                <select onChange={(e) => handleGlMemoExec('fontSize', e.target.value)} className="h-6 px-1 text-xs border border-gray-300 rounded bg-white">
                  <option value="3">14</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                </select>
              </div>
              <div ref={glMemoEditorRef} contentEditable className="w-full min-h-[180px] max-h-[300px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning />
              <div className="flex justify-center mt-5"><button onClick={handleSaveGlMemo} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button></div>
            </div>
          </div>
        </div>
      )}

      {/* Task Modal */}
      {showGlTaskModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-4 py-3 bg-blue-600">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">NEW TASK</h3>
              <button onClick={() => { setShowGlTaskModal(false); setEditingGlTask(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-4">
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Task</label>
                  <input type="text" value={glTaskForm.task} onChange={(e) => setGlTaskForm({ ...glTaskForm, task: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Total Hours</label>
                  <input type="text" value={glTaskForm.total_hours} onChange={(e) => setGlTaskForm({ ...glTaskForm, total_hours: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Responsible</label>
                  <select value={glTaskForm.responsible} onChange={(e) => setGlTaskForm({ ...glTaskForm, responsible: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Difference</label>
                  <input type="text" value={glTaskForm.difference} onChange={(e) => setGlTaskForm({ ...glTaskForm, difference: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Done By</label>
                  <select value={glTaskForm.done_by} onChange={(e) => setGlTaskForm({ ...glTaskForm, done_by: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Checked By</label>
                  <select value={glTaskForm.checked_by} onChange={(e) => setGlTaskForm({ ...glTaskForm, checked_by: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Admin User">Admin User</option>
                    <option value="Project Manager">Project Manager</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Required Hours</label>
                  <input type="text" value={glTaskForm.required_hours} onChange={(e) => setGlTaskForm({ ...glTaskForm, required_hours: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Date</label>
                  <input type="date" value={glTaskForm.date} onChange={(e) => setGlTaskForm({ ...glTaskForm, date: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">Start Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={glTaskForm.start_date} onChange={(e) => setGlTaskForm({ ...glTaskForm, start_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={glTaskForm.start_time} onChange={(e) => setGlTaskForm({ ...glTaskForm, start_time: e.target.value })} className="w-20 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-medium text-blue-600 block mb-1">End Date / Time</label>
                  <div className="flex gap-2">
                    <input type="date" value={glTaskForm.end_date} onChange={(e) => setGlTaskForm({ ...glTaskForm, end_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                    <input type="time" value={glTaskForm.end_time} onChange={(e) => setGlTaskForm({ ...glTaskForm, end_time: e.target.value })} className="w-20 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                  </div>
                </div>
                <div className="col-span-2">
                  <label className="text-xs font-medium text-blue-600 block mb-1">Status</label>
                  <select value={glTaskForm.status} onChange={(e) => setGlTaskForm({ ...glTaskForm, status: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Status</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                  </select>
                </div>
              </div>
              <div className="mt-4">
                <label className="text-xs font-medium text-blue-600 block mb-1">Remarks</label>
                <div className="flex items-center gap-2 px-2 py-1.5 border border-gray-300 rounded-t bg-white">
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlTaskExec('bold'); }} className="w-6 h-6 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded">B</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlTaskExec('italic'); }} className="w-6 h-6 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded">I</button>
                  <button type="button" onMouseDown={(e) => { e.preventDefault(); handleGlTaskExec('underline'); }} className="w-6 h-6 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded">U</button>
                </div>
                <div ref={glTaskEditorRef} contentEditable className="w-full min-h-[100px] max-h-[200px] overflow-y-auto px-2 py-2 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white" suppressContentEditableWarning dangerouslySetInnerHTML={{ __html: glTaskForm.remarks }} />
              </div>
              <div className="flex justify-center mt-4">
                <button onClick={handleSaveGlTask} className="px-6 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Support Form ==============
function SupportForm({ data, crId, leadId, refreshData, onOpenEmailModal }: any) {
  const [supportSubTab, setSupportSubTab] = useState('ticket');
  const supportSubTabs = ['Ticket', 'Summary', 'Feedback', 'Memo', 'Workflow & Audit Trail'];

  // Top section state
  const [supportFormData, setSupportFormData] = useState({
    company_name: '', contact_name: '', email_format_type: '', branch_office: '', contact_email: ''
  });
  const [supportContacts, setSupportContacts] = useState<any[]>([]);
  const [supportEmailTemplates, setSupportEmailTemplates] = useState<any[]>([]);
  const [supportDocs, setSupportDocs] = useState<any[]>([]);
  const [supportFile, setSupportFile] = useState<File | null>(null);
  const [supportUploading, setSupportUploading] = useState(false);
  const supportFileRef = React.useRef<HTMLInputElement>(null);
  const [supportEmailSentList, setSupportEmailSentList] = useState<any[]>([]);

  // Ticket state
  const [supportTickets, setSupportTickets] = useState<any[]>([]);
  const [showTicketModal, setShowTicketModal] = useState(false);
  const [editingTicket, setEditingTicket] = useState<any>(null);
  const [ticketForm, setTicketForm] = useState({
    ticket_no: '', date_time: '', user_name: '', module: '', sub_module: '', child_module: '',
    category: '', sub_category: '', details: '', priority: 'Medium', resolution: '', resolved_by: '', closed_date: '', status: 'Open'
  });
  const ticketEditorRef = React.useRef<HTMLDivElement>(null);
  const ticketFileRef = React.useRef<HTMLInputElement>(null);
  const [ticketFile, setTicketFile] = useState<File | null>(null);

  // Summary state
  const [supportSummary, setSupportSummary] = useState<any[]>([]);
  const [summaryStatusFilter, setSummaryStatusFilter] = useState('');

  // Feedback state
  const [supportFeedback, setSupportFeedback] = useState<any[]>([]);
  const [showFeedbackModal, setShowFeedbackModal] = useState(false);
  const [editingFeedback, setEditingFeedback] = useState<any>(null);
  const [feedbackForm, setFeedbackForm] = useState({ title: '', content: '', rating: '' });
  const feedbackEditorRef = React.useRef<HTMLDivElement>(null);
  const [feedbackFilter, setFeedbackFilter] = useState({
    ticket_number: '', company_name: '', issued_by: '', date_received: '', help_topic: '', module: '', priority: '', work_group: '', assigned: ''
  });

  // Memo state
  const [supportMemos, setSupportMemos] = useState<any[]>([]);
  const [showSupportMemoModal, setShowSupportMemoModal] = useState(false);
  const [editingSupportMemo, setEditingSupportMemo] = useState<any>(null);
  const supportMemoEditorRef = React.useRef<HTMLDivElement>(null);

  // Fetch data
  useEffect(() => {
    if (crId) {
      fetchSupportContacts();
      fetchSupportDocs();
      fetchSupportTickets();
      fetchSupportMemos();
    }
  }, [crId]);

  // Load email templates for Support tab
  useEffect(() => {
    api.getCRIEmailTemplates('Support').then(setSupportEmailTemplates).catch(() => setSupportEmailTemplates([]));
  }, []);

  useEffect(() => {
    if (data) {
      setSupportFormData(prev => ({
        ...prev,
        company_name: data.company_name || '',
        branch_office: data.branch_office || ''
      }));
    }
  }, [data]);

  const fetchSupportContacts = async () => {
    try { const res = await api.getLeadContactsForEdit(leadId); setSupportContacts(res); } catch (err) { console.error('Failed to fetch contacts:', err); }
  };
  const fetchSupportDocs = async () => {
    try { const res = await api.getCRDocuments(crId, 'support'); setSupportDocs(res); } catch (err) { console.error('Failed to fetch docs:', err); }
  };
  const fetchSupportTickets = async () => {
    try { const res = await api.getCRActivities(crId, 'support-ticket'); setSupportTickets(res); } catch (err) { console.error('Failed to fetch tickets:', err); }
  };
  const fetchSupportMemos = async () => {
    try { const res = await api.getCRMemos(crId, 'support-memo'); setSupportMemos(res); } catch (err) { console.error('Failed to fetch memos:', err); }
  };

  // File handlers
  const handleSupportChooseFile = () => supportFileRef.current?.click();
  const handleSupportFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) setSupportFile(e.target.files[0]);
  };
  const handleSupportUploadFile = async () => {
    if (!crId || !supportFile) return;
    setSupportUploading(true);
    try {
      await api.uploadCRDocument(crId, supportFile, 'support', 'Support Document');
      fetchSupportDocs();
      setSupportFile(null);
      if (supportFileRef.current) supportFileRef.current.value = '';
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); } finally { setSupportUploading(false); }
  };
  const handleSupportDeleteDoc = async (docId: number) => {
    if (!crId || !confirm('Delete this document?')) return;
    try { await api.deleteCRDocument(crId, docId); fetchSupportDocs(); } catch { alert('Failed to delete'); }
  };

  // Ticket handlers
  const handleTicketExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleOpenTicketModal = (ticket?: any) => {
    if (ticket) {
      setEditingTicket(ticket);
      setTicketForm({
        ticket_no: ticket.ticket_no || '', date_time: ticket.date_time || '', user_name: ticket.user_name || '',
        module: ticket.module || '', sub_module: ticket.sub_module || '', child_module: ticket.child_module || '',
        category: ticket.category || '', sub_category: ticket.sub_category || '', details: ticket.details || '',
        priority: ticket.priority || 'Medium', resolution: ticket.resolution || '', resolved_by: ticket.resolved_by || '',
        closed_date: ticket.closed_date || '', status: ticket.status || 'Open'
      });
    } else {
      setEditingTicket(null);
      const now = new Date();
      const ticketNo = String(Math.floor(Math.random() * 9000000) + 1000000);
      setTicketForm({
        ticket_no: ticketNo, date_time: now.toISOString().slice(0, 16), user_name: '', module: '', sub_module: '', child_module: '',
        category: '', sub_category: '', details: '', priority: 'Medium', resolution: '', resolved_by: '', closed_date: '', status: 'Open'
      });
    }
    setShowTicketModal(true);
  };
  const handleSaveTicket = async () => {
    if (!crId) return;
    const detailsContent = ticketForm.details;
    const formToSave = {
      activity_type: 'ticket',
      subject: ticketForm.ticket_no,
      description: detailsContent,
      start_date: ticketForm.date_time?.split('T')[0] || '',
      start_time: ticketForm.date_time?.split('T')[1] || '',
      status: ticketForm.status,
      extra_data: JSON.stringify({
        ticket_no: ticketForm.ticket_no,
        user_name: ticketForm.user_name,
        module: ticketForm.module,
        sub_module: ticketForm.sub_module,
        child_module: ticketForm.child_module,
        category: ticketForm.category,
        sub_category: ticketForm.sub_category,
        priority: ticketForm.priority,
        resolution: ticketForm.resolution,
        resolved_by: ticketForm.resolved_by,
        closed_date: ticketForm.closed_date
      })
    };
    try {
      if (editingTicket) {
        await api.updateCRActivity(crId, editingTicket.id, { ...formToSave, activity_category: 'support-ticket' });
      } else {
        await api.createCRActivity(crId, { ...formToSave, activity_category: 'support-ticket' });
      }
      fetchSupportTickets();
      setShowTicketModal(false);
      setEditingTicket(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save ticket'); }
  };
  const handleDeleteTicket = async (id: number) => {
    if (!crId || !confirm('Delete this ticket?')) return;
    try { await api.deleteCRActivity(crId, id); fetchSupportTickets(); } catch { alert('Failed to delete'); }
  };
  const handleTicketFileUpload = async () => {
    if (!crId || !ticketFile) return;
    try {
      await api.uploadCRDocument(crId, ticketFile, 'support-ticket', `Ticket Attachment - ${ticketForm.ticket_no}`);
      setTicketFile(null);
      if (ticketFileRef.current) ticketFileRef.current.value = '';
      alert('File uploaded successfully');
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to upload file'); }
  };

  // Feedback handlers
  const handleSearchFeedback = () => {
    // Filter feedback based on feedbackFilter values
    console.log('Searching feedback with filters:', feedbackFilter);
  };
  const handleDeleteFeedback = async (id: number) => {
    if (!crId || !confirm('Delete this feedback?')) return;
    try {
      await api.deleteCRActivity(crId, id);
      setSupportFeedback(prev => prev.filter(f => f.id !== id));
    } catch { alert('Failed to delete'); }
  };

  // Memo handlers
  const handleSupportMemoExec = (cmd: string, val?: string) => { document.execCommand(cmd, false, val); };
  const handleSaveSupportMemo = async () => {
    if (!crId) return;
    const content = supportMemoEditorRef.current?.innerHTML || '';
    try {
      if (editingSupportMemo) {
        await api.updateCRMemo(crId, editingSupportMemo.id, { content, memo_category: 'support-memo' });
      } else {
        await api.createCRMemo(crId, { title: 'Support Memo', content, memo_category: 'support-memo' });
      }
      fetchSupportMemos();
      setShowSupportMemoModal(false);
      setEditingSupportMemo(null);
    } catch (err: any) { alert(err?.response?.data?.detail || 'Failed to save memo'); }
  };
  const handleDeleteSupportMemo = async (id: number) => {
    if (!crId || !confirm('Delete this memo?')) return;
    try { await api.deleteCRMemo(crId, id); fetchSupportMemos(); } catch { alert('Failed to delete'); }
  };

  const fieldLabelClass = "text-xs font-medium text-blue-600 w-32 flex-shrink-0";
  const fieldInputClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50";
  const fieldSelectClass = "flex-1 h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white";

  // Parse ticket extra data
  const parseTicketData = (ticket: any) => {
    try {
      const extra = ticket.extra_data ? JSON.parse(ticket.extra_data) : {};
      return {
        ticket_no: extra.ticket_no || ticket.subject || '',
        date_time: ticket.start_date ? `${ticket.start_date}${ticket.start_time ? 'T' + ticket.start_time : ''}` : '',
        user_name: extra.user_name || '',
        module: extra.module || '',
        sub_module: extra.sub_module || '',
        child_module: extra.child_module || '',
        category: extra.category || '',
        sub_category: extra.sub_category || '',
        details: ticket.description || '',
        priority: extra.priority || 'Medium',
        resolution: extra.resolution || '',
        resolved_by: extra.resolved_by || '',
        closed_date: extra.closed_date || '',
        status: ticket.status || 'Open'
      };
    } catch {
      return { ticket_no: ticket.subject || '', date_time: '', user_name: '', module: '', sub_module: '', child_module: '', category: '', sub_category: '', details: '', priority: 'Medium', resolution: '', resolved_by: '', closed_date: '', status: 'Open' };
    }
  };

  return (
    <div className="space-y-4">
      {/* Top Section */}
      <div className="grid grid-cols-2 gap-6">
        {/* Left Column */}
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <label className={fieldLabelClass}>Company Name</label>
            <input type="text" value={supportFormData.company_name} onChange={(e) => setSupportFormData({ ...supportFormData, company_name: e.target.value })} className={fieldInputClass} />
          </div>
          <div className="flex items-center gap-2">
            <label className={fieldLabelClass}>Contact Name</label>
            <select value={supportFormData.contact_name} onChange={(e) => { const cid = e.target.value; const sc = supportContacts.find((c: any) => c.id?.toString() === cid); setSupportFormData({ ...supportFormData, contact_name: cid, contact_email: sc?.work_email || sc?.personal_email || sc?.email || '' }); }} className={fieldSelectClass}>
              <option value="">Select Contact Name</option>
              {supportContacts.map((c: any) => <option key={c.id} value={c.id}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
            </select>
          </div>
          <div className="flex items-center gap-2">
            <label className={fieldLabelClass}>Email Format / Type</label>
            <div className="flex-1 flex">
              <select value={supportFormData.email_format_type} onChange={(e) => setSupportFormData({ ...supportFormData, email_format_type: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded-l bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select Email Format</option>
                {supportEmailTemplates.map((template: any) => (
                  <option key={template.id} value={template.email_format}>{template.email_format}</option>
                ))}
              </select>
              <button
                onClick={() => onOpenEmailModal && onOpenEmailModal('Support', supportFormData.contact_email, supportEmailTemplates.find((t: any) => t.email_format === supportFormData.email_format_type)?.id)}
                className="w-10 h-8 flex items-center justify-center bg-blue-600 text-white rounded-r hover:bg-blue-700 border border-blue-600"
              >
                <Mail className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <label className={fieldLabelClass}>Branch Office</label>
            <input type="text" value={supportFormData.branch_office} onChange={(e) => setSupportFormData({ ...supportFormData, branch_office: e.target.value })} className={fieldInputClass} />
          </div>
          <div className="flex items-center gap-2">
            <label className={fieldLabelClass}>Contact Email</label>
            <input type="text" value={supportFormData.contact_email} readOnly className={`${fieldInputClass} bg-gray-100`} />
          </div>
          <div className="flex items-center gap-2">
            <label className={fieldLabelClass}>Document</label>
            <input type="file" ref={supportFileRef} onChange={handleSupportFileChange} className="hidden" />
            <span className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 flex items-center text-gray-500 truncate">{supportFile?.name || ''}</span>
            <button onClick={handleSupportChooseFile} className="h-8 px-3 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
              <CheckCircle className="w-3 h-3" /> Choose File
            </button>
            <button onClick={handleSupportUploadFile} disabled={!supportFile || supportUploading} className="h-8 px-4 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 disabled:opacity-50">
              {supportUploading ? 'Uploading...' : 'Upload'}
            </button>
          </div>
        </div>
      </div>

      {/* Two Tables Side by Side */}
      <div className="grid grid-cols-2 gap-4">
        {/* Email Sent To Table */}
        <div>
          <table className="w-full text-xs border border-gray-300">
            <thead>
              <tr className="bg-blue-600 text-white">
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Email Sent To</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Attachments</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Sent On</th>
                <th className="px-2 py-1.5 text-center font-medium w-16">Action</th>
              </tr>
            </thead>
            <tbody>
              {supportEmailSentList.length === 0 ? (
                <tr><td colSpan={4} className="px-2 py-4 text-center text-gray-400 border-t">No emails sent</td></tr>
              ) : (
                supportEmailSentList.map((email: any, idx: number) => (
                  <tr key={idx} className="border-t hover:bg-gray-50">
                    <td className="px-2 py-1.5 border-r">{email.sent_to}</td>
                    <td className="px-2 py-1.5 border-r">{email.attachments}</td>
                    <td className="px-2 py-1.5 border-r">{email.sent_on}</td>
                    <td className="px-2 py-1.5 text-center">
                      <button className="text-red-500 hover:text-red-700"><Trash2 className="w-3.5 h-3.5" /></button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

        {/* Files Table */}
        <div>
          <table className="w-full text-xs border border-gray-300">
            <thead>
              <tr className="bg-blue-600 text-white">
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">File Name</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Link</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Size</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Upload On</th>
                <th className="px-2 py-1.5 text-center font-medium w-16">Action</th>
              </tr>
            </thead>
            <tbody>
              {supportDocs.length === 0 ? (
                <tr><td colSpan={5} className="px-2 py-4 text-center text-gray-400 border-t">No files uploaded</td></tr>
              ) : (
                supportDocs.map((doc: any) => (
                  <tr key={doc.id} className="border-t hover:bg-gray-50">
                    <td className="px-2 py-1.5 border-r text-blue-600">{doc.file_name || 'ticket'}</td>
                    <td className="px-2 py-1.5 border-r">
                      <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="text-orange-500 hover:underline truncate block max-w-[120px]">
                        {doc.file_url?.split('/').pop()?.substring(0, 20) || 'View'}...
                      </a>
                    </td>
                    <td className="px-2 py-1.5 border-r">{doc.file_size ? `${(doc.file_size / 1024).toFixed(2)} Kb` : '-'}</td>
                    <td className="px-2 py-1.5 border-r">{doc.created_at ? new Date(doc.created_at).toLocaleDateString() : '-'}</td>
                    <td className="px-2 py-1.5 text-center">
                      <div className="flex items-center justify-center gap-1">
                        <input type="checkbox" className="w-3 h-3" />
                        <button onClick={() => handleSupportDeleteDoc(doc.id)} className="text-red-500 hover:text-red-700"><Trash2 className="w-3.5 h-3.5" /></button>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Sub-tabs */}
      <div className="flex items-center gap-1 border-b border-gray-200">
        {supportSubTabs.map((tab) => (
          <button
            key={tab}
            onClick={() => setSupportSubTab(tab.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-'))}
            className={`px-3 py-1.5 text-xs font-medium rounded-t transition-colors ${
              supportSubTab === tab.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-')
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {tab}
          </button>
        ))}
      </div>

      {/* Ticket Sub-tab */}
      {supportSubTab === 'ticket' && (
        <div>
          <div className="mb-3">
            <button onClick={() => { setShowTicketModal(!showTicketModal); if (!showTicketModal) handleOpenTicketModal(); }} className="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50">
              New Ticket
            </button>
          </div>

          {/* Inline Ticket Form */}
          {showTicketModal && (
            <div className="mb-4 p-4 bg-white border border-gray-200 rounded">
              {/* Row 1 */}
              <div className="grid grid-cols-3 gap-4 mb-3">
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">User</label>
                  <select value={ticketForm.user_name} onChange={(e) => setTicketForm({ ...ticketForm, user_name: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    {supportContacts.map((c: any) => <option key={c.id} value={`${c.first_name || ''} ${c.last_name || ''}`.trim()}>{`${c.first_name || ''} ${c.last_name || ''}`.trim()}</option>)}
                  </select>
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Module</label>
                  <select value={ticketForm.module} onChange={(e) => setTicketForm({ ...ticketForm, module: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Menu</option>
                    <option value="Sales">Sales</option>
                    <option value="Inventory">Inventory</option>
                    <option value="Finance">Finance</option>
                    <option value="HR">HR</option>
                    <option value="CRM">CRM</option>
                    <option value="Reports">Reports</option>
                  </select>
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-28 flex-shrink-0">Closed Date / Time</label>
                  <input type="datetime-local" value={ticketForm.closed_date} onChange={(e) => setTicketForm({ ...ticketForm, closed_date: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
              </div>

              {/* Row 2 */}
              <div className="grid grid-cols-3 gap-4 mb-3">
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Category</label>
                  <select value={ticketForm.category} onChange={(e) => setTicketForm({ ...ticketForm, category: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">- Select Category -</option>
                    <option value="Bug">Bug</option>
                    <option value="Feature Request">Feature Request</option>
                    <option value="Support">Support</option>
                    <option value="Question">Question</option>
                  </select>
                  <button className="h-8 w-8 flex items-center justify-center border border-gray-300 rounded bg-gray-50 hover:bg-gray-100 text-gray-600">+</button>
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Sub- Module</label>
                  <select value={ticketForm.sub_module} onChange={(e) => setTicketForm({ ...ticketForm, sub_module: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Orders">Orders</option>
                    <option value="Invoices">Invoices</option>
                    <option value="Payments">Payments</option>
                    <option value="Returns">Returns</option>
                  </select>
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-28 flex-shrink-0">Ticket Number</label>
                  <input type="text" value={ticketForm.ticket_no} readOnly className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-100" />
                </div>
              </div>

              {/* Row 3 */}
              <div className="grid grid-cols-3 gap-4 mb-3">
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Sub-Category</label>
                  <select value={ticketForm.sub_category} onChange={(e) => setTicketForm({ ...ticketForm, sub_category: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Sub-Category</option>
                    <option value="UI Issue">UI Issue</option>
                    <option value="Data Issue">Data Issue</option>
                    <option value="Performance">Performance</option>
                    <option value="Other">Other</option>
                  </select>
                  <button className="h-8 w-8 flex items-center justify-center border border-gray-300 rounded bg-gray-50 hover:bg-gray-100 text-gray-600">+</button>
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Child-Module</label>
                  <select value={ticketForm.child_module} onChange={(e) => setTicketForm({ ...ticketForm, child_module: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Please Select</option>
                    <option value="Create">Create</option>
                    <option value="Edit">Edit</option>
                    <option value="Delete">Delete</option>
                    <option value="View">View</option>
                  </select>
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-28 flex-shrink-0">Priority</label>
                  <select value={ticketForm.priority} onChange={(e) => setTicketForm({ ...ticketForm, priority: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Priority</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                  </select>
                </div>
              </div>

              {/* Row 4 */}
              <div className="grid grid-cols-3 gap-4 mb-3">
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Details</label>
                  <input type="text" value={ticketForm.details} onChange={(e) => setTicketForm({ ...ticketForm, details: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Resolved By</label>
                  <input type="text" value={ticketForm.resolved_by} onChange={(e) => setTicketForm({ ...ticketForm, resolved_by: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-28 flex-shrink-0">Status</label>
                  <select value={ticketForm.status} onChange={(e) => setTicketForm({ ...ticketForm, status: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50">
                    <option value="">Select Status</option>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Closed">Closed</option>
                  </select>
                </div>
              </div>

              {/* Row 5 */}
              <div className="grid grid-cols-3 gap-4 mb-4">
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Resolution Details</label>
                  <input type="text" value={ticketForm.resolution} onChange={(e) => setTicketForm({ ...ticketForm, resolution: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-24 flex-shrink-0">Date / Time</label>
                  <input type="datetime-local" value={ticketForm.date_time} onChange={(e) => setTicketForm({ ...ticketForm, date_time: e.target.value })} className="flex-1 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50" />
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-xs font-medium text-blue-600 w-28 flex-shrink-0">Upload File</label>
                  <input type="file" ref={ticketFileRef} onChange={(e) => setTicketFile(e.target.files?.[0] || null)} className="hidden" />
                  <button onClick={() => ticketFileRef.current?.click()} className="h-8 px-3 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 flex items-center gap-1">
                    <CheckCircle className="w-3 h-3" /> Choose File
                  </button>
                  <button onClick={handleTicketFileUpload} disabled={!ticketFile} className="h-8 px-4 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 disabled:opacity-50">
                    Upload
                  </button>
                </div>
              </div>

              {/* Save Button */}
              <div className="flex justify-center">
                <button onClick={handleSaveTicket} className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          )}

          <div className="overflow-x-auto">
            <table className="w-full text-xs border border-gray-300">
              <thead>
                <tr className="bg-blue-600 text-white">
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Ticket No.</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Date/Time</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">User Name</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Module/Sub-Module/Child-Module</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Category/Sub-Category</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Details</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Priority</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Resolution</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Resolved By</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Closed Date</th>
                  <th className="px-2 py-1.5 text-left font-medium">Status</th>
                </tr>
              </thead>
              <tbody>
                {supportTickets.length === 0 ? (
                  <tr><td colSpan={11} className="px-2 py-4 text-center text-gray-400 border-t">No tickets found</td></tr>
                ) : (
                  supportTickets.map((ticket: any) => {
                    const tData = parseTicketData(ticket);
                    return (
                      <tr key={ticket.id} className="border-t hover:bg-gray-50 cursor-pointer" onClick={() => { setEditingTicket(ticket); setTicketForm(tData); setShowTicketModal(true); }}>
                        <td className="px-2 py-1.5 border-r text-blue-600">{tData.ticket_no}</td>
                        <td className="px-2 py-1.5 border-r whitespace-nowrap">{tData.date_time ? new Date(tData.date_time).toLocaleString() : '-'}</td>
                        <td className="px-2 py-1.5 border-r">{tData.user_name}</td>
                        <td className="px-2 py-1.5 border-r">{[tData.module, tData.sub_module, tData.child_module].filter(Boolean).join(' / ')}</td>
                        <td className="px-2 py-1.5 border-r">{[tData.category, tData.sub_category].filter(Boolean).join(' / ')}</td>
                        <td className="px-2 py-1.5 border-r max-w-[150px] truncate">{tData.details}</td>
                        <td className="px-2 py-1.5 border-r">
                          <span className={`px-1.5 py-0.5 rounded text-white text-[10px] ${tData.priority === 'High' ? 'bg-red-500' : tData.priority === 'Medium' ? 'bg-yellow-500' : 'bg-green-500'}`}>
                            {tData.priority}
                          </span>
                        </td>
                        <td className="px-2 py-1.5 border-r max-w-[100px] truncate">{tData.resolution}</td>
                        <td className="px-2 py-1.5 border-r">{tData.resolved_by}</td>
                        <td className="px-2 py-1.5 border-r whitespace-nowrap">{tData.closed_date}</td>
                        <td className="px-2 py-1.5">
                          <span className={`px-1.5 py-0.5 rounded text-white text-[10px] ${tData.status === 'Closed' ? 'bg-gray-500' : tData.status === 'In Progress' ? 'bg-blue-500' : 'bg-green-500'}`}>
                            {tData.status}
                          </span>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Summary Sub-tab */}
      {supportSubTab === 'summary' && (
        <div>
          {/* Status Filter and Generate PDF */}
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <label className="text-xs font-medium text-blue-600 w-16">Status</label>
              <select value={summaryStatusFilter} onChange={(e) => setSummaryStatusFilter(e.target.value)} className="w-64 h-8 px-2 text-sm border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Nothing selected</option>
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Closed">Closed</option>
              </select>
            </div>
            <button onClick={() => alert('Generate PDF functionality')} className="h-8 px-4 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
              Generate PDF
            </button>
          </div>

          {/* Tickets Table */}
          <div className="overflow-x-auto">
            <table className="w-full text-xs border border-gray-300">
              <thead>
                <tr className="bg-blue-600 text-white">
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Ticket No.</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Date/Time</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">User Name</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Module/Sub-Module/Child-Module</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Category/Sub-Category</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Details</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Priority</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Resolution</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Resolved By</th>
                  <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 whitespace-nowrap">Closed Date</th>
                  <th className="px-2 py-1.5 text-left font-medium">Status</th>
                </tr>
              </thead>
              <tbody>
                {supportTickets.filter((t: any) => !summaryStatusFilter || parseTicketData(t).status === summaryStatusFilter).length === 0 ? (
                  <tr><td colSpan={11} className="px-2 py-4 text-center text-gray-400 border-t">No tickets found</td></tr>
                ) : (
                  supportTickets.filter((t: any) => !summaryStatusFilter || parseTicketData(t).status === summaryStatusFilter).map((ticket: any) => {
                    const tData = parseTicketData(ticket);
                    return (
                      <tr key={ticket.id} className="border-t hover:bg-gray-50">
                        <td className="px-2 py-1.5 border-r text-blue-600">{tData.ticket_no}</td>
                        <td className="px-2 py-1.5 border-r whitespace-nowrap">{tData.date_time ? new Date(tData.date_time).toLocaleString() : '-'}</td>
                        <td className="px-2 py-1.5 border-r">{tData.user_name}</td>
                        <td className="px-2 py-1.5 border-r">{[tData.module, tData.sub_module, tData.child_module].filter(Boolean).join(' / ')}</td>
                        <td className="px-2 py-1.5 border-r">{[tData.category, tData.sub_category].filter(Boolean).join(' / ')}</td>
                        <td className="px-2 py-1.5 border-r max-w-[150px] truncate">{tData.details}</td>
                        <td className="px-2 py-1.5 border-r">
                          <span className={`px-1.5 py-0.5 rounded text-white text-[10px] ${tData.priority === 'High' ? 'bg-red-500' : tData.priority === 'Medium' ? 'bg-yellow-500' : 'bg-green-500'}`}>
                            {tData.priority}
                          </span>
                        </td>
                        <td className="px-2 py-1.5 border-r max-w-[100px] truncate">{tData.resolution}</td>
                        <td className="px-2 py-1.5 border-r">{tData.resolved_by}</td>
                        <td className="px-2 py-1.5 border-r whitespace-nowrap">{tData.closed_date}</td>
                        <td className="px-2 py-1.5">
                          <span className={`px-1.5 py-0.5 rounded text-white text-[10px] ${tData.status === 'Closed' ? 'bg-gray-500' : tData.status === 'In Progress' ? 'bg-blue-500' : 'bg-green-500'}`}>
                            {tData.status}
                          </span>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Feedback Sub-tab */}
      {supportSubTab === 'feedback' && (
        <div className="overflow-x-auto">
          <table className="w-full text-xs border border-gray-300">
            <thead>
              <tr className="bg-blue-600 text-white">
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500 w-10">No.</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Ticket Number</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Company Name</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Issued By</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Date Received</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Help Topic</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Module</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Priority</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Work Group</th>
                <th className="px-2 py-1.5 text-left font-medium border-r border-blue-500">Assigned</th>
                <th className="px-2 py-1.5 text-center font-medium w-20">Action</th>
              </tr>
            </thead>
            <tbody>
              {/* Filter Row */}
              <tr className="bg-white border-t">
                <td className="px-1 py-1.5 border-r border-gray-200"></td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <input type="text" value={feedbackFilter.ticket_number} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, ticket_number: e.target.value })} placeholder="Ticket No." className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <select value={feedbackFilter.company_name} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, company_name: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Company</option>
                    <option value="Company A">Company A</option>
                    <option value="Company B">Company B</option>
                  </select>
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <input type="text" value={feedbackFilter.issued_by} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, issued_by: e.target.value })} placeholder="Issued By" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <input type="date" value={feedbackFilter.date_received} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, date_received: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <select value={feedbackFilter.help_topic} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, help_topic: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">- Select Category -</option>
                    <option value="Technical">Technical</option>
                    <option value="Billing">Billing</option>
                    <option value="General">General</option>
                  </select>
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <select value={feedbackFilter.module} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, module: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">- Select Menu -</option>
                    <option value="Sales">Sales</option>
                    <option value="Inventory">Inventory</option>
                    <option value="Finance">Finance</option>
                  </select>
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <select value={feedbackFilter.priority} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, priority: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                  </select>
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <select value={feedbackFilter.work_group} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, work_group: e.target.value })} className="w-full h-7 px-1 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">Select Work Group</option>
                    <option value="Support Team">Support Team</option>
                    <option value="Dev Team">Dev Team</option>
                    <option value="QA Team">QA Team</option>
                  </select>
                </td>
                <td className="px-1 py-1.5 border-r border-gray-200">
                  <input type="text" value={feedbackFilter.assigned} onChange={(e) => setFeedbackFilter({ ...feedbackFilter, assigned: e.target.value })} placeholder="User Name" className="w-full h-7 px-2 text-xs border border-gray-300 rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </td>
                <td className="px-1 py-1.5 text-center">
                  <button onClick={() => handleSearchFeedback()} className="h-7 px-4 text-xs font-medium text-white bg-green-500 rounded hover:bg-green-600">
                    Search
                  </button>
                </td>
              </tr>
              {/* Data Rows */}
              {supportFeedback.length === 0 ? (
                <tr><td colSpan={11} className="px-2 py-4 text-center text-gray-400 border-t">No feedback found</td></tr>
              ) : (
                supportFeedback.map((fb: any, idx: number) => (
                  <tr key={fb.id || idx} className="border-t hover:bg-gray-50">
                    <td className="px-2 py-1.5 border-r">{idx + 1}</td>
                    <td className="px-2 py-1.5 border-r text-blue-600">{fb.ticket_number}</td>
                    <td className="px-2 py-1.5 border-r">{fb.company_name}</td>
                    <td className="px-2 py-1.5 border-r">{fb.issued_by}</td>
                    <td className="px-2 py-1.5 border-r whitespace-nowrap">{fb.date_received}</td>
                    <td className="px-2 py-1.5 border-r">{fb.help_topic}</td>
                    <td className="px-2 py-1.5 border-r">{fb.module}</td>
                    <td className="px-2 py-1.5 border-r">
                      <span className={`px-1.5 py-0.5 rounded text-white text-[10px] ${fb.priority === 'High' ? 'bg-red-500' : fb.priority === 'Medium' ? 'bg-yellow-500' : 'bg-green-500'}`}>
                        {fb.priority}
                      </span>
                    </td>
                    <td className="px-2 py-1.5 border-r">{fb.work_group}</td>
                    <td className="px-2 py-1.5 border-r">{fb.assigned}</td>
                    <td className="px-2 py-1.5 text-center">
                      <button onClick={() => handleDeleteFeedback(fb.id)} className="text-red-500 hover:text-red-700"><Trash2 className="w-3.5 h-3.5" /></button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      )}

      {/* Memo Sub-tab */}
      {supportSubTab === 'memo' && (
        <div>
          <div className="mb-3">
            <button onClick={() => { setEditingSupportMemo(null); setShowSupportMemoModal(true); }} className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
              Add Memo
            </button>
          </div>
          {supportMemos.length === 0 ? (
            <div className="text-xs text-gray-400 text-center py-4 bg-gray-50 rounded border">No memos found</div>
          ) : (
            <div className="space-y-2">
              {supportMemos.map((memo: any) => (
                <div key={memo.id} className="p-3 bg-gray-50 rounded border">
                  <div className="flex justify-between items-start mb-2">
                    <span className="text-xs text-gray-500">{memo.created_at ? new Date(memo.created_at).toLocaleString() : ''}</span>
                    <button onClick={() => handleDeleteSupportMemo(memo.id)} className="text-red-500 hover:text-red-700"><Trash2 className="w-3.5 h-3.5" /></button>
                  </div>
                  <div className="text-sm" dangerouslySetInnerHTML={{ __html: memo.content }} />
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Workflow & Audit Trail Sub-tab */}
      {supportSubTab === 'workflow-audit-trail' && (
        <div className="text-xs text-gray-400 text-center py-4 bg-gray-50 rounded border">
          Workflow and audit trail coming soon
        </div>
      )}

      {/* Memo Modal */}
      {showSupportMemoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3 bg-blue-800">
              <h3 className="text-sm font-bold text-white uppercase tracking-wide">MEMO DETAILS</h3>
              <button onClick={() => { setShowSupportMemoModal(false); setEditingSupportMemo(null); }} className="text-white hover:text-gray-300"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-5">
              <div className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-t bg-white">
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('bold'); }} className="w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-100 rounded border border-gray-200">B</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('italic'); }} className="w-7 h-7 flex items-center justify-center italic text-sm hover:bg-gray-100 rounded border border-gray-200">I</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('underline'); }} className="w-7 h-7 flex items-center justify-center underline text-sm hover:bg-gray-100 rounded border border-gray-200">U</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('strikeThrough'); }} className="w-7 h-7 flex items-center justify-center line-through text-sm hover:bg-gray-100 rounded border border-gray-200">S</button>
                <select onChange={(e) => handleSupportMemoExec('fontName', e.target.value)} className="h-7 px-1 text-xs border border-gray-200 rounded bg-white">
                  <option value="jost">jost</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                </select>
                <select onChange={(e) => handleSupportMemoExec('fontSize', e.target.value)} className="h-7 px-1 text-xs border border-gray-200 rounded bg-white">
                  <option value="3">14</option>
                  <option value="2">12</option>
                  <option value="4">16</option>
                  <option value="5">18</option>
                </select>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('foreColor', '#FFFF00'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200 bg-yellow-300 font-bold">A</button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('insertUnorderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('insertOrderedList'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg>
                </button>
                <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSupportMemoExec('outdent'); }} className="w-7 h-7 flex items-center justify-center text-sm hover:bg-gray-100 rounded border border-gray-200">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 19l-7-7 7-7m8 14V5" /></svg>
                </button>
              </div>
              <div ref={supportMemoEditorRef} contentEditable className="w-full min-h-[200px] max-h-[300px] overflow-y-auto px-3 py-3 text-sm border border-t-0 border-gray-300 rounded-b focus:outline-none bg-white resize-y" style={{ fontFamily: 'jost, sans-serif' }} suppressContentEditableWarning dangerouslySetInnerHTML={{ __html: editingSupportMemo?.content || '' }} />
              <div className="flex justify-center mt-5">
                <button onClick={handleSaveSupportMemo} className="px-8 py-2 text-sm font-medium text-white bg-green-500 rounded hover:bg-green-600">Save</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============== Generic Tab Details ==============
function GenericTabDetails({ tabName }: { tabName: string }) {
  const tabDescriptions: Record<string, { title: string; description: string; fields: string[] }> = {
    'initiation': {
      title: 'Project Initiation',
      description: 'Initial project setup and kickoff phase',
      fields: ['Project Charter', 'Stakeholders', 'Objectives', 'Success Criteria']
    },
    'planning': {
      title: 'Project Planning',
      description: 'Detailed planning and timeline definition',
      fields: ['Project Plan', 'Timeline', 'Resources', 'Milestones']
    },
    'configuration': {
      title: 'System Configuration',
      description: 'Software configuration and customization',
      fields: ['System Setup', 'Modules', 'Integrations', 'Customizations']
    },
    'training': {
      title: 'User Training',
      description: 'End-user and admin training sessions',
      fields: ['Training Schedule', 'Materials', 'Attendees', 'Completion Status']
    },
    'uat': {
      title: 'User Acceptance Testing',
      description: 'Testing and validation by end-users',
      fields: ['Test Cases', 'Test Results', 'Issues Found', 'Sign-off Status']
    },
    'data-migration': {
      title: 'Data Migration',
      description: 'Legacy data migration and validation',
      fields: ['Data Sources', 'Migration Plan', 'Validation Results', 'Completion Status']
    },
    'go-live': {
      title: 'Go Live',
      description: 'Production deployment and launch',
      fields: ['Launch Date', 'Checklist', 'Rollback Plan', 'Deployment Status']
    },
    'support': {
      title: 'Post-Implementation Support',
      description: 'Ongoing support and maintenance',
      fields: ['Support Plan', 'SLA', 'Tickets', 'Escalation Process']
    }
  };

  const info = tabDescriptions[tabName] || {
    title: tabName.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
    description: 'Phase details and management',
    fields: ['Status', 'Notes', 'Timeline', 'Resources']
  };

  return (
    <div className="space-y-4">
      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 className="text-sm font-semibold text-blue-800">{info.title}</h3>
        <p className="text-xs text-blue-600 mt-1">{info.description}</p>
      </div>

      <div className="grid grid-cols-2 gap-4">
        {info.fields.map((field, index) => (
          <div key={index} className="bg-gray-50 border border-gray-200 rounded-lg p-3">
            <label className="text-xs font-medium text-blue-600 block mb-1">{field}</label>
            <div className="text-xs text-gray-400 italic">Not configured</div>
          </div>
        ))}
      </div>

      <div className="text-center py-4 bg-gray-50 rounded-lg border border-gray-200">
        <p className="text-xs text-gray-500">Use the sub-tabs to manage Activities, Documents, and Memos for this phase.</p>
      </div>
    </div>
  );
}

// ============== Activity Modal ==============
function ActivityModal({ isOpen, onClose, onSave, editingItem }: any) {
  const [formData, setFormData] = useState({
    activity_type: editingItem?.activity_type || 'task',
    subject: editingItem?.subject || '',
    description: editingItem?.description || '',
    priority: editingItem?.priority || 'medium',
    start_date: editingItem?.start_date || '',
    start_time: editingItem?.start_time || '',
    end_date: editingItem?.end_date || '',
    end_time: editingItem?.end_time || '',
    status: editingItem?.status || 'planned',
  });

  const inputClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500";

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white rounded-lg shadow-xl w-[500px] max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between p-3 border-b bg-blue-600 text-white rounded-t-lg">
          <h3 className="font-medium">{editingItem ? 'Edit Activity' : 'New Activity'}</h3>
          <button onClick={onClose}><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Type</label>
              <select value={formData.activity_type} onChange={(e) => setFormData({ ...formData, activity_type: e.target.value })} className={inputClass}>
                <option value="task">Task</option>
                <option value="call">Call</option>
                <option value="meeting">Meeting</option>
                <option value="email">Email</option>
                <option value="follow_up">Follow Up</option>
              </select>
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Priority</label>
              <select value={formData.priority} onChange={(e) => setFormData({ ...formData, priority: e.target.value })} className={inputClass}>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Subject</label>
            <input type="text" value={formData.subject} onChange={(e) => setFormData({ ...formData, subject: e.target.value })} className={inputClass} />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Description</label>
            <textarea value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} className="w-full h-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Start Date</label>
              <input type="date" value={formData.start_date} onChange={(e) => setFormData({ ...formData, start_date: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Start Time</label>
              <input type="time" value={formData.start_time} onChange={(e) => setFormData({ ...formData, start_time: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">End Date</label>
              <input type="date" value={formData.end_date} onChange={(e) => setFormData({ ...formData, end_date: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">End Time</label>
              <input type="time" value={formData.end_time} onChange={(e) => setFormData({ ...formData, end_time: e.target.value })} className={inputClass} />
            </div>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Status</label>
            <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })} className={inputClass}>
              <option value="planned">Planned</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div className="flex justify-end gap-2 p-3 border-t">
          <button onClick={onClose} className="px-4 py-1.5 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
          <button onClick={() => onSave(formData)} className="px-4 py-1.5 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">Save</button>
        </div>
      </div>
    </div>
  );
}

// ============== Memo Modal ==============
function MemoModal({ isOpen, onClose, onSave, editingItem }: any) {
  const [formData, setFormData] = useState({
    title: editingItem?.title || '',
    content: editingItem?.content || '',
  });

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white rounded-lg shadow-xl w-[400px]">
        <div className="flex items-center justify-between p-3 border-b bg-blue-600 text-white rounded-t-lg">
          <h3 className="font-medium">{editingItem ? 'Edit Memo' : 'New Memo'}</h3>
          <button onClick={onClose}><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4 space-y-3">
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Title</label>
            <input type="text" value={formData.title} onChange={(e) => setFormData({ ...formData, title: e.target.value })} className="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Content</label>
            <textarea value={formData.content} onChange={(e) => setFormData({ ...formData, content: e.target.value })} className="w-full h-32 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
        </div>
        <div className="flex justify-end gap-2 p-3 border-t">
          <button onClick={onClose} className="px-4 py-1.5 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
          <button onClick={() => onSave(formData)} className="px-4 py-1.5 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">Save</button>
        </div>
      </div>
    </div>
  );
}

// ============== Demo Modal ==============
function DemoModal({ isOpen, onClose, crId, editingItem, refreshData }: any) {
  const [formData, setFormData] = useState({
    demo_date: editingItem?.demo_date || '',
    demo_time: editingItem?.demo_time || '',
    demo_type: editingItem?.demo_type || '',
    presenter_id: editingItem?.presenter_id || '',
    attendees: editingItem?.attendees || '',
    location: editingItem?.location || '',
    meeting_link: editingItem?.meeting_link || '',
    modules_to_demo: editingItem?.modules_to_demo || '',
    notes: editingItem?.notes || '',
    feedback: editingItem?.feedback || '',
    status: editingItem?.status || 'scheduled',
  });
  const [saving, setSaving] = useState(false);

  const inputClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500";

  const handleSave = async () => {
    setSaving(true);
    try {
      if (editingItem) {
        await api.updateCRDemo(crId, editingItem.id, formData);
      } else {
        await api.createCRDemo(crId, formData);
      }
      refreshData();
      onClose();
    } catch (err) {
      alert('Failed to save');
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white rounded-lg shadow-xl w-[500px] max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between p-3 border-b bg-blue-600 text-white rounded-t-lg">
          <h3 className="font-medium">{editingItem ? 'Edit Demo' : 'New Demo'}</h3>
          <button onClick={onClose}><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Date</label>
              <input type="date" value={formData.demo_date} onChange={(e) => setFormData({ ...formData, demo_date: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Time</label>
              <input type="time" value={formData.demo_time} onChange={(e) => setFormData({ ...formData, demo_time: e.target.value })} className={inputClass} />
            </div>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Demo Type</label>
            <select value={formData.demo_type} onChange={(e) => setFormData({ ...formData, demo_type: e.target.value })} className={inputClass}>
              <option value="">Select Type</option>
              <option value="online">Online</option>
              <option value="onsite">Onsite</option>
              <option value="hybrid">Hybrid</option>
            </select>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Modules to Demo</label>
            <input type="text" value={formData.modules_to_demo} onChange={(e) => setFormData({ ...formData, modules_to_demo: e.target.value })} className={inputClass} />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Location</label>
            <input type="text" value={formData.location} onChange={(e) => setFormData({ ...formData, location: e.target.value })} className={inputClass} />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Meeting Link</label>
            <input type="text" value={formData.meeting_link} onChange={(e) => setFormData({ ...formData, meeting_link: e.target.value })} className={inputClass} />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Attendees</label>
            <input type="text" value={formData.attendees} onChange={(e) => setFormData({ ...formData, attendees: e.target.value })} className={inputClass} />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Notes</label>
            <textarea value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Feedback</label>
            <textarea value={formData.feedback} onChange={(e) => setFormData({ ...formData, feedback: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Status</label>
            <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })} className={inputClass}>
              <option value="scheduled">Scheduled</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div className="flex justify-end gap-2 p-3 border-t">
          <button onClick={onClose} className="px-4 py-1.5 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-1.5 text-sm text-white bg-blue-600 rounded hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </div>
  );
}

// ============== Proposal Modal ==============
function ProposalModal({ isOpen, onClose, crId, editingItem, refreshData }: any) {
  const [formData, setFormData] = useState({
    proposal_number: editingItem?.proposal_number || '',
    proposal_date: editingItem?.proposal_date || '',
    valid_until: editingItem?.valid_until || '',
    subtotal: editingItem?.subtotal || 0,
    discount: editingItem?.discount || 0,
    tax: editingItem?.tax || 0,
    total: editingItem?.total || 0,
    currency: editingItem?.currency || 'USD',
    purpose: editingItem?.purpose || '',
    scope: editingItem?.scope || '',
    deliverables: editingItem?.deliverables || '',
    terms_conditions: editingItem?.terms_conditions || '',
    status: editingItem?.status || 'draft',
  });
  const [saving, setSaving] = useState(false);

  const inputClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500";

  const handleSave = async () => {
    setSaving(true);
    try {
      if (editingItem) {
        await api.updateCRProposal(crId, editingItem.id, formData);
      } else {
        await api.createCRProposal(crId, formData);
      }
      refreshData();
      onClose();
    } catch (err) {
      alert('Failed to save');
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white rounded-lg shadow-xl w-[600px] max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between p-3 border-b bg-blue-600 text-white rounded-t-lg">
          <h3 className="font-medium">{editingItem ? 'Edit Proposal' : 'New Proposal'}</h3>
          <button onClick={onClose}><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4 space-y-3">
          <div className="grid grid-cols-3 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Proposal Number</label>
              <input type="text" value={formData.proposal_number} onChange={(e) => setFormData({ ...formData, proposal_number: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Date</label>
              <input type="date" value={formData.proposal_date} onChange={(e) => setFormData({ ...formData, proposal_date: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Valid Until</label>
              <input type="date" value={formData.valid_until} onChange={(e) => setFormData({ ...formData, valid_until: e.target.value })} className={inputClass} />
            </div>
          </div>
          <div className="grid grid-cols-4 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Currency</label>
              <select value={formData.currency} onChange={(e) => setFormData({ ...formData, currency: e.target.value })} className={inputClass}>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
                <option value="PKR">PKR</option>
              </select>
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Subtotal</label>
              <input type="number" value={formData.subtotal} onChange={(e) => setFormData({ ...formData, subtotal: parseFloat(e.target.value) || 0 })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Discount</label>
              <input type="number" value={formData.discount} onChange={(e) => setFormData({ ...formData, discount: parseFloat(e.target.value) || 0 })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Tax</label>
              <input type="number" value={formData.tax} onChange={(e) => setFormData({ ...formData, tax: parseFloat(e.target.value) || 0 })} className={inputClass} />
            </div>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Total</label>
            <input type="number" value={formData.total} onChange={(e) => setFormData({ ...formData, total: parseFloat(e.target.value) || 0 })} className={inputClass} />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Purpose</label>
            <textarea value={formData.purpose} onChange={(e) => setFormData({ ...formData, purpose: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Scope</label>
            <textarea value={formData.scope} onChange={(e) => setFormData({ ...formData, scope: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Deliverables</label>
            <textarea value={formData.deliverables} onChange={(e) => setFormData({ ...formData, deliverables: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Terms & Conditions</label>
            <textarea value={formData.terms_conditions} onChange={(e) => setFormData({ ...formData, terms_conditions: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Status</label>
            <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })} className={inputClass}>
              <option value="draft">Draft</option>
              <option value="sent">Sent</option>
              <option value="accepted">Accepted</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
        <div className="flex justify-end gap-2 p-3 border-t">
          <button onClick={onClose} className="px-4 py-1.5 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-1.5 text-sm text-white bg-blue-600 rounded hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </div>
  );
}

// ============== Agreement Modal ==============
function AgreementModal({ isOpen, onClose, crId, editingItem, refreshData }: any) {
  const [formData, setFormData] = useState({
    agreement_number: editingItem?.agreement_number || '',
    agreement_date: editingItem?.agreement_date || '',
    start_date: editingItem?.start_date || '',
    end_date: editingItem?.end_date || '',
    agreement_type: editingItem?.agreement_type || '',
    agreement_value: editingItem?.agreement_value || 0,
    currency: editingItem?.currency || 'USD',
    terms: editingItem?.terms || '',
    special_conditions: editingItem?.special_conditions || '',
    signed_by_customer: editingItem?.signed_by_customer || false,
    signed_by_company: editingItem?.signed_by_company || false,
    customer_signatory: editingItem?.customer_signatory || '',
    company_signatory: editingItem?.company_signatory || '',
    status: editingItem?.status || 'draft',
  });
  const [saving, setSaving] = useState(false);

  const inputClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500";

  const handleSave = async () => {
    setSaving(true);
    try {
      if (editingItem) {
        await api.updateCRAgreement(crId, editingItem.id, formData);
      } else {
        await api.createCRAgreement(crId, formData);
      }
      refreshData();
      onClose();
    } catch (err) {
      alert('Failed to save');
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white rounded-lg shadow-xl w-[600px] max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between p-3 border-b bg-blue-600 text-white rounded-t-lg">
          <h3 className="font-medium">{editingItem ? 'Edit Agreement' : 'New Agreement'}</h3>
          <button onClick={onClose}><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Agreement Number</label>
              <input type="text" value={formData.agreement_number} onChange={(e) => setFormData({ ...formData, agreement_number: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Agreement Date</label>
              <input type="date" value={formData.agreement_date} onChange={(e) => setFormData({ ...formData, agreement_date: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Start Date</label>
              <input type="date" value={formData.start_date} onChange={(e) => setFormData({ ...formData, start_date: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">End Date</label>
              <input type="date" value={formData.end_date} onChange={(e) => setFormData({ ...formData, end_date: e.target.value })} className={inputClass} />
            </div>
          </div>
          <div className="grid grid-cols-3 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Agreement Type</label>
              <select value={formData.agreement_type} onChange={(e) => setFormData({ ...formData, agreement_type: e.target.value })} className={inputClass}>
                <option value="">Select Type</option>
                <option value="service">Service Agreement</option>
                <option value="license">License Agreement</option>
                <option value="support">Support Agreement</option>
                <option value="nda">NDA</option>
              </select>
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Currency</label>
              <select value={formData.currency} onChange={(e) => setFormData({ ...formData, currency: e.target.value })} className={inputClass}>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
                <option value="PKR">PKR</option>
              </select>
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Value</label>
              <input type="number" value={formData.agreement_value} onChange={(e) => setFormData({ ...formData, agreement_value: parseFloat(e.target.value) || 0 })} className={inputClass} />
            </div>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Terms</label>
            <textarea value={formData.terms} onChange={(e) => setFormData({ ...formData, terms: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Special Conditions</label>
            <textarea value={formData.special_conditions} onChange={(e) => setFormData({ ...formData, special_conditions: e.target.value })} className="w-full h-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Customer Signatory</label>
              <input type="text" value={formData.customer_signatory} onChange={(e) => setFormData({ ...formData, customer_signatory: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Company Signatory</label>
              <input type="text" value={formData.company_signatory} onChange={(e) => setFormData({ ...formData, company_signatory: e.target.value })} className={inputClass} />
            </div>
          </div>
          <div className="flex gap-4">
            <label className="flex items-center gap-2 text-xs">
              <input type="checkbox" checked={formData.signed_by_customer} onChange={(e) => setFormData({ ...formData, signed_by_customer: e.target.checked })} />
              Signed by Customer
            </label>
            <label className="flex items-center gap-2 text-xs">
              <input type="checkbox" checked={formData.signed_by_company} onChange={(e) => setFormData({ ...formData, signed_by_company: e.target.checked })} />
              Signed by Company
            </label>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Status</label>
            <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })} className={inputClass}>
              <option value="draft">Draft</option>
              <option value="sent">Sent</option>
              <option value="signed">Signed</option>
              <option value="active">Active</option>
              <option value="expired">Expired</option>
              <option value="terminated">Terminated</option>
            </select>
          </div>
        </div>
        <div className="flex justify-end gap-2 p-3 border-t">
          <button onClick={onClose} className="px-4 py-1.5 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-1.5 text-sm text-white bg-blue-600 rounded hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </div>
  );
}

// ============== Call Log Modal ==============
function CallLogModal({ isOpen, onClose, crId, editingItem, refreshData }: any) {
  const [formData, setFormData] = useState({
    call_date: editingItem?.call_date || '',
    call_time: editingItem?.call_time || '',
    duration_minutes: editingItem?.duration_minutes || '',
    call_type: editingItem?.call_type || 'outbound',
    subject: editingItem?.subject || '',
    notes: editingItem?.notes || '',
    outcome: editingItem?.outcome || '',
    follow_up_required: editingItem?.follow_up_required || false,
    follow_up_date: editingItem?.follow_up_date || '',
  });
  const [saving, setSaving] = useState(false);

  const inputClass = "w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500";

  const handleSave = async () => {
    setSaving(true);
    try {
      if (editingItem) {
        await api.updateCRCallLog(crId, editingItem.id, formData);
      } else {
        await api.createCRCallLog(crId, formData);
      }
      refreshData();
      onClose();
    } catch (err) {
      alert('Failed to save');
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white rounded-lg shadow-xl w-[500px]">
        <div className="flex items-center justify-between p-3 border-b bg-blue-600 text-white rounded-t-lg">
          <h3 className="font-medium">{editingItem ? 'Edit Call Log' : 'New Call Log'}</h3>
          <button onClick={onClose}><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4 space-y-3">
          <div className="grid grid-cols-3 gap-3">
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Date</label>
              <input type="date" value={formData.call_date} onChange={(e) => setFormData({ ...formData, call_date: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Time</label>
              <input type="time" value={formData.call_time} onChange={(e) => setFormData({ ...formData, call_time: e.target.value })} className={inputClass} />
            </div>
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Duration (min)</label>
              <input type="number" value={formData.duration_minutes} onChange={(e) => setFormData({ ...formData, duration_minutes: parseInt(e.target.value) || '' })} className={inputClass} />
            </div>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Call Type</label>
            <select value={formData.call_type} onChange={(e) => setFormData({ ...formData, call_type: e.target.value })} className={inputClass}>
              <option value="outbound">Outbound</option>
              <option value="inbound">Inbound</option>
              <option value="scheduled">Scheduled</option>
            </select>
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Subject</label>
            <input type="text" value={formData.subject} onChange={(e) => setFormData({ ...formData, subject: e.target.value })} className={inputClass} />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Notes</label>
            <textarea value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })} className="w-full h-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>
          <div>
            <label className="text-xs font-medium text-blue-600 mb-1 block">Outcome</label>
            <select value={formData.outcome} onChange={(e) => setFormData({ ...formData, outcome: e.target.value })} className={inputClass}>
              <option value="">Select Outcome</option>
              <option value="connected">Connected</option>
              <option value="voicemail">Voicemail</option>
              <option value="no_answer">No Answer</option>
              <option value="busy">Busy</option>
              <option value="callback_requested">Callback Requested</option>
            </select>
          </div>
          <div className="flex items-center gap-2">
            <input type="checkbox" id="follow_up" checked={formData.follow_up_required} onChange={(e) => setFormData({ ...formData, follow_up_required: e.target.checked })} />
            <label htmlFor="follow_up" className="text-xs text-gray-700">Follow-up Required</label>
          </div>
          {formData.follow_up_required && (
            <div>
              <label className="text-xs font-medium text-blue-600 mb-1 block">Follow-up Date</label>
              <input type="date" value={formData.follow_up_date} onChange={(e) => setFormData({ ...formData, follow_up_date: e.target.value })} className={inputClass} />
            </div>
          )}
        </div>
        <div className="flex justify-end gap-2 p-3 border-t">
          <button onClick={onClose} className="px-4 py-1.5 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-1.5 text-sm text-white bg-blue-600 rounded hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </div>
  );
}

// ============== Email Modal ==============
function EmailModal({ isOpen, onClose, crId, leadId, tab, contactEmail, templateId, companyName }: any) {
  const [formData, setFormData] = useState({
    to: contactEmail || '',
    cc: '',
    bcc: '',
    subject: '',
    body: '',
  });
  const [templates, setTemplates] = useState<any[]>([]);
  const [selectedTemplate, setSelectedTemplate] = useState<any>(null);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [sending, setSending] = useState(false);
  const [loadingTemplate, setLoadingTemplate] = useState(false);
  const fileInputRef = React.useRef<HTMLInputElement>(null);
  const editorRef = React.useRef<HTMLDivElement>(null);

  // Load templates for the tab
  useEffect(() => {
    if (tab) {
      api.getCRIEmailTemplates(tab).then(setTemplates).catch(() => setTemplates([]));
    }
  }, [tab]);

  // Update to field when contactEmail prop changes
  useEffect(() => {
    if (contactEmail) {
      setFormData(prev => ({ ...prev, to: contactEmail }));
    }
  }, [contactEmail]);

  // Load template content when templateId changes or when selected from dropdown
  useEffect(() => {
    if (templateId && templates.length > 0) {
      const template = templates.find((t: any) => t.id === templateId);
      if (template) {
        loadTemplateContent(template);
      }
    }
  }, [templateId, templates]);

  const loadTemplateContent = async (template: any) => {
    setLoadingTemplate(true);
    try {
      setSelectedTemplate(template);
      setFormData(prev => ({
        ...prev,
        subject: template.subject || '',
        body: template.email_template || '',
      }));
    } catch (err) {
      console.error('Failed to load template:', err);
    } finally {
      setLoadingTemplate(false);
    }
  };

  const handleTemplateChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const templateIdVal = parseInt(e.target.value);
    if (templateIdVal) {
      const template = templates.find((t: any) => t.id === templateIdVal);
      if (template) {
        loadTemplateContent(template);
      }
    } else {
      setSelectedTemplate(null);
      setFormData(prev => ({ ...prev, subject: '', body: '' }));
    }
  };

  const handleChooseFile = () => {
    fileInputRef.current?.click();
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleSend = async () => {
    if (!formData.to) {
      alert('Please enter recipient email address');
      return;
    }
    if (!formData.subject) {
      alert('Please enter subject');
      return;
    }
    setSending(true);
    try {
      // For now, we'll simulate sending - in production, this would call an API
      await new Promise(resolve => setTimeout(resolve, 1000));
      alert('Email sent successfully!');
      onClose();
    } catch (err: any) {
      alert(err?.response?.data?.detail || 'Failed to send email');
    } finally {
      setSending(false);
    }
  };

  // Format buttons for toolbar
  const formatText = (command: string, value?: string) => {
    editorRef.current?.focus();
    document.execCommand(command, false, value);
  };

  if (!isOpen) return null;

  const tabTitle = tab ? tab.charAt(0).toUpperCase() + tab.slice(1).replace(/-/g, ' ') : 'Lead Request';

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
      <div className="bg-white shadow-2xl w-[950px] max-h-[90vh] overflow-hidden flex flex-col border border-gray-400">
        {/* Header - Dark background like screenshot */}
        <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-cyan-600 to-cyan-700 text-white">
          <h3 className="font-semibold text-sm tracking-wide">EMAIL: {tabTitle.toUpperCase()} :</h3>
          <button onClick={onClose} className="text-white hover:text-gray-200 text-xl font-bold px-2">
            &times;
          </button>
        </div>

        {/* Form Fields - Matching screenshot layout */}
        <div className="px-6 py-4 space-y-2 bg-white">
          {/* To */}
          <div className="flex items-center">
            <label className="text-sm font-medium text-blue-600 w-20">To</label>
            <input
              type="text"
              value={formData.to}
              onChange={(e) => setFormData({ ...formData, to: e.target.value })}
              className="flex-1 h-7 px-2 text-sm border border-gray-300 focus:outline-none focus:border-blue-500"
            />
          </div>

          {/* Cc */}
          <div className="flex items-center">
            <label className="text-sm font-medium text-blue-600 w-20">Cc</label>
            <input
              type="text"
              value={formData.cc}
              onChange={(e) => setFormData({ ...formData, cc: e.target.value })}
              className="flex-1 h-7 px-2 text-sm border border-gray-300 focus:outline-none focus:border-blue-500"
            />
          </div>

          {/* Bcc */}
          <div className="flex items-center">
            <label className="text-sm font-medium text-blue-600 w-20">Bcc</label>
            <input
              type="text"
              value={formData.bcc}
              onChange={(e) => setFormData({ ...formData, bcc: e.target.value })}
              className="flex-1 h-7 px-2 text-sm border border-gray-300 focus:outline-none focus:border-blue-500"
            />
          </div>

          {/* Subject */}
          <div className="flex items-center">
            <label className="text-sm font-medium text-blue-600 w-20">Subject</label>
            <input
              type="text"
              value={formData.subject}
              onChange={(e) => setFormData({ ...formData, subject: e.target.value })}
              className="flex-1 h-7 px-2 text-sm border border-gray-300 focus:outline-none focus:border-blue-500"
            />
          </div>

          {/* Upload File row with Send button */}
          <div className="flex items-center">
            <label className="text-sm font-medium text-blue-600 w-20">Upload File</label>
            <input
              type="text"
              value={selectedFile?.name || ''}
              readOnly
              className="flex-1 h-7 px-2 text-sm border border-gray-300 bg-white"
            />
            <input
              ref={fileInputRef}
              type="file"
              onChange={handleFileChange}
              className="hidden"
            />
            <button
              onClick={handleChooseFile}
              className="ml-2 h-7 px-3 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 flex items-center gap-1"
            >
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              Choose File
            </button>
            <button
              onClick={handleSend}
              disabled={sending}
              className="ml-auto h-7 px-5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"
            >
              {sending ? 'Sending...' : 'Send'}
            </button>
          </div>
        </div>

        {/* Toolbar - Gray background matching screenshot */}
        <div className="flex items-center gap-0.5 px-3 py-1.5 bg-gray-100 border-t border-b border-gray-300">
          {/* Edit/Pen icon */}
          <button onClick={() => {}} className="p-1.5 hover:bg-gray-200 rounded" title="Edit">
            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
          </button>
          <div className="w-px h-5 bg-gray-300 mx-1" />
          {/* Bold */}
          <button onClick={() => formatText('bold')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded font-bold text-sm" title="Bold">
            B
          </button>
          {/* Italic */}
          <button onClick={() => formatText('italic')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded italic text-sm" title="Italic">
            I
          </button>
          {/* Underline */}
          <button onClick={() => formatText('underline')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded underline text-sm" title="Underline">
            U
          </button>
          {/* Strikethrough */}
          <button onClick={() => formatText('strikeThrough')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded line-through text-sm" title="Strikethrough">
            S
          </button>
          <div className="w-px h-5 bg-gray-300 mx-1" />
          {/* Font Family */}
          <select
            onChange={(e) => formatText('fontName', e.target.value)}
            defaultValue="Helvetica"
            className="h-6 px-1 text-xs border border-gray-300 rounded bg-white"
          >
            <option value="Helvetica">Helvetica</option>
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Georgia">Georgia</option>
            <option value="Courier New">Courier New</option>
          </select>
          {/* Font Size */}
          <select
            onChange={(e) => formatText('fontSize', e.target.value)}
            defaultValue="3"
            className="h-6 px-1 text-xs border border-gray-300 rounded bg-white w-12"
          >
            <option value="1">8</option>
            <option value="2">10</option>
            <option value="3">14</option>
            <option value="4">16</option>
            <option value="5">18</option>
            <option value="6">24</option>
            <option value="7">36</option>
          </select>
          <div className="w-px h-5 bg-gray-300 mx-1" />
          {/* Text Color */}
          <button onClick={() => {}} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded text-sm font-bold text-red-500" title="Text Color">
            A<span className="text-xs">&#9660;</span>
          </button>
          <div className="w-px h-5 bg-gray-300 mx-1" />
          {/* Bullet List */}
          <button onClick={() => formatText('insertUnorderedList')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Bullet List">
            <svg className="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M4 6h2v2H4V6zm0 5h2v2H4v-2zm0 5h2v2H4v-2zm4-10h12v2H8V6zm0 5h12v2H8v-2zm0 5h12v2H8v-2z"/>
            </svg>
          </button>
          {/* Numbered List */}
          <button onClick={() => formatText('insertOrderedList')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Numbered List">
            <svg className="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M2 6h2v1H3v1h1v1H2V8h1V7H2V6zm0 5h2v1h1v1H2v-1h1v-1H2v-1zm2 4H2v1h2v1H2v1h3v-1H3v-1h2v-2H4zm4-9h12v2H8V6zm0 5h12v2H8v-2zm0 5h12v2H8v-2z"/>
            </svg>
          </button>
          {/* Indent */}
          <button onClick={() => formatText('indent')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Increase Indent">
            <svg className="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 21h18v-2H3v2zM3 8v8l4-4-4-4zm8 9h10v-2H11v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm0 4h10v-2H11v2z"/>
            </svg>
          </button>
          {/* Outdent */}
          <button onClick={() => formatText('outdent')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Decrease Indent">
            <svg className="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M11 17h10v-2H11v2zm-8-5l4 4V8l-4 4zm0 9h18v-2H3v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm0 4h10v-2H11v2z"/>
            </svg>
          </button>
          <div className="w-px h-5 bg-gray-300 mx-1" />
          {/* Table */}
          <button onClick={() => {}} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Insert Table">
            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </button>
          {/* Link */}
          <button onClick={() => {}} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Insert Link">
            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
          </button>
          {/* Image */}
          <button onClick={() => {}} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Insert Image">
            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </button>
          {/* Horizontal Rule */}
          <button onClick={() => formatText('insertHorizontalRule')} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Horizontal Line">
            <svg className="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M4 11h16v2H4z"/>
            </svg>
          </button>
          {/* Expand */}
          <button onClick={() => {}} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Expand">
            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
          </button>
          {/* Code */}
          <button onClick={() => {}} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="View Source">
            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
          </button>
          {/* Help */}
          <button onClick={() => {}} className="w-7 h-7 flex items-center justify-center hover:bg-gray-200 rounded" title="Help">
            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
        </div>

        {/* Email Body - Rich Text Editor */}
        <div className="flex-1 overflow-auto bg-white">
          {loadingTemplate ? (
            <div className="flex items-center justify-center h-full min-h-[350px]">
              <span className="text-gray-500">Loading template...</span>
            </div>
          ) : (
            <div
              ref={editorRef}
              contentEditable
              className="min-h-[350px] p-4 focus:outline-none text-sm"
              dangerouslySetInnerHTML={{ __html: formData.body }}
              onBlur={(e) => setFormData({ ...formData, body: e.currentTarget.innerHTML })}
              style={{ lineHeight: '1.6' }}
            />
          )}
        </div>
      </div>
    </div>
  );
}
